{"version":3,"sources":["meteor://💻app/packages/steedos:app-workflow/checkNpm.js","meteor://💻app/packages/steedos_app-workflow/core.coffee","meteor://💻app/core.coffee","meteor://💻app/packages/steedos_app-workflow/server/methods/flow_copy.coffee","meteor://💻app/server/methods/flow_copy.coffee","meteor://💻app/packages/steedos_app-workflow/server/methods/distribute.coffee","meteor://💻app/server/methods/distribute.coffee","meteor://💻app/packages/steedos:app-workflow/server/lib/workflow_manager.js","meteor://💻app/packages/steedos_app-workflow/server/lib/uuflow_manager.coffee","meteor://💻app/server/lib/uuflow_manager.coffee","meteor://💻app/packages/steedos_app-workflow/server/lib/push_manager.coffee","meteor://💻app/server/lib/push_manager.coffee","meteor://💻app/packages/steedos_app-workflow/server/lib/export.coffee","meteor://💻app/server/lib/export.coffee","meteor://💻app/packages/steedos_app-workflow/server/lib/import.coffee","meteor://💻app/server/lib/import.coffee","meteor://💻app/packages/steedos_app-workflow/cfs/instances.coffee","meteor://💻app/cfs/instances.coffee","meteor://💻app/packages/steedos_app-workflow/routes/export.coffee","meteor://💻app/routes/export.coffee","meteor://💻app/packages/steedos_app-workflow/routes/import.coffee","meteor://💻app/routes/import.coffee"],"names":["checkNpmVersions","module","link","v","eval","WorkflowCore","Meteor","isClient","openFlowDesign","locale","space","flow","companyId","flowName","iframe_url","ref","title","url","toLocaleLowerCase","Creator","isSpaceAdmin","userId","encodeURIComponent","Steedos","absoluteUrl","t","db","flows","findOne","name","openWindow","openFormDesign","form","Modal","show","formId","keyboard","backdrop","startup","$","document","keydown","e","keyCode","key","length","target","tagName","closest","hasClass","click","isServer","checkCreatePermissions","spaceId","uid","company_id","getCollection","find","_id","count","methods","flow_copy","flowId","options","Error","copy","get_distribute_flows","opts","pinyin","query","searchText","values","params","unblock","JSON","parse","Array","test","state","$regex","limit","fields","fetch","$in","forEach","f","spaces","push","label","value","update_distribute_settings","flow_id","distribute_optional_users_id","step_flows","distribute_to_self","distribute_end_notification","upload_after_being_distributed","distribute_optional_users","setObj","check","String","Boolean","Object","_","each","current","steps","s","allowDistribute","sf","distribute_optional_flows","users","u","id","isEmpty","update","$set","WorkflowManager","getPositionsFilterByUsers","orgId","roleId","flow_positions","role","org","uniqUsers","users_str","users_obj","stringify","uniq","us","getRoleUsersbyOrgAndRole","roleUsers","orgPositions","orgPosition","roleUserIds","concat","getUsers","organization","getOrganization","parent","getRoleUsersByOrgAndRoles","roleIds","getRoleUsersByOrgsAndRoles","orgIds","getRoleUsersByUsersAndRoles","userIds","user","organizations","getSpaceRoles","flow_roles","getRole","getSpacePositions","getUserRoles","userRoles","userPositions","userPosition","getOrganizationsUsers","orgs","orgUsers","getSpaceOrganizations","getOrganizationChildrens","parents","getOrganizationsChildrens","chidrenOrgs","created","created_by","modified","modified_by","getOrganizations","getCompany","getCompanys","companyIds","getUser","notNeedDetails","spaceUser","space_users","company","companys","company_ids","roles","spaceUsers","getHrRolesUsers","hrRoleIds","hrRolesUsers","isArray","hrRoles","hrRole","getFormulaUsers","getProperty","hr","getFormulaUserObjects","getFormulaUserObject","getFormulaOrgObjects","getFormulaOrgObject","getInstanceFormVersion","instance","Template","view","template","steedosData","form_fields","form_version","forms","where","historys","field","type","getFormVersion","versionId","findPropertyByPK","getInstanceFlowVersion","flow_version","getInstanceStep","stepId","g_step","step","canAdmin","fl","curSpaceUser","perms","hasAdminRight","users_can_admin","includes","orgs_can_admin","intersection","some","canMonitor","hasMonitorRight","users_can_monitor","orgs_can_monitor","hasInstancePermissions","admins","approvedUsers","union","outbox_users","inbox_users","cc_users","submitter","applicant","originalInstances","instances","related_instances","$all","console","log","hasPermission","ins","havePermissionUsers","getNameForUser","hasFlowAdminPermission","space_id","user_id","space_user","getMyAdminOrMonitorFlows","flow_ids","Cookies","_eval","isSkipStep","steedosCore","require","uuflowManager","check_authorization","req","res","authToken","cookies","hashedToken","get","Accounts","_hashLoginToken","checkNestStepUsersIsValid","selected","scope","nextStep","allow_pick_approve_users","difference","getInstance","instance_id","getSpace","getSpaceUser","getFlow","getSpaceUserOrgInfo","info","fullname","organization_name","organization_fullname","getTrace","trace_id","trace","traces","getApprove","approve_id","approve","approves","isTraceNotFinished","is_finished","isApproveNotFinished","isInstancePending","lang","TAPi18n","__","isHandlerOrAgent","agent","isInstanceDraft","isInstanceSubmitter","current_user_id","isInstanceSubmitterOrApplicantOrSpaceAdmin","getStep","step_id","flow_rev","isExistStep","history","isJudgeLegal","judge","getUserOrganization","positions","role_names","position","isFlowEnabled","isFlowSpaceMatched","calculateCondition","condition_str","__values","average","max","min","sum","subform_field","sum_field_value","field_value","Number","sub_field","error","stack","setFormFieldVariable","_subform_values","group_fullname","group_id","group_name","organization_selectuser","role_selectuser","subform_fields_all","user_name","user_roles","current_field","values_arr","code","is_multiselect","group","select_user","contains","skip_steps","getNextSteps","applicant_name","applicant_organization_fullname","applicant_organization_name","applicant_roles","approver_name","approver_organization_fullname","approver_organization_name","approver_roles","current_approve","flowVersions","flow_steps","formVersion","lines","nextSteps","prefix","reg","rejectedSteps","rev_nextSteps","start_approve","step_type","submitter_name","submitter_organization_fullname","submitter_organization_name","submitter_roles","trace_steps","version_steps","getUpdatedValues","previous_trace_ids","handler_organization_fullname","handler_organization_name","handler","handler_name","step_line","step_line_condition","condition","replace","vowel","to_step","filter","line","pluck","flowVer","flow_ver_step","flow_step","history_step","next_step_id","_next_step","nextStepId","_step","newest_values","trace_approve","extend","clone","getForm","form_id","form_v","form_h","getCategory","category_id","categories","getInstanceName","vals","default_value","func","iscript","name_forumla","rev","script","applicant_organization","moment","submit_date","utcOffset","format","indexOf","trim","getApproveValues","approve_values","permissions","instance_form","sectionField","formula","workflow_engine","approve_from_client","current_user_info","current_user","auto_submitted","applicant_id","checkApplicant","description","geolocation","i","instance_trace","key_str","last_step","last_step_type","last_trace","next_step","next_step_type","next_steps","space_user_org_info","to_users","trace_approves","updateObj","read_date","Date","next_step_user","checkSpaceUser","engine_step_type_is_start_or_submit_or_condition","engine_step_type_is_sign","engine_step_type_is_counterSign","keywords","caculateKeywords","final_decision","pushManager","send_instance_notification","send_message_current_user","last","triggerWebhook","distributedInstancesRemind","h","instance_traces","newTrace","next_step_name","next_step_users","next_user_ids","updated_values","approve_next_step","finish_date","handler_organization","cost_time","start_date","Mongo","ObjectID","_str","unshift","current_step_name","current_step_auto_submit","getHandlersManager","getHandlers","due_date","getDueDate","timeout_hours","next_step_user_id","idx","handler_id","handler_info","newApprove","next_step_space_user","next_step_user_org_info","user_info","getAgent","is_read","is_error","setRemindInfo","getCurrentStepAutoSubmit","timeout_auto_submit","isAllApproveFinished","oneClickApproval","oneClickRejection","appro","splice","ins_html","instanceHtml","templateName","showTrace","showAttachments","tagger","width","styles","InstanceReadOnlyTemplate","getInstanceHtml","getFlowCompanyId","create_instance","instance_from_client","appr_obj","category","ins_obj","instance_flow_version","new_ins_id","now","start_step","trace_from_client","trace_obj","permissionManager","getFlowPermissions","_makeNewID","applicant_company","is_archived","is_deleted","auto_remind","flow_name","category_name","insert","timeout_line","l","hours","wrapAsync","start","cb","getTimeoutDateWithoutHolidays","then","resolve","reject","submit_instance","applicant_org_info","attachments","checkUsers","flow_has_upgrade","instance_name","nextTrace","submitter_id","upObj","alerts","current_no","nextApprove","direct","get_SpaceChangeSet","formids","is_admin","sync_token","changeSet","formids_ary","getTime","inserts","Spaces","Users","SpaceUsers","Organizations","Roles","Positions","Forms","Flows","Instances","updates","deletes","split","$gt","$lte","deleted_instances","deleted","steedos_id","submitter_steedos_id","applicant_steedos_id","ChangeSet","caculate_date","deadline","priority","remind_date","Match","OneOf","toString","caculateWorkingTime","caculatePlusHalfWorkingDay","base_date","plus_halfday_date","sendRemindSMS","reminded_count","ins_name","users_id","ins_id","send_users","skip_users","settings","remind","substr","mobile","$exists","mobile_verified","notification","payload","hasOwnProperty","SMSQueue","send","Format","Action","ParamString","RecNum","SignName","TemplateCode","msg","open_app_url","appName","Push","checkMainAttach","file_name","main","main_name_split","new_ins_name","cfs","pop","join","extension","multiValue","is_searchable","singleV","s_value","s_field","checkValueFieldsRequire","require_but_empty_fields","is_required","triggerRecordInstanceQueue","record_ids","step_name","ins_state","newObj","owDoc","syncType","sync_type","records","instance_finish_date","sent","sending","createdAt","createdBy","instance_record_queue","current_trace","next_approves","original_flow","original_instacne","original_instacne_id","original_user","ref1","ref2","distribute_from_instances","fromId","r","process_delegation_rules","from","enabled","start_time","end_time","$gte","to","cancelProcessDelegation","toId","ccQuery","$elemMatch","a","idxStr","send_message_to_specifyUser","$addToSet","timeoutAutoSubmit","nextUserIds","toLine","updatedInstance","services","relocate","_users","ah","approve_users","current_setp","current_setp_type","current_space_user","current_user_organization","new_inbox_users","not_in_inbox_users","relocate_appr","relocate_comment","relocate_inbox_users","relocate_next_step","sameTraces","signShowApproveId","ta","ti","sign_show","$unset","draft_save_instance","index","org_id","result","ref3","bqq_app_id","imo_app_cid","imo","appcid","imo_app_uid","appuid","imo_sync_app_key","sync_app_key","imo_push_app_key","push_app_key","get_to_users","send_from","cc_user_ids","approve_user_ids","remove_users","get_body","parameters","approves_description","body","currentStep_type","current_user_name","email_approve_type","email_description","email_final_decision","from_username","href","lastApprove_judge","lastApprove_usersname","last_approve_judge","nextApprove_usersname","nextStep_type","push_approve_type","push_final_decision","to_username","url_approve_type","approve_type","current_username","get_title","getSmsBody","get_badge","badge","sk_all","sk_all_new","user_spaces","user_accepted","user_space","appCategories","c","ref4","sk","sk_new","app","$ne","groupBy","categorys","_set","appKeyValue","appKeyValueNew","categoryBadge","categoryForms","categoryFormsIds","categorysIds","$or","steedos_keyvalues","workflow","send_to_qq","to_user","from_user","instance_state","i18n_obj","app_id","box","bqq_uri","employee_access_token","oauth","open_id","recv_open_ids","response","tips_url","encodeURI","HTTP","post","data","ret","send_email_to_SMTP","subject","content","reply_user","email","email_verified","email_notification","MailQueue","checkMailFromNameLength","html","send_message_by_raix_push","send_message","steedos_ids","send_to_sms","message","ref5","sms_notification","_approves_des","_approves_username","body_style_end","body_style_start","current_step","to_user_change","appr","_appr_description","_appr_userName","br","footnote","inscribed","push_body","action","from_user_id","to_user_ids","from_space_user","username","to_space_user","webhooks","active","w","WebhookQueue","payload_url","content_type","_getFlowByForm","steedosExport","is_copy","object_workflows","object_name","field_map","field_map_back","field_map_script","field_map_back_script","sync_attachment","hr_roles_api_name","hr_roles_name","roles_api_name","roles_name","api_name","approver_roles_name","approver_roles_api_name","approver_hr_roles","approver_hr_roles_name","approver_hr_roles_api_name","_getFieldNumberRule","_getNumberRuleName","c_fields","instance_number_rules","str","isString","f1","number_rule","number_rule_name","year","first_number","rules","number","_formatFieldsID","checkObjectWorkflow","objectql","upgradeFlow","upgradeFlowByForm","upgradeForm","steedosImport","formVersionId","currentUserId","flowCollection","flowCurrent","flowUpdateObj","up","$push","_rev","ff","formCollection","formUpdateObj","insCount","pass","recordsCount","form_script","flowCome","clientStepIds","flowComeStepsStr","stepsStr","st","parseFloat","name_formula","code_formula","is_valid","flowtype","help_text","decription","error_message","objectName","doc","_obj","_objconfig","allowValues","diff","diff1","fileds","objectField","objectFieldBack","getObject","error1","toConfig","enable_workflow","getObjectLookupFieldOptions","objectWorkflow","oldDoc","assign","new_category","new_flow_ids","new_form_ids","upgrade","upgradeFlowId","upgradeFormId","owner","nr","flowObjectWorkflows","orgs_can_add","users_can_add","_accepted_approve_users","_accepted_approver_orgs","approveRolesByIds","approve_roles","approver_users","approver_orgs","oid","role_name","_hr_index","apiName","role_id","role_query","_index","approveRoleById","flow_role_query","roleApiName","_role","_objectWorkflow","remove","fs_store","store_name","store","FS","Store","OSS","aliyun","S3","aws","STEEDOSCLOUD","steedosCloud","FileSystem","path","process","env","STEEDOS_STORAGE_DIR","fileKeyMaker","fileObj","absolutePath","extention","filename","filenameInStore","final_filename","mkdirp","month","name_split","pathname","_getInfo","substring","getFullYear","getMonth","metadata","sync","collectionName","Collection","stores","allow","download","JSZip","exportByFlowIds","flowIds","fileNames","zip","fileName","file","Buffer","setHeader","generateNodeStream","pipe","on","WebApp","connectHandlers","use","next","writeHead","end","JsonRoutes","sendResult","importWorkflow","jsonStr","new_flowIds","new_flows","add","parseFiles","e1","fail","files","multiple","success","jsonData","reason","details","statusCode"],"mappings":"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","file":"/packages/steedos_app-workflow.js","sourcesContent":["import {\n\tcheckNpmVersions\n} from 'meteor/tmeasday:check-npm-versions';\ncheckNpmVersions({\n\teval: \">=0.1.2\",\n}, 'steedos:app-workflow');","@WorkflowCore = {}\n\nif Meteor.isClient\n\tWorkflowCore.openFlowDesign = (locale, space, flow, companyId)->\n\t\turl = \"/applications/designer/current/#{locale.toLocaleLowerCase()}/?spaceId=#{space}\"\n\t\tif flow\n\t\t\turl = url + \"&flowId=#{flow}\"\n\t\tif companyId && !Creator.isSpaceAdmin(space, Meteor.userId())\n\t\t\turl = url + \"&companyId=#{companyId}\"\n\t\t\n\t\turl = encodeURIComponent(Steedos.absoluteUrl(url))\n\t\ttitle = \"#{t(\"Workflow Designer\")}\"\n\t\tif flow\n\t\t\tflowName = db.flows.findOne(flow)?.name\n\t\t\tif flowName\n\t\t\t\ttitle = \"#{flowName} | #{title}\"\n\t\ttitle = encodeURIComponent(title)\n\t\tiframe_url = \"/api/workflow/designer?url=#{url}&title=#{title}\"\n\t\tSteedos.openWindow Steedos.absoluteUrl(iframe_url)\n\tWorkflowCore.openFormDesign = (locale, space, form, companyId)->\n\t\tModal.show('formDesign', {formId: form}, {keyboard:false, backdrop: \"static\"})\n\n\tMeteor.startup ->\n\t\t$(document).keydown (e) ->\n\t\t\tif e.keyCode == \"13\" or e.key == \"Enter\"\n\t\t\t\tif $(\".flow-modal\").length != 1\n\t\t\t\t\treturn;\n\t\t\t\tif e.target.tagName != \"TEXTAREA\" or $(e.target).closest(\"div\").hasClass(\"bootstrap-tagsinput\")\n\t\t\t\t\tif $(\".flow-modal\").length == 1\n\t\t\t\t\t\t$(\".flow-modal .btn-confirm\").click()\n\nif Meteor.isServer\n\tWorkflowCore.checkCreatePermissions = (spaceId, uid, company_id)->\n#\t\tpermissions = Creator.getObjectPermissions(spaceId, uid, 'flows')\n#\n#\t\tif !permissions.allowCreate\n#\t\t\treturn false\n#\n#\t\t# 如果不是工作区管理员, 则必须要指定company_id\n#\t\tif !Steedos.isSpaceAdmin(spaceId, uid)\n#\t\t\tuserCompanyId = Creator.getUserCompanyId(uid, spaceId)\n#\t\t\tif !company_id || !userCompanyId || company_id != userCompanyId\n#\t\t\t\treturn false\n\n\t\tif company_id\n\t\t\tif Creator.getCollection(\"company\").find({ _id: company_id, space: spaceId }).count() == 0\n\t\t\t\treturn false\n\n\t\treturn true","this.WorkflowCore = {};\n\nif (Meteor.isClient) {\n  WorkflowCore.openFlowDesign = function(locale, space, flow, companyId) {\n    var flowName, iframe_url, ref, title, url;\n    url = \"/applications/designer/current/\" + (locale.toLocaleLowerCase()) + \"/?spaceId=\" + space;\n    if (flow) {\n      url = url + (\"&flowId=\" + flow);\n    }\n    if (companyId && !Creator.isSpaceAdmin(space, Meteor.userId())) {\n      url = url + (\"&companyId=\" + companyId);\n    }\n    url = encodeURIComponent(Steedos.absoluteUrl(url));\n    title = \"\" + (t(\"Workflow Designer\"));\n    if (flow) {\n      flowName = (ref = db.flows.findOne(flow)) != null ? ref.name : void 0;\n      if (flowName) {\n        title = flowName + \" | \" + title;\n      }\n    }\n    title = encodeURIComponent(title);\n    iframe_url = \"/api/workflow/designer?url=\" + url + \"&title=\" + title;\n    return Steedos.openWindow(Steedos.absoluteUrl(iframe_url));\n  };\n  WorkflowCore.openFormDesign = function(locale, space, form, companyId) {\n    return Modal.show('formDesign', {\n      formId: form\n    }, {\n      keyboard: false,\n      backdrop: \"static\"\n    });\n  };\n  Meteor.startup(function() {\n    return $(document).keydown(function(e) {\n      if (e.keyCode === \"13\" || e.key === \"Enter\") {\n        if ($(\".flow-modal\").length !== 1) {\n          return;\n        }\n        if (e.target.tagName !== \"TEXTAREA\" || $(e.target).closest(\"div\").hasClass(\"bootstrap-tagsinput\")) {\n          if ($(\".flow-modal\").length === 1) {\n            return $(\".flow-modal .btn-confirm\").click();\n          }\n        }\n      }\n    });\n  });\n}\n\nif (Meteor.isServer) {\n  WorkflowCore.checkCreatePermissions = function(spaceId, uid, company_id) {\n    if (company_id) {\n      if (Creator.getCollection(\"company\").find({\n        _id: company_id,\n        space: spaceId\n      }).count() === 0) {\n        return false;\n      }\n    }\n    return true;\n  };\n}\n","Meteor.methods\n\tflow_copy: (spaceId, flowId, options)->\n\t\tif (!this.userId)\n\t\t\treturn;\n\n\t\tif !WorkflowCore.checkCreatePermissions(spaceId, this.userId, options?.company_id)\n\t\t\tthrow  Meteor.Error(\"No permission\");\n\n\t\tdb.flows.copy(this.userId, spaceId, flowId, options, false)","Meteor.methods({\n  flow_copy: function(spaceId, flowId, options) {\n    if (!this.userId) {\n      return;\n    }\n    if (!WorkflowCore.checkCreatePermissions(spaceId, this.userId, options != null ? options.company_id : void 0)) {\n      throw Meteor.Error(\"No permission\");\n    }\n    return db.flows.copy(this.userId, spaceId, flowId, options, false);\n  }\n});\n","Meteor.methods\n\tget_distribute_flows: (options) ->\n\t\tunless options.params\n\t\t\treturn []\n\n\t\tthis.unblock\n\t\tuid = this.userId\n\t\tsearchText = options.searchText\n\t\tvalues = options.values\n\t\tspaceId = JSON.parse(options.params).spaceId\n\n\t\t# Meteor.wrapAsync((callback) ->\n\t\t# \tMeteor.setTimeout (->\n\t\t# \t\tcallback()\n\t\t# \t\treturn\n\t\t# \t), 1000\n\t\t# \treturn\n\t\t# )()\n\n\t\topts = new Array\n\n\t\tflows = new Array\n\n\t\tif searchText\n\t\t\tpinyin = /^[a-zA-Z\\']*$/.test(searchText)\n\t\t\tif (pinyin && searchText.length > 8) || (!pinyin && searchText.length > 1)\n\t\t\t\tquery = { space: spaceId, state: 'enabled', name: { $regex: searchText } }\n\t\t\t\tflows = db.flows.find(query, { limit: 10, fields: { name: 1, space: 1 } }).fetch()\n\t\telse if values.length\n\t\t\tflows = db.flows.find({ _id: { $in: values } }, { fields: { name: 1, space: 1 } }).fetch()\n\n\t\tflows.forEach (f) ->\n\t\t\tspace = db.spaces.findOne({ _id: f.space }, { fields: { name: 1 } })\n\t\t\topts.push({ label: \"[#{space.name}]#{f.name}\", value: f._id })\n\n\t\treturn opts\n\n\tupdate_distribute_settings: (flow_id, distribute_optional_users_id, step_flows, distribute_to_self, distribute_end_notification, upload_after_being_distributed) ->\n\t\tcheck flow_id, String\n\t\tcheck distribute_optional_users_id, Array\n\t\tcheck step_flows, Array\n\t\tcheck distribute_to_self, Boolean\n\t\tcheck distribute_end_notification, Boolean\n\t\tcheck upload_after_being_distributed, Boolean\n\n\t\tflow = db.flows.findOne(flow_id)\n\t\tif not flow\n\t\t\tthrow new Meteor.Error 'error', 'flow not found!'\n\n\t\tsetObj = new Object\n\n\t\t_.each flow.current.steps, (s) ->\n\t\t\tif s.allowDistribute is true\n\t\t\t\t_.each step_flows, (sf) ->\n\t\t\t\t\tif sf._id is s._id\n\t\t\t\t\t\ts.distribute_optional_flows = sf.distribute_optional_flows\n\n\t\tdistribute_optional_users = new Array\n\t\tdb.users.find({ _id: { $in: distribute_optional_users_id } }, { fields: { name: 1 } }).forEach (u) ->\n\t\t\tdistribute_optional_users.push({ id: u._id, name: u.name })\n\t\tsetObj.distribute_optional_users = distribute_optional_users\n\n\t\tif not _.isEmpty(step_flows)\n\t\t\tsetObj['current.steps'] = flow.current.steps\n\n\t\tsetObj['distribute_to_self'] = distribute_to_self\n\n\t\tsetObj['distribute_end_notification'] = distribute_end_notification\n\t\t\n\t\tsetObj['upload_after_being_distributed'] = upload_after_being_distributed\n\n\t\tdb.flows.update({ _id: flow_id }, { $set: setObj })\n\n\t\treturn true\n","Meteor.methods({\n  get_distribute_flows: function(options) {\n    var flows, opts, pinyin, query, searchText, spaceId, uid, values;\n    if (!options.params) {\n      return [];\n    }\n    this.unblock;\n    uid = this.userId;\n    searchText = options.searchText;\n    values = options.values;\n    spaceId = JSON.parse(options.params).spaceId;\n    opts = new Array;\n    flows = new Array;\n    if (searchText) {\n      pinyin = /^[a-zA-Z\\']*$/.test(searchText);\n      if ((pinyin && searchText.length > 8) || (!pinyin && searchText.length > 1)) {\n        query = {\n          space: spaceId,\n          state: 'enabled',\n          name: {\n            $regex: searchText\n          }\n        };\n        flows = db.flows.find(query, {\n          limit: 10,\n          fields: {\n            name: 1,\n            space: 1\n          }\n        }).fetch();\n      }\n    } else if (values.length) {\n      flows = db.flows.find({\n        _id: {\n          $in: values\n        }\n      }, {\n        fields: {\n          name: 1,\n          space: 1\n        }\n      }).fetch();\n    }\n    flows.forEach(function(f) {\n      var space;\n      space = db.spaces.findOne({\n        _id: f.space\n      }, {\n        fields: {\n          name: 1\n        }\n      });\n      return opts.push({\n        label: \"[\" + space.name + \"]\" + f.name,\n        value: f._id\n      });\n    });\n    return opts;\n  },\n  update_distribute_settings: function(flow_id, distribute_optional_users_id, step_flows, distribute_to_self, distribute_end_notification, upload_after_being_distributed) {\n    var distribute_optional_users, flow, setObj;\n    check(flow_id, String);\n    check(distribute_optional_users_id, Array);\n    check(step_flows, Array);\n    check(distribute_to_self, Boolean);\n    check(distribute_end_notification, Boolean);\n    check(upload_after_being_distributed, Boolean);\n    flow = db.flows.findOne(flow_id);\n    if (!flow) {\n      throw new Meteor.Error('error', 'flow not found!');\n    }\n    setObj = new Object;\n    _.each(flow.current.steps, function(s) {\n      if (s.allowDistribute === true) {\n        return _.each(step_flows, function(sf) {\n          if (sf._id === s._id) {\n            return s.distribute_optional_flows = sf.distribute_optional_flows;\n          }\n        });\n      }\n    });\n    distribute_optional_users = new Array;\n    db.users.find({\n      _id: {\n        $in: distribute_optional_users_id\n      }\n    }, {\n      fields: {\n        name: 1\n      }\n    }).forEach(function(u) {\n      return distribute_optional_users.push({\n        id: u._id,\n        name: u.name\n      });\n    });\n    setObj.distribute_optional_users = distribute_optional_users;\n    if (!_.isEmpty(step_flows)) {\n      setObj['current.steps'] = flow.current.steps;\n    }\n    setObj['distribute_to_self'] = distribute_to_self;\n    setObj['distribute_end_notification'] = distribute_end_notification;\n    setObj['upload_after_being_distributed'] = upload_after_being_distributed;\n    db.flows.update({\n      _id: flow_id\n    }, {\n      $set: setObj\n    });\n    return true;\n  }\n});\n","WorkflowManager = {}\n\nWorkflowManager.getPositionsFilterByUsers = function (spaceId, orgId, roleId) {\n\tif (!spaceId || !orgId || !roleId)\n\t\treturn []\n\n\treturn db.flow_positions.find({\n\t\tspace: spaceId,\n\t\trole: roleId,\n\t\torg: orgId\n\t}, {\n\t\tfields: {\n\t\t\tusers: 1\n\t\t}\n\t}).fetch();\n}\n\nWorkflowManager.uniqUsers = function (users) {\n\tif (_.isEmpty(users))\n\t\treturn []\n\n\tvar users_str = [],\n\t\tusers_obj = [];\n\t_.each(users, function (u) {\n\t\tusers_str.push(JSON.stringify(u))\n\t})\n\n\tusers_str = _.uniq(users_str);\n\n\t_.each(users_str, function (us) {\n\t\tusers_obj.push(JSON.parse(us))\n\t})\n\n\treturn users_obj\n}\n\n/*\n 返回指定部门下的角色成员,如果指定部门没有找到对应的角色，则会继续找部门的上级部门直到找到为止。\n return [{spaceUser}]\n */\nWorkflowManager.getRoleUsersbyOrgAndRole = function (spaceId, orgId, roleId) {\n\tvar roleUsers = new Array();\n\n\tvar orgPositions = WorkflowManager.getPositionsFilterByUsers(spaceId, orgId, roleId);\n\n\torgPositions.forEach(function (orgPosition) {\n\t\tvar roleUserIds = orgPosition.users;\n\t\troleUsers = roleUsers.concat(WorkflowManager.getUsers(spaceId, roleUserIds, true));\n\t});\n\n\tif (orgPositions.length == 0) {\n\t\tvar organization = WorkflowManager.getOrganization(orgId);\n\t\tif (organization && organization.parent != '')\n\t\t\troleUsers = roleUsers.concat(WorkflowManager.getRoleUsersbyOrgAndRole(spaceId, organization.parent, roleId));\n\t}\n\n\treturn roleUsers;\n};\n\nWorkflowManager.getRoleUsersByOrgAndRoles = function (spaceId, orgId, roleIds) {\n\n\tvar roleUsers = new Array();\n\n\troleIds.forEach(function (roleId) {\n\t\troleUsers = roleUsers.concat(WorkflowManager.getRoleUsersbyOrgAndRole(spaceId, orgId, roleId));\n\t});\n\n\treturn roleUsers;\n\n};\n\nWorkflowManager.getRoleUsersByOrgsAndRoles = function (spaceId, orgIds, roleIds) {\n\tvar roleUsers = new Array();\n\n\tif (!orgIds || !roleIds)\n\t\treturn roleUsers;\n\n\torgIds.forEach(function (orgId) {\n\t\troleUsers = roleUsers.concat(WorkflowManager.getRoleUsersByOrgAndRoles(spaceId, orgId, roleIds));\n\t});\n\n\treturn roleUsers;\n};\n\n/*\n 返回用户所在部门下的角色成员.\n return [{spaceUser}]\n */\nWorkflowManager.getRoleUsersByUsersAndRoles = function (spaceId, userIds, roleIds) {\n\n\tvar roleUsers = new Array();\n\n\tif (!userIds || !roleIds)\n\t\treturn roleUsers;\n\n\tvar users = WorkflowManager.getUsers(spaceId, userIds, true);\n\n\tusers.forEach(function (user) {\n\t\troleUsers = roleUsers.concat(WorkflowManager.getRoleUsersByOrgsAndRoles(spaceId, user.organizations, roleIds));\n\t});\n\n\treturn roleUsers;\n};\n\nWorkflowManager.getSpaceRoles = function (spaceId) {\n\tif (!spaceId) {\n\t\treturn;\n\t}\n\n\treturn db.flow_roles.find({\n\t\tspace: spaceId\n\t}).fetch();\n};\n\nWorkflowManager.getRole = function (spaceId, roleId) {\n\n\tif (!roleId || !spaceId) {\n\t\treturn;\n\t}\n\n\treturn db.flow_roles.findOne({\n\t\t_id: roleId,\n\t\tspace: spaceId\n\t});\n};\n\nWorkflowManager.getSpacePositions = function (spaceId) {\n\treturn db.flow_positions.find({\n\t\tspace: spaceId\n\t}).fetch();\n};\n\n//获取用户岗位\nWorkflowManager.getUserRoles = function (spaceId, orgId, userId) {\n\n\tvar userRoles = new Array();\n\n\t// var spacePositions = WorkflowManager.getSpacePositions(spaceId);\n\n\t//orgRoles = spacePositions.filterProperty(\"org\", orgId); ？？？\n\t// var userPositions = spacePositions.filterProperty(\"users\", userId);\n\n\tvar userPositions = db.flow_positions.find({\n\t\tspace: spaceId,\n\t\tusers: userId\n\t}, {\n\t\tfields: {\n\t\t\trole: 1\n\t\t}\n\t});\n\n\tuserPositions.forEach(function (userPosition) {\n\t\tuserRoles.push(WorkflowManager.getRole(spaceId, userPosition.role));\n\t});\n\n\treturn userRoles;\n};\n\nWorkflowManager.getOrganizationsUsers = function (spaceId, orgs) {\n\n\tvar orgUsers = new Array();\n\n\torgs.forEach(function (org) {\n\t\torgUsers = orgUsers.concat(WorkflowManager.getUsers(spaceId, org.users, true));\n\t});\n\n\treturn orgUsers;\n}\n\n//获取space下的所有部门\nWorkflowManager.getSpaceOrganizations = function (spaceId) {\n\treturn db.organizations.find({\n\t\tspace: spaceId\n\t}).fetch();\n};\n\nWorkflowManager.getOrganizationChildrens = function (spaceId, orgId) {\n\treturn db.organizations.find({\n\t\tspace: spaceId,\n\t\tparents: orgId\n\t}).fetch();\n};\n\nWorkflowManager.getOrganizationsChildrens = function (spaceId, orgIds) {\n\tvar chidrenOrgs = new Array();\n\torgIds.forEach(function (orgId) {\n\t\tchidrenOrgs = chidrenOrgs.concat(WorkflowManager.getOrganizationChildrens(spaceId, orgId));\n\t});\n\n\treturn chidrenOrgs;\n};\n\nWorkflowManager.getOrganization = function (orgId) {\n\tif (!orgId) {\n\t\treturn;\n\t}\n\n\treturn db.organizations.findOne(orgId, {fields: {created: 0, created_by: 0, modified: 0, modified_by: 0}});\n};\n\nWorkflowManager.getOrganizations = function (orgIds) {\n\tif (!orgIds) {\n\t\treturn [];\n\t}\n\n\tif (\"string\" == typeof (orgIds)) {\n\t\treturn [WorkflowManager.getOrganization(orgIds)]\n\t}\n\n\treturn db.organizations.find({\n\t\t_id: {\n\t\t\t$in: orgIds\n\t\t}\n\t}, {fields: {created: 0, created_by: 0, modified: 0, modified_by: 0}}).fetch();\n};\n\nWorkflowManager.getCompany = function (companyId) {\n\tif (!companyId) {\n\t\treturn {};\n\t}\n\treturn Creator.getCollection(\"company\").findOne(companyId, {fields: {created: 0, created_by: 0, modified: 0, modified_by: 0}}) || {};\n}\n\nWorkflowManager.getCompanys = function (companyIds) {\n\tif (!companyIds) {\n\t\treturn [];\n\t}\n\n\tif (\"string\" == typeof (companyIds)) {\n\t\treturn [WorkflowManager.getCompany(companyIds)]\n\t}\n\treturn Creator.getCollection(\"company\").find({\n\t\t_id: {\n\t\t\t$in: companyIds\n\t\t}\n\t}, {fields: {created: 0, created_by: 0, modified: 0, modified_by: 0}}).fetch();\n};\n\n\nWorkflowManager.getUser = function (spaceId, userId, notNeedDetails) {\n\tif (!userId || !spaceId) {\n\t\treturn;\n\t}\n\n\tif (typeof userId != \"string\") {\n\t\treturn WorkflowManager.getUsers(spaceId, userId);\n\t}\n\n\tvar spaceUser = db.space_users.findOne({\n\t\tspace: spaceId,\n\t\tuser: userId\n\t}, {fields: {created: 0, created_by: 0, modified: 0, modified_by: 0}});\n\n\tif (!spaceUser) {\n\t\treturn\n\t}\n\n\tif (notNeedDetails == true) {\n\t\tspaceUser.id = spaceUser.user;\n\t} else {\n\t\tspaceUser.id = spaceUser.user;\n\t\tspaceUser.organization = WorkflowManager.getOrganization(spaceUser.organization);\n\t\tif (!spaceUser.organization) {\n\t\t\treturn;\n\t\t}\n\n\t\tspaceUser.company = WorkflowManager.getCompany(spaceUser.company_id);\n\t\tspaceUser.companys = WorkflowManager.getCompanys(spaceUser.company_ids);\n\n\t\tspaceUser.roles = WorkflowManager.getUserRoles(spaceId, spaceUser.organization.id, spaceUser.id);\n\t}\n\n\treturn spaceUser;\n};\n\nWorkflowManager.getUsers = function (spaceId, userIds, notNeedDetails) {\n\n\tif (\"string\" == typeof (userIds)) {\n\t\treturn [WorkflowManager.getUser(spaceId, userIds, notNeedDetails)]\n\t}\n\n\tvar users = new Array();\n\tif (userIds && spaceId) {\n\t\tvar spaceUsers = db.space_users.find({\n\t\t\tspace: spaceId,\n\t\t\tuser: {\n\t\t\t\t$in: userIds\n\t\t\t}\n\t\t}, {fields: {created: 0, created_by: 0, modified: 0, modified_by: 0}});\n\n\t\tif (notNeedDetails == true) {\n\t\t\tspaceUsers.forEach(function (spaceUser) {\n\t\t\t\tspaceUser.id = spaceUser.user;\n\t\t\t\tusers.push(spaceUser);\n\t\t\t})\n\t\t} else {\n\t\t\tspaceUsers.forEach(function (spaceUser) {\n\t\t\t\tspaceUser.id = spaceUser.user;\n\n\t\t\t\tspaceUser.organization = WorkflowManager.getOrganization(spaceUser.organization);\n\n\t\t\t\tspaceUser.organizations = WorkflowManager.getOrganizations(spaceUser.organizations);\n\n\t\t\t\tspaceUser.company = WorkflowManager.getCompany(spaceUser.company_id);\n\t\t\t\tspaceUser.companys = WorkflowManager.getCompanys(spaceUser.company_ids);\n\n\t\t\t\tif (spaceUser.organization) {\n\t\t\t\t\tspaceUser.roles = WorkflowManager.getUserRoles(spaceId, spaceUser.organization.id, spaceUser.id);\n\t\t\t\t\tusers.push(spaceUser);\n\t\t\t\t}\n\t\t\t})\n\t\t}\n\n\t}\n\n\treturn users;\n};\n\nWorkflowManager.getHrRolesUsers = function(spaceId, hrRoleIds){\n\tvar hrRolesUsers = [];\n\n\tif(!_.isArray(hrRoleIds)){\n\t\treturn [];\n\t}\n\tvar hrRoles = db.roles.find({space: spaceId, _id: {$in: hrRoleIds}}).fetch();\n\t_.each(hrRoles, function(hrRole){\n\t\thrRolesUsers = hrRolesUsers.concat(hrRole.users || [])\n\t});\n\n\tvar spaceUsers = db.space_users.find({\n\t\tspace: spaceId,\n\t\tuser: {$in: hrRolesUsers}\n\t}, {fields: {created: 0, created_by: 0, modified: 0, modified_by: 0}}).fetch();\n\n\t_.each(spaceUsers, function(spaceUser){\n\t\tspaceUser.id = spaceUser.user\n\t});\n\treturn spaceUsers\n}\n\nWorkflowManager.getFormulaUsers = function (spaceId, userIds) {\n\n\tvar users = WorkflowManager.getUsers(spaceId, userIds);\n\tusers.forEach(function (user) {\n\n\t\tuser.organization.id = user.organization._id;\n\n\t\tuser.organizations = {\n\t\t\t'id': user.organizations.getProperty(\"_id\"),\n\t\t\t'name': user.organizations.getProperty(\"name\"),\n\t\t\t'fullname': user.organizations.getProperty(\"fullname\")\n\t\t}\n\n\t\tuser.company.id = user.company._id;\n\n\t\tuser.companys = {\n\t\t\t'id': user.companys.getProperty(\"_id\"),\n\t\t\t'name': user.companys.getProperty(\"name\"),\n\t\t\t'code': user.companys.getProperty(\"code\"),\n\t\t}\n\n\t\tif (!user.hr) {\n\t\t\tuser.hr = {}\n\t\t}\n\n\t\tuser.roles = user.roles ? user.roles.getProperty('name') : [];\n\t})\n\n\treturn users;\n}\n\nWorkflowManager.getFormulaUserObjects = function (spaceId, userIds) {\n\tif (!userIds)\n\t\treturn {\n\t\t\torganization: {},\n\t\t\thr: {}\n\t\t};\n\treturn WorkflowManager.getFormulaUserObject(spaceId, userIds);\n}\n\nWorkflowManager.getFormulaUserObject = function (spaceId, userId) {\n\n\tif (!userId)\n\t\treturn {\n\t\t\torganization: {},\n\t\t\thr: {}\n\t\t};\n\n\tif (userId instanceof Array) {\n\t\treturn WorkflowManager.getFormulaUsers(spaceId, userId);\n\t} else {\n\t\treturn WorkflowManager.getFormulaUsers(spaceId, [userId])[0];\n\t}\n};\n\n\nWorkflowManager.getFormulaOrgObjects = function (orgIds) {\n\tif (!orgIds)\n\t\treturn;\n\treturn WorkflowManager.getFormulaOrgObject(orgIds);\n}\n\nWorkflowManager.getFormulaOrgObject = function (orgId) {\n\n\tif (orgId instanceof Array) {\n\t\tvar orgs = WorkflowManager.getOrganizations(orgId);\n\t\torgs.forEach(function (org) {\n\t\t\torg.id = org._id;\n\t\t});\n\n\t\treturn orgs;\n\t} else {\n\t\tvar org = WorkflowManager.getOrganization(orgId);\n\t\tif (!org)\n\t\t\treturn null;\n\n\t\torg.id = orgId;\n\n\t\treturn org;\n\t}\n\n}\n\nWorkflowManager.getInstanceFormVersion = function () {\n\n\tvar instance = Template.instance().view.template.steedosData.instance\n\n\tvar form, form_fields, form_version;\n\tform = db.forms.findOne(instance.form);\n\tform_version = {};\n\tform_fields = [];\n\tif (form.current._id === instance.form_version) {\n\t\tform_version = form.current;\n\t} else {\n\t\tform_version = _.where(form.historys, {\n\t\t\t_id: instance.form_version\n\t\t})[0];\n\t}\n\tform_version.fields.forEach(function (field) {\n\t\tif (field.type === 'section') {\n\t\t\tform_fields.push(field);\n\t\t\tif (field.fields) {\n\t\t\t\treturn field.fields.forEach(function (f) {\n\t\t\t\t\treturn form_fields.push(f);\n\t\t\t\t});\n\t\t\t}\n\t\t} else if (field.type === 'table') {\n\t\t\tfield['sfields'] = field['fields'];\n\t\t\tdelete field['fields'];\n\t\t\treturn form_fields.push(field);\n\t\t} else {\n\t\t\treturn form_fields.push(field);\n\t\t}\n\t});\n\tform_version.fields = form_fields;\n\treturn form_version;\n};\n\nWorkflowManager.getFormVersion = function (id, versionId) {\n\tvar form = db.forms.findOne({\n\t\t_id: id\n\t});\n\n\tvar form_version = form.current\n\n\tif (form_version._id != versionId) {\n\t\tform_version = form.historys.findPropertyByPK(\"_id\", versionId)\n\t}\n\n\tvar form_fields = [];\n\n\tform_version.fields.forEach(function (field) {\n\t\tif (field.type == 'section') {\n\t\t\tform_fields.push(field);\n\t\t\tif (field.fields) {\n\t\t\t\tfield.fields.forEach(function (f) {\n\t\t\t\t\tform_fields.push(f);\n\t\t\t\t});\n\t\t\t}\n\t\t} else {\n\t\t\tform_fields.push(field);\n\t\t}\n\t});\n\n\tform_version.fields = form_fields;\n\n\treturn form_version;\n}\n\nWorkflowManager.getInstanceFlowVersion = function (instance) {\n\tif (!instance) {\n\t\tinstance = Template.instance().view.template.steedosData.instance;\n\t}\n\n\tvar flow, flow_version;\n\tflow = db.flows.findOne(instance.flow);\n\tflow_version = {};\n\tif (flow.current._id === instance.flow_version) {\n\t\tflow_version = flow.current;\n\t} else {\n\t\tflow_version = _.where(flow.historys, {\n\t\t\t_id: instance.flow_version\n\t\t})[0];\n\t}\n\treturn flow_version;\n};\n\nWorkflowManager.getInstanceStep = function (stepId) {\n\tflow = WorkflowManager.getInstanceFlowVersion();\n\n\tif (!flow)\n\t\treturn null;\n\n\tvar g_step;\n\n\tflow.steps.forEach(\n\t\tfunction (step) {\n\t\t\tif (step._id == stepId) {\n\t\t\t\tg_step = step;\n\t\t\t\tg_step.id = step._id;\n\t\t\t\treturn;\n\t\t\t}\n\t\t}\n\t);\n\n\treturn g_step;\n};\n\n\nWorkflowManager.canAdmin = function (fl, curSpaceUser, organizations) {\n\tvar perms = fl.perms;\n\tvar hasAdminRight = false;\n\tif (perms) {\n\t\tif (perms.users_can_admin && perms.users_can_admin.includes(curSpaceUser.user)) {\n\t\t\thasAdminRight = true;\n\t\t} else if (perms.orgs_can_admin && perms.orgs_can_admin.length > 0) {\n\t\t\tif (curSpaceUser && curSpaceUser.organizations && _.intersection(curSpaceUser.organizations, perms.orgs_can_admin).length > 0) {\n\t\t\t\thasAdminRight = true;\n\t\t\t} else {\n\t\t\t\tif (organizations) {\n\n\t\t\t\t\thasAdminRight = _.some(organizations, function (org) {\n\t\t\t\t\t\treturn org.parents && _.intersection(org.parents, perms.orgs_can_admin).length > 0;\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\treturn hasAdminRight;\n};\n\nWorkflowManager.canMonitor = function (fl, curSpaceUser, organizations) {\n\tvar perms = fl.perms;\n\tvar hasMonitorRight = false;\n\tif (perms) {\n\t\tif (perms.users_can_monitor && perms.users_can_monitor.includes(curSpaceUser.user)) {\n\t\t\thasMonitorRight = true;\n\t\t} else if (perms.orgs_can_monitor && perms.orgs_can_monitor.length > 0) {\n\t\t\tif (curSpaceUser && curSpaceUser.organizations && _.intersection(curSpaceUser.organizations, perms.orgs_can_monitor).length > 0) {\n\t\t\t\thasMonitorRight = true;\n\t\t\t} else {\n\t\t\t\tif (organizations) {\n\n\t\t\t\t\thasMonitorRight = _.some(organizations, function (org) {\n\t\t\t\t\t\treturn org.parents && _.intersection(org.parents, perms.orgs_can_monitor).length > 0;\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\treturn hasMonitorRight;\n};\n\n//校验user是否对instance有查看权限：\n// 1 工作区管理员则返回true\n// 2 用户在submitter、applicant、outbox_users、inbox_users、cc_users、created_by、modified_by 中：return true;\n// 3 用户是流程管理员，监控员：return true;\n// 4 否则：return false;\nWorkflowManager.hasInstancePermissions = function (user, instance) {\n\n\tif (user && instance) {\n\t\tvar space = db.spaces.findOne({\n\t\t\t_id: instance.space\n\t\t}, {\n\t\t\tfields: {\n\t\t\t\tadmins: 1\n\t\t\t}\n\t\t});\n\t\tif (space && space.admins && space.admins.includes(user._id)) {\n\t\t\treturn true;\n\t\t}\n\t}\n\n\tvar approvedUsers = _.union(instance.outbox_users, instance.inbox_users, instance.cc_users, [instance.submitter], [instance.applicant], [instance.created_by], [instance.modified_by]);\n\n\tif (approvedUsers.includes(user._id)) {\n\t\treturn true;\n\t}\n\n\t//被那些instance关联\n\tvar originalInstances = db.instances.find({\n\t\trelated_instances: {\n\t\t\t$all: [instance._id]\n\t\t}\n\t}, {\n\t\tfields: {\n\t\t\toutbox_users: 1,\n\t\t\tinbox_users: 1,\n\t\t\tcc_users: 1,\n\t\t\tsubmitter: 1,\n\t\t\tapplicant: 1\n\t\t}\n\t})\n\tconsole.log(\"originalInstances size is \" + originalInstances.count());\n\tif (originalInstances.count() > 0) {\n\t\tvar hasPermission = false;\n\t\t_.some(originalInstances.fetch(), function (ins) {\n\t\t\tconsole.log(ins)\n\t\t\thavePermissionUsers = _.union(ins.outbox_users, ins.inbox_users, ins.cc_users, [ins.submitter], [ins.applicant]);\n\t\t\tconsole.log(havePermissionUsers)\n\t\t\tif (havePermissionUsers.includes(user._id)) {\n\t\t\t\thasPermission = true;\n\t\t\t\treturn true;\n\t\t\t}\n\t\t})\n\t\tif (hasPermission) {\n\t\t\treturn true;\n\t\t}\n\t}\n\n\tspaceUser = db.space_users.findOne({\n\t\tspace: instance.space,\n\t\tuser: user._id\n\t})\n\n\tif (spaceUser) {\n\t\torganizations = db.organizations.find({\n\t\t\t_id: {\n\t\t\t\t$in: spaceUser.organizations\n\t\t\t}\n\t\t}).fetch();\n\n\t\tflow = db.flows.findOne({\n\t\t\t_id: instance.flow\n\t\t});\n\n\t\tif (flow) {\n\t\t\treturn WorkflowManager.canMonitor(flow, spaceUser, organizations) || WorkflowManager.canAdmin(flow, spaceUser, organizations)\n\t\t}\n\t\treturn false;\n\t}\n\treturn false;\n\n}\n\nWorkflowManager.getNameForUser = function (userId) {\n\tcheck(userId, String);\n\treturn db.users.findOne({\n\t\t_id: userId\n\t}, {\n\t\tfields: {\n\t\t\tname: 1\n\t\t}\n\t});\n}\n\n// 工作区管理员和流程管理员拥有流程的管理权限\nWorkflowManager.hasFlowAdminPermission = function (flow_id, space_id, user_id) {\n\tvar space = db.spaces.findOne({\n\t\t_id: space_id\n\t}, {\n\t\tfields: {\n\t\t\tadmins: 1\n\t\t}\n\t});\n\n\tif (!space)\n\t\treturn false;\n\n\tif (space.admins && space.admins.includes(user_id))\n\t\treturn true;\n\n\tvar hasPermission = false;\n\n\tvar space_user = db.space_users.findOne({\n\t\tspace: space_id,\n\t\tuser: user_id\n\t}, {\n\t\tfields: {\n\t\t\torganizations: 1,\n\t\t\tuser: 1\n\t\t}\n\t})\n\tif (space_user) {\n\t\tvar organizations = db.organizations.find({\n\t\t\t_id: {\n\t\t\t\t$in: space_user.organizations\n\t\t\t}\n\t\t}, {\n\t\t\tfields: {\n\t\t\t\tparents: 1\n\t\t\t}\n\t\t}).fetch()\n\n\t\tvar fl = db.flows.findOne({\n\t\t\t_id: flow_id\n\t\t}, {\n\t\t\tfields: {\n\t\t\t\tperms: 1\n\t\t\t}\n\t\t})\n\n\t\tif (fl && organizations) {\n\t\t\thasPermission = WorkflowManager.canAdmin(fl, space_user, organizations);\n\t\t}\n\t}\n\n\treturn hasPermission;\n\n}\n\nWorkflowManager.getMyAdminOrMonitorFlows = function(spaceId, userId) {\n\tvar flows, flow_ids = [],\n\t\tcurSpaceUser, organization;\n\tcurSpaceUser = db.space_users.findOne({\n\t\tspace: spaceId,\n\t\t'user': userId\n\t});\n\tif (curSpaceUser) {\n\t\torganizations = db.organizations.find({\n\t\t\t_id: {\n\t\t\t\t$in: curSpaceUser.organizations\n\t\t\t}\n\t\t}).fetch();\n\t\tflows = db.flows.find();\n\t\tflows.forEach(function(fl) {\n\t\t\tif (WorkflowManager.canMonitor(fl, curSpaceUser, organizations) || WorkflowManager.canAdmin(fl, curSpaceUser, organizations)) {\n\t\t\t\tflow_ids.push(fl._id);\n\t\t\t}\n\t\t})\n\t}\n\treturn flow_ids;\n};","Cookies = require(\"cookies\")\n_eval = require('eval')\nsteedosCore = require('@steedos/core')\n\nuuflowManager = {}\n\nuuflowManager.check_authorization = (req, res) ->\n\tquery = req.query\n\tuserId = query[\"X-User-Id\"]\n\tauthToken = query[\"X-Auth-Token\"]\n\n\t# then check cookie\n\tif !userId or !authToken\n\t\tcookies = new Cookies( req, res )\n\t\tuserId = cookies.get(\"X-User-Id\")\n\t\tauthToken = cookies.get(\"X-Auth-Token\")\n\n\tif not userId or not authToken\n\t\tthrow new Meteor.Error 401, 'Unauthorized'\n\n\thashedToken = Accounts._hashLoginToken(authToken)\n\tuser = Meteor.users.findOne\n\t\t_id: userId,\n\t\t\"services.resume.loginTokens.hashedToken\": hashedToken\n\n\tif not user\n\t\tthrow new Meteor.Error 401, 'Unauthorized'\n\n\treturn user\n\nuuflowManager.checkNestStepUsersIsValid = (selected, scope, nextStep)->\n\tif nextStep?.allow_pick_approve_users\n\t\treturn true;\n\tif _.difference(selected, scope).length > 0\n\t\treturn false\n\treturn true\n\nuuflowManager.getInstance = (instance_id) ->\n\tins = db.instances.findOne(instance_id)\n\tif not ins\n\t\tthrow new Meteor.Error('error!', \"申请单ID：#{instance_id}有误或此申请单已经被删除\")\n\treturn ins\n\nuuflowManager.getSpace = (space_id) ->\n\tspace = db.spaces.findOne(space_id)\n\tif not space\n\t\tthrow new Meteor.Error('error!', \"space_id有误或此space已经被删除\")\n\treturn space\n\nuuflowManager.getSpaceUser = (space_id, user_id) ->\n\tspace_user = db.space_users.findOne({ space: space_id, user: user_id })\n\tif not space_user\n\t\tthrow new Meteor.Error('error!', \"user_id对应的用户不属于当前space\")\n\treturn space_user\n\nuuflowManager.getFlow = (flow_id) ->\n\tflow = db.flows.findOne(flow_id)\n\tif not flow\n\t\tthrow new Meteor.Error('error!', \"id有误或此流程已经被删除\")\n\treturn flow\n\nuuflowManager.getSpaceUserOrgInfo = (space_user) ->\n\tinfo = new Object\n\tinfo.organization = space_user.organization\n\torg = db.organizations.findOne(space_user.organization, { fields: { name: 1 , fullname: 1 } })\n\tinfo.organization_name = org.name\n\tinfo.organization_fullname = org.fullname\n\treturn info\n\nuuflowManager.getTrace = (instance, trace_id) ->\n\ttrace = _.find(instance.traces, (t) ->\n\t\treturn t._id is trace_id\n\t)\n\tif not trace\n\t\tthrow new Meteor.Error('error!', \"trace_id有误\")\n\treturn trace\n\nuuflowManager.getApprove = (trace, approve_id) ->\n\tapprove = _.find(trace.approves, (t) ->\n\t\treturn t._id is approve_id\n\t)\n\tif not approve\n\t\tthrow new Meteor.Error('error!', \"trace_id有误\")\n\treturn approve\n\nuuflowManager.isTraceNotFinished = (trace) ->\n\tif trace.is_finished isnt false\n\t\tthrow new Meteor.Error('error!', \"可能已有人对此文件做了处理。请点击已审核，查看文件的最新状态\")\n\treturn\n\nuuflowManager.isApproveNotFinished = (approve) ->\n\tif approve.is_finished != false\n\t\tthrow new Meteor.Error('error!', \"当前步骤不为未完成状态,不能进行此操作\")\n\treturn\n\nuuflowManager.isInstancePending = (instance, lang = \"zh-CN\") ->\n\tif instance.state isnt \"pending\"\n\t\tthrow new Meteor.Error('error!', TAPi18n.__('instance.remindMessage.update_failed', {}, lang))\n\treturn\n\nuuflowManager.isHandlerOrAgent = (approve, user_id) ->\n\tif approve.user isnt user_id and approve.agent isnt user_id\n\t\tthrow new Meteor.Error('error!', \"不是当前步骤对应的处理人或其代理人，不能进行此操作\")\n\nuuflowManager.isInstanceDraft = (instance, lang = \"zh-CN\") ->\n\tif instance.state isnt \"draft\"\n\t\tthrow new Meteor.Error('error!', TAPi18n.__('instance.remindMessage.update_failed', {}, lang))\n\nuuflowManager.isInstanceSubmitter = (instance, current_user_id) ->\n\tif instance.submitter isnt current_user_id\n\t\tthrow new Meteor.Error('error!', '当前用户不是申请单对应的提交人,不能进行此操作')\n\nuuflowManager.isInstanceSubmitterOrApplicantOrSpaceAdmin = (instance, current_user_id, space) ->\n\tif instance.submitter isnt current_user_id and instance.applicant isnt current_user_id && not space.admins.includes(current_user_id)\n\t\tthrow new Meteor.Error('error!', \"当前用户不是申请单对应的提交人或申请人或工作区管理员\")\n\nuuflowManager.getStep = (instance, flow, step_id) ->\n\tflow_rev = instance.flow_version\n\tisExistStep = null\n\tif flow.current._id is flow_rev\n\t\tisExistStep = _.find(flow.current.steps, (step) ->\n\t\t\treturn step._id is step_id\n\t\t)\n\telse\n\t\t_.each(flow.historys, (history) ->\n\t\t\tif history._id is flow_rev\n\t\t\t\tisExistStep = _.find(history.steps, (step) ->\n\t\t\t\t\treturn step._id is step_id\n\t\t\t\t)\n\t\t)\n\n\tif not isExistStep\n\t\tthrow new Meteor.Error('error!', \"不能获取step\")\n\n\treturn isExistStep\n\nuuflowManager.isJudgeLegal = (judge) ->\n\tif judge isnt \"approved\" and judge isnt \"rejected\" and judge isnt \"readed\" and judge isnt \"submitted\"\n\t\tthrow new Meteor.Error('error!', \"judge有误\")\n\treturn\n\nuuflowManager.isSpaceAdmin = (space_id, user_id) ->\n\tspace = db.spaces.findOne({ _id: space_id }, { fields: { admins: 1 } })\n\tif not space.admins.includes(user_id)\n\t\tthrow new Meteor.Error('error!', \"当前用户不是工作区管理员,不能进行此操作\")\n\treturn\n\nuuflowManager.getUser = (user_id) ->\n\tuser = db.users.findOne(user_id)\n\tif not user\n\t\tthrow new Meteor.Error('error!', \"用户ID有误或此用户已经被删除\")\n\treturn user\n\nuuflowManager.getUserOrganization = (user_id, space_id) ->\n\torg = db.organizations.findOne({ space: space_id, users: user_id })\n\treturn org\n\nuuflowManager.getUserRoles = (user_id, space_id) ->\n\trole_names = new Array\n\tpositions = db.flow_positions.find({ space: space_id, users: user_id }, { fields: { role: 1 } }).fetch()\n\t_.each(positions, (position) ->\n\t\trole = db.flow_roles.findOne({ _id: position.role }, { fields: { name: 1 } })\n\t\tif role\n\t\t\trole_names.push(role.name)\n\t)\n\treturn role_names\n\nuuflowManager.isFlowEnabled = (flow) ->\n\tif flow.state isnt \"enabled\"\n\t\tthrow new Meteor.Error('error!', \"流程未启用,操作失败\")\n\nuuflowManager.isFlowSpaceMatched = (flow, space_id) ->\n\tif flow.space isnt space_id\n\t\tthrow new Meteor.Error('error!', \"流程和工作区ID不匹配\")\n\n# 当前节点为条件节点类型时，根据条件计算出后续步骤\nuuflowManager.calculateCondition = (values, condition_str) ->\n\ttry\n\t\t__values = values\n\n\t\tsum = (subform_field) ->\n\t\t\tif not subform_field\n\t\t\t\tthrow new Meteor.Error('error!', \"参数为空\")\n\t\t\tif not subform_field instanceof Array\n\t\t\t\tthrow new Meteor.Error('error!', \"参数不是数组类型\")\n\t\t\tsum_field_value = 0\n\t\t\t_.each(subform_field, (field_value) ->\n\t\t\t\tfield_value = Number(String(field_value))\n\t\t\t\tsum_field_value += field_value\n\t\t\t)\n\t\t\treturn sum_field_value\n\n\t\taverage = (subform_field) ->\n\t\t\tif not subform_field\n\t\t\t\tthrow new Meteor.Error('error!', \"参数为空\")\n\t\t\tif not subform_field instanceof Array\n\t\t\t\tthrow new Meteor.Error('error!', \"参数不是数组类型\")\n\t\t\treturn sum(subform_field) / count(subform_field)\n\n\t\tcount = (subform_field) ->\n\t\t\tif not subform_field\n\t\t\t\tthrow new Meteor.Error('error!', \"参数为空\")\n\t\t\tsubform_field.length\n\n\t\tmax = (subform_field) ->\n\t\t\tif not subform_field\n\t\t\t\tthrow new Meteor.Error('error!', \"参数为空\")\n\t\t\tif not subform_field instanceof Array\n\t\t\t\tthrow new Meteor.Error('error!', \"参数不是数组类型\")\n\t\t\tsub_field = new Array\n\t\t\t_.each(subform_field, (field_value) ->\n\t\t\t\tsub_field.push(Number(String(field_value)))\n\t\t\t)\n\t\t\treturn _.max(sub_field)\n\n\t\tmin = (subform_field) ->\n\t\t\tif not subform_field\n\t\t\t\tthrow new Meteor.Error('error!', \"参数为空\")\n\t\t\tif not subform_field instanceof Array\n\t\t\t\tthrow new Meteor.Error('error!', \"参数不是数组类型\")\n\t\t\tsub_field = new Array\n\t\t\t_.each(subform_field, (field_value) ->\n\t\t\t\tsub_field.push(Number(String(field_value)))\n\t\t\t)\n\t\t\treturn _.min(sub_field)\n\n\t\teval(condition_str)\n\tcatch e\n\t\tconsole.error e.stack\n\t\treturn false\n\n\n# 代码结构\n# 子表\n#   数值\n#   字符\n# 选组\n#   多选\n#   单选\n# 选人\n#   多选\n#   单选\n# 数值\n# 字符\nuuflowManager.setFormFieldVariable = (fields, __values, space_id) ->\n\ttry\n\t\t_.each(fields, (field) ->\n\t\t\tif field.type is \"table\" #子表\n\t\t\t\t#得到已引用的子表字段\n\t\t\t\tsubform_fields_all = field.fields\n\t\t\t\t_subform_values = new Object\n\t\t\t\t_.each(subform_fields_all, (current_field) ->\n\t\t\t\t\tvalues_arr = new Array\n\t\t\t\t\tif [\"number\", \"percentage\", \"currency\"].includes(current_field[\"type\"])\n\t\t\t\t\t\t_.each(__values[field.code], (sub_field) ->\n\t\t\t\t\t\t\tvalues_arr.push(sub_field[current_field[\"code\"]])\n\t\t\t\t\t\t)\n\t\t\t\t\telse if current_field[\"type\"] is \"checkbox\"\n\t\t\t\t\t\t_.each(__values[field.code], (sub_field) ->\n\t\t\t\t\t\t\tif sub_field[current_field[\"code\"]] is \"true\"\n\t\t\t\t\t\t\t\tvalues_arr.push(true)\n\t\t\t\t\t\t\telse if sub_field[current_field[\"code\"]] is \"false\"\n\t\t\t\t\t\t\t\tvalues_arr.push(false)\n\t\t\t\t\t\t)\n\t\t\t\t\telse\n\t\t\t\t\t\t_.each(__values[field.code], (sub_field) ->\n\t\t\t\t\t\t\tif sub_field[current_field[\"code\"]]\n\t\t\t\t\t\t\t\tvalues_arr.push(sub_field[current_field[\"code\"]])\n\t\t\t\t\t\t\telse\n\t\t\t\t\t\t\t\tvalues_arr.push(\"\")\n\t\t\t\t\t\t)\n\n\t\t\t\t\t__values[current_field[\"code\"]] = values_arr\n\t\t\t\t)\n\t\t\telse if field.type is \"group\" #选组\n\t\t\t\tif field.is_multiselect\n\t\t\t\t\tif __values[field.code] and __values[field.code].length > 0\n\t\t\t\t\t\tgroup_id = new Array\n\t\t\t\t\t\tgroup_name = new Array\n\t\t\t\t\t\tgroup_fullname = new Array\n\t\t\t\t\t\t_.each(__values[field.code], (group) ->\n\t\t\t\t\t\t\tgroup_id.push(group[\"id\"])\n\t\t\t\t\t\t\tgroup_name.push(group[\"name\"])\n\t\t\t\t\t\t\tgroup_fullname.push(group[\"fullname\"])\n\t\t\t\t\t\t)\n\t\t\t\t\t\t__values[field.code] = new Object\n\t\t\t\t\t\t__values[field.code][\"id\"] = group_id\n\t\t\t\t\t\t__values[field.code][\"name\"] = group_name\n\t\t\t\t\t\t__values[field.code][\"fullname\"] = group_fullname\n\t\t\telse if field.type is \"user\" #选人\n\t\t\t\tif field.is_multiselect\n\t\t\t\t\tif __values[field.code] and __values[field.code].length > 0\n\t\t\t\t\t\tuser_id = new Array\n\t\t\t\t\t\tuser_name = new Array\n\t\t\t\t\t\torganization = new Object\n\t\t\t\t\t\torganization[\"user_organization_fullname\"] = new Array\n\t\t\t\t\t\torganization[\"user_organization_name\"] = new Array\n\t\t\t\t\t\tuser_roles = new Array\n\n\t\t\t\t\t\t_.each(__values[field.code], (select_user) ->\n\t\t\t\t\t\t\tuser_id.push(select_user[\"id\"])\n\t\t\t\t\t\t\tuser_name.push(select_user[\"name\"])\n\t\t\t\t\t\t\torganization_selectuser = uuflowManager.getUserOrganization(select_user[\"id\"], space_id)\n\t\t\t\t\t\t\trole_selectuser = uuflowManager.getUserRoles(select_user[\"id\"], space_id)\n\t\t\t\t\t\t\tif organization_selectuser\n\t\t\t\t\t\t\t\torganization[\"user_organization_fullname\"].push(organization_selectuser.fullname)\n\t\t\t\t\t\t\t\torganization[\"user_organization_name\"].push(organization_selectuser.name)\n\t\t\t\t\t\t\tif role_selectuser\n\t\t\t\t\t\t\t\tuser_roles = user_roles or role_selectuser\n\t\t\t\t\t\t)\n\n\t\t\t\t\t\t__values[field.code] = new Object\n\t\t\t\t\t\t__values[field.code][\"id\"] = user_id\n\t\t\t\t\t\t__values[field.code][\"name\"] = user_name\n\t\t\t\t\t\t__values[field.code][\"organization\"] = organization\n\t\t\t\t\t\t__values[field.code][\"roles\"] = roles\n\t\t\t\telse\n\t\t\t\t\tif __values[field.code]\n\t\t\t\t\t\torganization_selectuser = uuflowManager.getUserOrganization(__values[field.code][\"id\"], space_id)\n\t\t\t\t\t\trole_selectuser = uuflowManager.getUserRoles(__values[field.code][\"id\"], space_id)\n\t\t\t\t\t\tif organization_selectuser\n\t\t\t\t\t\t\t__values[field.code][\"organization\"] = new Object\n\t\t\t\t\t\t\t__values[field.code][\"organization\"][\"fullname\"] = organization_selectuser.fullname\n\t\t\t\t\t\t\t__values[field.code][\"organization\"][\"name\"] = organization_selectuser.name\n\n\t\t\t\t\t\t__values[field.code][\"roles\"] = role_selectuser\n\n\t\t\telse if [\"number\", \"percentage\", \"currency\"].includes(field.type) #数值类型\n\t\t\t\tif __values[field.code]\n\t\t\t\t\t__values[field.code] = Number(__values[field.code])\n\t\t\t\telse\n\t\t\t\t\t__values[field.code] = 0\n\t\t\telse if field.type is \"checkbox\" #勾选框\n\t\t\t\tif __values[field.code] is \"true\"\n\t\t\t\t\t__values[field.code] = true\n\t\t\t\telse if __values[field.code] is \"false\"\n\t\t\t\t\t__values[field.code] = false\n\t\t)\n\tcatch e\n\t\tconsole.error e.stack\nisSkipStep = (instance, step)->\n\treturn _.contains(instance.skip_steps, step._id)\n\n# 应用场景：此函数用于返回备选的所有下一步的id\nuuflowManager.getNextSteps = (instance, flow, step, judge, values) ->\n\tstep_type = step.step_type\n\tnextSteps = new Array\n\tif step_type is \"condition\"\n\t\t#step的lines中查询出state=submitted且instance.fields满足其条件的line\n\t\tif values != undefined\n\t\t\t__values = values\n\t\telse\n\t\t\t__values = uuflowManager.getUpdatedValues(instance)\n\t\tcurrent_approve = null\n\t\t# 获取当前Approve\n\t\ttraces = instance.traces\n\t\t_.each traces, (trace) ->\n\t\t\tif trace.is_finished is false\n\t\t\t\tcurrent_approve = trace.approves[0]\n\n\t\tstart_approve = null\n\t\t# 获取开始节点Approve\n\t\t_.each traces, (trace) ->\n\t\t\tif not trace.previous_trace_ids or trace.previous_trace_ids.length is 0\n\t\t\t\tstart_approve = trace.approves[0]\n\n\t\t# 申请人所在组织全名称\n\t\tapplicant_organization_fullname = instance.applicant_organization_fullname\n\t\t# 申请人所在组织的名称\n\t\tapplicant_organization_name = instance.applicant_organization_name\n\t\t# 申请人的审批岗位\n\t\tapplicant_roles = uuflowManager.getUserRoles(instance.applicant, instance.space)\n\t\t# 申请人的全名\n\t\tapplicant_name = instance.applicant_name\n\t\t# 填单人所在组织全名称\n\t\tsubmitter_organization_fullname = start_approve.handler_organization_fullname\n\t\t# 填单人所在组织的名称\n\t\tsubmitter_organization_name = start_approve.handler_organization_name\n\t\t# 填单人的审批岗位\n\t\tsubmitter_roles = uuflowManager.getUserRoles(start_approve.handler, instance.space)\n\t\t# 填单人的全名\n\t\tsubmitter_name = start_approve.handler_name\n\t\t# 处理人所在组织全名称\n\t\tapprover_organization_fullname = current_approve.handler_organization_fullname\n\t\t# 处理人所在组织的名称\n\t\tapprover_organization_name = current_approve.handler_organization_name\n\t\t# 处理人的审批岗位\n\t\tapprover_roles = uuflowManager.getUserRoles(current_approve.handler, instance.space)\n\t\t# 处理人的全名\n\t\tapprover_name = current_approve.handler_name\n\n\t\t# Condition中涉及的一些变量\n\t\t__values[\"applicant\"] = new Object\n\t\t__values[\"applicant\"][\"roles\"] = applicant_roles\n\t\t__values[\"applicant\"][\"name\"] = applicant_name\n\t\t__values[\"applicant\"][\"organization\"] = new Object\n\t\t__values[\"applicant\"][\"organization\"][\"fullname\"] = applicant_organization_fullname\n\t\t__values[\"applicant\"][\"organization\"][\"name\"] = applicant_organization_name\n\n\t\t__values[\"submitter\"] = new Object\n\t\t__values[\"submitter\"][\"roles\"] = submitter_roles\n\t\t__values[\"submitter\"][\"name\"] = submitter_name\n\t\t__values[\"submitter\"][\"organization\"] = new Object\n\t\t__values[\"submitter\"][\"organization\"][\"fullname\"] = submitter_organization_fullname\n\t\t__values[\"submitter\"][\"organization\"][\"name\"] = submitter_organization_name\n\n\t\t__values[\"approver\"] = new Object\n\t\t__values[\"approver\"][\"roles\"] = approver_roles\n\t\t__values[\"approver\"][\"name\"] = approver_name\n\t\t__values[\"approver\"][\"organization\"] = new Object\n\t\t__values[\"approver\"][\"organization\"][\"fullname\"] = approver_organization_fullname\n\t\t__values[\"approver\"][\"organization\"][\"name\"] = approver_organization_name\n\n\t\t# 获取申请单对应表单\n\t\tform = db.forms.findOne(instance.form)\n\t\tformVersion = null\n\t\tif instance.form_version is form.current._id\n\t\t\tformVersion = form.current\n\t\telse\n\t\t\tformVersion = _.find(form.historys, (history) ->\n\t\t\t\treturn instance.form_version is history._id\n\t\t\t)\n\n\t\t# 定义表单中字段\n\t\tuuflowManager.setFormFieldVariable(formVersion.fields, __values, instance.space)\n\t\t# 匹配包括花括号自身在内的所有符号\n\t\treg = /(\\{[^{}]*\\})/g\n\t\tprefix = \"__values\"\n\t\t_.each step.lines, (step_line) ->\n\t\t\tstep_line_condition = step_line.condition.replace reg, (vowel) ->\n\t\t\t\treturn prefix + vowel.replace(/\\{\\s*/, \"[\\\"\").replace(/\\s*\\}/, \"\\\"]\").replace(/\\s*\\.\\s*/g, \"\\\"][\\\"\")\n\t\t\tif step_line.state is \"submitted\" and uuflowManager.calculateCondition(__values, step_line_condition)\n\t\t\t\tif step_line.state is \"submitted\"\n\t\t\t\t\tnextSteps.push(step_line.to_step)\n\n\telse if step_type is \"end\"\n\t\treturn new Array\n\telse if step_type is \"submit\" or step_type is \"start\" or step_type is \"counterSign\"\n\t\tlines = _.filter(step.lines, (line) ->\n\t\t\treturn line.state is \"submitted\"\n\t\t)\n\t\tif lines.length is 0\n\t\t\tthrow new Meteor.Error('error!', \"流程的连线配置有误\")\n\t\telse\n\t\t\tnextSteps = _.pluck(lines, 'to_step')\n\telse if step_type is \"sign\"\n\t\tif judge is \"approved\"\n\t\t\tlines = _.filter(step.lines, (line) ->\n\t\t\t\treturn line.state is \"approved\"\n\t\t\t)\n\t\t\tif lines.length is 0\n\t\t\t\tthrow new Meteor.Error('error!', \"流程的连线配置有误\")\n\t\t\telse\n\t\t\t\tnextSteps = _.pluck(lines, 'to_step')\n\t\telse if judge is \"rejected\"\n\t\t\tlines = _.filter(step.lines, (line) ->\n\t\t\t\treturn line.state is \"rejected\"\n\t\t\t)\n\t\t\trejectedSteps = _.pluck(lines, 'to_step')\n\t\t\t# 取出instance的traces,取出所有历史trace中(is_finished=ture)的step_id\n\t\t\ttrace_steps = new Array\n\t\t\t_.each(instance.traces, (trace) ->\n\t\t\t\tif trace.is_finished is true\n\t\t\t\t\tflowVersions = new Array\n\t\t\t\t\tflowVersions.push(flow.current)\n\t\t\t\t\tif flow.historys\n\t\t\t\t\t\tflowVersions = flowVersions.concat(flow.historys)\n\t\t\t\t\t_.each(flowVersions, (flowVer) ->\n\t\t\t\t\t\tif flowVer._id is instance.flow_version\n\t\t\t\t\t\t\t_.each(flowVer.steps, (flow_ver_step) ->\n\t\t\t\t\t\t\t\tif flow_ver_step._id is trace.step and flow_ver_step.step_type isnt \"condition\"\n\t\t\t\t\t\t\t\t\ttrace_steps.push(trace.step)\n\t\t\t\t\t\t\t)\n\t\t\t\t\t)\n\t\t\t)\n\t\t\t# 取出flow,取到instance对应的版本的开始结点和结束结点的step_id\n\t\t\tflow_steps = new Array\n\t\t\tif instance.flow_version is flow.current._id\n\t\t\t\t_.each(flow.current.steps, (flow_step) ->\n\t\t\t\t\tif flow_step.step_type is \"start\" or flow_step.step_type is \"end\"\n\t\t\t\t\t\tflow_steps.push(flow_step._id)\n\t\t\t\t)\n\t\t\telse\n\t\t\t\t_.each(flow.historys, (history) ->\n\t\t\t\t\t_.each(history.steps, (history_step) ->\n\t\t\t\t\t\tif history_step.step_type is \"start\" or history_step.step_type is \"end\"\n\t\t\t\t\t\t\tflow_steps.push(history_step._id)\n\t\t\t\t\t)\n\t\t\t\t)\n\n\t\t\tnextSteps = _.union(rejectedSteps, trace_steps, flow_steps)\n\n\t# 若下一步中包含 条件节点 则 继续取得 条件节点的 后续步骤\n\tversion_steps = new Object\n\tflowVersions = new Array\n\tflowVersions.push(flow.current)\n\tif flow.historys\n\t\tflowVersions = flowVersions.concat(flow.historys)\n\n\t_.each(flowVersions, (flowVer) ->\n\t\tif flowVer._id is instance.flow_version\n\t\t\t_.each(flowVer.steps, (flow_ver_step) ->\n\t\t\t\tversion_steps[flow_ver_step._id] = flow_ver_step\n\t\t\t)\n\t)\n\n\tnextSteps = _.uniq(nextSteps)\n\t_.each(nextSteps, (next_step_id) ->\n\t\t_next_step = version_steps[next_step_id]\n\t\tif _next_step.step_type is \"condition\"\n\t\t\tif _next_step.lines\n\t\t\t\t_.each(_next_step.lines, (line) ->\n\t\t\t\t\tif line.to_step\n\t\t\t\t\t\tnextSteps.push(line.to_step)\n\t\t\t\t)\n\t)\n\n\tnextSteps = _.uniq(nextSteps)\n\trev_nextSteps = new Array();\n\t_.each nextSteps, (nextStepId)->\n\t\t_step = uuflowManager.getStep(instance, flow, nextStepId);\n\t\tif isSkipStep(instance, _step)\n\t\t\tif !judge && _step.step_type == 'sign'\n\t\t\t\tjudge = 'approved'\n\t\t\trev_nextSteps = rev_nextSteps.concat(uuflowManager.getNextSteps(instance, flow, _step, judge))\n\t\telse\n\t\t\trev_nextSteps.push(nextStepId);\n\trev_nextSteps = _.uniq(rev_nextSteps)\n\treturn rev_nextSteps\n\nuuflowManager.getUpdatedValues = (instance, approve_id) ->\n\t# 取得最新的approve\n\ttrace_approve = null\n\t_.each(instance.traces, (trace) ->\n\t\tif trace.is_finished is false\n\t\t\tif approve_id\n\t\t\t\ttrace_approve = _.find(trace.approves, (approve) ->\n\t\t\t\t\treturn approve._id == approve_id\n\t\t\t\t)\n\t\t\telse\n\t\t\t\ttrace_approve = _.find(trace.approves, (approve) ->\n\t\t\t\t\treturn approve.is_finished is false and approve.type isnt 'cc' and approve.type isnt 'distribute'\n\t\t\t\t)\n\t)\n\n\t# 取得最新的values\n\tnewest_values = null\n\tif not instance.values\n\t\tnewest_values = trace_approve?.values\n\telse if not trace_approve?.values\n\t\tnewest_values = instance.values\n\telse\n\t\tnewest_values =  _.extend(_.clone(instance.values), trace_approve.values)\n\treturn newest_values\n\nuuflowManager.getForm = (form_id) ->\n\tform = db.forms.findOne(form_id)\n\tif not form\n\t\tthrow new Meteor.Error('error!', '表单ID有误或此表单已经被删除')\n\n\treturn form\n\nuuflowManager.getFormVersion = (form, form_version) ->\n\tform_v = null\n\tif form_version is form.current._id\n\t\tform_v = form.current\n\telse\n\t\tform_v = _.find(form.historys, (form_h) ->\n\t\t\treturn form_version is form_h._id\n\t\t)\n\n\tif not form_v\n\t\tthrow new Meteor.Error('error!', '未找到表单对应的版本')\n\n\treturn form_v\n\nuuflowManager.getCategory = (category_id) ->\n\treturn db.categories.findOne(category_id)\n\nuuflowManager.getInstanceName = (instance, vals) ->\n\tvalues = _.clone(vals || instance.values) || {}\n\n\tapplicant = WorkflowManager.getFormulaUserObject(instance.space, instance.applicant)\n\n\tvalues[\"applicant\"] = applicant\n\n\tvalues[\"applicant_name\"] = instance.applicant_name\n\tvalues[\"applicant_organization\"] = instance.applicant_organization\n\tvalues[\"applicant_organization_fullname\"] = instance.applicant_organization_fullname\n\tvalues[\"applicant_organization_name\"] = instance.applicant_organization_name\n\n\tvalues[\"submit_date\"] = moment(instance.submit_date).utcOffset(0, false).format(\"YYYY-MM-DD\")\n\n\tform_id = instance.form\n\tflow = uuflowManager.getFlow(instance.flow)\n\n\tdefault_value = flow.name + ' ' + instance.code\n\tform_version = instance.form_version\n\tform = uuflowManager.getForm(form_id)\n\tform_v = uuflowManager.getFormVersion(form, form_version)\n\tname_forumla = form_v.name_forumla\n\trev = default_value\n\n\tif name_forumla\n\n\t\tif name_forumla.indexOf(\"{applicant.\") > -1\n\t\t\tiscript = name_forumla.replace(/\\{applicant./g, \"(applicant.\").replace(/\\}/g, \" || '')\")\n\n\t\tiscript = name_forumla.replace(/\\{/g, \"(values.\").replace(/\\}/g, \" || '')\")\n\n#\t\tconsole.log(iscript)\n\n\t\ttry\n\t\t\tscript = \"module.exports = function (applicant, values, flow, form) { return \" + iscript + \" }\"\n\t\t\tfunc = _eval(script, \"getInstanceName\")\n\n\t\t\trev = func(applicant, values, flow, form) || default_value\n\n\t\t\t#文件名中不能包含特殊字符: '? * : \" < > \\ / |'， 直接替换为空\n\t\t\trev = rev.replace(/\\?|\\*|\\:|\\\"|\\<|\\>|\\\\|\\/|\\|/g, \"\")\n\n\t\tcatch e\n\t\t\tconsole.log e\n\n\treturn rev.trim()\n\nuuflowManager.getApproveValues = (approve_values, permissions, form_id, form_version) ->\n\t# 如果permissions为null，则approve_values为{}\n\tif permissions is null\n\t\tapprove_values = new Object\n\telse\n\t\t# 获得instance中的所有字段\n\t\tinstance_form = db.forms.findOne(form_id)\n\t\tform_v = null\n\t\tif form_version is instance_form.current._id\n\t\t\tform_v = instance_form.current\n\t\telse\n\t\t\tform_v = _.find(instance_form.historys, (form_h) ->\n\t\t\t\treturn form_version is form_h._id\n\t\t\t)\n\n\t\t_.each(form_v.fields, (field) ->\n\t\t\tif field.type is \"table\"\n#\t\t\t\t_.each(field.fields, (tableField)->\n#\t\t\t\t\tif approve_values[field.code] isnt null\n#\t\t\t\t\t\t_.each(approve_values[field.code], (tableValue)->\n#\t\t\t\t\t\t\tif !tableField.formula && (permissions[tableField.code] is null or permissions[tableField.code] isnt \"editable\")\n#\t\t\t\t\t\t\t\tdelete tableValue[tableField.code]\n#\t\t\t\t\t\t)\n#\t\t\t\t)\n\t\t\t\treturn\n\t\t\telse if field.type is \"section\"\n\t\t\t\t_.each(field.fields, (sectionField) ->\n\t\t\t\t\tif !sectionField.formula && (permissions[sectionField.code] is null or permissions[sectionField.code] isnt \"editable\")\n\t\t\t\t\t\tdelete approve_values[sectionField.code]\n\t\t\t\t)\n\t\t\telse\n\t\t\t\tif !field.formula && (permissions[field.code] is null or permissions[field.code] isnt \"editable\")\n\t\t\t\t\tdelete approve_values[field.code]\n\t\t)\n\treturn approve_values\n\nuuflowManager.workflow_engine = (approve_from_client, current_user_info, current_user, auto_submitted)->\n\tinstance_id = approve_from_client[\"instance\"]\n\ttrace_id = approve_from_client[\"trace\"]\n\tapprove_id = approve_from_client[\"_id\"]\n\tvalues = approve_from_client[\"values\"]\n\tif not values then values = new Object\n\tnext_steps = approve_from_client[\"next_steps\"]\n\tjudge = approve_from_client[\"judge\"]\n\tdescription = approve_from_client[\"description\"]\n\tgeolocation = approve_from_client[\"geolocation\"]\n\n\tsetObj = new Object\n\n\t# 获取一个instance\n\tinstance = uuflowManager.getInstance(instance_id)\n\tspace_id = instance.space\n\tflow_id = instance.flow\n\t# 获取一个space\n\tspace = uuflowManager.getSpace(space_id)\n\tapplicant_id = instance.applicant\n\t# 校验申请人user_accepted = true\n\tcheckApplicant = uuflowManager.getSpaceUser(space_id, applicant_id)\n\t# 获取一个flow\n\tflow = uuflowManager.getFlow(flow_id)\n\t# 获取一个space下的一个user\n\tspace_user = uuflowManager.getSpaceUser(space_id, current_user)\n\t# 获取space_user所在的部门信息\n\tspace_user_org_info = uuflowManager.getSpaceUserOrgInfo(space_user)\n\t# 获取一个trace\n\ttrace = uuflowManager.getTrace(instance, trace_id)\n\t# 获取一个approve\n\tapprove = uuflowManager.getApprove(trace, approve_id)\n\t# 判断一个trace是否为未完成状态\n\tuuflowManager.isTraceNotFinished(trace)\n\t# 判断一个approve是否为未完成状态\n\tuuflowManager.isApproveNotFinished(approve)\n\t# 判断一个instance是否为审核中状态\n\tuuflowManager.isInstancePending(instance)\n\t# 判断当前用户是否approve 对应的处理人或代理人\n\tuuflowManager.isHandlerOrAgent(approve, current_user)\n\n\t# 先执行审核状态暂存的操作\n\t# ================begin================\n\tstep = uuflowManager.getStep(instance, flow, trace.step)\n\tstep_type = step.step_type\n\tinstance_trace = _.find(instance.traces, (trace)->\n\t\treturn trace._id is trace_id\n\t)\n\n\ttrace_approves = instance_trace.approves\n\n\ti = 0\n\twhile i < trace_approves.length\n\t\tif trace_approves[i]._id is approve_id\n\t\t\tkey_str = \"traces.$.approves.\" + i + \".\"\n\t\t\tsetObj[key_str + \"geolocation\"] = geolocation\n\t\t\tif step_type is \"condition\"\n\t\t\telse if step_type is \"start\" or step_type is \"submit\"\n\t\t\t\tsetObj[key_str + \"judge\"] = \"submitted\"\n\t\t\t\tsetObj[key_str + \"description\"] = description\n\t\t\telse if step_type is \"sign\" or step_type is \"counterSign\"\n\t\t\t\t# 如果是会签并且前台没有显示核准驳回已阅的radio则给judge默认submitted\n\t\t\t\tif step_type is \"counterSign\" and not judge\n\t\t\t\t\tjudge = 'submitted'\n\t\t\t\t# 判断前台传的judge是否合法\n\t\t\t\tuuflowManager.isJudgeLegal(judge)\n\t\t\t\tsetObj[key_str + \"judge\"] = judge\n\t\t\t\tsetObj[key_str + \"description\"] = description\n\n\t\t\tsetObj[key_str + \"next_steps\"] = next_steps\n\t\t\tsetObj[key_str + \"is_read\"] = true\n\t\t\tif not trace_approves[i].read_date\n\t\t\t\tsetObj[key_str + \"read_date\"] = new Date\n\t\t\t# 调整approves 的values 。删除values中在当前步骤中没有编辑权限的字段值\n\t\t\tsetObj[key_str + \"values\"] = uuflowManager.getApproveValues(values, step[\"permissions\"], instance.form, instance.form_version)\n\n\t\t\t# 更新instance记录\n\t\t\tsetObj.modified = new Date\n\t\t\tsetObj.modified_by = current_user\n\n\t\t\tdb.instances.update({_id: instance_id, \"traces._id\": trace_id}, {$set: setObj})\n\t\ti++\n\n\n\t# ================end================\n\tinstance = uuflowManager.getInstance(instance_id)\n\t# 防止此时的instance已经被处理\n\t# 获取一个trace\n\ttrace = uuflowManager.getTrace(instance, trace_id)\n\t# 获取一个approve\n\tapprove = uuflowManager.getApprove(trace, approve_id)\n\t# 判断一个trace是否为未完成状态\n\tuuflowManager.isTraceNotFinished(trace)\n\t# 判断一个approve是否为未完成状态\n\tuuflowManager.isApproveNotFinished(approve)\n\t# 判断一个instance是否为审核中状态\n\tuuflowManager.isInstancePending(instance)\n\t# 判断当前用户是否approve 对应的处理人或代理人\n\tuuflowManager.isHandlerOrAgent(approve, current_user)\n\tupdateObj = new Object\n\n\tif next_steps is null or next_steps.length is 0\n\t\tthrow new Meteor.Error('error!', '还未指定下一步和处理人，操作失败')\n\telse\n\t\t# 验证next_steps里面是否只有一个step\n\t\tif next_steps.length > 1\n\t\t\tthrow new Meteor.Error('error!', '不能指定多个后续步骤')\n\t\telse\n\t\t\t# 校验下一步处理人user_accepted = true\n\t\t\t_.each next_steps[0][\"users\"], (next_step_user) ->\n\t\t\t\tcheckSpaceUser = uuflowManager.getSpaceUser(space_id, next_step_user)\n\n\t\tif step_type is \"start\" or step_type is \"submit\" or step_type is \"condition\"\n\t\t\tupdateObj = uuflowManager.engine_step_type_is_start_or_submit_or_condition(instance_id, trace_id, approve_id, next_steps, space_user_org_info, judge, instance, flow, step, current_user, current_user_info, auto_submitted)\n\t\telse if step_type is \"sign\"\n\t\t\tupdateObj = uuflowManager.engine_step_type_is_sign(instance_id, trace_id, approve_id, next_steps, space_user_org_info, judge, instance, flow, step, current_user, current_user_info, description, auto_submitted)\n\t\telse if step_type is \"counterSign\"\n\t\t\tupdateObj = uuflowManager.engine_step_type_is_counterSign(instance_id, trace_id, approve_id, next_steps, space_user_org_info, judge, instance, flow, step, current_user, current_user_info, auto_submitted)\n\t\telse if step_type is \"end\"\n\t\t\tthrow new Meteor.Error('error!', 'end结点出现approve，服务器错误')\n\n\t\tform = db.forms.findOne(instance.form)\n\t\tupdateObj.keywords = uuflowManager.caculateKeywords(updateObj.values, form, instance.form_version)\n\t\tdb.instances.update({_id: instance_id}, {$set: updateObj})\n\n\tinstance = uuflowManager.getInstance(instance_id)\n\tinstance_trace = _.find(instance.traces, (trace)->\n\t\treturn trace._id is trace_id\n\t)\n\tnext_step_id = next_steps[0][\"step\"]\n\tnext_step = uuflowManager.getStep(instance, flow, next_step_id)\n\tnext_step_type = next_step.step_type\n\t#发送消息开始\n\tif \"completed\" is instance.state\n\t\tif \"approved\" is instance.final_decision\n\t\t\t#通知填单人、申请人\n\t\t\tpushManager.send_instance_notification(\"approved_completed_applicant\", instance, description, current_user_info)\n\t\telse if \"rejected\" is instance.final_decision\n\t\t\t#通知填单人、申请人\n\t\t\tpushManager.send_instance_notification(\"rejected_completed_applicant\", instance, description, current_user_info)\n\t\telse\n\t\t\t#通知填单人、申请人\n\t\t\tpushManager.send_instance_notification(\"submit_completed_applicant\", instance, description, current_user_info)\n\n\telse if \"pending\" is instance.state\n\t\tif \"rejected\" is instance_trace.judge and instance_trace.is_finished is true\n\t\t\tif 'start' is next_step_type\n\t\t\t\t#驳回给申请人时，发送短消息\n\t\t\t\tpushManager.send_instance_notification(\"submit_pending_rejected_applicant_inbox\", instance, description, current_user_info)\n\t\t\telse\n\t\t\t\t#通知填单人、申请人\n\t\t\t\tpushManager.send_instance_notification(\"submit_pending_rejected_applicant\", instance, description, current_user_info)\n\t\t\t\t# 发送消息给下一步处理人\n\t\t\t\tpushManager.send_instance_notification(\"submit_pending_rejected_inbox\", instance, description, current_user_info)\n\t\telse if instance_trace.is_finished is false\n\t\t\t# 会签 并且当前trace未结束\n\t\t\t# 发送push消息 给 inbox_users\n\n\t\telse\n\t\t\t# 发送消息给下一步处理人\n\t\t\tpushManager.send_instance_notification(\"submit_pending_inbox\", instance, description, current_user_info)\n\t#发送消息给当前用户\n\tpushManager.send_message_current_user(current_user_info)\n\n\t# 如果已经配置webhook并已激活则触发\n\tto_users = instance.inbox_users\n\tlast_trace = _.last(instance.traces)\n\tlast_step = uuflowManager.getStep(instance, flow, last_trace.step)\n\tlast_step_type = last_step.step_type\n\tif last_step_type is \"counterSign\" and _.where(last_trace.approves, {is_finished: true}).length > 0\n\t\tto_users = []\n\n\tpushManager.triggerWebhook(flow_id, instance, approve_from_client, 'engine_submit', current_user, to_users)\n\n\t# 判断申请单是否分发，分发文件结束提醒发起人\n\tuuflowManager.distributedInstancesRemind(instance)\n\n\treturn instance\n\n\nuuflowManager.engine_step_type_is_start_or_submit_or_condition = (instance_id, trace_id, approve_id, next_steps, space_user_org_info, judge, instance, flow, step, current_user, current_user_info, auto_submitted) ->\n\tsetObj = new Object\n\tspace_id = instance.space\n\t# 验证next_steps.step是否合法\n\tnextSteps = uuflowManager.getNextSteps(instance, flow, step, \"\")\n\t# 判断next_steps.step是否在nextSteps中,若不在则不合法\n\t_.each next_steps, (approve_next_step) ->\n\t\tif not nextSteps.includes approve_next_step[\"step\"]\n\t\t\tthrow new Meteor.Error('error!', \"approve中next_steps.step：\" + approve_next_step.step + \" 不合法\")\n\n\t# 若合法,执行流转\n\tnext_step_id = next_steps[0][\"step\"]\n\tnext_step = uuflowManager.getStep(instance, flow, next_step_id)\n\tnext_step_type = next_step.step_type\n\tnext_step_name = next_step.name\n\t# 判断next_step是否为结束结点\n\tif next_step_type is \"end\"\n\t\t# 若是结束结点\n\t\tinstance_traces = instance.traces\n\t\ti = 0\n\t\twhile i < instance_traces.length\n\t\t\tif instance_traces[i]._id is trace_id\n\t\t\t\t# 更新当前trace记录\n\t\t\t\tinstance_traces[i].is_finished = true\n\t\t\t\tinstance_traces[i].finish_date = new Date\n\t\t\t\tinstance_traces[i].judge = judge\n\t\t\t\th = 0\n\t\t\t\twhile h < instance_traces[i].approves.length\n\t\t\t\t\tif instance_traces[i].approves[h]._id is approve_id\n\t\t\t\t\t\t# 更新当前trace.approve记录\n\t\t\t\t\t\tinstance_traces[i].approves[h].is_finished = true\n\t\t\t\t\t\tinstance_traces[i].approves[h].handler = current_user\n\t\t\t\t\t\tinstance_traces[i].approves[h].handler_name = current_user_info.name\n\t\t\t\t\t\tinstance_traces[i].approves[h].finish_date = new Date\n\t\t\t\t\t\tinstance_traces[i].approves[h].handler_organization = space_user_org_info[\"organization\"]\n\t\t\t\t\t\tinstance_traces[i].approves[h].handler_organization_name = space_user_org_info[\"organization_name\"]\n\t\t\t\t\t\tinstance_traces[i].approves[h].handler_organization_fullname = space_user_org_info[\"organization_fullname\"]\n\t\t\t\t\t\t# 调整approves 的values 。删除values中在当前步骤中没有编辑权限的字段值\n\t\t\t\t\t\t# instance_traces[i].approves[h].values = uuflowManager.getApproveValues(instance_traces[i].approves[h].values, step[\"permissions\"], instance.form, instance.form_version)\n\t\t\t\t\t\tinstance_traces[i].approves[h].cost_time = instance_traces[i].approves[h].finish_date - instance_traces[i].approves[h].start_date\n\t\t\t\t\t\tinstance_traces[i].approves[h].auto_submitted = auto_submitted\n\t\t\t\t\th++\n\t\t\ti++\n\n\t\t# 插入下一步trace记录\n\t\tnewTrace = new Object\n\t\tnewTrace._id = new Mongo.ObjectID()._str\n\t\tnewTrace.instance = instance_id\n\t\tnewTrace.previous_trace_ids = [trace_id]\n\t\tnewTrace.is_finished = true\n\t\tnewTrace.step = next_step_id\n\t\tnewTrace.name = next_step_name\n\t\tnewTrace.start_date = new Date\n\t\tnewTrace.finish_date = new Date\n\n\t\t# 更新instance记录\n\t\tsetObj.state = \"completed\"\n\t\tsetObj.modified = new Date\n\t\tsetObj.modified_by = current_user\n\t\tsetObj.values = uuflowManager.getUpdatedValues(uuflowManager.getInstance(instance_id))\n\t\tinstance.values = setObj.values\n\t\tsetObj.name = uuflowManager.getInstanceName(instance)\n\n\t\tinstance_trace = _.find(instance_traces, (trace) ->\n\t\t\treturn trace._id is trace_id\n\t\t)\n\t\ttrace_approve = _.find(instance_trace.approves, (approve) ->\n\t\t\treturn approve._id is approve_id\n\t\t)\n\t\toutbox_users = instance.outbox_users\n\t\toutbox_users.unshift(trace_approve.handler)\n\t\toutbox_users.unshift(trace_approve.user)\n\t\tsetObj.outbox_users = _.uniq(outbox_users)\n\n\t\tinstance_traces.push(newTrace)\n\t\tsetObj.traces = instance_traces\n\t\tsetObj.inbox_users = []\n\t\tsetObj.finish_date = new Date\n\t\tsetObj.current_step_name = next_step_name\n\t\tsetObj.final_decision = 'approved'\n\t\tsetObj.current_step_auto_submit = false\n\telse\n\t\t# 若不是结束结点\n\t\t# 先判断nextsteps.step.users是否为空\n\t\tnext_step_users = next_steps[0][\"users\"]\n\t\tif next_step_users is null or next_step_users.length is 0\n\t\t\tthrow new Meteor.Error('error!', \"未指定下一步处理人\")\n\t\telse\n\t\t\tif next_step_users.length > 1 and next_step.step_type isnt \"counterSign\"\n\t\t\t\tthrow new Meteor.Error('error!', \"不能指定多个处理人\")\n\t\t\telse\n\t\t\t\t# 验证next_user是否合法，调用getHandlersManager.getHandlers(:instance_id,当前trace对应的step_id),判断next_user是否在其返回的结果中\n\t\t\t\tnext_user_ids = getHandlersManager.getHandlers(instance_id, next_step_id, current_user)\n\t\t\t\tif !uuflowManager.checkNestStepUsersIsValid(next_step_users, next_user_ids, next_step)\n\t\t\t\t\tthrow new Meteor.Error('error!', \"指定的下一步处理人有误\")\n\t\t\t\telse\n\t\t\t\t\t# 若合法，执行流转操作\n\t\t\t\t\tinstance_traces = instance.traces\n\t\t\t\t\ti = 0\n\t\t\t\t\twhile i < instance_traces.length\n\t\t\t\t\t\tif instance_traces[i]._id is trace_id\n\t\t\t\t\t\t\t# 更新当前trace记录\n\t\t\t\t\t\t\tinstance_traces[i].is_finished = true\n\t\t\t\t\t\t\tinstance_traces[i].finish_date = new Date\n\t\t\t\t\t\t\tinstance_traces[i].judge = judge\n\t\t\t\t\t\t\th = 0\n\t\t\t\t\t\t\twhile h < instance_traces[i].approves.length\n\t\t\t\t\t\t\t\tif instance_traces[i].approves[h]._id is approve_id\n\t\t\t\t\t\t\t\t\t# 更新当前trace.approve记录\n\t\t\t\t\t\t\t\t\tinstance_traces[i].approves[h].is_finished = true\n\t\t\t\t\t\t\t\t\tinstance_traces[i].approves[h].handler = current_user\n\t\t\t\t\t\t\t\t\tinstance_traces[i].approves[h].handler_name = current_user_info.name\n\t\t\t\t\t\t\t\t\tinstance_traces[i].approves[h].finish_date = new Date\n\t\t\t\t\t\t\t\t\tinstance_traces[i].approves[h].handler_organization = space_user_org_info[\"organization\"]\n\t\t\t\t\t\t\t\t\tinstance_traces[i].approves[h].handler_organization_name = space_user_org_info[\"organization_name\"]\n\t\t\t\t\t\t\t\t\tinstance_traces[i].approves[h].handler_organization_fullname = space_user_org_info[\"organization_fullname\"]\n\t\t\t\t\t\t\t\t\t# 调整approves 的values 。删除values中在当前步骤中没有编辑权限的字段值\n\t\t\t\t\t\t\t\t\t# instance_traces[i].approves[h].values = uuflowManager.getApproveValues(instance_traces[i].approves[h].values, step[\"permissions\"], instance.form, instance.form_version)\n\t\t\t\t\t\t\t\t\tinstance_traces[i].approves[h].cost_time = instance_traces[i].approves[h].finish_date - instance_traces[i].approves[h].start_date\n\t\t\t\t\t\t\t\t\tinstance_traces[i].approves[h].auto_submitted = auto_submitted\n\t\t\t\t\t\t\t\th++\n\t\t\t\t\t\ti++\n\n\t\t\t\t\t# 插入下一步trace记录\n\t\t\t\t\tnewTrace = new Object\n\t\t\t\t\tnewTrace._id = new Mongo.ObjectID()._str\n\t\t\t\t\tnewTrace.instance = instance_id\n\t\t\t\t\tnewTrace.previous_trace_ids = [trace_id]\n\t\t\t\t\tnewTrace.is_finished = false\n\t\t\t\t\tnewTrace.step = next_step_id\n\t\t\t\t\tnewTrace.name = next_step_name\n\t\t\t\t\tnewTrace.start_date = new Date\n\t\t\t\t\tnewTrace.due_date = uuflowManager.getDueDate(next_step.timeout_hours, space_id)\n\t\t\t\t\tnewTrace.approves = new Array\n\n\t\t\t\t\tupdated_values = uuflowManager.getUpdatedValues(uuflowManager.getInstance(instance_id))\n\t\t\t\t\t_.each next_step_users, (next_step_user_id, idx) ->\n\t\t\t\t\t\t# 插入下一步trace.approve记录\n\t\t\t\t\t\tnewApprove = new Object\n\t\t\t\t\t\tnewApprove._id = new Mongo.ObjectID()._str\n\t\t\t\t\t\tnewApprove.instance = instance_id\n\t\t\t\t\t\tnewApprove.trace = newTrace._id\n\t\t\t\t\t\tnewApprove.is_finished = false\n\t\t\t\t\t\tnewApprove.user = next_step_user_id\n\n\t\t\t\t\t\tuser_info = db.users.findOne({ _id: next_step_user_id }, { fields: { name: 1 } })\n\t\t\t\t\t\tnewApprove.user_name = user_info.name\n\n\t\t\t\t\t\thandler_id = next_step_user_id\n\t\t\t\t\t\thandler_info = user_info\n\t\t\t\t\t\tagent = uuflowManager.getAgent(space_id, next_step_user_id)\n\t\t\t\t\t\tif agent\n\t\t\t\t\t\t\tnext_step_users[idx] = agent\n\t\t\t\t\t\t\thandler_id = agent\n\t\t\t\t\t\t\thandler_info = db.users.findOne({ _id: agent }, { fields: { name: 1 } })\n\t\t\t\t\t\t\tnewApprove.agent = agent\n\n\t\t\t\t\t\tnewApprove.handler = handler_id\n\t\t\t\t\t\tnewApprove.handler_name = handler_info.name\n\n\t\t\t\t\t\tnext_step_space_user = db.space_users.findOne({ space: space_id, user: handler_id })\n\t\t\t\t\t\t# 获取next_step_user所在的部门信息\n\t\t\t\t\t\tnext_step_user_org_info = uuflowManager.getSpaceUserOrgInfo(next_step_space_user)\n\t\t\t\t\t\tnewApprove.handler_organization = next_step_user_org_info[\"organization\"]\n\t\t\t\t\t\tnewApprove.handler_organization_name = next_step_user_org_info[\"organization_name\"]\n\t\t\t\t\t\tnewApprove.handler_organization_fullname = next_step_user_org_info[\"organization_fullname\"]\n\t\t\t\t\t\tnewApprove.start_date = new Date\n\t\t\t\t\t\tnewApprove.due_date = newTrace.due_date\n\t\t\t\t\t\tnewApprove.is_read = false\n\t\t\t\t\t\tnewApprove.is_error = false\n\t\t\t\t\t\tnewApprove.values = new Object\n\t\t\t\t\t\tuuflowManager.setRemindInfo(updated_values, newApprove)\n\t\t\t\t\t\tnewTrace.approves.push(newApprove)\n\n\t\t\t\t\t# 更新instance记录\n\t\t\t\t\tsetObj.state = \"pending\"\n\t\t\t\t\tsetObj.modified = new Date\n\t\t\t\t\tsetObj.modified_by = current_user\n\t\t\t\t\tsetObj.values = updated_values\n\t\t\t\t\tinstance.values = setObj.values\n\t\t\t\t\tsetObj.name = uuflowManager.getInstanceName(instance)\n\n\t\t\t\t\tinstance_trace = _.find(instance_traces, (trace) ->\n\t\t\t\t\t\treturn trace._id is trace_id\n\t\t\t\t\t)\n\t\t\t\t\ttrace_approve = _.find(instance_trace.approves, (approve) ->\n\t\t\t\t\t\treturn approve._id is approve_id\n\t\t\t\t\t)\n\t\t\t\t\toutbox_users = instance.outbox_users\n\t\t\t\t\toutbox_users.unshift(trace_approve.user)\n\t\t\t\t\toutbox_users.unshift(trace_approve.handler)\n\t\t\t\t\tsetObj.outbox_users = _.uniq(outbox_users)\n\t\t\t\t\tsetObj.inbox_users = next_step_users\n\n\t\t\t\t\tinstance_traces.push(newTrace)\n\t\t\t\t\tsetObj.traces = instance_traces\n\t\t\t\t\tsetObj.current_step_name = next_step_name\n\n\t\t\t\t\tsetObj.current_step_auto_submit = uuflowManager.getCurrentStepAutoSubmit(flow.timeout_auto_submit, next_step.lines)\n\n\treturn setObj\n\nuuflowManager.engine_step_type_is_sign = (instance_id, trace_id, approve_id, next_steps, space_user_org_info, judge, instance, flow, step, current_user, current_user_info, description, auto_submitted) ->\n\tsetObj = new Object\n\tspace_id = instance.space\n\t# 验证approve的judge是否为空\n\n\tif not judge\n\t\tthrow new Meteor.Error('error!', \"单签结点还未选择处理意见，操作失败\")\n\telse\n\t\tif judge is \"approved\"\n\t\t\t# 验证next_steps.step是否合法,判断next_steps.step是否在其中\n\t\t\tnextSteps = uuflowManager.getNextSteps(instance, flow, step, \"approved\")\n\n\t\t\t# 判断next_steps.step是否在nextSteps中,若不在则不合法\n\t\t\t_.each(next_steps, (approve_next_step) ->\n\t\t\t\tif not nextSteps.includes(approve_next_step[\"step\"])\n\t\t\t\t\tthrow new Meteor.Error('error!', \"指定的下一步有误\")\n\t\t\t)\n\t\t\t# 若合法,执行流转\n\t\t\tnext_step_id = next_steps[0][\"step\"]\n\t\t\tnext_step = uuflowManager.getStep(instance, flow, next_step_id)\n\t\t\tnext_step_type = next_step[\"step_type\"]\n\t\t\tnext_step_name = next_step[\"name\"]\n\t\t\t# 判断next_step是否为结束结点\n\t\t\tif next_step_type is \"end\"\n\t\t\t\t# 若是结束结点\n\t\t\t\tinstance_traces = instance.traces\n\t\t\t\ti = 0\n\t\t\t\twhile i < instance_traces.length\n\t\t\t\t\tif instance_traces[i]._id is trace_id\n\t\t\t\t\t\t# 更新当前trace记录\n\t\t\t\t\t\tinstance_traces[i].is_finished = true\n\t\t\t\t\t\tinstance_traces[i].finish_date = new Date\n\t\t\t\t\t\tinstance_traces[i].judge = judge\n\t\t\t\t\t\th = 0\n\t\t\t\t\t\twhile h < instance_traces[i].approves.length\n\t\t\t\t\t\t\tif instance_traces[i].approves[h]._id is approve_id\n\t\t\t\t\t\t\t\t# 更新当前trace.approve记录\n\t\t\t\t\t\t\t\tinstance_traces[i].approves[h].is_finished = true\n\t\t\t\t\t\t\t\tinstance_traces[i].approves[h].handler = current_user\n\t\t\t\t\t\t\t\tinstance_traces[i].approves[h].handler_name = current_user_info.name\n\t\t\t\t\t\t\t\tinstance_traces[i].approves[h].finish_date = new Date\n\t\t\t\t\t\t\t\tinstance_traces[i].approves[h].handler_organization = space_user_org_info[\"organization\"]\n\t\t\t\t\t\t\t\tinstance_traces[i].approves[h].handler_organization_name = space_user_org_info[\"organization_name\"]\n\t\t\t\t\t\t\t\tinstance_traces[i].approves[h].handler_organization_fullname = space_user_org_info[\"organization_fullname\"]\n\t\t\t\t\t\t\t\tinstance_traces[i].approves[h].cost_time = instance_traces[i].approves[h].finish_date - instance_traces[i].approves[h].start_date\n\t\t\t\t\t\t\t\tinstance_traces[i].approves[h].auto_submitted = auto_submitted\n\t\t\t\t\t\t\th++\n\t\t\t\t\ti++\n\n\t\t\t\t# 插入下一步trace记录\n\t\t\t\tnewTrace = new Object\n\t\t\t\tnewTrace._id = new Mongo.ObjectID()._str\n\t\t\t\tnewTrace.instance = instance_id\n\t\t\t\tnewTrace.previous_trace_ids = [trace_id]\n\t\t\t\tnewTrace.is_finished = true\n\t\t\t\tnewTrace.step = next_step_id\n\t\t\t\tnewTrace.name = next_step_name\n\t\t\t\tnewTrace.start_date = new Date\n\t\t\t\tnewTrace.finish_date = new Date\n\n\t\t\t\t# 更新instance记录\n\t\t\t\tsetObj.state = \"completed\"\n\t\t\t\tsetObj.final_decision = judge\n\t\t\t\tsetObj.modified = new Date\n\t\t\t\tsetObj.modified_by = current_user\n\t\t\t\tsetObj.values = uuflowManager.getUpdatedValues(uuflowManager.getInstance(instance_id))\n\t\t\t\tinstance.values = setObj.values\n\t\t\t\tsetObj.name = uuflowManager.getInstanceName(instance)\n\n\t\t\t\tinstance_trace = _.find(instance_traces, (trace) ->\n\t\t\t\t\treturn trace._id is trace_id\n\t\t\t\t)\n\t\t\t\ttrace_approve = _.find(instance_trace.approves, (approve) ->\n\t\t\t\t\treturn approve._id is approve_id\n\t\t\t\t)\n\t\t\t\toutbox_users = instance.outbox_users\n\t\t\t\toutbox_users.unshift(trace_approve.handler)\n\t\t\t\toutbox_users.unshift(trace_approve.user)\n\t\t\t\tsetObj.outbox_users = _.uniq(outbox_users)\n\t\t\t\tinstance_traces.push(newTrace)\n\t\t\t\tsetObj.traces = instance_traces\n\t\t\t\tsetObj.inbox_users = []\n\t\t\t\tsetObj.finish_date = new Date\n\n\t\t\t\tif instance.cc_users\n\t\t\t\t\tsetObj.cc_users = instance.cc_users\n\n\t\t\t\tsetObj.current_step_name = next_step_name\n\t\t\t\tsetObj.current_step_auto_submit = false\n\t\t\telse\n\t\t\t\t# 若不是结束结点\n\t\t\t\t# 先判断nextsteps.step.users是否为空\n\t\t\t\tnext_step_users = next_steps[0][\"users\"]\n\t\t\t\tif next_step_users is null or next_step_users.length is 0\n\t\t\t\t\tthrow new Meteor.Error('error!', \"未指定下一步处理人\")\n\t\t\t\telse\n\t\t\t\t\tif next_step_users.length > 1 and next_step[\"step_type\"] isnt \"counterSign\"\n\t\t\t\t\t\tthrow new Meteor.Error('error!', \"不能指定多个处理人\")\n\t\t\t\t\telse\n\t\t\t\t\t\t# 验证next_user是否合法，调用getHandlersManager.getHandlers(:instance_id,当前trace对应的step_id),判断next_user是否在其返回的结果中\n\t\t\t\t\t\tnext_user_ids = getHandlersManager.getHandlers(instance_id, next_step_id, current_user)\n\t\t\t\t\t\tif !uuflowManager.checkNestStepUsersIsValid(next_step_users, next_user_ids, next_step)\n\t\t\t\t\t\t\tthrow new Meteor.Error('error!', \"指定的下一步处理人有误\")\n\t\t\t\t\t\telse\n\t\t\t\t\t\t\t# 若合法，执行流转操作\n\t\t\t\t\t\t\tinstance_traces = instance.traces\n\t\t\t\t\t\t\ti = 0\n\t\t\t\t\t\t\twhile i < instance_traces.length\n\t\t\t\t\t\t\t\tif instance_traces[i]._id is trace_id\n\t\t\t\t\t\t\t\t\t# 更新当前trace记录\n\t\t\t\t\t\t\t\t\tinstance_traces[i].is_finished = true\n\t\t\t\t\t\t\t\t\tinstance_traces[i].finish_date = new Date\n\t\t\t\t\t\t\t\t\tinstance_traces[i].judge = judge\n\t\t\t\t\t\t\t\t\th = 0\n\t\t\t\t\t\t\t\t\twhile h < instance_traces[i].approves.length\n\t\t\t\t\t\t\t\t\t\tif instance_traces[i].approves[h]._id is approve_id\n\t\t\t\t\t\t\t\t\t\t\t# 更新当前trace.approve记录\n\t\t\t\t\t\t\t\t\t\t\tinstance_traces[i].approves[h].is_finished = true\n\t\t\t\t\t\t\t\t\t\t\tinstance_traces[i].approves[h].handler = current_user\n\t\t\t\t\t\t\t\t\t\t\tinstance_traces[i].approves[h].handler_name = current_user_info.name\n\t\t\t\t\t\t\t\t\t\t\tinstance_traces[i].approves[h].finish_date = new Date\n\t\t\t\t\t\t\t\t\t\t\tinstance_traces[i].approves[h].handler_organization = space_user_org_info[\"organization\"]\n\t\t\t\t\t\t\t\t\t\t\tinstance_traces[i].approves[h].handler_organization_name = space_user_org_info[\"organization_name\"]\n\t\t\t\t\t\t\t\t\t\t\tinstance_traces[i].approves[h].handler_organization_fullname = space_user_org_info[\"organization_fullname\"]\n\t\t\t\t\t\t\t\t\t\t\tinstance_traces[i].approves[h].cost_time = instance_traces[i].approves[h].finish_date - instance_traces[i].approves[h].start_date\n\t\t\t\t\t\t\t\t\t\t\tinstance_traces[i].approves[h].auto_submitted = auto_submitted\n\t\t\t\t\t\t\t\t\t\th++\n\t\t\t\t\t\t\t\ti++\n\n\t\t\t\t\t\t\t# 插入下一步trace记录\n\t\t\t\t\t\t\tnewTrace = new Object\n\t\t\t\t\t\t\tnewTrace._id = new Mongo.ObjectID()._str\n\t\t\t\t\t\t\tnewTrace.instance = instance_id\n\t\t\t\t\t\t\tnewTrace.previous_trace_ids = [trace_id]\n\t\t\t\t\t\t\tnewTrace.is_finished = false\n\t\t\t\t\t\t\tnewTrace.step = next_step_id\n\t\t\t\t\t\t\tnewTrace.name = next_step_name\n\t\t\t\t\t\t\tnewTrace.start_date = new Date\n\t\t\t\t\t\t\tnewTrace.due_date = uuflowManager.getDueDate(next_step.timeout_hours, space_id)\n\t\t\t\t\t\t\tnewTrace.approves = new Array\n\n\t\t\t\t\t\t\tupdated_values = uuflowManager.getUpdatedValues(uuflowManager.getInstance(instance_id))\n\t\t\t\t\t\t\t_.each next_step_users, (next_step_user_id, idx) ->\n\t\t\t\t\t\t\t\t# 插入下一步trace.approve记录\n\t\t\t\t\t\t\t\tnewApprove = new Object\n\t\t\t\t\t\t\t\tnewApprove._id = new Mongo.ObjectID()._str\n\t\t\t\t\t\t\t\tnewApprove.instance = instance_id\n\t\t\t\t\t\t\t\tnewApprove.trace = newTrace._id\n\t\t\t\t\t\t\t\tnewApprove.is_finished = false\n\t\t\t\t\t\t\t\tnewApprove.user = next_step_user_id\n\n\t\t\t\t\t\t\t\tuser_info = db.users.findOne({ _id: next_step_user_id }, { fields: { name: 1 } })\n\t\t\t\t\t\t\t\tnewApprove.user_name = user_info.name\n\n\t\t\t\t\t\t\t\thandler_id = next_step_user_id\n\t\t\t\t\t\t\t\thandler_info = user_info\n\t\t\t\t\t\t\t\tagent = uuflowManager.getAgent(space_id, next_step_user_id)\n\t\t\t\t\t\t\t\tif agent\n\t\t\t\t\t\t\t\t\tnext_step_users[idx] = agent\n\t\t\t\t\t\t\t\t\thandler_id = agent\n\t\t\t\t\t\t\t\t\thandler_info = db.users.findOne({ _id: agent }, { fields: { name: 1 } })\n\t\t\t\t\t\t\t\t\tnewApprove.agent = agent\n\n\t\t\t\t\t\t\t\tnewApprove.handler = handler_id\n\t\t\t\t\t\t\t\tnewApprove.handler_name = handler_info.name\n\n\t\t\t\t\t\t\t\tnext_step_space_user = db.space_users.findOne({\n\t\t\t\t\t\t\t\t\tspace: space_id,\n\t\t\t\t\t\t\t\t\tuser: handler_id\n\t\t\t\t\t\t\t\t})\n\t\t\t\t\t\t\t\t# 获取next_step_user所在的部门信息\n\t\t\t\t\t\t\t\tnext_step_user_org_info = uuflowManager.getSpaceUserOrgInfo(next_step_space_user)\n\t\t\t\t\t\t\t\tnewApprove.handler_organization = next_step_user_org_info[\"organization\"]\n\t\t\t\t\t\t\t\tnewApprove.handler_organization_name = next_step_user_org_info[\"organization_name\"]\n\t\t\t\t\t\t\t\tnewApprove.handler_organization_fullname = next_step_user_org_info[\"organization_fullname\"]\n\t\t\t\t\t\t\t\tnewApprove.start_date = new Date\n\t\t\t\t\t\t\t\tnewApprove.due_date = newTrace.due_date\n\t\t\t\t\t\t\t\tnewApprove.is_read = false\n\t\t\t\t\t\t\t\tnewApprove.is_error = false\n\t\t\t\t\t\t\t\tnewApprove.values = new Object\n\t\t\t\t\t\t\t\tuuflowManager.setRemindInfo(updated_values, newApprove)\n\t\t\t\t\t\t\t\tnewTrace.approves.push(newApprove)\n\n\t\t\t\t\t\t\t# 更新instance记录\n\t\t\t\t\t\t\tsetObj.final_decision = judge\n\t\t\t\t\t\t\tsetObj.modified = new Date\n\t\t\t\t\t\t\tsetObj.modified_by = current_user\n\t\t\t\t\t\t\tsetObj.values = updated_values\n\t\t\t\t\t\t\tinstance.values = setObj.values\n\t\t\t\t\t\t\tsetObj.name = uuflowManager.getInstanceName(instance)\n\n\t\t\t\t\t\t\tinstance_trace = _.find(instance_traces, (trace) ->\n\t\t\t\t\t\t\t\treturn trace._id is trace_id\n\t\t\t\t\t\t\t)\n\t\t\t\t\t\t\ttrace_approve = _.find(instance_trace.approves, (approve) ->\n\t\t\t\t\t\t\t\treturn approve._id is approve_id\n\t\t\t\t\t\t\t)\n\t\t\t\t\t\t\toutbox_users = instance.outbox_users\n\t\t\t\t\t\t\toutbox_users.unshift(trace_approve.user)\n\t\t\t\t\t\t\toutbox_users.unshift(trace_approve.handler)\n\t\t\t\t\t\t\tsetObj.outbox_users = _.uniq(outbox_users)\n\t\t\t\t\t\t\tsetObj.inbox_users = next_step_users\n\t\t\t\t\t\t\tinstance_traces.push(newTrace)\n\t\t\t\t\t\t\tsetObj.traces = instance_traces\n\n\t\t\t\t\t\t\tsetObj.state = \"pending\"\n\t\t\t\t\t\t\tif instance.cc_users\n\t\t\t\t\t\t\t\tsetObj.cc_users = instance.cc_users\n\n\t\t\t\t\t\t\tsetObj.current_step_name = next_step_name\n\n\t\t\t\t\t\t\tsetObj.current_step_auto_submit = uuflowManager.getCurrentStepAutoSubmit(flow.timeout_auto_submit, next_step.lines)\n\t\telse if judge is \"rejected\"\n\t\t\tif not description\n\t\t\t\tthrow new Meteor.Error('error!', \"请填写驳回理由\")\n\t\t\telse\n\t\t\t\t# 验证next_steps.step是否合法,判断next_steps.step是否在其中\n\t\t\t\tnextSteps = uuflowManager.getNextSteps(instance, flow, step, \"rejected\")\n\t\t\t\t# 判断next_steps.step是否在nextSteps中,若不在则不合法\n\t\t\t\t_.each next_steps, (approve_next_step) ->\n\t\t\t\t\tif not nextSteps.includes(approve_next_step[\"step\"])\n\t\t\t\t\t\tthrow new Meteor.Error('error!', \"指定的下一步有误\")\n\t\t\t\t# 若合法,执行流转\n\t\t\t\tnext_step_id = next_steps[0][\"step\"]\n\t\t\t\tnext_step = uuflowManager.getStep(instance, flow, next_step_id)\n\t\t\t\tnext_step_type = next_step[\"step_type\"]\n\t\t\t\tnext_step_name = next_step[\"name\"]\n\t\t\t\t# 判断next_step是否为结束结点\n\t\t\t\tif next_step_type is \"end\"\n\t\t\t\t\t# 若是结束结点\n\t\t\t\t\tinstance_traces = instance.traces\n\t\t\t\t\ti = 0\n\t\t\t\t\twhile i < instance_traces.length\n\t\t\t\t\t\tif instance_traces[i]._id is trace_id\n\t\t\t\t\t\t\t# 更新当前trace记录\n\t\t\t\t\t\t\tinstance_traces[i].is_finished = true\n\t\t\t\t\t\t\tinstance_traces[i].finish_date = new Date\n\t\t\t\t\t\t\tinstance_traces[i].judge = judge\n\t\t\t\t\t\t\th = 0\n\t\t\t\t\t\t\twhile h < instance_traces[i].approves.length\n\t\t\t\t\t\t\t\tif instance_traces[i].approves[h]._id is approve_id\n\t\t\t\t\t\t\t\t\t# 更新当前trace.approve记录\n\t\t\t\t\t\t\t\t\tinstance_traces[i].approves[h].is_finished = true\n\t\t\t\t\t\t\t\t\tinstance_traces[i].approves[h].handler = current_user\n\t\t\t\t\t\t\t\t\tinstance_traces[i].approves[h].handler_name = current_user_info.name\n\t\t\t\t\t\t\t\t\tinstance_traces[i].approves[h].finish_date = new Date\n\t\t\t\t\t\t\t\t\tinstance_traces[i].approves[h].handler_organization = space_user_org_info[\"organization\"]\n\t\t\t\t\t\t\t\t\tinstance_traces[i].approves[h].handler_organization_name = space_user_org_info[\"organization_name\"]\n\t\t\t\t\t\t\t\t\tinstance_traces[i].approves[h].handler_organization_fullname = space_user_org_info[\"organization_fullname\"]\n\t\t\t\t\t\t\t\t\tinstance_traces[i].approves[h].cost_time = instance_traces[i].approves[h].finish_date - instance_traces[i].approves[h].start_date\n\t\t\t\t\t\t\t\t\tinstance_traces[i].approves[h].auto_submitted = auto_submitted\n\t\t\t\t\t\t\t\th++\n\t\t\t\t\t\ti++\n\n\t\t\t\t\t# 插入下一步trace记录\n\t\t\t\t\tnewTrace = new Object\n\t\t\t\t\tnewTrace._id = new Mongo.ObjectID()._str\n\t\t\t\t\tnewTrace.instance = instance_id\n\t\t\t\t\tnewTrace.previous_trace_ids = [trace_id]\n\t\t\t\t\tnewTrace.is_finished = true\n\t\t\t\t\tnewTrace.step = next_step_id\n\t\t\t\t\tnewTrace.name = next_step_name\n\t\t\t\t\tnewTrace.start_date = new Date\n\t\t\t\t\tnewTrace.finish_date = new Date\n\n\t\t\t\t\t# 更新instance记录\n\t\t\t\t\tsetObj.state = \"completed\"\n\t\t\t\t\tsetObj.final_decision = judge\n\t\t\t\t\tsetObj.modified = new Date\n\t\t\t\t\tsetObj.modified_by = current_user\n\t\t\t\t\tsetObj.values = uuflowManager.getUpdatedValues(uuflowManager.getInstance(instance_id))\n\t\t\t\t\tinstance.values = setObj.values\n\t\t\t\t\tsetObj.name = uuflowManager.getInstanceName(instance)\n\n\t\t\t\t\tinstance_trace = _.find(instance_traces, (trace) ->\n\t\t\t\t\t\treturn trace._id is trace_id\n\t\t\t\t\t)\n\t\t\t\t\ttrace_approve = _.find(instance_trace.approves, (approve) ->\n\t\t\t\t\t\treturn approve._id is approve_id\n\t\t\t\t\t)\n\t\t\t\t\toutbox_users = instance.outbox_users\n\t\t\t\t\toutbox_users.unshift(trace_approve.handler)\n\t\t\t\t\toutbox_users.unshift(trace_approve.user)\n\t\t\t\t\tsetObj.outbox_users = _.uniq(outbox_users)\n\t\t\t\t\tinstance_traces.push(newTrace)\n\t\t\t\t\tsetObj.traces = instance_traces\n\t\t\t\t\tsetObj.inbox_users = []\n\t\t\t\t\tsetObj.finish_date = new Date\n\n\t\t\t\t\tif instance.cc_users\n\t\t\t\t\t\tsetObj.cc_users = instance.cc_users\n\n\t\t\t\t\tsetObj.current_step_name = next_step_name\n\t\t\t\t\tsetObj.current_step_auto_submit = false\n\t\t\t\telse\n\t\t\t\t\t# 若不是结束结点\n\t\t\t\t\t# 先判断nextsteps.step.users是否为空\n\t\t\t\t\tnext_step_users = next_steps[0][\"users\"]\n\t\t\t\t\tif next_step_users is null or next_step_users.length is 0\n\t\t\t\t\t\tthrow new Meteor.Error('error!', \"未指定下一步处理人\")\n\t\t\t\t\telse\n\t\t\t\t\t\tif next_step_users.length > 1 and next_step[\"step_type\"] isnt \"counterSign\"\n\t\t\t\t\t\t\tthrow new Meteor.Error('error!', \"不能指定多个处理人\")\n\t\t\t\t\t\telse\n\t\t\t\t\t\t\t# 验证next_user是否合法，调用getHandlersManager.getHandlers(:instance_id,当前trace对应的step_id),判断next_user是否在其返回的结果中\n\t\t\t\t\t\t\tnext_user_ids = getHandlersManager.getHandlers(instance_id, next_step_id, current_user)\n\t\t\t\t\t\t\tif !uuflowManager.checkNestStepUsersIsValid(next_step_users, next_user_ids, next_step)\n\t\t\t\t\t\t\t\tthrow new Meteor.Error('error!', \"指定的下一步处理人有误\")\n\t\t\t\t\t\t\telse\n\t\t\t\t\t\t\t\t# 若合法，执行流转操作\n\t\t\t\t\t\t\t\tinstance_traces = instance.traces\n\t\t\t\t\t\t\t\ti = 0\n\t\t\t\t\t\t\t\twhile i < instance_traces.length\n\t\t\t\t\t\t\t\t\tif instance_traces[i]._id is trace_id\n\t\t\t\t\t\t\t\t\t\t# 更新当前trace记录\n\t\t\t\t\t\t\t\t\t\tinstance_traces[i].is_finished = true\n\t\t\t\t\t\t\t\t\t\tinstance_traces[i].finish_date = new Date\n\t\t\t\t\t\t\t\t\t\tinstance_traces[i].judge = judge\n\t\t\t\t\t\t\t\t\t\th = 0\n\t\t\t\t\t\t\t\t\t\twhile h < instance_traces[i].approves.length\n\t\t\t\t\t\t\t\t\t\t\tif instance_traces[i].approves[h]._id is approve_id\n\t\t\t\t\t\t\t\t\t\t\t\t# 更新当前trace.approve记录\n\t\t\t\t\t\t\t\t\t\t\t\tinstance_traces[i].approves[h].is_finished = true\n\t\t\t\t\t\t\t\t\t\t\t\tinstance_traces[i].approves[h].handler = current_user\n\t\t\t\t\t\t\t\t\t\t\t\tinstance_traces[i].approves[h].handler_name = current_user_info.name\n\t\t\t\t\t\t\t\t\t\t\t\tinstance_traces[i].approves[h].finish_date = new Date\n\t\t\t\t\t\t\t\t\t\t\t\tinstance_traces[i].approves[h].handler_organization = space_user_org_info[\"organization\"]\n\t\t\t\t\t\t\t\t\t\t\t\tinstance_traces[i].approves[h].handler_organization_name = space_user_org_info[\"organization_name\"]\n\t\t\t\t\t\t\t\t\t\t\t\tinstance_traces[i].approves[h].handler_organization_fullname = space_user_org_info[\"organization_fullname\"]\n\t\t\t\t\t\t\t\t\t\t\t\tinstance_traces[i].approves[h].cost_time = instance_traces[i].approves[h].finish_date - instance_traces[i].approves[h].start_date\n\t\t\t\t\t\t\t\t\t\t\t\tinstance_traces[i].approves[h].auto_submitted = auto_submitted\n\t\t\t\t\t\t\t\t\t\t\th++\n\t\t\t\t\t\t\t\t\ti++\n\n\t\t\t\t\t\t\t\t# 插入下一步trace记录\n\t\t\t\t\t\t\t\tnewTrace = new Object\n\t\t\t\t\t\t\t\tnewTrace._id = new Mongo.ObjectID()._str\n\t\t\t\t\t\t\t\tnewTrace.instance = instance_id\n\t\t\t\t\t\t\t\tnewTrace.previous_trace_ids = [trace_id]\n\t\t\t\t\t\t\t\tnewTrace.is_finished = false\n\t\t\t\t\t\t\t\tnewTrace.step = next_step_id\n\t\t\t\t\t\t\t\tnewTrace.name = next_step_name\n\t\t\t\t\t\t\t\tnewTrace.start_date = new Date\n\t\t\t\t\t\t\t\tnewTrace.due_date = uuflowManager.getDueDate(next_step.timeout_hours, space_id)\n\t\t\t\t\t\t\t\tnewTrace.approves = new Array\n\n\t\t\t\t\t\t\t\tupdated_values = uuflowManager.getUpdatedValues(uuflowManager.getInstance(instance_id))\n\t\t\t\t\t\t\t\t_.each next_step_users, (next_step_user_id, idx) ->\n\t\t\t\t\t\t\t\t\t# 插入下一步trace.approve记录\n\t\t\t\t\t\t\t\t\tnewApprove = new Object\n\t\t\t\t\t\t\t\t\tnewApprove._id = new Mongo.ObjectID()._str\n\t\t\t\t\t\t\t\t\tnewApprove.instance = instance_id\n\t\t\t\t\t\t\t\t\tnewApprove.trace = newTrace._id\n\t\t\t\t\t\t\t\t\tnewApprove.is_finished = false\n\t\t\t\t\t\t\t\t\tnewApprove.user = next_step_user_id\n\n\t\t\t\t\t\t\t\t\tuser_info = db.users.findOne({ _id: next_step_user_id }, { fields: { name: 1 } })\n\t\t\t\t\t\t\t\t\tnewApprove.user_name = user_info.name\n\n\t\t\t\t\t\t\t\t\thandler_id = next_step_user_id\n\t\t\t\t\t\t\t\t\thandler_info = user_info\n\t\t\t\t\t\t\t\t\tagent = uuflowManager.getAgent(space_id, next_step_user_id)\n\t\t\t\t\t\t\t\t\tif agent\n\t\t\t\t\t\t\t\t\t\tnext_step_users[idx] = agent\n\t\t\t\t\t\t\t\t\t\thandler_id = agent\n\t\t\t\t\t\t\t\t\t\thandler_info = db.users.findOne({ _id: agent }, { fields: { name: 1 } })\n\t\t\t\t\t\t\t\t\t\tnewApprove.agent = agent\n\n\t\t\t\t\t\t\t\t\tnewApprove.handler = handler_id\n\t\t\t\t\t\t\t\t\tnewApprove.handler_name = handler_info.name\n\n\t\t\t\t\t\t\t\t\tnext_step_space_user = db.space_users.findOne({\n\t\t\t\t\t\t\t\t\t\tspace: space_id,\n\t\t\t\t\t\t\t\t\t\tuser: handler_id\n\t\t\t\t\t\t\t\t\t})\n\t\t\t\t\t\t\t\t\t# 获取next_step_user所在的部门信息\n\t\t\t\t\t\t\t\t\tnext_step_user_org_info = uuflowManager.getSpaceUserOrgInfo(next_step_space_user)\n\t\t\t\t\t\t\t\t\tnewApprove.handler_organization = next_step_user_org_info[\"organization\"]\n\t\t\t\t\t\t\t\t\tnewApprove.handler_organization_name = next_step_user_org_info[\"organization_name\"]\n\t\t\t\t\t\t\t\t\tnewApprove.handler_organization_fullname = next_step_user_org_info[\"organization_fullname\"]\n\t\t\t\t\t\t\t\t\tnewApprove.start_date = new Date\n\t\t\t\t\t\t\t\t\tnewApprove.due_date = newTrace.due_date\n\t\t\t\t\t\t\t\t\tnewApprove.is_read = false\n\t\t\t\t\t\t\t\t\tnewApprove.is_error = false\n\t\t\t\t\t\t\t\t\tnewApprove.values = new Object\n\t\t\t\t\t\t\t\t\tuuflowManager.setRemindInfo(updated_values, newApprove)\n\t\t\t\t\t\t\t\t\tnewTrace.approves.push(newApprove)\n\n\t\t\t\t\t\t\t\t# 更新instance记录\n\t\t\t\t\t\t\t\tsetObj.final_decision = judge\n\t\t\t\t\t\t\t\tsetObj.modified = new Date\n\t\t\t\t\t\t\t\tsetObj.modified_by = current_user\n\t\t\t\t\t\t\t\tsetObj.values = updated_values\n\t\t\t\t\t\t\t\tinstance.values = setObj.values\n\t\t\t\t\t\t\t\tsetObj.name = uuflowManager.getInstanceName(instance)\n\n\t\t\t\t\t\t\t\tinstance_trace = _.find(instance_traces, (trace) ->\n\t\t\t\t\t\t\t\t\treturn trace._id is trace_id\n\t\t\t\t\t\t\t\t)\n\t\t\t\t\t\t\t\ttrace_approve = _.find(instance_trace.approves, (approve) ->\n\t\t\t\t\t\t\t\t\treturn approve._id is approve_id\n\t\t\t\t\t\t\t\t)\n\t\t\t\t\t\t\t\toutbox_users = instance.outbox_users\n\t\t\t\t\t\t\t\toutbox_users.unshift(trace_approve.user)\n\t\t\t\t\t\t\t\toutbox_users.unshift(trace_approve.handler)\n\t\t\t\t\t\t\t\tsetObj.outbox_users = _.uniq(outbox_users)\n\t\t\t\t\t\t\t\tsetObj.inbox_users = next_step_users\n\t\t\t\t\t\t\t\tinstance_traces.push(newTrace)\n\t\t\t\t\t\t\t\tsetObj.traces = instance_traces\n\n\t\t\t\t\t\t\t\tsetObj.state = \"pending\"\n\t\t\t\t\t\t\t\tif instance.cc_users\n\t\t\t\t\t\t\t\t\tsetObj.cc_users = instance.cc_users\n\n\t\t\t\t\t\t\t\tsetObj.current_step_name = next_step_name\n\n\t\t\t\t\t\t\t\tsetObj.current_step_auto_submit = uuflowManager.getCurrentStepAutoSubmit(flow.timeout_auto_submit, next_step.lines)\n\n\n\treturn setObj\n\nuuflowManager.engine_step_type_is_counterSign = (instance_id, trace_id, approve_id, next_steps, space_user_org_info, judge, instance, flow, step, current_user, current_user_info, auto_submitted) ->\n\tsetObj = new Object\n\tspace_id = instance.space\n\t# 验证approve的judge是否为空\n\tif not judge\n\t\tthrow new Meteor.Error('error!', \"请选择核准或驳回。\")\n\telse\n\t\tif step.oneClickApproval and ['approved','readed'].includes(judge)\n\t\t\t# 验证next_steps.step是否合法,判断next_steps.step是否在其中\n\t\t\tnextSteps = uuflowManager.getNextSteps(instance, flow, step, \"approved\")\n\t\t\t# 判断next_steps.step是否在nextSteps中,若不在则不合法\n\t\t\t_.each next_steps, (approve_next_step) ->\n\t\t\t\tif not nextSteps.includes(approve_next_step[\"step\"])\n\t\t\t\t\tthrow new Meteor.Error('error!', \"指定的下一步有误\")\n\n\t\t# 若合法,执行流转\n\t\tnext_step_id = next_steps[0][\"step\"]\n\t\tnext_step = uuflowManager.getStep(instance, flow, next_step_id)\n\t\tnext_step_type = next_step[\"step_type\"]\n\t\tnext_step_name = next_step[\"name\"]\n\n\t\tinstance_traces = instance.traces\n\t\tisAllApproveFinished = true\n\t\ti = 0\n\t\twhile i < instance_traces.length\n\t\t\tif instance_traces[i]._id is trace_id\n\t\t\t\th = 0\n\t\t\t\twhile h < instance_traces[i].approves.length\n\t\t\t\t\tif instance_traces[i].approves[h]._id is approve_id or ((step.oneClickApproval and ['approved','readed'].includes(judge)) or (step.oneClickRejection and 'rejected' is judge))\n\t\t\t\t\t\t# 更新当前trace.approve记录\n\t\t\t\t\t\tinstance_traces[i].approves[h].is_finished = true\n\t\t\t\t\t\tinstance_traces[i].approves[h].finish_date = new Date\n\t\t\t\t\t\tinstance_traces[i].approves[h].cost_time = instance_traces[i].approves[h].finish_date - instance_traces[i].approves[h].start_date\n\t\t\t\t\t\tinstance_traces[i].approves[h].auto_submitted = auto_submitted\n\n\t\t\t\t\tif instance_traces[i].approves[h].is_finished is false and instance_traces[i].approves[h].type isnt 'cc' and instance_traces[i].approves[h].type isnt 'distribute'\n\t\t\t\t\t\tisAllApproveFinished = false\n\n\t\t\t\t\th++\n\t\t\ti++\n\n\t\tif isAllApproveFinished is true\n\t\t\ti = 0\n\t\t\twhile i < instance_traces.length\n\t\t\t\tif instance_traces[i]._id is trace_id\n\t\t\t\t\t# 更新当前trace记录\n\t\t\t\t\tinstance_traces[i].is_finished = true\n\t\t\t\t\tinstance_traces[i].finish_date = new Date\n\t\t\t\t\tinstance_traces[i].judge = \"submitted\"\n\t\t\t\ti++\n\n\t\t\t# 判断next_step是否为结束结点\n\t\t\tif next_step_type is \"end\"\n\t\t\t\t# 插入下一步trace记录\n\t\t\t\tnewTrace = new Object\n\t\t\t\tnewTrace._id = new Mongo.ObjectID()._str\n\t\t\t\tnewTrace.instance = instance_id\n\t\t\t\tnewTrace.previous_trace_ids = [trace_id]\n\t\t\t\tnewTrace.is_finished = true\n\t\t\t\tnewTrace.step = next_step_id\n\t\t\t\tnewTrace.name = next_step_name\n\t\t\t\tnewTrace.start_date = new Date\n\t\t\t\tnewTrace.finish_date = new Date\n\t\t\t\t# 更新instance记录\n\t\t\t\tsetObj.state = \"completed\"\n\t\t\t\tsetObj.modified = new Date\n\t\t\t\tsetObj.modified_by = current_user\n\n\t\t\t\tinstance_trace = _.find(instance_traces, (trace) ->\n\t\t\t\t\treturn trace._id is trace_id\n\t\t\t\t)\n\n\t\t\t\toutbox_users = instance.outbox_users\n\t\t\t\t_.each instance_trace.approves, (appro) ->\n\t\t\t\t\toutbox_users.push appro.user\n\t\t\t\t\toutbox_users.push appro.handler\n\n\t\t\t\tsetObj.outbox_users = _.uniq(outbox_users)\n\t\t\t\tsetObj.inbox_users = new Array\n\t\t\t\tinstance_traces.push(newTrace)\n\t\t\t\tsetObj.traces = instance_traces\n\t\t\t\tsetObj.finish_date = new Date\n\n\t\t\t\tupdated_values = uuflowManager.getUpdatedValues(uuflowManager.getInstance(instance_id), approve_id)\n\t\t\t\tsetObj.values = updated_values\n\t\t\t\tsetObj.name = uuflowManager.getInstanceName(instance)\n\t\t\t\tif instance.cc_users\n\t\t\t\t\tsetObj.cc_users = instance.cc_users\n\n\t\t\t\tsetObj.current_step_name = next_step_name\n\t\t\t\tfinal_decision = ''\n\t\t\t\tif step.oneClickApproval and ['approved','readed'].includes(judge)\n\t\t\t\t\t# 如果开启了一键核准并且选择了核准则设置final_decision为approved\n\t\t\t\t\tfinal_decision = 'approved'\n\t\t\t\telse if step.oneClickRejection and 'rejected' is judge\n\t\t\t\t\t# 如果开启了一键驳回并且选择了驳回则设置final_decision为rejected\n\t\t\t\t\tfinal_decision = 'rejected'\n\t\t\t\tsetObj.final_decision = final_decision || 'approved' # 会签到结束默认为approved\n\t\t\t\tsetObj.current_step_auto_submit = false\n\t\t\telse\n\t\t\t\t# 若不是结束结点\n\t\t\t\t# 先判断nextsteps.step.users是否为空\n\t\t\t\tnext_step_users = next_steps[0][\"users\"]\n\t\t\t\tif next_step_users is null or next_step_users.length is 0\n\t\t\t\t\tthrow new Meteor.Error('error!', \"未指定下一步处理人\")\n\t\t\t\telse\n\t\t\t\t\tif next_step_users.length > 1 and next_step[\"step_type\"] isnt \"counterSign\"\n\t\t\t\t\t\tthrow new Meteor.Error('error!', \"不能指定多个处理人\")\n\t\t\t\t\telse\n\t\t\t\t\t\t# 验证next_user是否合法，调用getHandlersManager.getHandlers(:instance_id,当前trace对应的step_id),判断next_user是否在其返回的结果中\n\t\t\t\t\t\tnext_user_ids = getHandlersManager.getHandlers(instance_id, next_step_id, current_user)\n\t\t\t\t\t\tif !uuflowManager.checkNestStepUsersIsValid(next_step_users, next_user_ids, next_steps)\n\t\t\t\t\t\t\tthrow new Meteor.Error('error!', \"指定的下一步处理人有误\")\n\t\t\t\t\t\telse\n\t\t\t\t\t\t\t# 插入下一步trace记录\n\t\t\t\t\t\t\tnewTrace = new Object\n\t\t\t\t\t\t\tnewTrace._id = new Mongo.ObjectID()._str\n\t\t\t\t\t\t\tnewTrace.instance = instance_id\n\t\t\t\t\t\t\tnewTrace.previous_trace_ids = [trace_id]\n\t\t\t\t\t\t\tnewTrace.is_finished = false\n\t\t\t\t\t\t\tnewTrace.step = next_step_id\n\t\t\t\t\t\t\tnewTrace.name = next_step_name\n\t\t\t\t\t\t\tnewTrace.start_date = new Date\n\t\t\t\t\t\t\tnewTrace.due_date = uuflowManager.getDueDate(next_step.timeout_hours, space_id)\n\t\t\t\t\t\t\tnewTrace.approves = new Array\n\t\t\t\t\t\t\t_.each next_step_users, (next_step_user_id, idx) ->\n\t\t\t\t\t\t\t\t# 插入下一步trace.approve记录\n\t\t\t\t\t\t\t\tnewApprove = new Object\n\t\t\t\t\t\t\t\tnewApprove._id = new Mongo.ObjectID()._str\n\t\t\t\t\t\t\t\tnewApprove.instance = instance_id\n\t\t\t\t\t\t\t\tnewApprove.trace = newTrace._id\n\t\t\t\t\t\t\t\tnewApprove.is_finished = false\n\t\t\t\t\t\t\t\tnewApprove.user = next_step_user_id\n\n\t\t\t\t\t\t\t\tuser_info = db.users.findOne({ _id: next_step_user_id }, { fields: { name: 1 } })\n\t\t\t\t\t\t\t\tnewApprove.user_name = user_info.name\n\n\t\t\t\t\t\t\t\thandler_id = next_step_user_id\n\t\t\t\t\t\t\t\thandler_info = user_info\n\t\t\t\t\t\t\t\tagent = uuflowManager.getAgent(space_id, next_step_user_id)\n\t\t\t\t\t\t\t\tif agent\n\t\t\t\t\t\t\t\t\tnext_step_users[idx] = agent\n\t\t\t\t\t\t\t\t\thandler_id = agent\n\t\t\t\t\t\t\t\t\thandler_info = db.users.findOne({ _id: agent }, { fields: { name: 1 } })\n\t\t\t\t\t\t\t\t\tnewApprove.agent = agent\n\n\t\t\t\t\t\t\t\tnewApprove.handler = handler_id\n\t\t\t\t\t\t\t\tnewApprove.handler_name = handler_info.name\n\n\t\t\t\t\t\t\t\tnext_step_space_user = db.space_users.findOne({\n\t\t\t\t\t\t\t\t\tspace: space_id,\n\t\t\t\t\t\t\t\t\tuser: handler_id\n\t\t\t\t\t\t\t\t})\n\t\t\t\t\t\t\t\t# 获取next_step_user所在的部门信息\n\t\t\t\t\t\t\t\tnext_step_user_org_info = uuflowManager.getSpaceUserOrgInfo(next_step_space_user)\n\t\t\t\t\t\t\t\tnewApprove.handler_organization = next_step_user_org_info[\"organization\"]\n\t\t\t\t\t\t\t\tnewApprove.handler_organization_name = next_step_user_org_info[\"organization_name\"]\n\t\t\t\t\t\t\t\tnewApprove.handler_organization_fullname = next_step_user_org_info[\"organization_fullname\"]\n\t\t\t\t\t\t\t\tnewApprove.start_date = new Date\n\t\t\t\t\t\t\t\tnewApprove.due_date = newTrace.due_date\n\t\t\t\t\t\t\t\tnewApprove.is_read = false\n\t\t\t\t\t\t\t\tnewApprove.is_error = false\n\t\t\t\t\t\t\t\tnewApprove.values = new Object\n\t\t\t\t\t\t\t\tuuflowManager.setRemindInfo(instance.values, newApprove)\n\t\t\t\t\t\t\t\tnewTrace.approves.push(newApprove)\n\n\t\t\t\t\t\t\t# 更新instance记录\n\t\t\t\t\t\t\tsetObj.modified = new Date\n\t\t\t\t\t\t\tsetObj.modified_by = current_user\n\n\t\t\t\t\t\t\tinstance_trace = _.find(instance_traces, (trace) ->\n\t\t\t\t\t\t\t\treturn trace._id is trace_id\n\t\t\t\t\t\t\t)\n\t\t\t\t\t\t\toutbox_users = instance.outbox_users\n\t\t\t\t\t\t\t_.each instance_trace.approves, (appro) ->\n\t\t\t\t\t\t\t\toutbox_users.push appro.user\n\t\t\t\t\t\t\t\toutbox_users.push appro.handler\n\n\t\t\t\t\t\t\tsetObj.outbox_users = _.uniq(outbox_users)\n\t\t\t\t\t\t\tsetObj.inbox_users = next_step_users\n\t\t\t\t\t\t\tinstance_traces.push(newTrace)\n\t\t\t\t\t\t\tsetObj.traces = instance_traces\n\n\t\t\t\t\t\t\tsetObj.state = \"pending\"\n\n\t\t\t\t\t\t\tupdated_values = uuflowManager.getUpdatedValues(uuflowManager.getInstance(instance_id), approve_id)\n\t\t\t\t\t\t\tsetObj.values = updated_values\n\t\t\t\t\t\t\tsetObj.name = uuflowManager.getInstanceName(instance)\n\t\t\t\t\t\t\tif instance.cc_users\n\t\t\t\t\t\t\t\tsetObj.cc_users = instance.cc_users\n\n\t\t\t\t\t\t\tsetObj.current_step_name = next_step_name\n\t\t\t\t\t\t\tsetObj.current_step_auto_submit = uuflowManager.getCurrentStepAutoSubmit(flow.timeout_auto_submit, next_step.lines)\n\t\telse\n\t\t\t# 当前trace未结束\n\t\t\tinstance_trace = _.find(instance_traces, (trace) ->\n\t\t\t\treturn trace._id is trace_id\n\t\t\t)\n\t\t\ttrace_approve = _.find(instance_trace.approves, (approve) ->\n\t\t\t\treturn approve._id is approve_id\n\t\t\t)\n\t\t\tinstance.outbox_users.unshift(trace_approve.handler)\n\t\t\tsetObj.outbox_users = instance.outbox_users\n\n\t\t\tinstance.inbox_users.splice(instance.inbox_users.indexOf(trace_approve.handler), 1)\n\n\t\t\tsetObj.inbox_users = instance.inbox_users\n\t\t\tsetObj.modified = new Date\n\t\t\tsetObj.modified_by = current_user\n\n\t\t\tsetObj.traces = instance_traces\n\n\t\t\tsetObj.state = \"pending\"\n\n\t\t\tupdated_values = uuflowManager.getUpdatedValues(uuflowManager.getInstance(instance_id), approve_id)\n\t\t\tsetObj.values = updated_values\n\t\t\tsetObj.name = uuflowManager.getInstanceName(instance)\n\t\t\tif instance.cc_users\n\t\t\t\tsetObj.cc_users = instance.cc_users\n\n\treturn setObj\n\n# 生成HTML格式只读表单和签核历程, 由于此方法生成的html数据会作为邮件内容发送，为了再邮件中样式显示正常，\n# 请不要写单独的css，所有样式请写在html标签的style属性中。\nuuflowManager.ins_html = (current_user_info, ins) ->\n\toptions = { templateName: 'table', showTrace: true, showAttachments: false, tagger: 'email' }\n\toptions.width = \"765px\" #此处宽度不能设置为偶数，否则会引起子表与主表线条对不齐的bug\n\toptions.styles = \"\n\t\tbody {\n\t\t  background: #ffffff !important;\n\t\t}.steedos .pull-right {\n\t\t\tfloat: right !important;\n\t\t}.steedos .inline-left{\n\t\t\tdisplay: inline;float: left;\n\t\t}.steedos .inline-right{\n\t\t\tdisplay: inline;float: right;\n\t\t}.steedos .no-border{\n\t\t  border: 0px;\n\t\t}.steedos .no-border td{\n\t\t  border: 0px;\n\t\t}.steedos tr:nth-child(2) td{\n\t\t  border-top: 0px !important;\n\t\t}.steedos .ins_applicant{\n\t\t  display: inline;\n\t\t  background: transparent !important;\n\t\t  border: none;\n\t\t}.steedos .instance-name{\n\t\t  width: #{options.width} !important;\n\t\t}.steedos table {\n\t\t  border-spacing: 0;\n\t\t  border-collapse: collapse;\n\t\t}.steedos .box {\n\t\t  background: #ffffff;\n\t\t}.steedos .form-table {\n\t\t  width: #{options.width};\n\t\t  border: solid 2px #000000;\n\t\t  border-collapse: collapse;\n\t\t  table-layout: fixed;\n\t\t}.steedosTable-item-field{\n\t\t\tpadding: 5px;\n\t\t}.steedos td{\n\t\t  border: solid 1px #000000;\n\t\t  border-collapse: collapse;\n\t\t}.steedos th {\n\t\t  border: 0px;\n\t\t  border-collapse: collapse;\n\t\t  padding: 0px;\n\t\t}.steedos .td-title{\n\t\t  padding: 4px 12px;\n\t\t}.steedos .td-field {\n\t\t  padding: 4px 12px;\n\t\t}.instance-view .instance-name {\n\t\t  text-align: center;\n\t\t  font-weight: bolder;\n\t\t}.td-childfield {\n\t\t  border-top: solid 1px #000000;\n\t\t  border-right: solid 1px #000000;\n\t\t  border-bottom: solid 1px #000000;\n\t\t  padding: 0px;\n\t\t}.panel-heading{\n\t\t  padding: 4px 12px;\n\t\t  font-weight: bold;\n\t\t  color: #333;\n\t\t  background-color: #f5f5f5;\n\t\t}.table-bordered tr:last-child th {\n\t\t  border-bottom: none;\n\t\t}.table-bordered tr:last-child td {\n\t\t  border-bottom: none;\n\t\t}.steedos-table th:first-child{\n\t\t  border-left: 0px !important;\n\t\t}.steedos-table td:first-child {\n\t\t  border-left: 0px !important;\n\t\t}.steedos-table table thead .title {\n\t\t  min-width: 50px;\n\t\t}.steedos-table th:last-child{\n\t\t  border-right: 0px !important;\n\t\t}.steedos-table td:last-child {\n\t\t  border-right: 0px !important;\n\t\t}.steedos-table table .number {\n\t\t  text-align: right;\n\t\t}.callout-default{\n\t\t  border-color: #D2D6DE;\n\t\t  color: #333;\n\t\t  background-color: #F1F1F1;\n\t\t  font-weight: bold;\n\t\t}.instance-table .callout {\n\t\t  margin: 0px;\n\t\t  padding: 4px 12px;\n\t\t  border-radius: 0px;\n\t\t  border-left: none;\n\t\t}.approved{\n\t\t\tcolor: green;\n\t\t}.rejected{\n\t\t\tcolor: red;\n\t\t}.terminated{\n\t\t\tcolor: black;\n\t\t}.reassigned{\n\t\t\tcolor: black;\n\t\t}.retrieved{\n\t\t\tcolor: black;\n\t\t}.trace-approve-talbe td {\n    \t\ttext-align: left;\n    \t\tborder: none;\n\t\t}.traces td table {\n   \t\t\twidth: 100%;\n\t\t}.approve-item .name{\n\t\t\twidth: 40%;\n\t\t}.approve-item .finish-date{\n\t\t\twidth: 35%;\n\t\t}.td-stepname{\n\t\t\tpadding: 4px 12px;\n\t\t}.td-approve td{\n\t\t\tpadding: 4px 12px;\n\t\t}.applicant-wrapper {\n    \t\tfont-weight: bolder;\n\t\t}\n\t\"\n\n\tinstanceHtml = InstanceReadOnlyTemplate.getInstanceHtml(current_user_info, ins.space, ins, options)\n\n#\t处理outlook 中，对部分css不支持的处理\n\tinstanceHtml = instanceHtml.replace('style=\"width: 100%;display: inline-table;\"', 'style=\"border:0px;text-align: center;width:765px;\"')\n\n\tinstanceHtml = instanceHtml.replace('class=\"instance-table-name-td\"', 'class=\"instance-table-name-td\" style=\"width:' + options.width + ';border:0px\"')\n#\tinstanceHtml = instanceHtml.replace('class=\"instance-table-wrapper-td\"', 'class=\"instance-table-wrapper-td\" style=\"width:' + options.width + ';border:0px\"')\n\n\tinstanceHtml = instanceHtml.replace('class=\"instance-name\"', 'class=\"instance-name\" style=\"width:' + options.width + '\"')\n\tinstanceHtml = instanceHtml.replace('class=\"table-page-body form-table\"', 'class=\"table-page-body form-table\" style=\"width:' + options.width + '\"')\n\tinstanceHtml = instanceHtml.replace('class=\"table table-condensed traces\"', 'class=\"table table-condensed traces\" style=\"width:' + options.width + ';border:solid 2.0px #000000\"')\n\n\tinstanceHtml = instanceHtml.replace('class=\"table-page-footer form-table no-border\"', 'class=\"table-page-footer form-table no-border\" style=\"border:0px;width:765px;\"')\n\n\tinstanceHtml = instanceHtml.replace(/class=\"td-title \"/g, 'class=\"td-title\" style=\"width:14%\"')\n\tinstanceHtml = instanceHtml.replace(/class=\"td-stepname\"/g, 'class=\"td-stepname\" style=\"width:' + 765 * 20 / 100 + 'px\"')\n\n\tinstanceHtml = instanceHtml.replace(/class=\"td-childfield\"/g, 'class=\"td-childfield\" style=\"padding:0px\"')\n\n\tinstanceHtml = instanceHtml.replace(/class=\"status approved\"/g, 'class=\"status approved\" style=\"color: green;\"')\n\tinstanceHtml = instanceHtml.replace(/class=\"status rejected\"/g, 'class=\"status rejected\" style=\"color: red;\"')\n\n\tinstanceHtml = instanceHtml.replace(/<table>/g, '<table style=\"width:100%;border:none\">')\n\tinstanceHtml = instanceHtml.replace(/<td class=\"name\">/g, '<td class=\"name\" style=\"width: 40%;\">')\n\tinstanceHtml = instanceHtml.replace(/<td class=\"finish-date\">/g, '<td class=\"finish-date\" style=\"width: 35%;\">')\n\n\tinstanceHtml = instanceHtml.replace(/inline-left'/g, \"inline-left' style='display: inline;float: left;'\")\n\tinstanceHtml = instanceHtml.replace(/inline-right'/g, \"inline-right' style='display: inline;float: right;'\")\n\tinstanceHtml = instanceHtml.replace(/pull-right'/g, \"pull-right' style='float: right;'\")\n\n\n\treturn instanceHtml\n\nuuflowManager.getFlowCompanyId = (flowId)->\n\treturn db.flows.findOne(flowId, { fields: { company_id: 1 } })?.company_id\n\nuuflowManager.create_instance = (instance_from_client, user_info) ->\n\tspace_id = instance_from_client[\"space\"]\n\tflow_id = instance_from_client[\"flow\"]\n\tinstance_flow_version = instance_from_client[\"flow_version\"]\n\tuser_id = user_info._id\n\t# 获取前台所传的trace\n\ttrace_from_client = null\n\t# 获取前台所传的approve\n\tapprove_from_client = null\n\tif instance_from_client[\"traces\"] and instance_from_client[\"traces\"][0]\n\t\ttrace_from_client = instance_from_client[\"traces\"][0]\n\t\tif trace_from_client[\"approves\"] and trace_from_client[\"approves\"][0]\n\t\t\tapprove_from_client = instance_from_client[\"traces\"][0][\"approves\"][0]\n\n\t# 获取一个space\n\tspace = uuflowManager.getSpace(space_id)\n\t# 获取一个flow\n\tflow = uuflowManager.getFlow(flow_id)\n\t# 获取一个space下的一个user\n\tspace_user = uuflowManager.getSpaceUser(space_id, user_id)\n\t# 获取space_user所在的部门信息\n\tspace_user_org_info = uuflowManager.getSpaceUserOrgInfo(space_user)\n\t# 判断一个flow是否为启用状态\n\tuuflowManager.isFlowEnabled(flow)\n\t# 判断一个flow和space_id是否匹配\n\tuuflowManager.isFlowSpaceMatched(flow, space_id)\n\n\tform = uuflowManager.getForm(flow.form)\n\n\tpermissions = permissionManager.getFlowPermissions(flow_id, user_id)\n\n\tif not permissions.includes(\"add\")\n\t\tthrow new Meteor.Error('error!', \"当前用户没有此流程的新建权限\")\n\n\tnow = new Date\n\tins_obj = {}\n\tins_obj._id = db.instances._makeNewID()\n\tins_obj.space = space_id\n\tins_obj.flow = flow_id\n\tins_obj.flow_version = flow.current._id\n\tins_obj.form = flow.form\n\tins_obj.form_version = flow.current.form_version\n\tins_obj.name = flow.name\n\tins_obj.submitter = user_id\n\tins_obj.submitter_name = user_info.name\n\tins_obj.applicant = if instance_from_client[\"applicant\"] then instance_from_client[\"applicant\"] else user_id\n\tins_obj.applicant_name = if instance_from_client[\"applicant_name\"] then instance_from_client[\"applicant_name\"] else user_info.name\n\tins_obj.applicant_organization = if instance_from_client[\"applicant_organization\"] then instance_from_client[\"applicant_organization\"] else space_user.organization\n\tins_obj.applicant_organization_name = if instance_from_client[\"applicant_organization_name\"] then instance_from_client[\"applicant_organization_name\"] else space_user_org_info.organization_name\n\tins_obj.applicant_organization_fullname = if instance_from_client[\"applicant_organization_fullname\"] then instance_from_client[\"applicant_organization_fullname\"] else  space_user_org_info.organization_fullname\n\tins_obj.applicant_company = if instance_from_client[\"applicant_company\"] then instance_from_client[\"applicant_company\"] else space_user.company_id\n\tins_obj.state = 'draft'\n\tins_obj.code = ''\n\tins_obj.is_archived = false\n\tins_obj.is_deleted = false\n\tins_obj.created = now\n\tins_obj.created_by = user_id\n\tins_obj.modified = now\n\tins_obj.modified_by = user_id\n\tins_obj.values = new Object\n\n\tcompanyId = uuflowManager.getFlowCompanyId(flow_id)\n\tif companyId\n\t\tins_obj.company_id = companyId\n\n\t# 新建Trace\n\ttrace_obj = {}\n\ttrace_obj._id = new Mongo.ObjectID()._str\n\ttrace_obj.instance = ins_obj._id\n\ttrace_obj.is_finished = false\n\t# 当前最新版flow中开始节点\n\tstart_step = _.find(flow.current.steps, (step) ->\n\t\treturn step.step_type is 'start'\n\t)\n\ttrace_obj.step = start_step._id\n\ttrace_obj.name = start_step.name\n\n\ttrace_obj.start_date = now\n\t# 新建Approve\n\tappr_obj = {}\n\tappr_obj._id = new Mongo.ObjectID()._str\n\tappr_obj.instance = ins_obj._id\n\tappr_obj.trace = trace_obj._id\n\tappr_obj.is_finished = false\n\tappr_obj.user = if instance_from_client[\"applicant\"] then instance_from_client[\"applicant\"] else user_id\n\tappr_obj.user_name = if instance_from_client[\"applicant_name\"] then instance_from_client[\"applicant_name\"] else user_info.name\n\tappr_obj.handler = user_id\n\tappr_obj.handler_name = user_info.name\n\tappr_obj.handler_organization = space_user.organization\n\tappr_obj.handler_organization_name = space_user_org_info.organization_name\n\tappr_obj.handler_organization_fullname = space_user_org_info.organization_fullname\n\tappr_obj.type = 'draft'\n\tappr_obj.start_date = now\n\tappr_obj.read_date = now\n\tappr_obj.is_read = true\n\tappr_obj.is_error = false\n\tappr_obj.description = ''\n\tappr_obj.values = if approve_from_client and approve_from_client[\"values\"] then approve_from_client[\"values\"] else new Object\n\n\ttrace_obj.approves = [appr_obj]\n\tins_obj.traces = [trace_obj]\n\n\tins_obj.inbox_users = instance_from_client.inbox_users || []\n\n\tins_obj.current_step_name = start_step.name\n\n\tif flow.auto_remind is true\n\t\tins_obj.auto_remind = true\n\n\t# 新建申请单时，instances记录流程名称、流程分类名称 #1313\n\tins_obj.flow_name = flow.name\n\tif form.category\n\t\tcategory = uuflowManager.getCategory(form.category)\n\t\tif category\n\t\t\tins_obj.category_name = category.name\n\t\t\tins_obj.category = category._id\n\n\tnew_ins_id = db.instances.insert(ins_obj)\n\n\treturn new_ins_id\n\nuuflowManager.getCurrentStepAutoSubmit = (timeout_auto_submit, lines)->\n\tif timeout_auto_submit && lines\n\t\ttimeout_line = _.find lines, (l)->\n\t\t\treturn l.timeout_line == true\n\t\tif timeout_line\n\t\t\treturn true\n\n\treturn false\n\nuuflowManager.getDueDate = (hours, spaceId) ->\n\tif hours\n\t\treturn Meteor.wrapAsync((start, hours, spaceId, cb) ->\n\t\t\t\tsteedosCore.getTimeoutDateWithoutHolidays(start, hours, spaceId).then (resolve, reject) ->\n\t\t\t\t\tcb(reject, resolve)\n\t\t\t)(new Date(), hours, spaceId)\n\treturn undefined\n\n\nuuflowManager.submit_instance = (instance_from_client, user_info) ->\n\tcurrent_user = user_info._id\n\tlang = \"en\"\n\tif user_info.locale is 'zh-cn'\n\t\tlang = 'zh-CN'\n\n\tinstance_id = instance_from_client[\"_id\"]\n\ttrace_id = instance_from_client[\"traces\"][0][\"_id\"]\n\tapprove_id = instance_from_client[\"traces\"][0][\"approves\"][0][\"_id\"]\n\tvalues = instance_from_client[\"traces\"][0][\"approves\"][0][\"values\"]\n\tif not values\n\t\tvalues = new Object\n\t#　验证表单上的applicant已填写\n\tif not instance_from_client[\"applicant\"]\n\t\tthrow new Meteor.Error('error!', \"请选择提交人\")\n\n\tapplicant_id = instance_from_client[\"applicant\"]\n\tsubmitter_id = instance_from_client[\"submitter\"]\n\tnext_steps = instance_from_client[\"traces\"][0][\"approves\"][0][\"next_steps\"]\n\tattachments = instance_from_client[\"traces\"][0][\"approves\"][0][\"attachments\"]\n\tdescription = instance_from_client[\"traces\"][0][\"approves\"][0][\"description\"]\n\t# 获取一个instance\n\tinstance = uuflowManager.getInstance(instance_id)\n\tspace_id = instance.space\n\tflow_id = instance.flow\n\t# 获取一个space\n\tspace = uuflowManager.getSpace(space_id)\n\t# 校验申请人user_accepted = true\n\tcheckApplicant = uuflowManager.getSpaceUser(space_id, applicant_id)\n\t# 获取一个flow\n\tflow = uuflowManager.getFlow(flow_id)\n\t# 确定instance的name\n\tinstance_name = instance_from_client[\"name\"]\n\t# 判断一个instance是否为拟稿状态\n\tuuflowManager.isInstanceDraft(instance, lang)\n\t# 获取一个space下的一个user\n\tspace_user = uuflowManager.getSpaceUser(space_id, current_user)\n\t# 获取space_user所在的部门信息\n\tspace_user_org_info = uuflowManager.getSpaceUserOrgInfo(space_user)\n\t# 判断一个用户是否是一个instance的提交者\n\tuuflowManager.isInstanceSubmitter(instance, current_user)\n\t# 判断一个flow是否为启用状态\n\tuuflowManager.isFlowEnabled(flow)\n\t# 验证该user_id或其所在的组有提交此申请单的权限\n\tpermissions = permissionManager.getFlowPermissions(flow_id, current_user)\n\tif not permissions.includes(\"add\")\n\t\tthrow new Meteor.Error('error!', \"该提交人没有提交此申请单的权限。\")\n\n\ttrace = instance_from_client[\"traces\"][0]\n\t# 获取一个step\n\tstep = uuflowManager.getStep(instance, flow, trace[\"step\"])\n\tapprove = trace[\"approves\"][0]\n\t# 先执行暂存的操作\n\t# ================begin================\n\tform = db.forms.findOne(instance.form)\n\t# 获取Flow当前版本开始节点\n\tstart_step = _.find(flow.current.steps, (step) ->\n\t\treturn step.step_type is 'start'\n\t)\n\n\tinstance_traces = instance.traces\n\tinstance_traces[0][\"approves\"][0].description = description\n\tsetObj = new Object\n\tflow_has_upgrade = false\n\t# 判断:applicant和原instance的applicant是否相等\n\tif applicant_id is instance.applicant\n\t\t# applicant和原instance的applicant相等\n\t\t# 判断流程是否已升级，instance[\"flow_version\"] == flow[\"current\"][\"_id\"]表示流程未升级\n\t\tif instance.flow_version is flow.current._id\n\t\t\tinstance_traces[0][\"approves\"][0].judge = \"submitted\"\n\t\t\t# 判断next_steps是否为空,不为空则写入到当前approve的next_steps中\n\t\t\tif next_steps\n\t\t\t\tinstance_traces[0][\"approves\"][0].next_steps = next_steps\n\n\t\t\tsetObj.modified = new Date\n\t\t\tsetObj.modified_by = current_user\n\t\telse\n\t\t\t# 流程已升级\n\t\t\tflow_has_upgrade = true\n\t\t\t# 更新instance记录\n\t\t\tsetObj.flow_version = flow.current._id\n\t\t\tsetObj.form_version = flow.current.form_version\n\t\t\tsetObj.modified = new Date\n\t\t\tsetObj.modified_by = current_user\n\t\t\t# 清空原来的值， 存入当前最新版flow中开始节点的step_id\n\t\t\tinstance_traces[0].step = start_step._id\n\t\t\tinstance_traces[0].name = start_step.name\n\t\t\tinstance_traces[0][\"approves\"][0].judge = \"submitted\"\n\n\telse\n\t\t# applicant和原instance的applicant不相等\n\t\tuser = uuflowManager.getUser(applicant_id)\n\t\tapplicant = uuflowManager.getSpaceUser(space_id, applicant_id)\n\t\t# 获取applicant所在的部门信息\n\t\tapplicant_org_info = uuflowManager.getSpaceUserOrgInfo(applicant)\n\t\t# 修改instance的applicant,applicant_name，同时修改开始结点的approve的user为:applicant,user_name\n\t\tsetObj.applicant = applicant_id\n\t\tsetObj.applicant_name = user.name\n\t\tsetObj.applicant_organization = applicant_org_info[\"organization\"]\n\t\tsetObj.applicant_organization_name = applicant_org_info[\"organization_name\"]\n\t\tsetObj.applicant_organization_fullname = applicant_org_info[\"organization_fullname\"]\n\t\tsetObj.applicant_company = applicant[\"company_id\"]\n\t\tinstance_traces[0][\"approves\"][0].user = applicant_id\n\t\tinstance_traces[0][\"approves\"][0].user_name = user.name\n\t\tinstance_traces[0][\"approves\"][0].judge = \"submitted\"\n\n\t\t# 判断流程是否已升级，instance[\"flow_version\"] == flow[\"current\"][\"_id\"]表示流程未升级\n\t\tif instance.flow_version is flow.current._id\n\t\t\t# 判断next_steps是否为空,不为空则写入到当前approve的next_steps中\n\t\t\tif next_steps\n\t\t\t\tinstance_traces[0][\"approves\"][0].next_steps = next_steps\n\t\t\t\tsetObj.modified = new Date\n\t\t\t\tsetObj.modified_by = current_user\n\t\telse\n\t\t\t# 流程已升级\n\t\t\tflow_has_upgrade = true\n\t\t\t# 更新instance记录\n\t\t\tsetObj.flow_version = flow.current._id\n\t\t\tsetObj.form_version = flow.current.form_version\n\t\t\tsetObj.modified = new Date\n\t\t\tsetObj.modified_by = current_user\n\t\t\t# 清空原来的值， 存入当前最新版flow中开始节点的step_id\n\t\t\tinstance_traces[0].step = start_step._id\n\t\t\tinstance_traces[0].name = start_step.name\n\n\t# 调整approves 的values 删除values中在当前步骤中没有编辑权限的字段值\n\tinstance_traces[0][\"approves\"][0].values = uuflowManager.getApproveValues(values, step.permissions, instance.form, instance.form_version) # 非odata字段从台帐将值传到审批单（开始节点此字段无编辑权限），审批单提交后，值丢失 #891\n\n\tsetObj.traces = instance_traces\n\tdb.instances.update({ _id: instance_id }, { $set: setObj })\n\tif flow_has_upgrade\n\t\treturn { alerts: TAPi18n.__('flow.point_upgraded', {}, lang) }\n\t# ================end================\n\tinstance = db.instances.findOne(instance_id) #使用最新的instance\n\t# 判断一个instance是否为拟稿状态\n\tuuflowManager.isInstanceDraft(instance, lang)\n\ttraces = instance.traces\n\tupObj = new Object\n\n\tif (not approve[\"next_steps\"]) or (approve[\"next_steps\"].length is 0)\n\t\tthrow new Meteor.Error('error!', \"还未指定下一步和处理人，提交失败\")\n\telse\n\t\t# 验证next_steps里面是否只有一个step\n\t\tif approve[\"next_steps\"].length > 1\n\t\t\tthrow new Meteor.Error('error!', \"不能指定多个后续步骤\")\n\t\telse\n\t\t\tnextSteps = uuflowManager.getNextSteps(instance, flow, step, \"\")\n\t\t\t_.each(approve[\"next_steps\"], (approve_next_step) ->\n\t\t\t\tif not nextSteps.includes(approve_next_step[\"step\"])\n\t\t\t\t\tthrow new Meteor.Error('error!', \"下一步步骤不合法\")\n\t\t\t)\n\t# 校验下一步处理人user_accepted = true\n\t_.each(approve[\"next_steps\"][0][\"users\"], (next_step_user) ->\n\t\tuuflowManager.getSpaceUser(space_id, next_step_user)\n\t)\n\tnext_step = uuflowManager.getStep(instance, flow, approve[\"next_steps\"][0][\"step\"])\n\t# 判断next_step是否为结束结点\n\tif next_step.step_type is \"end\"\n\n\t\t# 更新approve\n\t\ttraces[0][\"approves\"][0].is_finished = true\n\t\ttraces[0][\"approves\"][0].finish_date = new Date\n\t\ttraces[0][\"approves\"][0].cost_time = traces[0][\"approves\"][0].finish_date - traces[0][\"approves\"][0].start_date\n\t\t# 更新trace\n\t\ttraces[0].is_finished = true\n\t\ttraces[0].judge = \"submitted\"\n\t\ttraces[0].finish_date = new Date\n\t\t# 插入下一步trace记录\n\t\tnewTrace = new Object\n\t\tnewTrace._id = new Mongo.ObjectID()._str\n\t\tnewTrace.instance = instance_id\n\t\tnewTrace.previous_trace_ids = [trace[\"_id\"]]\n\t\tnewTrace.is_finished = true\n\t\tnewTrace.step = next_step._id\n\t\tnewTrace.name = next_step.name\n\t\tnewTrace.start_date = new Date\n\t\tnewTrace.finish_date = new Date\n\t\t# 更新instance记录\n\t\t# 申请单名称按照固定规则生成申请单名称：流程名称＋' '+申请单编号\n\t\tupObj.submit_date = new Date\n\t\tupObj.state = \"completed\"\n\t\tupObj.values = uuflowManager.getUpdatedValues(uuflowManager.getInstance(instance_id))\n\t\tupObj.code = flow.current_no + 1 + \"\"\n\t\tinstance.code = upObj.code\n\t\tinstance.values = upObj.values\n\t\tupObj.name = uuflowManager.getInstanceName(instance)\n\t\tupObj.modified = new Date\n\t\tupObj.modified_by = current_user\n\t\tupObj.inbox_users = []\n\t\tupObj.outbox_users = _.uniq [current_user, traces[0][\"approves\"][0][\"user\"]]\n\t\t# 调整approves 的values 删除values中在当前步骤中没有编辑权限的字段值\n\t\t# traces[0][\"approves\"][0].values = uuflowManager.getApproveValues(traces[0][\"approves\"][0].values, step.permissions, instance.form, instance.form_version)\n\t\ttraces.push(newTrace)\n\t\tupObj.traces = traces\n\t\tupObj.finish_date = new Date\n\t\tupObj.current_step_name = next_step.name\n\t\tupObj.final_decision = \"approved\"\n\t\tupObj.current_step_auto_submit = false\n\telse # next_step不为结束节点\n\t\t# 取得下一步处理人\n\t\tnext_step_users = approve[\"next_steps\"][0][\"users\"]\n\t\t# 判断nextsteps.step.users是否为空\n\t\tif (not next_step_users) or (next_step_users.length is 0)\n\t\t\tthrow new Meteor.Error('error!', \"未指定下一步处理人\")\n\t\telse\n\t\t\tif next_step_users.length > 1 and next_step.step_type isnt \"counterSign\"\n\t\t\t\tthrow new Meteor.Error('error!', \"不能指定多个处理人\")\n\t\t\telse\n\t\t\t\t# 验证下一步处理人next_user是否合法\n\t\t\t\tcheckUsers = getHandlersManager.getHandlers(instance_id, approve[\"next_steps\"][0][\"step\"], current_user)\n\t\t\t\tif !uuflowManager.checkNestStepUsersIsValid(next_step_users, checkUsers, next_step)\n\t\t\t\t\tthrow new Meteor.Error('error!', \"指定的下一步处理人有误\")\n\t\t\t\telse\n\t\t\t\t\t# 若合法，执行流转操作\n\t\t\t\t\t# 更新approve\n\t\t\t\t\ttraces[0][\"approves\"][0].is_finished = true\n\t\t\t\t\ttraces[0][\"approves\"][0].finish_date = new Date\n\t\t\t\t\ttraces[0][\"approves\"][0].cost_time = traces[0][\"approves\"][0].finish_date - traces[0][\"approves\"][0].start_date\n\t\t\t\t\t# 更新trace\n\t\t\t\t\ttraces[0].is_finished = true\n\t\t\t\t\ttraces[0].finish_date = new Date\n\t\t\t\t\ttraces[0].judge = \"submitted\"\n\t\t\t\t\t# 插入下一步trace记录\n\t\t\t\t\tnextTrace = new Object\n\t\t\t\t\tnextTrace._id = new Mongo.ObjectID()._str\n\t\t\t\t\tnextTrace.instance = instance_id\n\t\t\t\t\tnextTrace.previous_trace_ids = [trace[\"_id\"]]\n\t\t\t\t\tnextTrace.is_finished = false\n\t\t\t\t\tnextTrace.step = next_step._id\n\t\t\t\t\tnextTrace.name = next_step.name\n\t\t\t\t\tnextTrace.start_date = new Date\n\t\t\t\t\tnextTrace.due_date = uuflowManager.getDueDate(next_step.timeout_hours, space_id)\n\t\t\t\t\tnextTrace.approves = new Array\n\n\t\t\t\t\tupdated_values = uuflowManager.getUpdatedValues(uuflowManager.getInstance(instance_id))\n\t\t\t\t\t# 插入下一步trace.approve记录\n\t\t\t\t\t_.each(next_step_users, (next_step_user_id, idx) ->\n\t\t\t\t\t\tnextApprove = new Object\n\t\t\t\t\t\tnextApprove._id = new Mongo.ObjectID()._str\n\n\t\t\t\t\t\tuser_info = uuflowManager.getUser(next_step_user_id)\n\t\t\t\t\t\thandler_id = next_step_user_id\n\t\t\t\t\t\thandler_info = user_info\n\t\t\t\t\t\tagent = uuflowManager.getAgent(space_id, next_step_user_id)\n\t\t\t\t\t\tif agent\n\t\t\t\t\t\t\tnext_step_users[idx] = agent\n\t\t\t\t\t\t\thandler_id = agent\n\t\t\t\t\t\t\thandler_info = uuflowManager.getUser(agent)\n\t\t\t\t\t\t\tnextApprove.agent = agent\n\n\t\t\t\t\t\tnextApprove.instance = instance_id\n\t\t\t\t\t\tnextApprove.trace = nextTrace._id\n\t\t\t\t\t\tnextApprove.is_finished = false\n\t\t\t\t\t\tnextApprove.user = next_step_user_id\n\t\t\t\t\t\tnextApprove.user_name = user_info.name\n\t\t\t\t\t\tnextApprove.handler = handler_id\n\t\t\t\t\t\tnextApprove.handler_name = handler_info.name\n\t\t\t\t\t\tnext_step_space_user = uuflowManager.getSpaceUser(space_id, handler_id)\n\t\t\t\t\t\t# 获取next_step_user所在的部门信息\n\t\t\t\t\t\tnext_step_user_org_info = uuflowManager.getSpaceUserOrgInfo(next_step_space_user)\n\t\t\t\t\t\tnextApprove.handler_organization = next_step_user_org_info[\"organization\"]\n\t\t\t\t\t\tnextApprove.handler_organization_name = next_step_user_org_info[\"organization_name\"]\n\t\t\t\t\t\tnextApprove.handler_organization_fullname = next_step_user_org_info[\"organization_fullname\"]\n\t\t\t\t\t\tnextApprove.start_date = new Date\n\t\t\t\t\t\tnextApprove.due_date = nextTrace.due_date\n\t\t\t\t\t\tnextApprove.is_read = false\n\t\t\t\t\t\tnextApprove.is_error = false\n\t\t\t\t\t\tnextApprove.values = new Object\n\t\t\t\t\t\tuuflowManager.setRemindInfo(updated_values, nextApprove)\n\t\t\t\t\t\tnextTrace.approves.push(nextApprove)\n\t\t\t\t\t)\n\t\t\t\t\t# 更新instance记录\n\t\t\t\t\tupObj.name = instance_name\n\t\t\t\t\tupObj.submit_date = new Date\n\t\t\t\t\tupObj.state = \"pending\"\n\t\t\t\t\t# 重新查找暂存之后的instance\n\t\t\t\t\tupObj.values = updated_values\n\t\t\t\t\tupObj.inbox_users = next_step_users\n\t\t\t\t\tupObj.modified = new Date\n\t\t\t\t\tupObj.modified_by = current_user\n\t\t\t\t\t# 申请单名称按照固定规则生成申请单名称：流程名称＋' '+申请单编号\n\t\t\t\t\tupObj.code = flow.current_no + 1 + \"\"\n\t\t\t\t\tinstance.code = upObj.code\n\t\t\t\t\tinstance.values = upObj.values\n\t\t\t\t\tupObj.name = uuflowManager.getInstanceName(instance)\n\t\t\t\t\t# 调整approves 的values 删除values中在当前步骤中没有编辑权限的字段值\n\t\t\t\t\t# traces[0][\"approves\"][0].values = uuflowManager.getApproveValues(traces[0][\"approves\"][0].values, step[\"permissions\"], instance.form, instance.form_version)\n\t\t\t\t\ttraces.push(nextTrace)\n\t\t\t\t\tupObj.traces = traces\n\t\t\t\t\tupObj.outbox_users = []\n\t\t\t\t\tupObj.current_step_name = next_step.name\n\t\t\t\t\tupObj.current_step_auto_submit = uuflowManager.getCurrentStepAutoSubmit(flow.timeout_auto_submit, next_step.lines)\n\n\tupObj.keywords = uuflowManager.caculateKeywords(upObj.values, form, instance.form_version)\n\tdb.instances.update({ _id: instance_id }, { $set: upObj })\n\tdb.flows.direct.update({ _id: flow._id }, { $set: { current_no: flow.current_no + 1 } })\n\tif next_step.step_type isnt \"end\"\n\t\tinstance = db.instances.findOne(instance_id)\n\t\t#发送短消息给申请人\n\t\tpushManager.send_instance_notification(\"first_submit_applicant\", instance, \"\", user_info)\n\t\t# 发送消息给下一步处理人\n\t\tpushManager.send_instance_notification(\"first_submit_inbox\", instance, \"\", user_info)\n\treturn {}\n\nuuflowManager.get_SpaceChangeSet = (formids, is_admin, sync_token) ->\n\tsync_token = new Date(Number(sync_token) * 1000)\n\tchangeSet = new Object\n\tchangeSet.sync_token = new Date().getTime() / 1000\n\tchangeSet.inserts = {\n\t\tSpaces: [],\n\t\tUsers: [],\n\t\tSpaceUsers: [],\n\t\tOrganizations: [],\n\t\tRoles: [],\n\t\tPositions: [],\n\t\tForms: [],\n\t\tFlows: [],\n\t\tInstances: []\n\t}\n\tchangeSet.updates = {\n\t\tSpaces: [],\n\t\tUsers: [],\n\t\tSpaceUsers: [],\n\t\tOrganizations: [],\n\t\tRoles: [],\n\t\tPositions: [],\n\t\tForms: [],\n\t\tFlows: [],\n\t\tInstances: []\n\t}\n\tchangeSet.deletes = {\n\t\tSpaces: [],\n\t\tUsers: [],\n\t\tSpaceUsers: [],\n\t\tOrganizations: [],\n\t\tRoles: [],\n\t\tPositions: [],\n\t\tForms: [],\n\t\tFlows: [],\n\t\tInstances: []\n\t}\n\n\tif formids and formids.trim()\n\t\tformids_ary = formids.split(\",\")\n\t\tchangeSet.inserts.Instances = db.instances.find({\n\t\t\tform: { $in: formids_ary },\n\t\t\tcreated: { $gt: sync_token }\n\t\t}).fetch()\n\t\tchangeSet.updates.Instances = db.instances.find({\n\t\t\tform: { $in: formids_ary },\n\t\t\tcreated: { $lte: sync_token },\n\t\t\tmodified: { $gt: sync_token }\n\t\t}).fetch()\n\t\tchangeSet.deletes.Instances = db.deleted_instances.find({\n\t\t\tform: { $in: formids_ary },\n\t\t\tdeleted: { $gt: sync_token }\n\t\t}, { fields: { _id: 1 } }).fetch()\n\n\telse if is_admin and is_admin.trim()\n\t\tchangeSet.inserts.Instances = db.instances.find({\n\t\t\tcreated: { $gt: sync_token }\n\t\t}).fetch()\n\t\tchangeSet.updates.Instances = db.instances.find({\n\t\t\tcreated: { $lte: sync_token },\n\t\t\tmodified: { $gt: sync_token }\n\t\t}).fetch()\n\t\tchangeSet.deletes.Instances = db.deleted_instances.find({\n\t\t\tdeleted: { $gt: sync_token }\n\t\t}, { fields: { _id: 1 } }).fetch()\n\n\t# 查询提交人和申请人steedos_id\n\t_.each changeSet.inserts.Instances, (ins) ->\n\t\tsubmitter = db.users.findOne({ _id: ins.submitter }, { fields: { steedos_id: 1 } })\n\t\tapplicant = db.users.findOne({ _id: ins.applicant }, { fields: { steedos_id: 1 } })\n\t\tins.submitter_steedos_id = submitter.steedos_id if submitter\n\t\tins.applicant_steedos_id = applicant.steedos_id if applicant\n\t_.each changeSet.updates.Instances, (ins) ->\n\t\tsubmitter = db.users.findOne({ _id: ins.submitter }, { fields: { steedos_id: 1 } })\n\t\tapplicant = db.users.findOne({ _id: ins.applicant }, { fields: { steedos_id: 1 } })\n\t\tins.submitter_steedos_id = submitter.steedos_id if submitter\n\t\tins.applicant_steedos_id = applicant.steedos_id if applicant\n\n\treturn { ChangeSet: changeSet }\n\n### 文件催办\n根据instance.values.priority和instance.values.deadline给approve增加remind相关信息\n{\n\tdeadline: Date,\n\tremind_date: Date,\n\treminded_count: Number\n}\n###\nuuflowManager.setRemindInfo = (values, approve) ->\n\tcheck values, Object\n\tcheck approve, Object\n\tcheck approve.start_date, Date\n\n\tremind_date = null\n\tdeadline = null\n\tstart_date = approve.start_date\n\n\tif values.priority and values.deadline\n\t\tcheck values.priority, Match.OneOf(\"普通\", \"办文\", \"紧急\", \"特急\")\n\t\t# 由于values中的date字段的值为String，故作如下校验\n\t\tdeadline = new Date(values.deadline)\n\t\tif deadline.toString() is \"Invalid Date\"\n\t\t\treturn\n\n\t\tpriority = values.priority\n\n\t\tif priority is \"普通\"\n\t\t\tremind_date = Steedos.caculateWorkingTime(start_date, 3)\n\t\telse if priority is \"办文\"\n\t\t\tif Steedos.caculatePlusHalfWorkingDay(start_date) > deadline # 超过了办结时限或者距离办结时限半日内\n\t\t\t\tremind_date = Steedos.caculatePlusHalfWorkingDay(start_date, true)\n\t\t\telse if Steedos.caculateWorkingTime(start_date, 1) > deadline\n\t\t\t\tcaculate_date = (base_date) ->\n\t\t\t\t\tplus_halfday_date = Steedos.caculatePlusHalfWorkingDay(base_date)\n\t\t\t\t\tif plus_halfday_date > deadline\n\t\t\t\t\t\tremind_date = base_date\n\t\t\t\t\telse\n\t\t\t\t\t\tcaculate_date(Steedos.caculatePlusHalfWorkingDay(base_date, true))\n\t\t\t\t\treturn\n\t\t\t\tcaculate_date(start_date)\n\t\t\telse\n\t\t\t\tremind_date = Steedos.caculateWorkingTime(start_date, 1)\n\t\telse if priority is \"紧急\" or priority is \"特急\"\n\t\t\tif Steedos.caculatePlusHalfWorkingDay(start_date) > deadline # 超过了办结时限或者距离办结时限半日内\n\t\t\t\tremind_date = Steedos.caculatePlusHalfWorkingDay(start_date, true)\n\t\t\telse if Steedos.caculateWorkingTime(start_date, 1) > deadline\n\t\t\t\tcaculate_date = (base_date) ->\n\t\t\t\t\tplus_halfday_date = Steedos.caculatePlusHalfWorkingDay(base_date)\n\t\t\t\t\tif plus_halfday_date > deadline\n\t\t\t\t\t\tremind_date = base_date\n\t\t\t\t\telse\n\t\t\t\t\t\tcaculate_date(Steedos.caculatePlusHalfWorkingDay(base_date, true))\n\t\t\t\t\treturn\n\t\t\t\tcaculate_date(start_date)\n\t\t\telse\n\t\t\t\tremind_date = Steedos.caculatePlusHalfWorkingDay start_date\n\t\t\tins = db.instances.findOne(approve.instance)\n\t\t\tif ins.state is 'draft'\n\t\t\t\tflow = db.flows.findOne({ _id: ins.flow }, { fields: { current_no: 1 } })\n\t\t\t\tins.code = flow.current_no + 1 + ''\n\t\t\tins.values = values\n\t\t\tuuflowManager.sendRemindSMS uuflowManager.getInstanceName(ins), deadline, [approve.user], ins.space, ins._id\n\telse\n\t\t# 如果没有配置 紧急程度 和办结时限 则按照 '普通' 规则催办\n\t\tremind_date = Steedos.caculateWorkingTime(start_date, 3)\n\n\tapprove.deadline = deadline\n\tapprove.remind_date = remind_date\n\tapprove.reminded_count = 0\n\n\treturn\n\n# 发送催办短信\nuuflowManager.sendRemindSMS = (ins_name, deadline, users_id, space_id, ins_id) ->\n\tcheck ins_name, String\n\tcheck deadline, Date\n\tcheck users_id, Array\n\tcheck space_id, String\n\tcheck ins_id, String\n\n\tskip_users = Meteor.settings.remind?.skip_users || []\n\tsend_users = []\n\t_.each users_id, (uid) ->\n\t\tif not skip_users.includes(uid)\n\t\t\tsend_users.push(uid)\n\n\tname = if ins_name.length > 15 then ins_name.substr(0,12) + '...' else ins_name\n\n\tdb.users.find({_id: {$in: _.uniq(send_users)}, mobile: {$exists: true}, mobile_verified: true}, {fields: {mobile: 1, utcOffset: 1, locale: 1, name: 1}}).forEach (user)->\n\t\tutcOffset = if user.hasOwnProperty('utcOffset') then user.utcOffset else 8\n\t\tparams = {\n\t\t\tinstance_name: name,\n\t\t\tdeadline: moment(deadline).utcOffset(utcOffset).format('MM-DD HH:mm')\n\t\t}\n\t\t#设置当前语言环境\n\t\tlang = 'en'\n\t\tif user.locale is 'zh-cn'\n\t\t\tlang = 'zh-CN'\n\t\t# 发送手机短信\n\t\tSMSQueue.send({\n\t\t\tFormat: 'JSON',\n\t\t\tAction: 'SingleSendSms',\n\t\t\tParamString: JSON.stringify(params),\n\t\t\tRecNum: user.mobile,\n\t\t\tSignName: 'OA系统',\n\t\t\tTemplateCode: 'SMS_67200967',\n\t\t\tmsg: TAPi18n.__('sms.remind.template', {instance_name: ins_name, deadline: params.deadline, open_app_url: Meteor.absoluteUrl()+\"workflow.html?space_id=#{space_id}&ins_id=#{ins_id}\"}, lang)\n\t\t})\n\n\t\t# 发推送消息\n\t\tnotification = new Object\n\t\tnotification[\"createdAt\"] = new Date\n\t\tnotification[\"createdBy\"] = '<SERVER>'\n\t\tnotification[\"from\"] = 'workflow'\n\t\tnotification['title'] = user.name\n\t\tnotification['text'] = TAPi18n.__('instance.push.body.remind', {instance_name: ins_name, deadline: params.deadline}, lang)\n\n\t\tpayload = new Object\n\t\tpayload[\"space\"] = space_id\n\t\tpayload[\"instance\"] = ins_id\n\t\tpayload[\"host\"] = Meteor.absoluteUrl().substr(0, Meteor.absoluteUrl().length - 1)\n\t\tpayload[\"requireInteraction\"] = true\n\t\tnotification[\"payload\"] = payload\n\t\tnotification['query'] = { userId: user._id, appName: 'workflow' }\n\n\t\tPush.send(notification)\n\n\n# 如果申请单的名字变了，正文的名字要跟申请单名字保持同步\nuuflowManager.checkMainAttach = (instance_id, name) ->\n\tmain = cfs.instances.findOne({ 'metadata.instance': instance_id, 'metadata.main': true, 'metadata.current': true })\n\tif main\n\t\tins = db.instances.findOne({ _id: instance_id }, { fields: { name: 1 } })\n\t\tnew_ins_name = name || ins.name\n\n\t\tnew_ins_name = new_ins_name.replace(/\\r/g, \"\").replace(/\\n/g, \"\")\n\n\t\t#文件名中不能包含特殊字符: '? * : \" < > \\ / |'， 直接替换为空\n\t\tnew_ins_name = new_ins_name.replace(/\\?|\\*|\\:|\\\"|\\<|\\>|\\\\|\\/|\\|/g, \"\")\n\n\t\tmain_name_split = main.name().split('.')\n\t\tmain_name_split.pop()\n\t\tif new_ins_name isnt main_name_split.join(\"\")\n\t\t\tfile_name = new_ins_name + \".\" + main.extension()\n\t\t\tmain.update({ $set: { 'original.name': file_name, 'copies.instances.name': file_name } })\n\nuuflowManager.caculateKeywords = (values, form, form_version) ->\n\tif _.isEmpty(values)\n\t\treturn \"\"\n\n\tkeywords = []\n\tform_v = null\n\tif form_version is form.current._id\n\t\tform_v = form.current\n\telse\n\t\tform_v = _.find(form.historys, (form_h) ->\n\t\t\treturn form_version is form_h._id\n\t\t)\n\n\t_.each form_v.fields, (field) ->\n\t\tif field.is_searchable\n\t\t\tif field.type == 'input' or field.type == 'email' or field.type == 'url' or field.type == 'number' or field.type == 'select' or field.type == 'radio'\n\t\t\t\tif values[field.code]\n\t\t\t\t\tkeywords.push values[field.code]\n\t\t\t# multiSelect\n\t\t\telse if field.type == 'multiSelect'\n\t\t\t\tif values[field.code]\n\t\t\t\t\tkeywords.push values[field.code]\n\t\t\t# 选人选组控件 取name\n\t\t\telse if field.type == 'user' or field.type == 'group'\n\t\t\t\t# 多选\n\t\t\t\tif field.is_multiselect == true\n\t\t\t\t\tmultiValue = values[field.code]\n\t\t\t\t\tif _.isArray(multiValue)\n\t\t\t\t\t\t_.each multiValue, (singleV) ->\n\t\t\t\t\t\t\tif singleV and singleV['name']\n\t\t\t\t\t\t\t\tkeywords.push singleV['name']\n\t\t\t\t# 单选\n\t\t\t\telse\n\t\t\t\t\tif values[field.code] and values[field.code]['name']\n\t\t\t\t\t\tkeywords.push values[field.code]['name']\n\t\t# 子表\n\t\telse if field.type == 'table'\n\t\t\tif values[field.code]\n\t\t\t\t_.each values[field.code], (s_value) ->\n\t\t\t\t\t_.each field.fields, (s_field) ->\n\t\t\t\t\t\tif s_field.is_searchable\n\t\t\t\t\t\t\tif s_field.type == 'input' or s_field.type == 'email' or s_field.type == 'url' or s_field.type == 'number' or s_field.type == 'select' or s_field.type == 'radio'\n\t\t\t\t\t\t\t\tif s_value[s_field.code]\n\t\t\t\t\t\t\t\t\tkeywords.push s_value[s_field.code]\n\t\t\t\t\t\t\t# multiSelect\n\t\t\t\t\t\t\telse if s_field.type == 'multiSelect'\n\t\t\t\t\t\t\t\tif s_value[s_field.code]\n\t\t\t\t\t\t\t\t\tkeywords.push s_value[s_field.code]\n\t\t\t\t\t\t\t# 选人选组控件 取name\n\t\t\t\t\t\t\telse if s_field.type is 'user' or s_field.type is 'group'\n\t\t\t\t\t\t\t\t# 多选\n\t\t\t\t\t\t\t\tif s_field.is_multiselect == true\n\t\t\t\t\t\t\t\t\tmultiValue = s_value[s_field.code]\n\t\t\t\t\t\t\t\t\tif _.isArray(multiValue)\n\t\t\t\t\t\t\t\t\t\t_.each multiValue, (singleV) ->\n\t\t\t\t\t\t\t\t\t\t\tif singleV and singleV['name']\n\t\t\t\t\t\t\t\t\t\t\t\tkeywords.push singleV['name']\n\t\t\t\t\t\t\t\t# 单选\n\t\t\t\t\t\t\t\telse\n\t\t\t\t\t\t\t\t\tif s_value[s_field.code] and s_value[s_field.code]['name']\n\t\t\t\t\t\t\t\t\t\tkeywords.push s_value[s_field.code]['name']\n\t\t# 分组\n\t\telse if field.type == 'section'\n\t\t\t_.each field.fields, (s_field) ->\n\t\t\t\tif s_field.is_searchable\n\t\t\t\t\tif s_field.type == 'input' or s_field.type == 'email' or s_field.type == 'url' or s_field.type == 'number' or s_field.type == 'select' or s_field.type == 'radio'\n\t\t\t\t\t\tif values[s_field.code]\n\t\t\t\t\t\t\tkeywords.push values[s_field.code]\n\t\t\t\t\t# multiSelect\n\t\t\t\t\telse if s_field.type == 'multiSelect'\n\t\t\t\t\t\tif values[s_field.code]\n\t\t\t\t\t\t\tkeywords.push values[s_field.code]\n\t\t\t\t\t# 选人选组控件 取name\n\t\t\t\t\telse if s_field.type is 'user' or s_field.type is 'group'\n\t\t\t\t\t\t# 多选\n\t\t\t\t\t\tif s_field.is_multiselect == true\n\t\t\t\t\t\t\tmultiValue = values[s_field.code]\n\t\t\t\t\t\t\tif _.isArray(multiValue)\n\t\t\t\t\t\t\t\t_.each multiValue, (singleV) ->\n\t\t\t\t\t\t\t\t\tif singleV and singleV['name']\n\t\t\t\t\t\t\t\t\t\tkeywords.push singleV['name']\n\t\t\t\t\t\t# 单选\n\t\t\t\t\t\telse\n\t\t\t\t\t\t\tif values[s_field.code] and values[s_field.code]['name']\n\t\t\t\t\t\t\t\tkeywords.push values[s_field.code]['name']\n\n\treturn keywords.join(\" \")\n\nuuflowManager.checkValueFieldsRequire = (values, form, form_version) ->\n\tvalues = values || {}\n\n\trequire_but_empty_fields = []\n\n\tform_v = null\n\tif form_version is form.current._id\n\t\tform_v = form.current\n\telse\n\t\tform_v = _.find(form.historys, (form_h) ->\n\t\t\treturn form_version is form_h._id\n\t\t)\n\n\t_.each form_v.fields, (field) ->\n\t\tif field.type != 'table'\n\t\t\tif field.is_required and _.isEmpty(values[field.code])\n\t\t\t\trequire_but_empty_fields.push field.name || field.code\n\n\t\t# 子表\n\t\telse if field.type == 'table'\n\t\t\tif _.isEmpty(values[field.code])\n\t\t\t\t_.each field.fields, (s_field) ->\n\t\t\t\t\tif s_field.is_required\n\t\t\t\t\t\trequire_but_empty_fields.push s_field.name || s_field.code\n\t\t\telse\n\t\t\t\t_.each values[field.code], (s_value) ->\n\t\t\t\t\t_.each field.fields, (s_field) ->\n\t\t\t\t\t\tif s_field.is_required and _.isEmpty(s_value[s_field.code])\n\t\t\t\t\t\t\trequire_but_empty_fields.push s_field.name || s_field.code\n\n\treturn require_but_empty_fields\n\nuuflowManager.triggerRecordInstanceQueue = (ins_id, record_ids, step_name, flow_id, ins_state) ->\n\towDoc = Creator.getCollection('object_workflows').findOne({ flow_id: flow_id })\n\tif owDoc\n\t\tsyncType = owDoc.sync_type\n\t\tif (!syncType || syncType == 'every_step') || (syncType == 'final_step' && ins_state == 'completed')\n\t\t\tnewObj = {\n\t\t\t\tinfo: {\n\t\t\t\t\tinstance_id: ins_id\n\t\t\t\t\trecords: record_ids\n\t\t\t\t\tstep_name: step_name\n\t\t\t\t\tinstance_finish_date: new Date()\n\t\t\t\t}\n\t\t\t\tsent: false\n\t\t\t\tsending: 0\n\t\t\t\tcreatedAt: new Date()\n\t\t\t\tcreatedBy: '<SERVER>'\n\t\t\t}\n\n\t\t\tdb.instance_record_queue.insert(newObj)\n\n\treturn\n\nuuflowManager.distributedInstancesRemind = (instance) ->\n\t# 确定是分发过来的\n\tif instance?.distribute_from_instances?.length>0\n\t\tflow = db.flows.findOne( { _id: instance?.flow } )\n\t\tcurrent_trace = instance[\"traces\"].pop()\n\t\tif instance?.state == \"draft\"\n\t\t\tnext_approves = current_trace?.approves\n\t\t\tif next_approves?.length == 1\n\t\t\t\tnext_step = next_approves[0]?.next_steps[0]\n\t\t\t\tnext_step_id = next_step?.step\n\t\telse\n\t\t\tnext_step_id = current_trace?.step\n\t\tif next_step_id\n\t\t\tnext_step = uuflowManager.getStep(instance, flow, next_step_id)\n\t\t\tif next_step?.step_type == \"end\"\n\t\t\t\t# 查原申请单\n\t\t\t\toriginal_instacne_id = instance?.distribute_from_instances?.pop()\n\t\t\t\t# original_instacne_id = \"X6whjGMLNvxDnFwSe\" # 定死\n\t\t\t\toriginal_instacne = db.instances.findOne(\n\t\t\t\t\t{ _id: original_instacne_id },\n\t\t\t\t\t{ fields: { flow: 1, name: 1,space: 1,created_by: 1 } }\n\t\t\t\t\t)\n\t\t\t\t# 根据原申请单查流程\n\t\t\t\toriginal_flow = db.flows.findOne(\n\t\t\t\t\t{ _id: original_instacne?.flow },\n\t\t\t\t\t{ fields: { distribute_end_notification: 1 } }\n\t\t\t\t\t)\n\n\t\t\t\tif original_flow?.distribute_end_notification==true\n\t\t\t\t\ttry\n\t\t\t\t\t\t# 分发提醒，这个表单的created_by\n\t\t\t\t\t\toriginal_user = db.users.findOne({_id: instance?.created_by})\n\n\t\t\t\t\t\t#设置当前语言环境\n\t\t\t\t\t\tlang = 'en'\n\t\t\t\t\t\tif original_user?.locale is 'zh-cn'\n\t\t\t\t\t\t\tlang = 'zh-CN'\n\t\t\t\t\t\t# 发推送消息\n\t\t\t\t\t\tnotification = new Object\n\t\t\t\t\t\tnotification[\"createdAt\"] = new Date\n\t\t\t\t\t\tnotification[\"createdBy\"] = '<SERVER>'\n\t\t\t\t\t\tnotification[\"from\"] = 'workflow'\n\t\t\t\t\t\tnotification['title'] = original_user.name\n\t\t\t\t\t\tnotification['text'] = TAPi18n.__('instance.push.body.distribute_remind', {instance_name: instance?.name}, lang)\n\n\t\t\t\t\t\tpayload = new Object\n\t\t\t\t\t\tpayload[\"space\"] = original_instacne?.space\n\t\t\t\t\t\tpayload[\"instance\"] = original_instacne?._id\n\t\t\t\t\t\tpayload[\"host\"] = Meteor.absoluteUrl().substr(0, Meteor.absoluteUrl().length - 1)\n\t\t\t\t\t\tpayload[\"requireInteraction\"] = true\n\t\t\t\t\t\tnotification[\"payload\"] = payload\n\t\t\t\t\t\tnotification['query'] = { userId: original_user._id, appName: 'workflow' }\n\n\n\t\t\t\t\t\tPush.send(notification)\n\t\t\t\t\tcatch e\n\t\t\t\t\t\tconsole.error e.stack\n\treturn\n\nuuflowManager.getAgent = (spaceId, fromId)->\n\tnow = new Date()\n\tr = db.process_delegation_rules.findOne({ space: spaceId, from: fromId, enabled: true, start_time: { $lte: now }, end_time: { $gte: now } })\n\treturn r?.to\n\nuuflowManager.cancelProcessDelegation = (spaceId, toId)->\n\tquery = { space: spaceId, inbox_users: toId }\n\tquery.traces = { $elemMatch: { is_finished: false, approves: { $elemMatch: { is_finished: false, agent: toId } } } }\n\tdb.instances.find(query, { fields: { inbox_users: 1, traces: 1, state: 1 } }).forEach (ins)->\n\t\ttrace = _.find ins.traces, (t)->\n\t\t\treturn t.is_finished is false\n\n\t\t_.each trace.approves, (a, idx)->\n\t\t\tif a.is_finished is false\n\t\t\t\tif a.agent is toId\n\t\t\t\t\tnext_step_space_user = uuflowManager.getSpaceUser(spaceId, a.user)\n\t\t\t\t\t# 获取next_step_user所在的部门信息\n\t\t\t\t\tnext_step_user_org_info = uuflowManager.getSpaceUserOrgInfo(next_step_space_user)\n\t\t\t\t\tidxStr = \"traces.$.approves.#{idx}.\"\n\t\t\t\t\tsetObj = {}\n\t\t\t\t\tsetObj[idxStr + 'handler'] = a.user\n\t\t\t\t\tsetObj[idxStr + 'handler_name'] = a.user_name\n\t\t\t\t\tsetObj[idxStr + 'handler_organization'] = next_step_user_org_info[\"organization\"]\n\t\t\t\t\tsetObj[idxStr + 'handler_organization_name'] = next_step_user_org_info[\"organization_name\"]\n\t\t\t\t\tsetObj[idxStr + 'handler_organization_fullname'] = next_step_user_org_info[\"organization_fullname\"]\n\t\t\t\t\tsetObj[idxStr + 'agent'] = null\n\t\t\t\t\tins.inbox_users.splice(ins.inbox_users.indexOf(toId), 1, a.user)\n\t\t\t\t\tsetObj.inbox_users = ins.inbox_users\n\n\t\t\t\t\t# 如果是分发还需要修改提交人信息\n\t\t\t\t\tif ins.state is 'draft'\n\t\t\t\t\t\tsetObj.submitter = a.user\n\t\t\t\t\t\tsetObj.submitter_name = a.user_name\n\n\t\t\t\t\tdb.instances.update({ _id: ins._id, inbox_users: toId, 'traces._id': a.trace }, { $set: setObj })\n\n\t\t\t\t\tpushManager.send_message_to_specifyUser('current_user', a.user)\n\t\t\t\t\tpushManager.send_message_to_specifyUser('current_user', toId)\n\t\t\t\telse if a.user is toId\n\t\t\t\t\tdb.instances.update({ _id: ins._id }, { $addToSet: { inbox_users: toId } })\n\n\tccQuery = { space: spaceId, cc_users: toId }\n\tccQuery['traces.approves'] = { $elemMatch: { is_finished: false, agent: toId, type: 'cc' } }\n\tdb.instances.find(ccQuery, { fields: { cc_users: 1, traces: 1 } }).forEach (ins)->\n\t\t_.each ins.traces, (t)->\n\t\t\t_.each t.approves, (a, idx)->\n\t\t\t\tif a.is_finished is false and a.type is 'cc'\n\t\t\t\t\tif a.agent is toId\n\t\t\t\t\t\tnext_step_space_user = uuflowManager.getSpaceUser(spaceId, a.user)\n\t\t\t\t\t\t# 获取next_step_user所在的部门信息\n\t\t\t\t\t\tnext_step_user_org_info = uuflowManager.getSpaceUserOrgInfo(next_step_space_user)\n\t\t\t\t\t\tidxStr = \"traces.$.approves.#{idx}.\"\n\t\t\t\t\t\tsetObj = {}\n\t\t\t\t\t\tsetObj[idxStr + 'handler'] = a.user\n\t\t\t\t\t\tsetObj[idxStr + 'handler_name'] = a.user_name\n\t\t\t\t\t\tsetObj[idxStr + 'handler_organization'] = next_step_user_org_info[\"organization\"]\n\t\t\t\t\t\tsetObj[idxStr + 'handler_organization_name'] = next_step_user_org_info[\"organization_name\"]\n\t\t\t\t\t\tsetObj[idxStr + 'handler_organization_fullname'] = next_step_user_org_info[\"organization_fullname\"]\n\t\t\t\t\t\tsetObj[idxStr + 'agent'] = null\n\t\t\t\t\t\tins.cc_users.splice(ins.cc_users.indexOf(toId), 1, a.user)\n\t\t\t\t\t\tsetObj.cc_users = ins.cc_users\n\n\t\t\t\t\t\tdb.instances.update({ _id: ins._id, cc_users: toId, 'traces._id': a.trace }, { $set: setObj })\n\n\t\t\t\t\t\tpushManager.send_message_to_specifyUser('current_user', a.user)\n\t\t\t\t\t\tpushManager.send_message_to_specifyUser('current_user', toId)\n\t\t\t\t\telse if a.user is toId\n\t\t\t\t\t\tdb.instances.update({ _id: ins._id }, { $addToSet: { cc_users: toId } })\n\n\nuuflowManager.timeoutAutoSubmit = (ins_id)->\n\tquery = {}\n\tif ins_id\n\t\tcheck ins_id, String\n\t\tquery._id = ins_id\n\n\tquery.state = 'pending'\n\tquery.current_step_auto_submit = true\n\tquery.traces = { $elemMatch: { is_finished: false, due_date: { $lte: new Date } } }\n\n\tdb.instances.find(query).forEach (ins)->\n\t\ttry\n\t\t\tflow_id = ins.flow\n\t\t\tinstance_id = ins._id\n\t\t\ttrace = _.last ins.traces\n\t\t\tflow = uuflowManager.getFlow(flow_id)\n\t\t\tstep = uuflowManager.getStep(ins, flow, trace.step)\n\t\t\tstep_type = step.step_type\n\t\t\ttoLine = _.find step.lines, (l)->\n\t\t\t\treturn l.timeout_line == true\n\t\t\tnextStepId = toLine.to_step\n\t\t\tnextStep = uuflowManager.getStep(ins, flow, nextStepId)\n\t\t\tif nextStep.step_type == 'condition'\n\t\t\t\tnextSteps = uuflowManager.getNextSteps(ins, flow, nextStep, \"\")\n\t\t\t\tconsole.error nextSteps\n\t\t\t\tnextStepId = nextSteps[0]\n\n\t\t\tnextUserIds = getHandlersManager.getHandlers(instance_id, nextStepId)\n\n\t\t\tjudge = \"submitted\"\n\t\t\tif step_type is \"sign\"\n\t\t\t\tjudge = \"approved\"\n\n\t\t\tapprove_from_client = {\n\t\t\t\t'instance': instance_id\n\t\t\t\t'trace': trace._id\n\t\t\t\t'judge': judge\n\t\t\t\t'next_steps': [{ 'step': nextStepId, 'users': nextUserIds }]\n\t\t\t}\n\t\t\t_.each trace.approves, (a)->\n\t\t\t\tapprove_from_client._id = a._id\n\t\t\t\tcurrent_user_info = db.users.findOne(a.handler, { services: 0 })\n\t\t\t\tupdatedInstance = uuflowManager.workflow_engine(approve_from_client, current_user_info, current_user_info._id, true)\n\n\t\t\t\t# 满足超时自动提交条件后，则将申请单提交至下一步骤，并发送提示给当前步骤处理人\n\t\t\t\tpushManager.send_instance_notification(\"auto_submit_pending_inbox\", updatedInstance, \"\", current_user_info)\n\n\t\tcatch e\n\t\t\tconsole.error 'AUTO TIMEOUT_AUTO_SUBMIT ERROR: '\n\t\t\tconsole.error e.stack\n\n\n\treturn true\n\n### 申请单重定位\ninstance_from_client: {\n\t_id: 申请单_id,\n\trelocate_inbox_users: 新处理人,\n\trelocate_comment: 备注,\n\trelocate_next_step: 新步骤\n}\ncurrent_user_info: User记录\n###\nuuflowManager.relocate = (instance_from_client, current_user_info)->\n\tcurrent_user = current_user_info._id\n\n\tinstance = uuflowManager.getInstance(instance_from_client[\"_id\"])\n\n\tlast_trace = _.last(instance.traces)\n\n\t# 验证login user_id对该流程有管理申请单的权限\n\tpermissions = permissionManager.getFlowPermissions(instance.flow, current_user)\n\tspace = db.spaces.findOne(instance.space, { fields: { admins: 1 } })\n\tif (not permissions.includes(\"admin\")) and (not space.admins.includes(current_user))\n\t\tthrow new Meteor.Error('error!', \"用户没有对当前流程的管理权限\")\n\n\tspace_id = instance.space\n\tinstance_id = last_trace.instance\n\tinbox_users = instance.inbox_users\n\trelocate_inbox_users = instance_from_client[\"relocate_inbox_users\"]\n\trelocate_comment = instance_from_client[\"relocate_comment\"]\n\trelocate_next_step = instance_from_client[\"relocate_next_step\"]\n\tnot_in_inbox_users = _.difference(inbox_users, relocate_inbox_users)\n\tnew_inbox_users = _.difference(relocate_inbox_users, inbox_users)\n\n\tapprove_users = []\n\n\t# 获取一个flow\n\tflow = uuflowManager.getFlow(instance.flow)\n\tnext_step = uuflowManager.getStep(instance, flow, relocate_next_step)\n\tnext_step_type = next_step.step_type\n\tnext_step_name = next_step.name\n\tcurrent_setp = uuflowManager.getStep(instance, flow, last_trace.step)\n\tcurrent_setp_type = current_setp.step_type\n\n\ttraces = instance.traces\n\tsetObj = new Object\n\t# 重定位的时候使用approve.values合并 instance.values生成新的instance.values #1328\n\tsetObj.values = uuflowManager.getUpdatedValues(instance)\n\tnow = new Date\n\ti = 0\n\twhile i < traces.length\n\t\tif traces[i]._id is last_trace._id\n\t\t\tif not traces[i].approves\n\t\t\t\ttraces[i].approves = new Array\n\t\t\t# 更新当前trace.approve记录\n\t\t\th = 0\n\t\t\twhile h < traces[i].approves.length\n\t\t\t\tif traces[i].approves[h].is_finished is false and traces[i].approves[h].type isnt \"cc\" and traces[i].approves[h].type isnt \"distribute\"\n\t\t\t\t\ttraces[i].approves[h].start_date = now\n\t\t\t\t\ttraces[i].approves[h].finish_date = now\n\t\t\t\t\ttraces[i].approves[h].read_date = now\n\t\t\t\t\ttraces[i].approves[h].is_error = false\n\t\t\t\t\ttraces[i].approves[h].is_read = true\n\t\t\t\t\ttraces[i].approves[h].is_finished = true\n\t\t\t\t\ttraces[i].approves[h].judge = \"terminated\"\n\t\t\t\t\ttraces[i].approves[h].cost_time = traces[i].approves[h].finish_date - traces[i].approves[h].start_date\n\t\t\t\t\tapprove_users.push(traces[i].approves[h].user)\n\n\t\t\t\t\t# begin 被重定位给A，再被重定位走，之前A的意见在意见栏中显示不出来了。 #1921\n\t\t\t\t\tif traces[i].approves[h].sign_show == true\n\t\t\t\t\t\tta = traces[i].approves[h]\n\t\t\t\t\t\tsameTraces = _.filter traces, (t)->\n\t\t\t\t\t\t\treturn t.step == traces[i].step\n\n\t\t\t\t\t\tl = sameTraces.length - 1\n\t\t\t\t\t\tsignShowApproveId = null\n\n\t\t\t\t\t\twhile l > -1\n\t\t\t\t\t\t\t_.each sameTraces[l].approves, (a)->\n\t\t\t\t\t\t\t\tif a.user == ta.user && a.judge != \"terminated\" && a.description && !signShowApproveId\n\t\t\t\t\t\t\t\t\tsignShowApproveId = a._id\n\t\t\t\t\t\t\tl--\n\n\t\t\t\t\t\tif signShowApproveId\n\t\t\t\t\t\t\tti = 0\n\t\t\t\t\t\t\twhile ti < traces.length\n\t\t\t\t\t\t\t\tah = 0\n\t\t\t\t\t\t\t\twhile ah < traces[ti].approves.length\n\t\t\t\t\t\t\t\t\tif traces[ti].approves[ah]._id == signShowApproveId\n\t\t\t\t\t\t\t\t\t\ttraces[ti].approves[ah].sign_show = true\n\t\t\t\t\t\t\t\t\t\ttraces[i].approves[h].sign_show = false\n\t\t\t\t\t\t\t\t\tah++\n\t\t\t\t\t\t\t\tti++\n\t\t\t\t\t# end 被重定位给A，再被重定位走，之前A的意见在意见栏中显示不出来了。 #1921\n\n\t\t\t\th++\n\n\t\t\t# 在同一trace下插入重定位操作者的approve记录\n\t\t\tcurrent_space_user = uuflowManager.getSpaceUser(space_id, current_user)\n\t\t\tcurrent_user_organization = db.organizations.findOne(current_space_user.organization, { fields: { name: 1 , fullname: 1 } })\n\t\t\trelocate_appr = new Object\n\t\t\trelocate_appr._id = new Mongo.ObjectID()._str\n\t\t\trelocate_appr.instance = instance_id\n\t\t\trelocate_appr.trace = traces[i]._id\n\t\t\trelocate_appr.is_finished = true\n\t\t\trelocate_appr.user = current_user\n\t\t\trelocate_appr.user_name = current_user_info.name\n\t\t\trelocate_appr.handler = current_user\n\t\t\trelocate_appr.handler_name = current_user_info.name\n\t\t\trelocate_appr.handler_organization = current_space_user.organization\n\t\t\trelocate_appr.handler_organization_name = current_user_organization.name\n\t\t\trelocate_appr.handler_organization_fullname = current_user_organization.fullname\n\t\t\trelocate_appr.start_date = now\n\t\t\trelocate_appr.finish_date = now\n\t\t\trelocate_appr.due_date = traces[i].due_date\n\t\t\trelocate_appr.read_date = now\n\t\t\trelocate_appr.judge = \"relocated\"\n\t\t\trelocate_appr.is_read = true\n\t\t\trelocate_appr.description = relocate_comment\n\t\t\trelocate_appr.is_error = false\n\t\t\trelocate_appr.values = new Object\n\t\t\trelocate_appr.cost_time = relocate_appr.finish_date - relocate_appr.start_date\n\t\t\ttraces[i].approves.push(relocate_appr)\n\n\t\t\t# 更新当前trace记录\n\t\t\ttraces[i].is_finished = true\n\t\t\ttraces[i].finish_date = now\n\t\t\ttraces[i].judge = \"relocated\"\n\n\t\ti++\n\n\tif next_step_type is \"end\"\n\t\t# 插入下一步trace记录\n\t\tnewTrace = new Object\n\t\tnewTrace._id = new Mongo.ObjectID()._str\n\t\tnewTrace.instance = instance_id\n\t\tnewTrace.previous_trace_ids = [last_trace._id]\n\t\tnewTrace.is_finished = true\n\t\tnewTrace.step = relocate_next_step\n\t\tnewTrace.name = next_step_name\n\t\tnewTrace.start_date = now\n\t\tnewTrace.finish_date = now\n\t\tnewTrace.approves = []\n\t\t# 更新instance记录\n\t\tsetObj.state = \"completed\"\n\t\tsetObj.inbox_users = []\n\t\tsetObj.final_decision = \"terminated\"\n\t\tsetObj.finish_date = new Date\n\t\tsetObj.current_step_name = next_step_name\n\t\tsetObj.current_step_auto_submit = false\n\telse\n\t\t# 插入下一步trace记录\n\t\tnewTrace = new Object\n\t\tnewTrace._id = new Mongo.ObjectID()._str\n\t\tnewTrace.instance = instance_id\n\t\tnewTrace.previous_trace_ids = [last_trace._id]\n\t\tnewTrace.is_finished = false\n\t\tnewTrace.step = relocate_next_step\n\t\tnewTrace.name = next_step_name\n\t\tnewTrace.start_date = now\n\t\tnewTrace.due_date = uuflowManager.getDueDate(next_step.timeout_hours, space_id)\n\t\tnewTrace.approves = []\n\t\t_.each(relocate_inbox_users, (next_step_user_id, idx)->\n\t\t\t# 插入下一步trace.approve记录\n\t\t\tnewApprove = new Object\n\t\t\tnewApprove._id = new Mongo.ObjectID()._str\n\t\t\tnewApprove.instance = instance_id\n\t\t\tnewApprove.trace = newTrace._id\n\t\t\tnewApprove.is_finished = false\n\t\t\tnewApprove.user = next_step_user_id\n\n\t\t\tuser_info = db.users.findOne(next_step_user_id, { fields: { name: 1 } })\n\t\t\tnewApprove.user_name = user_info.name\n\n\t\t\thandler_id = next_step_user_id\n\t\t\thandler_info = user_info\n\t\t\tagent = uuflowManager.getAgent(space_id, next_step_user_id)\n\t\t\tif agent\n\t\t\t\trelocate_inbox_users[idx] = agent\n\t\t\t\thandler_id = agent\n\t\t\t\thandler_info = db.users.findOne({ _id: agent }, { fields: { name: 1 } })\n\t\t\t\tnewApprove.agent = agent\n\n\t\t\tnewApprove.handler = handler_id\n\t\t\tnewApprove.handler_name = handler_info.name\n\n\t\t\tnext_step_space_user = uuflowManager.getSpaceUser(space_id, handler_id)\n\t\t\t# 获取next_step_user所在的部门信息\n\t\t\tnext_step_user_org_info = uuflowManager.getSpaceUserOrgInfo(next_step_space_user)\n\t\t\tnewApprove.handler_organization = next_step_user_org_info[\"organization\"]\n\t\t\tnewApprove.handler_organization_name = next_step_user_org_info[\"organization_name\"]\n\t\t\tnewApprove.handler_organization_fullname = next_step_user_org_info[\"organization_fullname\"]\n\n\t\t\tnewApprove.start_date = now\n\t\t\tnewApprove.due_date = newTrace.due_date\n\t\t\tnewApprove.is_read = false\n\t\t\tnewApprove.is_error = false\n\t\t\tnewApprove.values = new Object\n\t\t\tuuflowManager.setRemindInfo(instance.values, newApprove)\n\t\t\tnewTrace.approves.push(newApprove)\n\t\t)\n\t\tsetObj.inbox_users = relocate_inbox_users\n\t\tsetObj.state = \"pending\"\n\t\tsetObj.current_step_name = next_step_name\n\t\tsetObj.current_step_auto_submit = uuflowManager.getCurrentStepAutoSubmit(flow.timeout_auto_submit, next_step.lines)\n\n\tinstance.outbox_users.push(current_user)\n\tinstance.outbox_users = instance.outbox_users.concat(inbox_users).concat(approve_users)\n\tsetObj.outbox_users = _.uniq(instance.outbox_users)\n\tsetObj.modified = now\n\tsetObj.modified_by = current_user\n\tsetObj.is_archived = false\n\ttraces.push(newTrace)\n\tsetObj.traces = traces\n\n\tif setObj.state == 'completed'\n\t\tr = db.instances.update({_id: instance_id}, {$set: setObj})\n\telse\n\t\tr = db.instances.update({_id: instance_id}, {$set: setObj, $unset: {finish_date: 1}})\n\n\tif r\n\t\tins = uuflowManager.getInstance(instance_id)\n\t\t# 给被删除的inbox_users 和 当前用户 发送push\n\t\tpushManager.send_message_current_user(current_user_info)\n\t\t_.each(not_in_inbox_users, (user_id)->\n\t\t\tif user_id isnt current_user\n\t\t\t\tpushManager.send_message_to_specifyUser(\"current_user\", user_id)\n\t\t)\n\t\t# 提取instances.outbox_users数组和填单人、申请人\n\t\t_users = new Array\n\t\t_users.push(ins.applicant)\n\t\t_users.push(ins.submitter)\n\t\t_users = _.uniq(_users.concat(ins.outbox_users))\n\t\t_.each(_users, (user_id)->\n\t\t\tpushManager.send_message_to_specifyUser(\"current_user\", user_id)\n\t\t)\n\n\t\t# 给新加入的inbox_users发送push message\n\t\tpushManager.send_instance_notification(\"reassign_new_inbox_users\", ins, relocate_comment, current_user_info)\n\n\t\t# 如果已经配置webhook并已激活则触发\n\t\tpushManager.triggerWebhook(ins.flow, ins, {}, 'relocate', current_user, ins.inbox_users)\n\nuuflowManager.draft_save_instance = (ins, userId) -> \n\tresult = true\n\tsetObj = {}\n\tindex = 0\n\tins_id = ins._id\n\ttrace_id = ins.traces[0]._id\n\tapprove_id = ins.traces[0].approves[0]._id\n\tdescription = ins.traces[0].approves[0].description\n\tnext_steps = ins.traces[0].approves[0].next_steps\n\tvalues = ins.traces[0].approves[0].values or {}\n\tapplicant_id = ins.applicant\n\tinstance = db.instances.findOne(ins_id, fields:\n\t\tapplicant: 1\n\t\tstate: 1\n\t\tsubmitter: 1\n\t\ttraces: 1\n\t\tform: 1\n\t\tflow_version: 1\n\t\tspace: 1\n\t\tflow: 1)\n\tspace_id = instance.space\n\tflow_id = instance.flow\n\tform_id = instance.form\n\ttraces = instance.traces\n\tcurrent_trace = _.find(traces, (t) ->\n\t\tt._id == trace_id\n\t)\n\tcurrent_trace.approves.forEach (a, idx) ->\n\t\tif a._id == approve_id\n\t\t\tindex = idx\n\t\treturn\n\tkey_str = 'traces.$.approves.' + index + '.'\n\t# 判断一个instance是否为拟稿状态\n\tcurrent_user = db.users.findOne({ _id: userId }, fields: locale: 1)\n\tlang = if current_user.locale == 'zh-cn' then 'zh-CN' else 'en'\n\tuuflowManager.isInstanceDraft instance, lang\n\t# 判断一个用户是否是一个instance的提交者\n\tuuflowManager.isInstanceSubmitter instance, userId\n\tflow = db.flows.findOne(flow_id, fields:\n\t\t'current._id': 1\n\t\t'current.form_version': 1\n\t\t'name': 1\n\t\t'current.steps': 1)\n\tsetObj.modified = new Date\n\tsetObj.modified_by = userId\n\tif flow.current._id != instance.flow_version\n\t\tresult = 'upgraded'\n\t\tstart_step = _.find(flow.current.steps, (s) ->\n\t\t\ts.step_type == 'start'\n\t\t)\n\t\t# 流程已升级\n\t\tsetObj.flow_version = flow.current._id\n\t\tsetObj.form_version = flow.current.form_version\n\t\t# 存入当前最新版flow中开始节点的step_id\n\t\tsetObj['traces.$.step'] = start_step._id\n\t\tsetObj['traces.$.name'] = start_step.name\n\tif instance.applicant != applicant_id\n\t\t# 申请人已变换\n\t\tuser = db.users.findOne(applicant_id, fields: name: 1)\n\t\tapplicant = db.space_users.find({\n\t\t\tspace: space_id\n\t\t\tuser: applicant_id\n\t\t}, fields: organization: 1)\n\t\torg_id = applicant.fetch()[0].organization\n\t\torganization = db.organizations.findOne(org_id, fields:\n\t\t\tname: 1\n\t\t\tfullname: 1)\n\t\tsetObj.applicant = applicant_id\n\t\tsetObj.applicant_name = user.name\n\t\tsetObj.applicant_organization = org_id\n\t\tsetObj.applicant_organization_name = organization.name\n\t\tsetObj.applicant_organization_fullname = organization.fullname\n\t\tsetObj[key_str + 'user'] = applicant_id\n\t\tsetObj[key_str + 'user_name'] = user.name\n\tsetObj[key_str + 'values'] = values\n\tsetObj[key_str + 'description'] = description\n\tsetObj[key_str + 'judge'] = 'submitted'\n\tsetObj[key_str + 'read_date'] = new Date\n\tif result != 'upgraded' and next_steps\n\t\tsetObj[key_str + 'next_steps'] = next_steps\n\t# 计算申请单标题\n\tform = db.forms.findOne({ _id: form_id }, fields: 'current.name_forumla': 1)\n\tname_forumla = form.current.name_forumla\n\tif name_forumla\n\t\t# var iscript = name_forumla.replace(/\\{/g, \"(values['\").replace(/\\}/g, \"'] || '')\");\n\t\t# var rev = eval(iscript);\n\t\tsetObj.name = uuflowManager.getInstanceName(ins, values)\n\tdb.instances.update {\n\t\t_id: ins_id\n\t\t'traces._id': trace_id\n\t}, $set: setObj\n\tresult","var Cookies, _eval, isSkipStep, steedosCore;               \n\nCookies = require(\"cookies\");\n\n_eval = require('eval');\n\nsteedosCore = require('@steedos/core');\n\nuuflowManager = {};\n\nuuflowManager.check_authorization = function(req, res) {\n  var authToken, cookies, hashedToken, query, user, userId;\n  query = req.query;\n  userId = query[\"X-User-Id\"];\n  authToken = query[\"X-Auth-Token\"];\n  if (!userId || !authToken) {\n    cookies = new Cookies(req, res);\n    userId = cookies.get(\"X-User-Id\");\n    authToken = cookies.get(\"X-Auth-Token\");\n  }\n  if (!userId || !authToken) {\n    throw new Meteor.Error(401, 'Unauthorized');\n  }\n  hashedToken = Accounts._hashLoginToken(authToken);\n  user = Meteor.users.findOne({\n    _id: userId,\n    \"services.resume.loginTokens.hashedToken\": hashedToken\n  });\n  if (!user) {\n    throw new Meteor.Error(401, 'Unauthorized');\n  }\n  return user;\n};\n\nuuflowManager.checkNestStepUsersIsValid = function(selected, scope, nextStep) {\n  if (nextStep != null ? nextStep.allow_pick_approve_users : void 0) {\n    return true;\n  }\n  if (_.difference(selected, scope).length > 0) {\n    return false;\n  }\n  return true;\n};\n\nuuflowManager.getInstance = function(instance_id) {\n  var ins;\n  ins = db.instances.findOne(instance_id);\n  if (!ins) {\n    throw new Meteor.Error('error!', \"申请单ID：\" + instance_id + \"有误或此申请单已经被删除\");\n  }\n  return ins;\n};\n\nuuflowManager.getSpace = function(space_id) {\n  var space;\n  space = db.spaces.findOne(space_id);\n  if (!space) {\n    throw new Meteor.Error('error!', \"space_id有误或此space已经被删除\");\n  }\n  return space;\n};\n\nuuflowManager.getSpaceUser = function(space_id, user_id) {\n  var space_user;\n  space_user = db.space_users.findOne({\n    space: space_id,\n    user: user_id\n  });\n  if (!space_user) {\n    throw new Meteor.Error('error!', \"user_id对应的用户不属于当前space\");\n  }\n  return space_user;\n};\n\nuuflowManager.getFlow = function(flow_id) {\n  var flow;\n  flow = db.flows.findOne(flow_id);\n  if (!flow) {\n    throw new Meteor.Error('error!', \"id有误或此流程已经被删除\");\n  }\n  return flow;\n};\n\nuuflowManager.getSpaceUserOrgInfo = function(space_user) {\n  var info, org;\n  info = new Object;\n  info.organization = space_user.organization;\n  org = db.organizations.findOne(space_user.organization, {\n    fields: {\n      name: 1,\n      fullname: 1\n    }\n  });\n  info.organization_name = org.name;\n  info.organization_fullname = org.fullname;\n  return info;\n};\n\nuuflowManager.getTrace = function(instance, trace_id) {\n  var trace;\n  trace = _.find(instance.traces, function(t) {\n    return t._id === trace_id;\n  });\n  if (!trace) {\n    throw new Meteor.Error('error!', \"trace_id有误\");\n  }\n  return trace;\n};\n\nuuflowManager.getApprove = function(trace, approve_id) {\n  var approve;\n  approve = _.find(trace.approves, function(t) {\n    return t._id === approve_id;\n  });\n  if (!approve) {\n    throw new Meteor.Error('error!', \"trace_id有误\");\n  }\n  return approve;\n};\n\nuuflowManager.isTraceNotFinished = function(trace) {\n  if (trace.is_finished !== false) {\n    throw new Meteor.Error('error!', \"可能已有人对此文件做了处理。请点击已审核，查看文件的最新状态\");\n  }\n};\n\nuuflowManager.isApproveNotFinished = function(approve) {\n  if (approve.is_finished !== false) {\n    throw new Meteor.Error('error!', \"当前步骤不为未完成状态,不能进行此操作\");\n  }\n};\n\nuuflowManager.isInstancePending = function(instance, lang) {\n  if (lang == null) {\n    lang = \"zh-CN\";\n  }\n  if (instance.state !== \"pending\") {\n    throw new Meteor.Error('error!', TAPi18n.__('instance.remindMessage.update_failed', {}, lang));\n  }\n};\n\nuuflowManager.isHandlerOrAgent = function(approve, user_id) {\n  if (approve.user !== user_id && approve.agent !== user_id) {\n    throw new Meteor.Error('error!', \"不是当前步骤对应的处理人或其代理人，不能进行此操作\");\n  }\n};\n\nuuflowManager.isInstanceDraft = function(instance, lang) {\n  if (lang == null) {\n    lang = \"zh-CN\";\n  }\n  if (instance.state !== \"draft\") {\n    throw new Meteor.Error('error!', TAPi18n.__('instance.remindMessage.update_failed', {}, lang));\n  }\n};\n\nuuflowManager.isInstanceSubmitter = function(instance, current_user_id) {\n  if (instance.submitter !== current_user_id) {\n    throw new Meteor.Error('error!', '当前用户不是申请单对应的提交人,不能进行此操作');\n  }\n};\n\nuuflowManager.isInstanceSubmitterOrApplicantOrSpaceAdmin = function(instance, current_user_id, space) {\n  if (instance.submitter !== current_user_id && instance.applicant !== current_user_id && !space.admins.includes(current_user_id)) {\n    throw new Meteor.Error('error!', \"当前用户不是申请单对应的提交人或申请人或工作区管理员\");\n  }\n};\n\nuuflowManager.getStep = function(instance, flow, step_id) {\n  var flow_rev, isExistStep;\n  flow_rev = instance.flow_version;\n  isExistStep = null;\n  if (flow.current._id === flow_rev) {\n    isExistStep = _.find(flow.current.steps, function(step) {\n      return step._id === step_id;\n    });\n  } else {\n    _.each(flow.historys, function(history) {\n      if (history._id === flow_rev) {\n        return isExistStep = _.find(history.steps, function(step) {\n          return step._id === step_id;\n        });\n      }\n    });\n  }\n  if (!isExistStep) {\n    throw new Meteor.Error('error!', \"不能获取step\");\n  }\n  return isExistStep;\n};\n\nuuflowManager.isJudgeLegal = function(judge) {\n  if (judge !== \"approved\" && judge !== \"rejected\" && judge !== \"readed\" && judge !== \"submitted\") {\n    throw new Meteor.Error('error!', \"judge有误\");\n  }\n};\n\nuuflowManager.isSpaceAdmin = function(space_id, user_id) {\n  var space;\n  space = db.spaces.findOne({\n    _id: space_id\n  }, {\n    fields: {\n      admins: 1\n    }\n  });\n  if (!space.admins.includes(user_id)) {\n    throw new Meteor.Error('error!', \"当前用户不是工作区管理员,不能进行此操作\");\n  }\n};\n\nuuflowManager.getUser = function(user_id) {\n  var user;\n  user = db.users.findOne(user_id);\n  if (!user) {\n    throw new Meteor.Error('error!', \"用户ID有误或此用户已经被删除\");\n  }\n  return user;\n};\n\nuuflowManager.getUserOrganization = function(user_id, space_id) {\n  var org;\n  org = db.organizations.findOne({\n    space: space_id,\n    users: user_id\n  });\n  return org;\n};\n\nuuflowManager.getUserRoles = function(user_id, space_id) {\n  var positions, role_names;\n  role_names = new Array;\n  positions = db.flow_positions.find({\n    space: space_id,\n    users: user_id\n  }, {\n    fields: {\n      role: 1\n    }\n  }).fetch();\n  _.each(positions, function(position) {\n    var role;\n    role = db.flow_roles.findOne({\n      _id: position.role\n    }, {\n      fields: {\n        name: 1\n      }\n    });\n    if (role) {\n      return role_names.push(role.name);\n    }\n  });\n  return role_names;\n};\n\nuuflowManager.isFlowEnabled = function(flow) {\n  if (flow.state !== \"enabled\") {\n    throw new Meteor.Error('error!', \"流程未启用,操作失败\");\n  }\n};\n\nuuflowManager.isFlowSpaceMatched = function(flow, space_id) {\n  if (flow.space !== space_id) {\n    throw new Meteor.Error('error!', \"流程和工作区ID不匹配\");\n  }\n};\n\nuuflowManager.calculateCondition = function(values, condition_str) {\n  var __values, average, count, e, max, min, sum;\n  try {\n    __values = values;\n    sum = function(subform_field) {\n      var sum_field_value;\n      if (!subform_field) {\n        throw new Meteor.Error('error!', \"参数为空\");\n      }\n      if (!subform_field instanceof Array) {\n        throw new Meteor.Error('error!', \"参数不是数组类型\");\n      }\n      sum_field_value = 0;\n      _.each(subform_field, function(field_value) {\n        field_value = Number(String(field_value));\n        return sum_field_value += field_value;\n      });\n      return sum_field_value;\n    };\n    average = function(subform_field) {\n      if (!subform_field) {\n        throw new Meteor.Error('error!', \"参数为空\");\n      }\n      if (!subform_field instanceof Array) {\n        throw new Meteor.Error('error!', \"参数不是数组类型\");\n      }\n      return sum(subform_field) / count(subform_field);\n    };\n    count = function(subform_field) {\n      if (!subform_field) {\n        throw new Meteor.Error('error!', \"参数为空\");\n      }\n      return subform_field.length;\n    };\n    max = function(subform_field) {\n      var sub_field;\n      if (!subform_field) {\n        throw new Meteor.Error('error!', \"参数为空\");\n      }\n      if (!subform_field instanceof Array) {\n        throw new Meteor.Error('error!', \"参数不是数组类型\");\n      }\n      sub_field = new Array;\n      _.each(subform_field, function(field_value) {\n        return sub_field.push(Number(String(field_value)));\n      });\n      return _.max(sub_field);\n    };\n    min = function(subform_field) {\n      var sub_field;\n      if (!subform_field) {\n        throw new Meteor.Error('error!', \"参数为空\");\n      }\n      if (!subform_field instanceof Array) {\n        throw new Meteor.Error('error!', \"参数不是数组类型\");\n      }\n      sub_field = new Array;\n      _.each(subform_field, function(field_value) {\n        return sub_field.push(Number(String(field_value)));\n      });\n      return _.min(sub_field);\n    };\n    return eval(condition_str);\n  } catch (error) {\n    e = error;\n    console.error(e.stack);\n    return false;\n  }\n};\n\nuuflowManager.setFormFieldVariable = function(fields, __values, space_id) {\n  var e;\n  try {\n    return _.each(fields, function(field) {\n      var _subform_values, group_fullname, group_id, group_name, organization, organization_selectuser, role_selectuser, subform_fields_all, user_id, user_name, user_roles;\n      if (field.type === \"table\") {\n        subform_fields_all = field.fields;\n        _subform_values = new Object;\n        return _.each(subform_fields_all, function(current_field) {\n          var values_arr;\n          values_arr = new Array;\n          if ([\"number\", \"percentage\", \"currency\"].includes(current_field[\"type\"])) {\n            _.each(__values[field.code], function(sub_field) {\n              return values_arr.push(sub_field[current_field[\"code\"]]);\n            });\n          } else if (current_field[\"type\"] === \"checkbox\") {\n            _.each(__values[field.code], function(sub_field) {\n              if (sub_field[current_field[\"code\"]] === \"true\") {\n                return values_arr.push(true);\n              } else if (sub_field[current_field[\"code\"]] === \"false\") {\n                return values_arr.push(false);\n              }\n            });\n          } else {\n            _.each(__values[field.code], function(sub_field) {\n              if (sub_field[current_field[\"code\"]]) {\n                return values_arr.push(sub_field[current_field[\"code\"]]);\n              } else {\n                return values_arr.push(\"\");\n              }\n            });\n          }\n          return __values[current_field[\"code\"]] = values_arr;\n        });\n      } else if (field.type === \"group\") {\n        if (field.is_multiselect) {\n          if (__values[field.code] && __values[field.code].length > 0) {\n            group_id = new Array;\n            group_name = new Array;\n            group_fullname = new Array;\n            _.each(__values[field.code], function(group) {\n              group_id.push(group[\"id\"]);\n              group_name.push(group[\"name\"]);\n              return group_fullname.push(group[\"fullname\"]);\n            });\n            __values[field.code] = new Object;\n            __values[field.code][\"id\"] = group_id;\n            __values[field.code][\"name\"] = group_name;\n            return __values[field.code][\"fullname\"] = group_fullname;\n          }\n        }\n      } else if (field.type === \"user\") {\n        if (field.is_multiselect) {\n          if (__values[field.code] && __values[field.code].length > 0) {\n            user_id = new Array;\n            user_name = new Array;\n            organization = new Object;\n            organization[\"user_organization_fullname\"] = new Array;\n            organization[\"user_organization_name\"] = new Array;\n            user_roles = new Array;\n            _.each(__values[field.code], function(select_user) {\n              var organization_selectuser, role_selectuser;\n              user_id.push(select_user[\"id\"]);\n              user_name.push(select_user[\"name\"]);\n              organization_selectuser = uuflowManager.getUserOrganization(select_user[\"id\"], space_id);\n              role_selectuser = uuflowManager.getUserRoles(select_user[\"id\"], space_id);\n              if (organization_selectuser) {\n                organization[\"user_organization_fullname\"].push(organization_selectuser.fullname);\n                organization[\"user_organization_name\"].push(organization_selectuser.name);\n              }\n              if (role_selectuser) {\n                return user_roles = user_roles || role_selectuser;\n              }\n            });\n            __values[field.code] = new Object;\n            __values[field.code][\"id\"] = user_id;\n            __values[field.code][\"name\"] = user_name;\n            __values[field.code][\"organization\"] = organization;\n            return __values[field.code][\"roles\"] = roles;\n          }\n        } else {\n          if (__values[field.code]) {\n            organization_selectuser = uuflowManager.getUserOrganization(__values[field.code][\"id\"], space_id);\n            role_selectuser = uuflowManager.getUserRoles(__values[field.code][\"id\"], space_id);\n            if (organization_selectuser) {\n              __values[field.code][\"organization\"] = new Object;\n              __values[field.code][\"organization\"][\"fullname\"] = organization_selectuser.fullname;\n              __values[field.code][\"organization\"][\"name\"] = organization_selectuser.name;\n            }\n            return __values[field.code][\"roles\"] = role_selectuser;\n          }\n        }\n      } else if ([\"number\", \"percentage\", \"currency\"].includes(field.type)) {\n        if (__values[field.code]) {\n          return __values[field.code] = Number(__values[field.code]);\n        } else {\n          return __values[field.code] = 0;\n        }\n      } else if (field.type === \"checkbox\") {\n        if (__values[field.code] === \"true\") {\n          return __values[field.code] = true;\n        } else if (__values[field.code] === \"false\") {\n          return __values[field.code] = false;\n        }\n      }\n    });\n  } catch (error) {\n    e = error;\n    return console.error(e.stack);\n  }\n};\n\nisSkipStep = function(instance, step) {\n  return _.contains(instance.skip_steps, step._id);\n};\n\nuuflowManager.getNextSteps = function(instance, flow, step, judge, values) {\n  var __values, applicant_name, applicant_organization_fullname, applicant_organization_name, applicant_roles, approver_name, approver_organization_fullname, approver_organization_name, approver_roles, current_approve, flowVersions, flow_steps, form, formVersion, lines, nextSteps, prefix, reg, rejectedSteps, rev_nextSteps, start_approve, step_type, submitter_name, submitter_organization_fullname, submitter_organization_name, submitter_roles, trace_steps, traces, version_steps;\n  step_type = step.step_type;\n  nextSteps = new Array;\n  if (step_type === \"condition\") {\n    if (values !== void 0) {\n      __values = values;\n    } else {\n      __values = uuflowManager.getUpdatedValues(instance);\n    }\n    current_approve = null;\n    traces = instance.traces;\n    _.each(traces, function(trace) {\n      if (trace.is_finished === false) {\n        return current_approve = trace.approves[0];\n      }\n    });\n    start_approve = null;\n    _.each(traces, function(trace) {\n      if (!trace.previous_trace_ids || trace.previous_trace_ids.length === 0) {\n        return start_approve = trace.approves[0];\n      }\n    });\n    applicant_organization_fullname = instance.applicant_organization_fullname;\n    applicant_organization_name = instance.applicant_organization_name;\n    applicant_roles = uuflowManager.getUserRoles(instance.applicant, instance.space);\n    applicant_name = instance.applicant_name;\n    submitter_organization_fullname = start_approve.handler_organization_fullname;\n    submitter_organization_name = start_approve.handler_organization_name;\n    submitter_roles = uuflowManager.getUserRoles(start_approve.handler, instance.space);\n    submitter_name = start_approve.handler_name;\n    approver_organization_fullname = current_approve.handler_organization_fullname;\n    approver_organization_name = current_approve.handler_organization_name;\n    approver_roles = uuflowManager.getUserRoles(current_approve.handler, instance.space);\n    approver_name = current_approve.handler_name;\n    __values[\"applicant\"] = new Object;\n    __values[\"applicant\"][\"roles\"] = applicant_roles;\n    __values[\"applicant\"][\"name\"] = applicant_name;\n    __values[\"applicant\"][\"organization\"] = new Object;\n    __values[\"applicant\"][\"organization\"][\"fullname\"] = applicant_organization_fullname;\n    __values[\"applicant\"][\"organization\"][\"name\"] = applicant_organization_name;\n    __values[\"submitter\"] = new Object;\n    __values[\"submitter\"][\"roles\"] = submitter_roles;\n    __values[\"submitter\"][\"name\"] = submitter_name;\n    __values[\"submitter\"][\"organization\"] = new Object;\n    __values[\"submitter\"][\"organization\"][\"fullname\"] = submitter_organization_fullname;\n    __values[\"submitter\"][\"organization\"][\"name\"] = submitter_organization_name;\n    __values[\"approver\"] = new Object;\n    __values[\"approver\"][\"roles\"] = approver_roles;\n    __values[\"approver\"][\"name\"] = approver_name;\n    __values[\"approver\"][\"organization\"] = new Object;\n    __values[\"approver\"][\"organization\"][\"fullname\"] = approver_organization_fullname;\n    __values[\"approver\"][\"organization\"][\"name\"] = approver_organization_name;\n    form = db.forms.findOne(instance.form);\n    formVersion = null;\n    if (instance.form_version === form.current._id) {\n      formVersion = form.current;\n    } else {\n      formVersion = _.find(form.historys, function(history) {\n        return instance.form_version === history._id;\n      });\n    }\n    uuflowManager.setFormFieldVariable(formVersion.fields, __values, instance.space);\n    reg = /(\\{[^{}]*\\})/g;\n    prefix = \"__values\";\n    _.each(step.lines, function(step_line) {\n      var step_line_condition;\n      step_line_condition = step_line.condition.replace(reg, function(vowel) {\n        return prefix + vowel.replace(/\\{\\s*/, \"[\\\"\").replace(/\\s*\\}/, \"\\\"]\").replace(/\\s*\\.\\s*/g, \"\\\"][\\\"\");\n      });\n      if (step_line.state === \"submitted\" && uuflowManager.calculateCondition(__values, step_line_condition)) {\n        if (step_line.state === \"submitted\") {\n          return nextSteps.push(step_line.to_step);\n        }\n      }\n    });\n  } else if (step_type === \"end\") {\n    return new Array;\n  } else if (step_type === \"submit\" || step_type === \"start\" || step_type === \"counterSign\") {\n    lines = _.filter(step.lines, function(line) {\n      return line.state === \"submitted\";\n    });\n    if (lines.length === 0) {\n      throw new Meteor.Error('error!', \"流程的连线配置有误\");\n    } else {\n      nextSteps = _.pluck(lines, 'to_step');\n    }\n  } else if (step_type === \"sign\") {\n    if (judge === \"approved\") {\n      lines = _.filter(step.lines, function(line) {\n        return line.state === \"approved\";\n      });\n      if (lines.length === 0) {\n        throw new Meteor.Error('error!', \"流程的连线配置有误\");\n      } else {\n        nextSteps = _.pluck(lines, 'to_step');\n      }\n    } else if (judge === \"rejected\") {\n      lines = _.filter(step.lines, function(line) {\n        return line.state === \"rejected\";\n      });\n      rejectedSteps = _.pluck(lines, 'to_step');\n      trace_steps = new Array;\n      _.each(instance.traces, function(trace) {\n        var flowVersions;\n        if (trace.is_finished === true) {\n          flowVersions = new Array;\n          flowVersions.push(flow.current);\n          if (flow.historys) {\n            flowVersions = flowVersions.concat(flow.historys);\n          }\n          return _.each(flowVersions, function(flowVer) {\n            if (flowVer._id === instance.flow_version) {\n              return _.each(flowVer.steps, function(flow_ver_step) {\n                if (flow_ver_step._id === trace.step && flow_ver_step.step_type !== \"condition\") {\n                  return trace_steps.push(trace.step);\n                }\n              });\n            }\n          });\n        }\n      });\n      flow_steps = new Array;\n      if (instance.flow_version === flow.current._id) {\n        _.each(flow.current.steps, function(flow_step) {\n          if (flow_step.step_type === \"start\" || flow_step.step_type === \"end\") {\n            return flow_steps.push(flow_step._id);\n          }\n        });\n      } else {\n        _.each(flow.historys, function(history) {\n          return _.each(history.steps, function(history_step) {\n            if (history_step.step_type === \"start\" || history_step.step_type === \"end\") {\n              return flow_steps.push(history_step._id);\n            }\n          });\n        });\n      }\n      nextSteps = _.union(rejectedSteps, trace_steps, flow_steps);\n    }\n  }\n  version_steps = new Object;\n  flowVersions = new Array;\n  flowVersions.push(flow.current);\n  if (flow.historys) {\n    flowVersions = flowVersions.concat(flow.historys);\n  }\n  _.each(flowVersions, function(flowVer) {\n    if (flowVer._id === instance.flow_version) {\n      return _.each(flowVer.steps, function(flow_ver_step) {\n        return version_steps[flow_ver_step._id] = flow_ver_step;\n      });\n    }\n  });\n  nextSteps = _.uniq(nextSteps);\n  _.each(nextSteps, function(next_step_id) {\n    var _next_step;\n    _next_step = version_steps[next_step_id];\n    if (_next_step.step_type === \"condition\") {\n      if (_next_step.lines) {\n        return _.each(_next_step.lines, function(line) {\n          if (line.to_step) {\n            return nextSteps.push(line.to_step);\n          }\n        });\n      }\n    }\n  });\n  nextSteps = _.uniq(nextSteps);\n  rev_nextSteps = new Array();\n  _.each(nextSteps, function(nextStepId) {\n    var _step;\n    _step = uuflowManager.getStep(instance, flow, nextStepId);\n    if (isSkipStep(instance, _step)) {\n      if (!judge && _step.step_type === 'sign') {\n        judge = 'approved';\n      }\n      return rev_nextSteps = rev_nextSteps.concat(uuflowManager.getNextSteps(instance, flow, _step, judge));\n    } else {\n      return rev_nextSteps.push(nextStepId);\n    }\n  });\n  rev_nextSteps = _.uniq(rev_nextSteps);\n  return rev_nextSteps;\n};\n\nuuflowManager.getUpdatedValues = function(instance, approve_id) {\n  var newest_values, trace_approve;\n  trace_approve = null;\n  _.each(instance.traces, function(trace) {\n    if (trace.is_finished === false) {\n      if (approve_id) {\n        return trace_approve = _.find(trace.approves, function(approve) {\n          return approve._id === approve_id;\n        });\n      } else {\n        return trace_approve = _.find(trace.approves, function(approve) {\n          return approve.is_finished === false && approve.type !== 'cc' && approve.type !== 'distribute';\n        });\n      }\n    }\n  });\n  newest_values = null;\n  if (!instance.values) {\n    newest_values = trace_approve != null ? trace_approve.values : void 0;\n  } else if (!(trace_approve != null ? trace_approve.values : void 0)) {\n    newest_values = instance.values;\n  } else {\n    newest_values = _.extend(_.clone(instance.values), trace_approve.values);\n  }\n  return newest_values;\n};\n\nuuflowManager.getForm = function(form_id) {\n  var form;\n  form = db.forms.findOne(form_id);\n  if (!form) {\n    throw new Meteor.Error('error!', '表单ID有误或此表单已经被删除');\n  }\n  return form;\n};\n\nuuflowManager.getFormVersion = function(form, form_version) {\n  var form_v;\n  form_v = null;\n  if (form_version === form.current._id) {\n    form_v = form.current;\n  } else {\n    form_v = _.find(form.historys, function(form_h) {\n      return form_version === form_h._id;\n    });\n  }\n  if (!form_v) {\n    throw new Meteor.Error('error!', '未找到表单对应的版本');\n  }\n  return form_v;\n};\n\nuuflowManager.getCategory = function(category_id) {\n  return db.categories.findOne(category_id);\n};\n\nuuflowManager.getInstanceName = function(instance, vals) {\n  var applicant, default_value, e, flow, form, form_id, form_v, form_version, func, iscript, name_forumla, rev, script, values;\n  values = _.clone(vals || instance.values) || {};\n  applicant = WorkflowManager.getFormulaUserObject(instance.space, instance.applicant);\n  values[\"applicant\"] = applicant;\n  values[\"applicant_name\"] = instance.applicant_name;\n  values[\"applicant_organization\"] = instance.applicant_organization;\n  values[\"applicant_organization_fullname\"] = instance.applicant_organization_fullname;\n  values[\"applicant_organization_name\"] = instance.applicant_organization_name;\n  values[\"submit_date\"] = moment(instance.submit_date).utcOffset(0, false).format(\"YYYY-MM-DD\");\n  form_id = instance.form;\n  flow = uuflowManager.getFlow(instance.flow);\n  default_value = flow.name + ' ' + instance.code;\n  form_version = instance.form_version;\n  form = uuflowManager.getForm(form_id);\n  form_v = uuflowManager.getFormVersion(form, form_version);\n  name_forumla = form_v.name_forumla;\n  rev = default_value;\n  if (name_forumla) {\n    if (name_forumla.indexOf(\"{applicant.\") > -1) {\n      iscript = name_forumla.replace(/\\{applicant./g, \"(applicant.\").replace(/\\}/g, \" || '')\");\n    }\n    iscript = name_forumla.replace(/\\{/g, \"(values.\").replace(/\\}/g, \" || '')\");\n    try {\n      script = \"module.exports = function (applicant, values, flow, form) { return \" + iscript + \" }\";\n      func = _eval(script, \"getInstanceName\");\n      rev = func(applicant, values, flow, form) || default_value;\n      rev = rev.replace(/\\?|\\*|\\:|\\\"|\\<|\\>|\\\\|\\/|\\|/g, \"\");\n    } catch (error) {\n      e = error;\n      console.log(e);\n    }\n  }\n  return rev.trim();\n};\n\nuuflowManager.getApproveValues = function(approve_values, permissions, form_id, form_version) {\n  var form_v, instance_form;\n  if (permissions === null) {\n    approve_values = new Object;\n  } else {\n    instance_form = db.forms.findOne(form_id);\n    form_v = null;\n    if (form_version === instance_form.current._id) {\n      form_v = instance_form.current;\n    } else {\n      form_v = _.find(instance_form.historys, function(form_h) {\n        return form_version === form_h._id;\n      });\n    }\n    _.each(form_v.fields, function(field) {\n      if (field.type === \"table\") {\n\n      } else if (field.type === \"section\") {\n        return _.each(field.fields, function(sectionField) {\n          if (!sectionField.formula && (permissions[sectionField.code] === null || permissions[sectionField.code] !== \"editable\")) {\n            return delete approve_values[sectionField.code];\n          }\n        });\n      } else {\n        if (!field.formula && (permissions[field.code] === null || permissions[field.code] !== \"editable\")) {\n          return delete approve_values[field.code];\n        }\n      }\n    });\n  }\n  return approve_values;\n};\n\nuuflowManager.workflow_engine = function(approve_from_client, current_user_info, current_user, auto_submitted) {\n  var applicant_id, approve, approve_id, checkApplicant, description, flow, flow_id, form, geolocation, i, instance, instance_id, instance_trace, judge, key_str, last_step, last_step_type, last_trace, next_step, next_step_id, next_step_type, next_steps, setObj, space, space_id, space_user, space_user_org_info, step, step_type, to_users, trace, trace_approves, trace_id, updateObj, values;\n  instance_id = approve_from_client[\"instance\"];\n  trace_id = approve_from_client[\"trace\"];\n  approve_id = approve_from_client[\"_id\"];\n  values = approve_from_client[\"values\"];\n  if (!values) {\n    values = new Object;\n  }\n  next_steps = approve_from_client[\"next_steps\"];\n  judge = approve_from_client[\"judge\"];\n  description = approve_from_client[\"description\"];\n  geolocation = approve_from_client[\"geolocation\"];\n  setObj = new Object;\n  instance = uuflowManager.getInstance(instance_id);\n  space_id = instance.space;\n  flow_id = instance.flow;\n  space = uuflowManager.getSpace(space_id);\n  applicant_id = instance.applicant;\n  checkApplicant = uuflowManager.getSpaceUser(space_id, applicant_id);\n  flow = uuflowManager.getFlow(flow_id);\n  space_user = uuflowManager.getSpaceUser(space_id, current_user);\n  space_user_org_info = uuflowManager.getSpaceUserOrgInfo(space_user);\n  trace = uuflowManager.getTrace(instance, trace_id);\n  approve = uuflowManager.getApprove(trace, approve_id);\n  uuflowManager.isTraceNotFinished(trace);\n  uuflowManager.isApproveNotFinished(approve);\n  uuflowManager.isInstancePending(instance);\n  uuflowManager.isHandlerOrAgent(approve, current_user);\n  step = uuflowManager.getStep(instance, flow, trace.step);\n  step_type = step.step_type;\n  instance_trace = _.find(instance.traces, function(trace) {\n    return trace._id === trace_id;\n  });\n  trace_approves = instance_trace.approves;\n  i = 0;\n  while (i < trace_approves.length) {\n    if (trace_approves[i]._id === approve_id) {\n      key_str = \"traces.$.approves.\" + i + \".\";\n      setObj[key_str + \"geolocation\"] = geolocation;\n      if (step_type === \"condition\") {\n\n      } else if (step_type === \"start\" || step_type === \"submit\") {\n        setObj[key_str + \"judge\"] = \"submitted\";\n        setObj[key_str + \"description\"] = description;\n      } else if (step_type === \"sign\" || step_type === \"counterSign\") {\n        if (step_type === \"counterSign\" && !judge) {\n          judge = 'submitted';\n        }\n        uuflowManager.isJudgeLegal(judge);\n        setObj[key_str + \"judge\"] = judge;\n        setObj[key_str + \"description\"] = description;\n      }\n      setObj[key_str + \"next_steps\"] = next_steps;\n      setObj[key_str + \"is_read\"] = true;\n      if (!trace_approves[i].read_date) {\n        setObj[key_str + \"read_date\"] = new Date;\n      }\n      setObj[key_str + \"values\"] = uuflowManager.getApproveValues(values, step[\"permissions\"], instance.form, instance.form_version);\n      setObj.modified = new Date;\n      setObj.modified_by = current_user;\n      db.instances.update({\n        _id: instance_id,\n        \"traces._id\": trace_id\n      }, {\n        $set: setObj\n      });\n    }\n    i++;\n  }\n  instance = uuflowManager.getInstance(instance_id);\n  trace = uuflowManager.getTrace(instance, trace_id);\n  approve = uuflowManager.getApprove(trace, approve_id);\n  uuflowManager.isTraceNotFinished(trace);\n  uuflowManager.isApproveNotFinished(approve);\n  uuflowManager.isInstancePending(instance);\n  uuflowManager.isHandlerOrAgent(approve, current_user);\n  updateObj = new Object;\n  if (next_steps === null || next_steps.length === 0) {\n    throw new Meteor.Error('error!', '还未指定下一步和处理人，操作失败');\n  } else {\n    if (next_steps.length > 1) {\n      throw new Meteor.Error('error!', '不能指定多个后续步骤');\n    } else {\n      _.each(next_steps[0][\"users\"], function(next_step_user) {\n        var checkSpaceUser;\n        return checkSpaceUser = uuflowManager.getSpaceUser(space_id, next_step_user);\n      });\n    }\n    if (step_type === \"start\" || step_type === \"submit\" || step_type === \"condition\") {\n      updateObj = uuflowManager.engine_step_type_is_start_or_submit_or_condition(instance_id, trace_id, approve_id, next_steps, space_user_org_info, judge, instance, flow, step, current_user, current_user_info, auto_submitted);\n    } else if (step_type === \"sign\") {\n      updateObj = uuflowManager.engine_step_type_is_sign(instance_id, trace_id, approve_id, next_steps, space_user_org_info, judge, instance, flow, step, current_user, current_user_info, description, auto_submitted);\n    } else if (step_type === \"counterSign\") {\n      updateObj = uuflowManager.engine_step_type_is_counterSign(instance_id, trace_id, approve_id, next_steps, space_user_org_info, judge, instance, flow, step, current_user, current_user_info, auto_submitted);\n    } else if (step_type === \"end\") {\n      throw new Meteor.Error('error!', 'end结点出现approve，服务器错误');\n    }\n    form = db.forms.findOne(instance.form);\n    updateObj.keywords = uuflowManager.caculateKeywords(updateObj.values, form, instance.form_version);\n    db.instances.update({\n      _id: instance_id\n    }, {\n      $set: updateObj\n    });\n  }\n  instance = uuflowManager.getInstance(instance_id);\n  instance_trace = _.find(instance.traces, function(trace) {\n    return trace._id === trace_id;\n  });\n  next_step_id = next_steps[0][\"step\"];\n  next_step = uuflowManager.getStep(instance, flow, next_step_id);\n  next_step_type = next_step.step_type;\n  if (\"completed\" === instance.state) {\n    if (\"approved\" === instance.final_decision) {\n      pushManager.send_instance_notification(\"approved_completed_applicant\", instance, description, current_user_info);\n    } else if (\"rejected\" === instance.final_decision) {\n      pushManager.send_instance_notification(\"rejected_completed_applicant\", instance, description, current_user_info);\n    } else {\n      pushManager.send_instance_notification(\"submit_completed_applicant\", instance, description, current_user_info);\n    }\n  } else if (\"pending\" === instance.state) {\n    if (\"rejected\" === instance_trace.judge && instance_trace.is_finished === true) {\n      if ('start' === next_step_type) {\n        pushManager.send_instance_notification(\"submit_pending_rejected_applicant_inbox\", instance, description, current_user_info);\n      } else {\n        pushManager.send_instance_notification(\"submit_pending_rejected_applicant\", instance, description, current_user_info);\n        pushManager.send_instance_notification(\"submit_pending_rejected_inbox\", instance, description, current_user_info);\n      }\n    } else if (instance_trace.is_finished === false) {\n\n    } else {\n      pushManager.send_instance_notification(\"submit_pending_inbox\", instance, description, current_user_info);\n    }\n  }\n  pushManager.send_message_current_user(current_user_info);\n  to_users = instance.inbox_users;\n  last_trace = _.last(instance.traces);\n  last_step = uuflowManager.getStep(instance, flow, last_trace.step);\n  last_step_type = last_step.step_type;\n  if (last_step_type === \"counterSign\" && _.where(last_trace.approves, {\n    is_finished: true\n  }).length > 0) {\n    to_users = [];\n  }\n  pushManager.triggerWebhook(flow_id, instance, approve_from_client, 'engine_submit', current_user, to_users);\n  uuflowManager.distributedInstancesRemind(instance);\n  return instance;\n};\n\nuuflowManager.engine_step_type_is_start_or_submit_or_condition = function(instance_id, trace_id, approve_id, next_steps, space_user_org_info, judge, instance, flow, step, current_user, current_user_info, auto_submitted) {\n  var h, i, instance_trace, instance_traces, newTrace, nextSteps, next_step, next_step_id, next_step_name, next_step_type, next_step_users, next_user_ids, outbox_users, setObj, space_id, trace_approve, updated_values;\n  setObj = new Object;\n  space_id = instance.space;\n  nextSteps = uuflowManager.getNextSteps(instance, flow, step, \"\");\n  _.each(next_steps, function(approve_next_step) {\n    if (!nextSteps.includes(approve_next_step[\"step\"])) {\n      throw new Meteor.Error('error!', \"approve中next_steps.step：\" + approve_next_step.step + \" 不合法\");\n    }\n  });\n  next_step_id = next_steps[0][\"step\"];\n  next_step = uuflowManager.getStep(instance, flow, next_step_id);\n  next_step_type = next_step.step_type;\n  next_step_name = next_step.name;\n  if (next_step_type === \"end\") {\n    instance_traces = instance.traces;\n    i = 0;\n    while (i < instance_traces.length) {\n      if (instance_traces[i]._id === trace_id) {\n        instance_traces[i].is_finished = true;\n        instance_traces[i].finish_date = new Date;\n        instance_traces[i].judge = judge;\n        h = 0;\n        while (h < instance_traces[i].approves.length) {\n          if (instance_traces[i].approves[h]._id === approve_id) {\n            instance_traces[i].approves[h].is_finished = true;\n            instance_traces[i].approves[h].handler = current_user;\n            instance_traces[i].approves[h].handler_name = current_user_info.name;\n            instance_traces[i].approves[h].finish_date = new Date;\n            instance_traces[i].approves[h].handler_organization = space_user_org_info[\"organization\"];\n            instance_traces[i].approves[h].handler_organization_name = space_user_org_info[\"organization_name\"];\n            instance_traces[i].approves[h].handler_organization_fullname = space_user_org_info[\"organization_fullname\"];\n            instance_traces[i].approves[h].cost_time = instance_traces[i].approves[h].finish_date - instance_traces[i].approves[h].start_date;\n            instance_traces[i].approves[h].auto_submitted = auto_submitted;\n          }\n          h++;\n        }\n      }\n      i++;\n    }\n    newTrace = new Object;\n    newTrace._id = new Mongo.ObjectID()._str;\n    newTrace.instance = instance_id;\n    newTrace.previous_trace_ids = [trace_id];\n    newTrace.is_finished = true;\n    newTrace.step = next_step_id;\n    newTrace.name = next_step_name;\n    newTrace.start_date = new Date;\n    newTrace.finish_date = new Date;\n    setObj.state = \"completed\";\n    setObj.modified = new Date;\n    setObj.modified_by = current_user;\n    setObj.values = uuflowManager.getUpdatedValues(uuflowManager.getInstance(instance_id));\n    instance.values = setObj.values;\n    setObj.name = uuflowManager.getInstanceName(instance);\n    instance_trace = _.find(instance_traces, function(trace) {\n      return trace._id === trace_id;\n    });\n    trace_approve = _.find(instance_trace.approves, function(approve) {\n      return approve._id === approve_id;\n    });\n    outbox_users = instance.outbox_users;\n    outbox_users.unshift(trace_approve.handler);\n    outbox_users.unshift(trace_approve.user);\n    setObj.outbox_users = _.uniq(outbox_users);\n    instance_traces.push(newTrace);\n    setObj.traces = instance_traces;\n    setObj.inbox_users = [];\n    setObj.finish_date = new Date;\n    setObj.current_step_name = next_step_name;\n    setObj.final_decision = 'approved';\n    setObj.current_step_auto_submit = false;\n  } else {\n    next_step_users = next_steps[0][\"users\"];\n    if (next_step_users === null || next_step_users.length === 0) {\n      throw new Meteor.Error('error!', \"未指定下一步处理人\");\n    } else {\n      if (next_step_users.length > 1 && next_step.step_type !== \"counterSign\") {\n        throw new Meteor.Error('error!', \"不能指定多个处理人\");\n      } else {\n        next_user_ids = getHandlersManager.getHandlers(instance_id, next_step_id, current_user);\n        if (!uuflowManager.checkNestStepUsersIsValid(next_step_users, next_user_ids, next_step)) {\n          throw new Meteor.Error('error!', \"指定的下一步处理人有误\");\n        } else {\n          instance_traces = instance.traces;\n          i = 0;\n          while (i < instance_traces.length) {\n            if (instance_traces[i]._id === trace_id) {\n              instance_traces[i].is_finished = true;\n              instance_traces[i].finish_date = new Date;\n              instance_traces[i].judge = judge;\n              h = 0;\n              while (h < instance_traces[i].approves.length) {\n                if (instance_traces[i].approves[h]._id === approve_id) {\n                  instance_traces[i].approves[h].is_finished = true;\n                  instance_traces[i].approves[h].handler = current_user;\n                  instance_traces[i].approves[h].handler_name = current_user_info.name;\n                  instance_traces[i].approves[h].finish_date = new Date;\n                  instance_traces[i].approves[h].handler_organization = space_user_org_info[\"organization\"];\n                  instance_traces[i].approves[h].handler_organization_name = space_user_org_info[\"organization_name\"];\n                  instance_traces[i].approves[h].handler_organization_fullname = space_user_org_info[\"organization_fullname\"];\n                  instance_traces[i].approves[h].cost_time = instance_traces[i].approves[h].finish_date - instance_traces[i].approves[h].start_date;\n                  instance_traces[i].approves[h].auto_submitted = auto_submitted;\n                }\n                h++;\n              }\n            }\n            i++;\n          }\n          newTrace = new Object;\n          newTrace._id = new Mongo.ObjectID()._str;\n          newTrace.instance = instance_id;\n          newTrace.previous_trace_ids = [trace_id];\n          newTrace.is_finished = false;\n          newTrace.step = next_step_id;\n          newTrace.name = next_step_name;\n          newTrace.start_date = new Date;\n          newTrace.due_date = uuflowManager.getDueDate(next_step.timeout_hours, space_id);\n          newTrace.approves = new Array;\n          updated_values = uuflowManager.getUpdatedValues(uuflowManager.getInstance(instance_id));\n          _.each(next_step_users, function(next_step_user_id, idx) {\n            var agent, handler_id, handler_info, newApprove, next_step_space_user, next_step_user_org_info, user_info;\n            newApprove = new Object;\n            newApprove._id = new Mongo.ObjectID()._str;\n            newApprove.instance = instance_id;\n            newApprove.trace = newTrace._id;\n            newApprove.is_finished = false;\n            newApprove.user = next_step_user_id;\n            user_info = db.users.findOne({\n              _id: next_step_user_id\n            }, {\n              fields: {\n                name: 1\n              }\n            });\n            newApprove.user_name = user_info.name;\n            handler_id = next_step_user_id;\n            handler_info = user_info;\n            agent = uuflowManager.getAgent(space_id, next_step_user_id);\n            if (agent) {\n              next_step_users[idx] = agent;\n              handler_id = agent;\n              handler_info = db.users.findOne({\n                _id: agent\n              }, {\n                fields: {\n                  name: 1\n                }\n              });\n              newApprove.agent = agent;\n            }\n            newApprove.handler = handler_id;\n            newApprove.handler_name = handler_info.name;\n            next_step_space_user = db.space_users.findOne({\n              space: space_id,\n              user: handler_id\n            });\n            next_step_user_org_info = uuflowManager.getSpaceUserOrgInfo(next_step_space_user);\n            newApprove.handler_organization = next_step_user_org_info[\"organization\"];\n            newApprove.handler_organization_name = next_step_user_org_info[\"organization_name\"];\n            newApprove.handler_organization_fullname = next_step_user_org_info[\"organization_fullname\"];\n            newApprove.start_date = new Date;\n            newApprove.due_date = newTrace.due_date;\n            newApprove.is_read = false;\n            newApprove.is_error = false;\n            newApprove.values = new Object;\n            uuflowManager.setRemindInfo(updated_values, newApprove);\n            return newTrace.approves.push(newApprove);\n          });\n          setObj.state = \"pending\";\n          setObj.modified = new Date;\n          setObj.modified_by = current_user;\n          setObj.values = updated_values;\n          instance.values = setObj.values;\n          setObj.name = uuflowManager.getInstanceName(instance);\n          instance_trace = _.find(instance_traces, function(trace) {\n            return trace._id === trace_id;\n          });\n          trace_approve = _.find(instance_trace.approves, function(approve) {\n            return approve._id === approve_id;\n          });\n          outbox_users = instance.outbox_users;\n          outbox_users.unshift(trace_approve.user);\n          outbox_users.unshift(trace_approve.handler);\n          setObj.outbox_users = _.uniq(outbox_users);\n          setObj.inbox_users = next_step_users;\n          instance_traces.push(newTrace);\n          setObj.traces = instance_traces;\n          setObj.current_step_name = next_step_name;\n          setObj.current_step_auto_submit = uuflowManager.getCurrentStepAutoSubmit(flow.timeout_auto_submit, next_step.lines);\n        }\n      }\n    }\n  }\n  return setObj;\n};\n\nuuflowManager.engine_step_type_is_sign = function(instance_id, trace_id, approve_id, next_steps, space_user_org_info, judge, instance, flow, step, current_user, current_user_info, description, auto_submitted) {\n  var h, i, instance_trace, instance_traces, newTrace, nextSteps, next_step, next_step_id, next_step_name, next_step_type, next_step_users, next_user_ids, outbox_users, setObj, space_id, trace_approve, updated_values;\n  setObj = new Object;\n  space_id = instance.space;\n  if (!judge) {\n    throw new Meteor.Error('error!', \"单签结点还未选择处理意见，操作失败\");\n  } else {\n    if (judge === \"approved\") {\n      nextSteps = uuflowManager.getNextSteps(instance, flow, step, \"approved\");\n      _.each(next_steps, function(approve_next_step) {\n        if (!nextSteps.includes(approve_next_step[\"step\"])) {\n          throw new Meteor.Error('error!', \"指定的下一步有误\");\n        }\n      });\n      next_step_id = next_steps[0][\"step\"];\n      next_step = uuflowManager.getStep(instance, flow, next_step_id);\n      next_step_type = next_step[\"step_type\"];\n      next_step_name = next_step[\"name\"];\n      if (next_step_type === \"end\") {\n        instance_traces = instance.traces;\n        i = 0;\n        while (i < instance_traces.length) {\n          if (instance_traces[i]._id === trace_id) {\n            instance_traces[i].is_finished = true;\n            instance_traces[i].finish_date = new Date;\n            instance_traces[i].judge = judge;\n            h = 0;\n            while (h < instance_traces[i].approves.length) {\n              if (instance_traces[i].approves[h]._id === approve_id) {\n                instance_traces[i].approves[h].is_finished = true;\n                instance_traces[i].approves[h].handler = current_user;\n                instance_traces[i].approves[h].handler_name = current_user_info.name;\n                instance_traces[i].approves[h].finish_date = new Date;\n                instance_traces[i].approves[h].handler_organization = space_user_org_info[\"organization\"];\n                instance_traces[i].approves[h].handler_organization_name = space_user_org_info[\"organization_name\"];\n                instance_traces[i].approves[h].handler_organization_fullname = space_user_org_info[\"organization_fullname\"];\n                instance_traces[i].approves[h].cost_time = instance_traces[i].approves[h].finish_date - instance_traces[i].approves[h].start_date;\n                instance_traces[i].approves[h].auto_submitted = auto_submitted;\n              }\n              h++;\n            }\n          }\n          i++;\n        }\n        newTrace = new Object;\n        newTrace._id = new Mongo.ObjectID()._str;\n        newTrace.instance = instance_id;\n        newTrace.previous_trace_ids = [trace_id];\n        newTrace.is_finished = true;\n        newTrace.step = next_step_id;\n        newTrace.name = next_step_name;\n        newTrace.start_date = new Date;\n        newTrace.finish_date = new Date;\n        setObj.state = \"completed\";\n        setObj.final_decision = judge;\n        setObj.modified = new Date;\n        setObj.modified_by = current_user;\n        setObj.values = uuflowManager.getUpdatedValues(uuflowManager.getInstance(instance_id));\n        instance.values = setObj.values;\n        setObj.name = uuflowManager.getInstanceName(instance);\n        instance_trace = _.find(instance_traces, function(trace) {\n          return trace._id === trace_id;\n        });\n        trace_approve = _.find(instance_trace.approves, function(approve) {\n          return approve._id === approve_id;\n        });\n        outbox_users = instance.outbox_users;\n        outbox_users.unshift(trace_approve.handler);\n        outbox_users.unshift(trace_approve.user);\n        setObj.outbox_users = _.uniq(outbox_users);\n        instance_traces.push(newTrace);\n        setObj.traces = instance_traces;\n        setObj.inbox_users = [];\n        setObj.finish_date = new Date;\n        if (instance.cc_users) {\n          setObj.cc_users = instance.cc_users;\n        }\n        setObj.current_step_name = next_step_name;\n        setObj.current_step_auto_submit = false;\n      } else {\n        next_step_users = next_steps[0][\"users\"];\n        if (next_step_users === null || next_step_users.length === 0) {\n          throw new Meteor.Error('error!', \"未指定下一步处理人\");\n        } else {\n          if (next_step_users.length > 1 && next_step[\"step_type\"] !== \"counterSign\") {\n            throw new Meteor.Error('error!', \"不能指定多个处理人\");\n          } else {\n            next_user_ids = getHandlersManager.getHandlers(instance_id, next_step_id, current_user);\n            if (!uuflowManager.checkNestStepUsersIsValid(next_step_users, next_user_ids, next_step)) {\n              throw new Meteor.Error('error!', \"指定的下一步处理人有误\");\n            } else {\n              instance_traces = instance.traces;\n              i = 0;\n              while (i < instance_traces.length) {\n                if (instance_traces[i]._id === trace_id) {\n                  instance_traces[i].is_finished = true;\n                  instance_traces[i].finish_date = new Date;\n                  instance_traces[i].judge = judge;\n                  h = 0;\n                  while (h < instance_traces[i].approves.length) {\n                    if (instance_traces[i].approves[h]._id === approve_id) {\n                      instance_traces[i].approves[h].is_finished = true;\n                      instance_traces[i].approves[h].handler = current_user;\n                      instance_traces[i].approves[h].handler_name = current_user_info.name;\n                      instance_traces[i].approves[h].finish_date = new Date;\n                      instance_traces[i].approves[h].handler_organization = space_user_org_info[\"organization\"];\n                      instance_traces[i].approves[h].handler_organization_name = space_user_org_info[\"organization_name\"];\n                      instance_traces[i].approves[h].handler_organization_fullname = space_user_org_info[\"organization_fullname\"];\n                      instance_traces[i].approves[h].cost_time = instance_traces[i].approves[h].finish_date - instance_traces[i].approves[h].start_date;\n                      instance_traces[i].approves[h].auto_submitted = auto_submitted;\n                    }\n                    h++;\n                  }\n                }\n                i++;\n              }\n              newTrace = new Object;\n              newTrace._id = new Mongo.ObjectID()._str;\n              newTrace.instance = instance_id;\n              newTrace.previous_trace_ids = [trace_id];\n              newTrace.is_finished = false;\n              newTrace.step = next_step_id;\n              newTrace.name = next_step_name;\n              newTrace.start_date = new Date;\n              newTrace.due_date = uuflowManager.getDueDate(next_step.timeout_hours, space_id);\n              newTrace.approves = new Array;\n              updated_values = uuflowManager.getUpdatedValues(uuflowManager.getInstance(instance_id));\n              _.each(next_step_users, function(next_step_user_id, idx) {\n                var agent, handler_id, handler_info, newApprove, next_step_space_user, next_step_user_org_info, user_info;\n                newApprove = new Object;\n                newApprove._id = new Mongo.ObjectID()._str;\n                newApprove.instance = instance_id;\n                newApprove.trace = newTrace._id;\n                newApprove.is_finished = false;\n                newApprove.user = next_step_user_id;\n                user_info = db.users.findOne({\n                  _id: next_step_user_id\n                }, {\n                  fields: {\n                    name: 1\n                  }\n                });\n                newApprove.user_name = user_info.name;\n                handler_id = next_step_user_id;\n                handler_info = user_info;\n                agent = uuflowManager.getAgent(space_id, next_step_user_id);\n                if (agent) {\n                  next_step_users[idx] = agent;\n                  handler_id = agent;\n                  handler_info = db.users.findOne({\n                    _id: agent\n                  }, {\n                    fields: {\n                      name: 1\n                    }\n                  });\n                  newApprove.agent = agent;\n                }\n                newApprove.handler = handler_id;\n                newApprove.handler_name = handler_info.name;\n                next_step_space_user = db.space_users.findOne({\n                  space: space_id,\n                  user: handler_id\n                });\n                next_step_user_org_info = uuflowManager.getSpaceUserOrgInfo(next_step_space_user);\n                newApprove.handler_organization = next_step_user_org_info[\"organization\"];\n                newApprove.handler_organization_name = next_step_user_org_info[\"organization_name\"];\n                newApprove.handler_organization_fullname = next_step_user_org_info[\"organization_fullname\"];\n                newApprove.start_date = new Date;\n                newApprove.due_date = newTrace.due_date;\n                newApprove.is_read = false;\n                newApprove.is_error = false;\n                newApprove.values = new Object;\n                uuflowManager.setRemindInfo(updated_values, newApprove);\n                return newTrace.approves.push(newApprove);\n              });\n              setObj.final_decision = judge;\n              setObj.modified = new Date;\n              setObj.modified_by = current_user;\n              setObj.values = updated_values;\n              instance.values = setObj.values;\n              setObj.name = uuflowManager.getInstanceName(instance);\n              instance_trace = _.find(instance_traces, function(trace) {\n                return trace._id === trace_id;\n              });\n              trace_approve = _.find(instance_trace.approves, function(approve) {\n                return approve._id === approve_id;\n              });\n              outbox_users = instance.outbox_users;\n              outbox_users.unshift(trace_approve.user);\n              outbox_users.unshift(trace_approve.handler);\n              setObj.outbox_users = _.uniq(outbox_users);\n              setObj.inbox_users = next_step_users;\n              instance_traces.push(newTrace);\n              setObj.traces = instance_traces;\n              setObj.state = \"pending\";\n              if (instance.cc_users) {\n                setObj.cc_users = instance.cc_users;\n              }\n              setObj.current_step_name = next_step_name;\n              setObj.current_step_auto_submit = uuflowManager.getCurrentStepAutoSubmit(flow.timeout_auto_submit, next_step.lines);\n            }\n          }\n        }\n      }\n    } else if (judge === \"rejected\") {\n      if (!description) {\n        throw new Meteor.Error('error!', \"请填写驳回理由\");\n      } else {\n        nextSteps = uuflowManager.getNextSteps(instance, flow, step, \"rejected\");\n        _.each(next_steps, function(approve_next_step) {\n          if (!nextSteps.includes(approve_next_step[\"step\"])) {\n            throw new Meteor.Error('error!', \"指定的下一步有误\");\n          }\n        });\n        next_step_id = next_steps[0][\"step\"];\n        next_step = uuflowManager.getStep(instance, flow, next_step_id);\n        next_step_type = next_step[\"step_type\"];\n        next_step_name = next_step[\"name\"];\n        if (next_step_type === \"end\") {\n          instance_traces = instance.traces;\n          i = 0;\n          while (i < instance_traces.length) {\n            if (instance_traces[i]._id === trace_id) {\n              instance_traces[i].is_finished = true;\n              instance_traces[i].finish_date = new Date;\n              instance_traces[i].judge = judge;\n              h = 0;\n              while (h < instance_traces[i].approves.length) {\n                if (instance_traces[i].approves[h]._id === approve_id) {\n                  instance_traces[i].approves[h].is_finished = true;\n                  instance_traces[i].approves[h].handler = current_user;\n                  instance_traces[i].approves[h].handler_name = current_user_info.name;\n                  instance_traces[i].approves[h].finish_date = new Date;\n                  instance_traces[i].approves[h].handler_organization = space_user_org_info[\"organization\"];\n                  instance_traces[i].approves[h].handler_organization_name = space_user_org_info[\"organization_name\"];\n                  instance_traces[i].approves[h].handler_organization_fullname = space_user_org_info[\"organization_fullname\"];\n                  instance_traces[i].approves[h].cost_time = instance_traces[i].approves[h].finish_date - instance_traces[i].approves[h].start_date;\n                  instance_traces[i].approves[h].auto_submitted = auto_submitted;\n                }\n                h++;\n              }\n            }\n            i++;\n          }\n          newTrace = new Object;\n          newTrace._id = new Mongo.ObjectID()._str;\n          newTrace.instance = instance_id;\n          newTrace.previous_trace_ids = [trace_id];\n          newTrace.is_finished = true;\n          newTrace.step = next_step_id;\n          newTrace.name = next_step_name;\n          newTrace.start_date = new Date;\n          newTrace.finish_date = new Date;\n          setObj.state = \"completed\";\n          setObj.final_decision = judge;\n          setObj.modified = new Date;\n          setObj.modified_by = current_user;\n          setObj.values = uuflowManager.getUpdatedValues(uuflowManager.getInstance(instance_id));\n          instance.values = setObj.values;\n          setObj.name = uuflowManager.getInstanceName(instance);\n          instance_trace = _.find(instance_traces, function(trace) {\n            return trace._id === trace_id;\n          });\n          trace_approve = _.find(instance_trace.approves, function(approve) {\n            return approve._id === approve_id;\n          });\n          outbox_users = instance.outbox_users;\n          outbox_users.unshift(trace_approve.handler);\n          outbox_users.unshift(trace_approve.user);\n          setObj.outbox_users = _.uniq(outbox_users);\n          instance_traces.push(newTrace);\n          setObj.traces = instance_traces;\n          setObj.inbox_users = [];\n          setObj.finish_date = new Date;\n          if (instance.cc_users) {\n            setObj.cc_users = instance.cc_users;\n          }\n          setObj.current_step_name = next_step_name;\n          setObj.current_step_auto_submit = false;\n        } else {\n          next_step_users = next_steps[0][\"users\"];\n          if (next_step_users === null || next_step_users.length === 0) {\n            throw new Meteor.Error('error!', \"未指定下一步处理人\");\n          } else {\n            if (next_step_users.length > 1 && next_step[\"step_type\"] !== \"counterSign\") {\n              throw new Meteor.Error('error!', \"不能指定多个处理人\");\n            } else {\n              next_user_ids = getHandlersManager.getHandlers(instance_id, next_step_id, current_user);\n              if (!uuflowManager.checkNestStepUsersIsValid(next_step_users, next_user_ids, next_step)) {\n                throw new Meteor.Error('error!', \"指定的下一步处理人有误\");\n              } else {\n                instance_traces = instance.traces;\n                i = 0;\n                while (i < instance_traces.length) {\n                  if (instance_traces[i]._id === trace_id) {\n                    instance_traces[i].is_finished = true;\n                    instance_traces[i].finish_date = new Date;\n                    instance_traces[i].judge = judge;\n                    h = 0;\n                    while (h < instance_traces[i].approves.length) {\n                      if (instance_traces[i].approves[h]._id === approve_id) {\n                        instance_traces[i].approves[h].is_finished = true;\n                        instance_traces[i].approves[h].handler = current_user;\n                        instance_traces[i].approves[h].handler_name = current_user_info.name;\n                        instance_traces[i].approves[h].finish_date = new Date;\n                        instance_traces[i].approves[h].handler_organization = space_user_org_info[\"organization\"];\n                        instance_traces[i].approves[h].handler_organization_name = space_user_org_info[\"organization_name\"];\n                        instance_traces[i].approves[h].handler_organization_fullname = space_user_org_info[\"organization_fullname\"];\n                        instance_traces[i].approves[h].cost_time = instance_traces[i].approves[h].finish_date - instance_traces[i].approves[h].start_date;\n                        instance_traces[i].approves[h].auto_submitted = auto_submitted;\n                      }\n                      h++;\n                    }\n                  }\n                  i++;\n                }\n                newTrace = new Object;\n                newTrace._id = new Mongo.ObjectID()._str;\n                newTrace.instance = instance_id;\n                newTrace.previous_trace_ids = [trace_id];\n                newTrace.is_finished = false;\n                newTrace.step = next_step_id;\n                newTrace.name = next_step_name;\n                newTrace.start_date = new Date;\n                newTrace.due_date = uuflowManager.getDueDate(next_step.timeout_hours, space_id);\n                newTrace.approves = new Array;\n                updated_values = uuflowManager.getUpdatedValues(uuflowManager.getInstance(instance_id));\n                _.each(next_step_users, function(next_step_user_id, idx) {\n                  var agent, handler_id, handler_info, newApprove, next_step_space_user, next_step_user_org_info, user_info;\n                  newApprove = new Object;\n                  newApprove._id = new Mongo.ObjectID()._str;\n                  newApprove.instance = instance_id;\n                  newApprove.trace = newTrace._id;\n                  newApprove.is_finished = false;\n                  newApprove.user = next_step_user_id;\n                  user_info = db.users.findOne({\n                    _id: next_step_user_id\n                  }, {\n                    fields: {\n                      name: 1\n                    }\n                  });\n                  newApprove.user_name = user_info.name;\n                  handler_id = next_step_user_id;\n                  handler_info = user_info;\n                  agent = uuflowManager.getAgent(space_id, next_step_user_id);\n                  if (agent) {\n                    next_step_users[idx] = agent;\n                    handler_id = agent;\n                    handler_info = db.users.findOne({\n                      _id: agent\n                    }, {\n                      fields: {\n                        name: 1\n                      }\n                    });\n                    newApprove.agent = agent;\n                  }\n                  newApprove.handler = handler_id;\n                  newApprove.handler_name = handler_info.name;\n                  next_step_space_user = db.space_users.findOne({\n                    space: space_id,\n                    user: handler_id\n                  });\n                  next_step_user_org_info = uuflowManager.getSpaceUserOrgInfo(next_step_space_user);\n                  newApprove.handler_organization = next_step_user_org_info[\"organization\"];\n                  newApprove.handler_organization_name = next_step_user_org_info[\"organization_name\"];\n                  newApprove.handler_organization_fullname = next_step_user_org_info[\"organization_fullname\"];\n                  newApprove.start_date = new Date;\n                  newApprove.due_date = newTrace.due_date;\n                  newApprove.is_read = false;\n                  newApprove.is_error = false;\n                  newApprove.values = new Object;\n                  uuflowManager.setRemindInfo(updated_values, newApprove);\n                  return newTrace.approves.push(newApprove);\n                });\n                setObj.final_decision = judge;\n                setObj.modified = new Date;\n                setObj.modified_by = current_user;\n                setObj.values = updated_values;\n                instance.values = setObj.values;\n                setObj.name = uuflowManager.getInstanceName(instance);\n                instance_trace = _.find(instance_traces, function(trace) {\n                  return trace._id === trace_id;\n                });\n                trace_approve = _.find(instance_trace.approves, function(approve) {\n                  return approve._id === approve_id;\n                });\n                outbox_users = instance.outbox_users;\n                outbox_users.unshift(trace_approve.user);\n                outbox_users.unshift(trace_approve.handler);\n                setObj.outbox_users = _.uniq(outbox_users);\n                setObj.inbox_users = next_step_users;\n                instance_traces.push(newTrace);\n                setObj.traces = instance_traces;\n                setObj.state = \"pending\";\n                if (instance.cc_users) {\n                  setObj.cc_users = instance.cc_users;\n                }\n                setObj.current_step_name = next_step_name;\n                setObj.current_step_auto_submit = uuflowManager.getCurrentStepAutoSubmit(flow.timeout_auto_submit, next_step.lines);\n              }\n            }\n          }\n        }\n      }\n    }\n  }\n  return setObj;\n};\n\nuuflowManager.engine_step_type_is_counterSign = function(instance_id, trace_id, approve_id, next_steps, space_user_org_info, judge, instance, flow, step, current_user, current_user_info, auto_submitted) {\n  var final_decision, h, i, instance_trace, instance_traces, isAllApproveFinished, newTrace, nextSteps, next_step, next_step_id, next_step_name, next_step_type, next_step_users, next_user_ids, outbox_users, setObj, space_id, trace_approve, updated_values;\n  setObj = new Object;\n  space_id = instance.space;\n  if (!judge) {\n    throw new Meteor.Error('error!', \"请选择核准或驳回。\");\n  } else {\n    if (step.oneClickApproval && ['approved', 'readed'].includes(judge)) {\n      nextSteps = uuflowManager.getNextSteps(instance, flow, step, \"approved\");\n      _.each(next_steps, function(approve_next_step) {\n        if (!nextSteps.includes(approve_next_step[\"step\"])) {\n          throw new Meteor.Error('error!', \"指定的下一步有误\");\n        }\n      });\n    }\n    next_step_id = next_steps[0][\"step\"];\n    next_step = uuflowManager.getStep(instance, flow, next_step_id);\n    next_step_type = next_step[\"step_type\"];\n    next_step_name = next_step[\"name\"];\n    instance_traces = instance.traces;\n    isAllApproveFinished = true;\n    i = 0;\n    while (i < instance_traces.length) {\n      if (instance_traces[i]._id === trace_id) {\n        h = 0;\n        while (h < instance_traces[i].approves.length) {\n          if (instance_traces[i].approves[h]._id === approve_id || ((step.oneClickApproval && ['approved', 'readed'].includes(judge)) || (step.oneClickRejection && 'rejected' === judge))) {\n            instance_traces[i].approves[h].is_finished = true;\n            instance_traces[i].approves[h].finish_date = new Date;\n            instance_traces[i].approves[h].cost_time = instance_traces[i].approves[h].finish_date - instance_traces[i].approves[h].start_date;\n            instance_traces[i].approves[h].auto_submitted = auto_submitted;\n          }\n          if (instance_traces[i].approves[h].is_finished === false && instance_traces[i].approves[h].type !== 'cc' && instance_traces[i].approves[h].type !== 'distribute') {\n            isAllApproveFinished = false;\n          }\n          h++;\n        }\n      }\n      i++;\n    }\n    if (isAllApproveFinished === true) {\n      i = 0;\n      while (i < instance_traces.length) {\n        if (instance_traces[i]._id === trace_id) {\n          instance_traces[i].is_finished = true;\n          instance_traces[i].finish_date = new Date;\n          instance_traces[i].judge = \"submitted\";\n        }\n        i++;\n      }\n      if (next_step_type === \"end\") {\n        newTrace = new Object;\n        newTrace._id = new Mongo.ObjectID()._str;\n        newTrace.instance = instance_id;\n        newTrace.previous_trace_ids = [trace_id];\n        newTrace.is_finished = true;\n        newTrace.step = next_step_id;\n        newTrace.name = next_step_name;\n        newTrace.start_date = new Date;\n        newTrace.finish_date = new Date;\n        setObj.state = \"completed\";\n        setObj.modified = new Date;\n        setObj.modified_by = current_user;\n        instance_trace = _.find(instance_traces, function(trace) {\n          return trace._id === trace_id;\n        });\n        outbox_users = instance.outbox_users;\n        _.each(instance_trace.approves, function(appro) {\n          outbox_users.push(appro.user);\n          return outbox_users.push(appro.handler);\n        });\n        setObj.outbox_users = _.uniq(outbox_users);\n        setObj.inbox_users = new Array;\n        instance_traces.push(newTrace);\n        setObj.traces = instance_traces;\n        setObj.finish_date = new Date;\n        updated_values = uuflowManager.getUpdatedValues(uuflowManager.getInstance(instance_id), approve_id);\n        setObj.values = updated_values;\n        setObj.name = uuflowManager.getInstanceName(instance);\n        if (instance.cc_users) {\n          setObj.cc_users = instance.cc_users;\n        }\n        setObj.current_step_name = next_step_name;\n        final_decision = '';\n        if (step.oneClickApproval && ['approved', 'readed'].includes(judge)) {\n          final_decision = 'approved';\n        } else if (step.oneClickRejection && 'rejected' === judge) {\n          final_decision = 'rejected';\n        }\n        setObj.final_decision = final_decision || 'approved';\n        setObj.current_step_auto_submit = false;\n      } else {\n        next_step_users = next_steps[0][\"users\"];\n        if (next_step_users === null || next_step_users.length === 0) {\n          throw new Meteor.Error('error!', \"未指定下一步处理人\");\n        } else {\n          if (next_step_users.length > 1 && next_step[\"step_type\"] !== \"counterSign\") {\n            throw new Meteor.Error('error!', \"不能指定多个处理人\");\n          } else {\n            next_user_ids = getHandlersManager.getHandlers(instance_id, next_step_id, current_user);\n            if (!uuflowManager.checkNestStepUsersIsValid(next_step_users, next_user_ids, next_steps)) {\n              throw new Meteor.Error('error!', \"指定的下一步处理人有误\");\n            } else {\n              newTrace = new Object;\n              newTrace._id = new Mongo.ObjectID()._str;\n              newTrace.instance = instance_id;\n              newTrace.previous_trace_ids = [trace_id];\n              newTrace.is_finished = false;\n              newTrace.step = next_step_id;\n              newTrace.name = next_step_name;\n              newTrace.start_date = new Date;\n              newTrace.due_date = uuflowManager.getDueDate(next_step.timeout_hours, space_id);\n              newTrace.approves = new Array;\n              _.each(next_step_users, function(next_step_user_id, idx) {\n                var agent, handler_id, handler_info, newApprove, next_step_space_user, next_step_user_org_info, user_info;\n                newApprove = new Object;\n                newApprove._id = new Mongo.ObjectID()._str;\n                newApprove.instance = instance_id;\n                newApprove.trace = newTrace._id;\n                newApprove.is_finished = false;\n                newApprove.user = next_step_user_id;\n                user_info = db.users.findOne({\n                  _id: next_step_user_id\n                }, {\n                  fields: {\n                    name: 1\n                  }\n                });\n                newApprove.user_name = user_info.name;\n                handler_id = next_step_user_id;\n                handler_info = user_info;\n                agent = uuflowManager.getAgent(space_id, next_step_user_id);\n                if (agent) {\n                  next_step_users[idx] = agent;\n                  handler_id = agent;\n                  handler_info = db.users.findOne({\n                    _id: agent\n                  }, {\n                    fields: {\n                      name: 1\n                    }\n                  });\n                  newApprove.agent = agent;\n                }\n                newApprove.handler = handler_id;\n                newApprove.handler_name = handler_info.name;\n                next_step_space_user = db.space_users.findOne({\n                  space: space_id,\n                  user: handler_id\n                });\n                next_step_user_org_info = uuflowManager.getSpaceUserOrgInfo(next_step_space_user);\n                newApprove.handler_organization = next_step_user_org_info[\"organization\"];\n                newApprove.handler_organization_name = next_step_user_org_info[\"organization_name\"];\n                newApprove.handler_organization_fullname = next_step_user_org_info[\"organization_fullname\"];\n                newApprove.start_date = new Date;\n                newApprove.due_date = newTrace.due_date;\n                newApprove.is_read = false;\n                newApprove.is_error = false;\n                newApprove.values = new Object;\n                uuflowManager.setRemindInfo(instance.values, newApprove);\n                return newTrace.approves.push(newApprove);\n              });\n              setObj.modified = new Date;\n              setObj.modified_by = current_user;\n              instance_trace = _.find(instance_traces, function(trace) {\n                return trace._id === trace_id;\n              });\n              outbox_users = instance.outbox_users;\n              _.each(instance_trace.approves, function(appro) {\n                outbox_users.push(appro.user);\n                return outbox_users.push(appro.handler);\n              });\n              setObj.outbox_users = _.uniq(outbox_users);\n              setObj.inbox_users = next_step_users;\n              instance_traces.push(newTrace);\n              setObj.traces = instance_traces;\n              setObj.state = \"pending\";\n              updated_values = uuflowManager.getUpdatedValues(uuflowManager.getInstance(instance_id), approve_id);\n              setObj.values = updated_values;\n              setObj.name = uuflowManager.getInstanceName(instance);\n              if (instance.cc_users) {\n                setObj.cc_users = instance.cc_users;\n              }\n              setObj.current_step_name = next_step_name;\n              setObj.current_step_auto_submit = uuflowManager.getCurrentStepAutoSubmit(flow.timeout_auto_submit, next_step.lines);\n            }\n          }\n        }\n      }\n    } else {\n      instance_trace = _.find(instance_traces, function(trace) {\n        return trace._id === trace_id;\n      });\n      trace_approve = _.find(instance_trace.approves, function(approve) {\n        return approve._id === approve_id;\n      });\n      instance.outbox_users.unshift(trace_approve.handler);\n      setObj.outbox_users = instance.outbox_users;\n      instance.inbox_users.splice(instance.inbox_users.indexOf(trace_approve.handler), 1);\n      setObj.inbox_users = instance.inbox_users;\n      setObj.modified = new Date;\n      setObj.modified_by = current_user;\n      setObj.traces = instance_traces;\n      setObj.state = \"pending\";\n      updated_values = uuflowManager.getUpdatedValues(uuflowManager.getInstance(instance_id), approve_id);\n      setObj.values = updated_values;\n      setObj.name = uuflowManager.getInstanceName(instance);\n      if (instance.cc_users) {\n        setObj.cc_users = instance.cc_users;\n      }\n    }\n  }\n  return setObj;\n};\n\nuuflowManager.ins_html = function(current_user_info, ins) {\n  var instanceHtml, options;\n  options = {\n    templateName: 'table',\n    showTrace: true,\n    showAttachments: false,\n    tagger: 'email'\n  };\n  options.width = \"765px\";\n  options.styles = \"body { background: #ffffff !important; }.steedos .pull-right { float: right !important; }.steedos .inline-left{ display: inline;float: left; }.steedos .inline-right{ display: inline;float: right; }.steedos .no-border{ border: 0px; }.steedos .no-border td{ border: 0px; }.steedos tr:nth-child(2) td{ border-top: 0px !important; }.steedos .ins_applicant{ display: inline; background: transparent !important; border: none; }.steedos .instance-name{ width: \" + options.width + \" !important; }.steedos table { border-spacing: 0; border-collapse: collapse; }.steedos .box { background: #ffffff; }.steedos .form-table { width: \" + options.width + \"; border: solid 2px #000000; border-collapse: collapse; table-layout: fixed; }.steedosTable-item-field{ padding: 5px; }.steedos td{ border: solid 1px #000000; border-collapse: collapse; }.steedos th { border: 0px; border-collapse: collapse; padding: 0px; }.steedos .td-title{ padding: 4px 12px; }.steedos .td-field { padding: 4px 12px; }.instance-view .instance-name { text-align: center; font-weight: bolder; }.td-childfield { border-top: solid 1px #000000; border-right: solid 1px #000000; border-bottom: solid 1px #000000; padding: 0px; }.panel-heading{ padding: 4px 12px; font-weight: bold; color: #333; background-color: #f5f5f5; }.table-bordered tr:last-child th { border-bottom: none; }.table-bordered tr:last-child td { border-bottom: none; }.steedos-table th:first-child{ border-left: 0px !important; }.steedos-table td:first-child { border-left: 0px !important; }.steedos-table table thead .title { min-width: 50px; }.steedos-table th:last-child{ border-right: 0px !important; }.steedos-table td:last-child { border-right: 0px !important; }.steedos-table table .number { text-align: right; }.callout-default{ border-color: #D2D6DE; color: #333; background-color: #F1F1F1; font-weight: bold; }.instance-table .callout { margin: 0px; padding: 4px 12px; border-radius: 0px; border-left: none; }.approved{ color: green; }.rejected{ color: red; }.terminated{ color: black; }.reassigned{ color: black; }.retrieved{ color: black; }.trace-approve-talbe td { text-align: left; border: none; }.traces td table { width: 100%; }.approve-item .name{ width: 40%; }.approve-item .finish-date{ width: 35%; }.td-stepname{ padding: 4px 12px; }.td-approve td{ padding: 4px 12px; }.applicant-wrapper { font-weight: bolder; }\";\n  instanceHtml = InstanceReadOnlyTemplate.getInstanceHtml(current_user_info, ins.space, ins, options);\n  instanceHtml = instanceHtml.replace('style=\"width: 100%;display: inline-table;\"', 'style=\"border:0px;text-align: center;width:765px;\"');\n  instanceHtml = instanceHtml.replace('class=\"instance-table-name-td\"', 'class=\"instance-table-name-td\" style=\"width:' + options.width + ';border:0px\"');\n  instanceHtml = instanceHtml.replace('class=\"instance-name\"', 'class=\"instance-name\" style=\"width:' + options.width + '\"');\n  instanceHtml = instanceHtml.replace('class=\"table-page-body form-table\"', 'class=\"table-page-body form-table\" style=\"width:' + options.width + '\"');\n  instanceHtml = instanceHtml.replace('class=\"table table-condensed traces\"', 'class=\"table table-condensed traces\" style=\"width:' + options.width + ';border:solid 2.0px #000000\"');\n  instanceHtml = instanceHtml.replace('class=\"table-page-footer form-table no-border\"', 'class=\"table-page-footer form-table no-border\" style=\"border:0px;width:765px;\"');\n  instanceHtml = instanceHtml.replace(/class=\"td-title \"/g, 'class=\"td-title\" style=\"width:14%\"');\n  instanceHtml = instanceHtml.replace(/class=\"td-stepname\"/g, 'class=\"td-stepname\" style=\"width:' + 765 * 20 / 100 + 'px\"');\n  instanceHtml = instanceHtml.replace(/class=\"td-childfield\"/g, 'class=\"td-childfield\" style=\"padding:0px\"');\n  instanceHtml = instanceHtml.replace(/class=\"status approved\"/g, 'class=\"status approved\" style=\"color: green;\"');\n  instanceHtml = instanceHtml.replace(/class=\"status rejected\"/g, 'class=\"status rejected\" style=\"color: red;\"');\n  instanceHtml = instanceHtml.replace(/<table>/g, '<table style=\"width:100%;border:none\">');\n  instanceHtml = instanceHtml.replace(/<td class=\"name\">/g, '<td class=\"name\" style=\"width: 40%;\">');\n  instanceHtml = instanceHtml.replace(/<td class=\"finish-date\">/g, '<td class=\"finish-date\" style=\"width: 35%;\">');\n  instanceHtml = instanceHtml.replace(/inline-left'/g, \"inline-left' style='display: inline;float: left;'\");\n  instanceHtml = instanceHtml.replace(/inline-right'/g, \"inline-right' style='display: inline;float: right;'\");\n  instanceHtml = instanceHtml.replace(/pull-right'/g, \"pull-right' style='float: right;'\");\n  return instanceHtml;\n};\n\nuuflowManager.getFlowCompanyId = function(flowId) {\n  var ref;\n  return (ref = db.flows.findOne(flowId, {\n    fields: {\n      company_id: 1\n    }\n  })) != null ? ref.company_id : void 0;\n};\n\nuuflowManager.create_instance = function(instance_from_client, user_info) {\n  var appr_obj, approve_from_client, category, companyId, flow, flow_id, form, ins_obj, instance_flow_version, new_ins_id, now, permissions, space, space_id, space_user, space_user_org_info, start_step, trace_from_client, trace_obj, user_id;\n  space_id = instance_from_client[\"space\"];\n  flow_id = instance_from_client[\"flow\"];\n  instance_flow_version = instance_from_client[\"flow_version\"];\n  user_id = user_info._id;\n  trace_from_client = null;\n  approve_from_client = null;\n  if (instance_from_client[\"traces\"] && instance_from_client[\"traces\"][0]) {\n    trace_from_client = instance_from_client[\"traces\"][0];\n    if (trace_from_client[\"approves\"] && trace_from_client[\"approves\"][0]) {\n      approve_from_client = instance_from_client[\"traces\"][0][\"approves\"][0];\n    }\n  }\n  space = uuflowManager.getSpace(space_id);\n  flow = uuflowManager.getFlow(flow_id);\n  space_user = uuflowManager.getSpaceUser(space_id, user_id);\n  space_user_org_info = uuflowManager.getSpaceUserOrgInfo(space_user);\n  uuflowManager.isFlowEnabled(flow);\n  uuflowManager.isFlowSpaceMatched(flow, space_id);\n  form = uuflowManager.getForm(flow.form);\n  permissions = permissionManager.getFlowPermissions(flow_id, user_id);\n  if (!permissions.includes(\"add\")) {\n    throw new Meteor.Error('error!', \"当前用户没有此流程的新建权限\");\n  }\n  now = new Date;\n  ins_obj = {};\n  ins_obj._id = db.instances._makeNewID();\n  ins_obj.space = space_id;\n  ins_obj.flow = flow_id;\n  ins_obj.flow_version = flow.current._id;\n  ins_obj.form = flow.form;\n  ins_obj.form_version = flow.current.form_version;\n  ins_obj.name = flow.name;\n  ins_obj.submitter = user_id;\n  ins_obj.submitter_name = user_info.name;\n  ins_obj.applicant = instance_from_client[\"applicant\"] ? instance_from_client[\"applicant\"] : user_id;\n  ins_obj.applicant_name = instance_from_client[\"applicant_name\"] ? instance_from_client[\"applicant_name\"] : user_info.name;\n  ins_obj.applicant_organization = instance_from_client[\"applicant_organization\"] ? instance_from_client[\"applicant_organization\"] : space_user.organization;\n  ins_obj.applicant_organization_name = instance_from_client[\"applicant_organization_name\"] ? instance_from_client[\"applicant_organization_name\"] : space_user_org_info.organization_name;\n  ins_obj.applicant_organization_fullname = instance_from_client[\"applicant_organization_fullname\"] ? instance_from_client[\"applicant_organization_fullname\"] : space_user_org_info.organization_fullname;\n  ins_obj.applicant_company = instance_from_client[\"applicant_company\"] ? instance_from_client[\"applicant_company\"] : space_user.company_id;\n  ins_obj.state = 'draft';\n  ins_obj.code = '';\n  ins_obj.is_archived = false;\n  ins_obj.is_deleted = false;\n  ins_obj.created = now;\n  ins_obj.created_by = user_id;\n  ins_obj.modified = now;\n  ins_obj.modified_by = user_id;\n  ins_obj.values = new Object;\n  companyId = uuflowManager.getFlowCompanyId(flow_id);\n  if (companyId) {\n    ins_obj.company_id = companyId;\n  }\n  trace_obj = {};\n  trace_obj._id = new Mongo.ObjectID()._str;\n  trace_obj.instance = ins_obj._id;\n  trace_obj.is_finished = false;\n  start_step = _.find(flow.current.steps, function(step) {\n    return step.step_type === 'start';\n  });\n  trace_obj.step = start_step._id;\n  trace_obj.name = start_step.name;\n  trace_obj.start_date = now;\n  appr_obj = {};\n  appr_obj._id = new Mongo.ObjectID()._str;\n  appr_obj.instance = ins_obj._id;\n  appr_obj.trace = trace_obj._id;\n  appr_obj.is_finished = false;\n  appr_obj.user = instance_from_client[\"applicant\"] ? instance_from_client[\"applicant\"] : user_id;\n  appr_obj.user_name = instance_from_client[\"applicant_name\"] ? instance_from_client[\"applicant_name\"] : user_info.name;\n  appr_obj.handler = user_id;\n  appr_obj.handler_name = user_info.name;\n  appr_obj.handler_organization = space_user.organization;\n  appr_obj.handler_organization_name = space_user_org_info.organization_name;\n  appr_obj.handler_organization_fullname = space_user_org_info.organization_fullname;\n  appr_obj.type = 'draft';\n  appr_obj.start_date = now;\n  appr_obj.read_date = now;\n  appr_obj.is_read = true;\n  appr_obj.is_error = false;\n  appr_obj.description = '';\n  appr_obj.values = approve_from_client && approve_from_client[\"values\"] ? approve_from_client[\"values\"] : new Object;\n  trace_obj.approves = [appr_obj];\n  ins_obj.traces = [trace_obj];\n  ins_obj.inbox_users = instance_from_client.inbox_users || [];\n  ins_obj.current_step_name = start_step.name;\n  if (flow.auto_remind === true) {\n    ins_obj.auto_remind = true;\n  }\n  ins_obj.flow_name = flow.name;\n  if (form.category) {\n    category = uuflowManager.getCategory(form.category);\n    if (category) {\n      ins_obj.category_name = category.name;\n      ins_obj.category = category._id;\n    }\n  }\n  new_ins_id = db.instances.insert(ins_obj);\n  return new_ins_id;\n};\n\nuuflowManager.getCurrentStepAutoSubmit = function(timeout_auto_submit, lines) {\n  var timeout_line;\n  if (timeout_auto_submit && lines) {\n    timeout_line = _.find(lines, function(l) {\n      return l.timeout_line === true;\n    });\n    if (timeout_line) {\n      return true;\n    }\n  }\n  return false;\n};\n\nuuflowManager.getDueDate = function(hours, spaceId) {\n  if (hours) {\n    return Meteor.wrapAsync(function(start, hours, spaceId, cb) {\n      return steedosCore.getTimeoutDateWithoutHolidays(start, hours, spaceId).then(function(resolve, reject) {\n        return cb(reject, resolve);\n      });\n    })(new Date(), hours, spaceId);\n  }\n  return void 0;\n};\n\nuuflowManager.submit_instance = function(instance_from_client, user_info) {\n  var applicant, applicant_id, applicant_org_info, approve, approve_id, attachments, checkApplicant, checkUsers, current_user, description, flow, flow_has_upgrade, flow_id, form, instance, instance_id, instance_name, instance_traces, lang, newTrace, nextSteps, nextTrace, next_step, next_step_users, next_steps, permissions, setObj, space, space_id, space_user, space_user_org_info, start_step, step, submitter_id, trace, trace_id, traces, upObj, updated_values, user, values;\n  current_user = user_info._id;\n  lang = \"en\";\n  if (user_info.locale === 'zh-cn') {\n    lang = 'zh-CN';\n  }\n  instance_id = instance_from_client[\"_id\"];\n  trace_id = instance_from_client[\"traces\"][0][\"_id\"];\n  approve_id = instance_from_client[\"traces\"][0][\"approves\"][0][\"_id\"];\n  values = instance_from_client[\"traces\"][0][\"approves\"][0][\"values\"];\n  if (!values) {\n    values = new Object;\n  }\n  if (!instance_from_client[\"applicant\"]) {\n    throw new Meteor.Error('error!', \"请选择提交人\");\n  }\n  applicant_id = instance_from_client[\"applicant\"];\n  submitter_id = instance_from_client[\"submitter\"];\n  next_steps = instance_from_client[\"traces\"][0][\"approves\"][0][\"next_steps\"];\n  attachments = instance_from_client[\"traces\"][0][\"approves\"][0][\"attachments\"];\n  description = instance_from_client[\"traces\"][0][\"approves\"][0][\"description\"];\n  instance = uuflowManager.getInstance(instance_id);\n  space_id = instance.space;\n  flow_id = instance.flow;\n  space = uuflowManager.getSpace(space_id);\n  checkApplicant = uuflowManager.getSpaceUser(space_id, applicant_id);\n  flow = uuflowManager.getFlow(flow_id);\n  instance_name = instance_from_client[\"name\"];\n  uuflowManager.isInstanceDraft(instance, lang);\n  space_user = uuflowManager.getSpaceUser(space_id, current_user);\n  space_user_org_info = uuflowManager.getSpaceUserOrgInfo(space_user);\n  uuflowManager.isInstanceSubmitter(instance, current_user);\n  uuflowManager.isFlowEnabled(flow);\n  permissions = permissionManager.getFlowPermissions(flow_id, current_user);\n  if (!permissions.includes(\"add\")) {\n    throw new Meteor.Error('error!', \"该提交人没有提交此申请单的权限。\");\n  }\n  trace = instance_from_client[\"traces\"][0];\n  step = uuflowManager.getStep(instance, flow, trace[\"step\"]);\n  approve = trace[\"approves\"][0];\n  form = db.forms.findOne(instance.form);\n  start_step = _.find(flow.current.steps, function(step) {\n    return step.step_type === 'start';\n  });\n  instance_traces = instance.traces;\n  instance_traces[0][\"approves\"][0].description = description;\n  setObj = new Object;\n  flow_has_upgrade = false;\n  if (applicant_id === instance.applicant) {\n    if (instance.flow_version === flow.current._id) {\n      instance_traces[0][\"approves\"][0].judge = \"submitted\";\n      if (next_steps) {\n        instance_traces[0][\"approves\"][0].next_steps = next_steps;\n      }\n      setObj.modified = new Date;\n      setObj.modified_by = current_user;\n    } else {\n      flow_has_upgrade = true;\n      setObj.flow_version = flow.current._id;\n      setObj.form_version = flow.current.form_version;\n      setObj.modified = new Date;\n      setObj.modified_by = current_user;\n      instance_traces[0].step = start_step._id;\n      instance_traces[0].name = start_step.name;\n      instance_traces[0][\"approves\"][0].judge = \"submitted\";\n    }\n  } else {\n    user = uuflowManager.getUser(applicant_id);\n    applicant = uuflowManager.getSpaceUser(space_id, applicant_id);\n    applicant_org_info = uuflowManager.getSpaceUserOrgInfo(applicant);\n    setObj.applicant = applicant_id;\n    setObj.applicant_name = user.name;\n    setObj.applicant_organization = applicant_org_info[\"organization\"];\n    setObj.applicant_organization_name = applicant_org_info[\"organization_name\"];\n    setObj.applicant_organization_fullname = applicant_org_info[\"organization_fullname\"];\n    setObj.applicant_company = applicant[\"company_id\"];\n    instance_traces[0][\"approves\"][0].user = applicant_id;\n    instance_traces[0][\"approves\"][0].user_name = user.name;\n    instance_traces[0][\"approves\"][0].judge = \"submitted\";\n    if (instance.flow_version === flow.current._id) {\n      if (next_steps) {\n        instance_traces[0][\"approves\"][0].next_steps = next_steps;\n        setObj.modified = new Date;\n        setObj.modified_by = current_user;\n      }\n    } else {\n      flow_has_upgrade = true;\n      setObj.flow_version = flow.current._id;\n      setObj.form_version = flow.current.form_version;\n      setObj.modified = new Date;\n      setObj.modified_by = current_user;\n      instance_traces[0].step = start_step._id;\n      instance_traces[0].name = start_step.name;\n    }\n  }\n  instance_traces[0][\"approves\"][0].values = uuflowManager.getApproveValues(values, step.permissions, instance.form, instance.form_version);\n  setObj.traces = instance_traces;\n  db.instances.update({\n    _id: instance_id\n  }, {\n    $set: setObj\n  });\n  if (flow_has_upgrade) {\n    return {\n      alerts: TAPi18n.__('flow.point_upgraded', {}, lang)\n    };\n  }\n  instance = db.instances.findOne(instance_id);\n  uuflowManager.isInstanceDraft(instance, lang);\n  traces = instance.traces;\n  upObj = new Object;\n  if ((!approve[\"next_steps\"]) || (approve[\"next_steps\"].length === 0)) {\n    throw new Meteor.Error('error!', \"还未指定下一步和处理人，提交失败\");\n  } else {\n    if (approve[\"next_steps\"].length > 1) {\n      throw new Meteor.Error('error!', \"不能指定多个后续步骤\");\n    } else {\n      nextSteps = uuflowManager.getNextSteps(instance, flow, step, \"\");\n      _.each(approve[\"next_steps\"], function(approve_next_step) {\n        if (!nextSteps.includes(approve_next_step[\"step\"])) {\n          throw new Meteor.Error('error!', \"下一步步骤不合法\");\n        }\n      });\n    }\n  }\n  _.each(approve[\"next_steps\"][0][\"users\"], function(next_step_user) {\n    return uuflowManager.getSpaceUser(space_id, next_step_user);\n  });\n  next_step = uuflowManager.getStep(instance, flow, approve[\"next_steps\"][0][\"step\"]);\n  if (next_step.step_type === \"end\") {\n    traces[0][\"approves\"][0].is_finished = true;\n    traces[0][\"approves\"][0].finish_date = new Date;\n    traces[0][\"approves\"][0].cost_time = traces[0][\"approves\"][0].finish_date - traces[0][\"approves\"][0].start_date;\n    traces[0].is_finished = true;\n    traces[0].judge = \"submitted\";\n    traces[0].finish_date = new Date;\n    newTrace = new Object;\n    newTrace._id = new Mongo.ObjectID()._str;\n    newTrace.instance = instance_id;\n    newTrace.previous_trace_ids = [trace[\"_id\"]];\n    newTrace.is_finished = true;\n    newTrace.step = next_step._id;\n    newTrace.name = next_step.name;\n    newTrace.start_date = new Date;\n    newTrace.finish_date = new Date;\n    upObj.submit_date = new Date;\n    upObj.state = \"completed\";\n    upObj.values = uuflowManager.getUpdatedValues(uuflowManager.getInstance(instance_id));\n    upObj.code = flow.current_no + 1 + \"\";\n    instance.code = upObj.code;\n    instance.values = upObj.values;\n    upObj.name = uuflowManager.getInstanceName(instance);\n    upObj.modified = new Date;\n    upObj.modified_by = current_user;\n    upObj.inbox_users = [];\n    upObj.outbox_users = _.uniq([current_user, traces[0][\"approves\"][0][\"user\"]]);\n    traces.push(newTrace);\n    upObj.traces = traces;\n    upObj.finish_date = new Date;\n    upObj.current_step_name = next_step.name;\n    upObj.final_decision = \"approved\";\n    upObj.current_step_auto_submit = false;\n  } else {\n    next_step_users = approve[\"next_steps\"][0][\"users\"];\n    if ((!next_step_users) || (next_step_users.length === 0)) {\n      throw new Meteor.Error('error!', \"未指定下一步处理人\");\n    } else {\n      if (next_step_users.length > 1 && next_step.step_type !== \"counterSign\") {\n        throw new Meteor.Error('error!', \"不能指定多个处理人\");\n      } else {\n        checkUsers = getHandlersManager.getHandlers(instance_id, approve[\"next_steps\"][0][\"step\"], current_user);\n        if (!uuflowManager.checkNestStepUsersIsValid(next_step_users, checkUsers, next_step)) {\n          throw new Meteor.Error('error!', \"指定的下一步处理人有误\");\n        } else {\n          traces[0][\"approves\"][0].is_finished = true;\n          traces[0][\"approves\"][0].finish_date = new Date;\n          traces[0][\"approves\"][0].cost_time = traces[0][\"approves\"][0].finish_date - traces[0][\"approves\"][0].start_date;\n          traces[0].is_finished = true;\n          traces[0].finish_date = new Date;\n          traces[0].judge = \"submitted\";\n          nextTrace = new Object;\n          nextTrace._id = new Mongo.ObjectID()._str;\n          nextTrace.instance = instance_id;\n          nextTrace.previous_trace_ids = [trace[\"_id\"]];\n          nextTrace.is_finished = false;\n          nextTrace.step = next_step._id;\n          nextTrace.name = next_step.name;\n          nextTrace.start_date = new Date;\n          nextTrace.due_date = uuflowManager.getDueDate(next_step.timeout_hours, space_id);\n          nextTrace.approves = new Array;\n          updated_values = uuflowManager.getUpdatedValues(uuflowManager.getInstance(instance_id));\n          _.each(next_step_users, function(next_step_user_id, idx) {\n            var agent, handler_id, handler_info, nextApprove, next_step_space_user, next_step_user_org_info;\n            nextApprove = new Object;\n            nextApprove._id = new Mongo.ObjectID()._str;\n            user_info = uuflowManager.getUser(next_step_user_id);\n            handler_id = next_step_user_id;\n            handler_info = user_info;\n            agent = uuflowManager.getAgent(space_id, next_step_user_id);\n            if (agent) {\n              next_step_users[idx] = agent;\n              handler_id = agent;\n              handler_info = uuflowManager.getUser(agent);\n              nextApprove.agent = agent;\n            }\n            nextApprove.instance = instance_id;\n            nextApprove.trace = nextTrace._id;\n            nextApprove.is_finished = false;\n            nextApprove.user = next_step_user_id;\n            nextApprove.user_name = user_info.name;\n            nextApprove.handler = handler_id;\n            nextApprove.handler_name = handler_info.name;\n            next_step_space_user = uuflowManager.getSpaceUser(space_id, handler_id);\n            next_step_user_org_info = uuflowManager.getSpaceUserOrgInfo(next_step_space_user);\n            nextApprove.handler_organization = next_step_user_org_info[\"organization\"];\n            nextApprove.handler_organization_name = next_step_user_org_info[\"organization_name\"];\n            nextApprove.handler_organization_fullname = next_step_user_org_info[\"organization_fullname\"];\n            nextApprove.start_date = new Date;\n            nextApprove.due_date = nextTrace.due_date;\n            nextApprove.is_read = false;\n            nextApprove.is_error = false;\n            nextApprove.values = new Object;\n            uuflowManager.setRemindInfo(updated_values, nextApprove);\n            return nextTrace.approves.push(nextApprove);\n          });\n          upObj.name = instance_name;\n          upObj.submit_date = new Date;\n          upObj.state = \"pending\";\n          upObj.values = updated_values;\n          upObj.inbox_users = next_step_users;\n          upObj.modified = new Date;\n          upObj.modified_by = current_user;\n          upObj.code = flow.current_no + 1 + \"\";\n          instance.code = upObj.code;\n          instance.values = upObj.values;\n          upObj.name = uuflowManager.getInstanceName(instance);\n          traces.push(nextTrace);\n          upObj.traces = traces;\n          upObj.outbox_users = [];\n          upObj.current_step_name = next_step.name;\n          upObj.current_step_auto_submit = uuflowManager.getCurrentStepAutoSubmit(flow.timeout_auto_submit, next_step.lines);\n        }\n      }\n    }\n  }\n  upObj.keywords = uuflowManager.caculateKeywords(upObj.values, form, instance.form_version);\n  db.instances.update({\n    _id: instance_id\n  }, {\n    $set: upObj\n  });\n  db.flows.direct.update({\n    _id: flow._id\n  }, {\n    $set: {\n      current_no: flow.current_no + 1\n    }\n  });\n  if (next_step.step_type !== \"end\") {\n    instance = db.instances.findOne(instance_id);\n    pushManager.send_instance_notification(\"first_submit_applicant\", instance, \"\", user_info);\n    pushManager.send_instance_notification(\"first_submit_inbox\", instance, \"\", user_info);\n  }\n  return {};\n};\n\nuuflowManager.get_SpaceChangeSet = function(formids, is_admin, sync_token) {\n  var changeSet, formids_ary;\n  sync_token = new Date(Number(sync_token) * 1000);\n  changeSet = new Object;\n  changeSet.sync_token = new Date().getTime() / 1000;\n  changeSet.inserts = {\n    Spaces: [],\n    Users: [],\n    SpaceUsers: [],\n    Organizations: [],\n    Roles: [],\n    Positions: [],\n    Forms: [],\n    Flows: [],\n    Instances: []\n  };\n  changeSet.updates = {\n    Spaces: [],\n    Users: [],\n    SpaceUsers: [],\n    Organizations: [],\n    Roles: [],\n    Positions: [],\n    Forms: [],\n    Flows: [],\n    Instances: []\n  };\n  changeSet.deletes = {\n    Spaces: [],\n    Users: [],\n    SpaceUsers: [],\n    Organizations: [],\n    Roles: [],\n    Positions: [],\n    Forms: [],\n    Flows: [],\n    Instances: []\n  };\n  if (formids && formids.trim()) {\n    formids_ary = formids.split(\",\");\n    changeSet.inserts.Instances = db.instances.find({\n      form: {\n        $in: formids_ary\n      },\n      created: {\n        $gt: sync_token\n      }\n    }).fetch();\n    changeSet.updates.Instances = db.instances.find({\n      form: {\n        $in: formids_ary\n      },\n      created: {\n        $lte: sync_token\n      },\n      modified: {\n        $gt: sync_token\n      }\n    }).fetch();\n    changeSet.deletes.Instances = db.deleted_instances.find({\n      form: {\n        $in: formids_ary\n      },\n      deleted: {\n        $gt: sync_token\n      }\n    }, {\n      fields: {\n        _id: 1\n      }\n    }).fetch();\n  } else if (is_admin && is_admin.trim()) {\n    changeSet.inserts.Instances = db.instances.find({\n      created: {\n        $gt: sync_token\n      }\n    }).fetch();\n    changeSet.updates.Instances = db.instances.find({\n      created: {\n        $lte: sync_token\n      },\n      modified: {\n        $gt: sync_token\n      }\n    }).fetch();\n    changeSet.deletes.Instances = db.deleted_instances.find({\n      deleted: {\n        $gt: sync_token\n      }\n    }, {\n      fields: {\n        _id: 1\n      }\n    }).fetch();\n  }\n  _.each(changeSet.inserts.Instances, function(ins) {\n    var applicant, submitter;\n    submitter = db.users.findOne({\n      _id: ins.submitter\n    }, {\n      fields: {\n        steedos_id: 1\n      }\n    });\n    applicant = db.users.findOne({\n      _id: ins.applicant\n    }, {\n      fields: {\n        steedos_id: 1\n      }\n    });\n    if (submitter) {\n      ins.submitter_steedos_id = submitter.steedos_id;\n    }\n    if (applicant) {\n      return ins.applicant_steedos_id = applicant.steedos_id;\n    }\n  });\n  _.each(changeSet.updates.Instances, function(ins) {\n    var applicant, submitter;\n    submitter = db.users.findOne({\n      _id: ins.submitter\n    }, {\n      fields: {\n        steedos_id: 1\n      }\n    });\n    applicant = db.users.findOne({\n      _id: ins.applicant\n    }, {\n      fields: {\n        steedos_id: 1\n      }\n    });\n    if (submitter) {\n      ins.submitter_steedos_id = submitter.steedos_id;\n    }\n    if (applicant) {\n      return ins.applicant_steedos_id = applicant.steedos_id;\n    }\n  });\n  return {\n    ChangeSet: changeSet\n  };\n};\n\n\n/* 文件催办\n根据instance.values.priority和instance.values.deadline给approve增加remind相关信息\n{\n\tdeadline: Date,\n\tremind_date: Date,\n\treminded_count: Number\n}\n */\n\nuuflowManager.setRemindInfo = function(values, approve) {\n  var caculate_date, deadline, flow, ins, priority, remind_date, start_date;\n  check(values, Object);\n  check(approve, Object);\n  check(approve.start_date, Date);\n  remind_date = null;\n  deadline = null;\n  start_date = approve.start_date;\n  if (values.priority && values.deadline) {\n    check(values.priority, Match.OneOf(\"普通\", \"办文\", \"紧急\", \"特急\"));\n    deadline = new Date(values.deadline);\n    if (deadline.toString() === \"Invalid Date\") {\n      return;\n    }\n    priority = values.priority;\n    if (priority === \"普通\") {\n      remind_date = Steedos.caculateWorkingTime(start_date, 3);\n    } else if (priority === \"办文\") {\n      if (Steedos.caculatePlusHalfWorkingDay(start_date) > deadline) {\n        remind_date = Steedos.caculatePlusHalfWorkingDay(start_date, true);\n      } else if (Steedos.caculateWorkingTime(start_date, 1) > deadline) {\n        caculate_date = function(base_date) {\n          var plus_halfday_date;\n          plus_halfday_date = Steedos.caculatePlusHalfWorkingDay(base_date);\n          if (plus_halfday_date > deadline) {\n            remind_date = base_date;\n          } else {\n            caculate_date(Steedos.caculatePlusHalfWorkingDay(base_date, true));\n          }\n        };\n        caculate_date(start_date);\n      } else {\n        remind_date = Steedos.caculateWorkingTime(start_date, 1);\n      }\n    } else if (priority === \"紧急\" || priority === \"特急\") {\n      if (Steedos.caculatePlusHalfWorkingDay(start_date) > deadline) {\n        remind_date = Steedos.caculatePlusHalfWorkingDay(start_date, true);\n      } else if (Steedos.caculateWorkingTime(start_date, 1) > deadline) {\n        caculate_date = function(base_date) {\n          var plus_halfday_date;\n          plus_halfday_date = Steedos.caculatePlusHalfWorkingDay(base_date);\n          if (plus_halfday_date > deadline) {\n            remind_date = base_date;\n          } else {\n            caculate_date(Steedos.caculatePlusHalfWorkingDay(base_date, true));\n          }\n        };\n        caculate_date(start_date);\n      } else {\n        remind_date = Steedos.caculatePlusHalfWorkingDay(start_date);\n      }\n      ins = db.instances.findOne(approve.instance);\n      if (ins.state === 'draft') {\n        flow = db.flows.findOne({\n          _id: ins.flow\n        }, {\n          fields: {\n            current_no: 1\n          }\n        });\n        ins.code = flow.current_no + 1 + '';\n      }\n      ins.values = values;\n      uuflowManager.sendRemindSMS(uuflowManager.getInstanceName(ins), deadline, [approve.user], ins.space, ins._id);\n    }\n  } else {\n    remind_date = Steedos.caculateWorkingTime(start_date, 3);\n  }\n  approve.deadline = deadline;\n  approve.remind_date = remind_date;\n  approve.reminded_count = 0;\n};\n\nuuflowManager.sendRemindSMS = function(ins_name, deadline, users_id, space_id, ins_id) {\n  var name, ref, send_users, skip_users;\n  check(ins_name, String);\n  check(deadline, Date);\n  check(users_id, Array);\n  check(space_id, String);\n  check(ins_id, String);\n  skip_users = ((ref = Meteor.settings.remind) != null ? ref.skip_users : void 0) || [];\n  send_users = [];\n  _.each(users_id, function(uid) {\n    if (!skip_users.includes(uid)) {\n      return send_users.push(uid);\n    }\n  });\n  name = ins_name.length > 15 ? ins_name.substr(0, 12) + '...' : ins_name;\n  return db.users.find({\n    _id: {\n      $in: _.uniq(send_users)\n    },\n    mobile: {\n      $exists: true\n    },\n    mobile_verified: true\n  }, {\n    fields: {\n      mobile: 1,\n      utcOffset: 1,\n      locale: 1,\n      name: 1\n    }\n  }).forEach(function(user) {\n    var lang, notification, params, payload, utcOffset;\n    utcOffset = user.hasOwnProperty('utcOffset') ? user.utcOffset : 8;\n    params = {\n      instance_name: name,\n      deadline: moment(deadline).utcOffset(utcOffset).format('MM-DD HH:mm')\n    };\n    lang = 'en';\n    if (user.locale === 'zh-cn') {\n      lang = 'zh-CN';\n    }\n    SMSQueue.send({\n      Format: 'JSON',\n      Action: 'SingleSendSms',\n      ParamString: JSON.stringify(params),\n      RecNum: user.mobile,\n      SignName: 'OA系统',\n      TemplateCode: 'SMS_67200967',\n      msg: TAPi18n.__('sms.remind.template', {\n        instance_name: ins_name,\n        deadline: params.deadline,\n        open_app_url: Meteor.absoluteUrl() + (\"workflow.html?space_id=\" + space_id + \"&ins_id=\" + ins_id)\n      }, lang)\n    });\n    notification = new Object;\n    notification[\"createdAt\"] = new Date;\n    notification[\"createdBy\"] = '<SERVER>';\n    notification[\"from\"] = 'workflow';\n    notification['title'] = user.name;\n    notification['text'] = TAPi18n.__('instance.push.body.remind', {\n      instance_name: ins_name,\n      deadline: params.deadline\n    }, lang);\n    payload = new Object;\n    payload[\"space\"] = space_id;\n    payload[\"instance\"] = ins_id;\n    payload[\"host\"] = Meteor.absoluteUrl().substr(0, Meteor.absoluteUrl().length - 1);\n    payload[\"requireInteraction\"] = true;\n    notification[\"payload\"] = payload;\n    notification['query'] = {\n      userId: user._id,\n      appName: 'workflow'\n    };\n    return Push.send(notification);\n  });\n};\n\nuuflowManager.checkMainAttach = function(instance_id, name) {\n  var file_name, ins, main, main_name_split, new_ins_name;\n  main = cfs.instances.findOne({\n    'metadata.instance': instance_id,\n    'metadata.main': true,\n    'metadata.current': true\n  });\n  if (main) {\n    ins = db.instances.findOne({\n      _id: instance_id\n    }, {\n      fields: {\n        name: 1\n      }\n    });\n    new_ins_name = name || ins.name;\n    new_ins_name = new_ins_name.replace(/\\r/g, \"\").replace(/\\n/g, \"\");\n    new_ins_name = new_ins_name.replace(/\\?|\\*|\\:|\\\"|\\<|\\>|\\\\|\\/|\\|/g, \"\");\n    main_name_split = main.name().split('.');\n    main_name_split.pop();\n    if (new_ins_name !== main_name_split.join(\"\")) {\n      file_name = new_ins_name + \".\" + main.extension();\n      return main.update({\n        $set: {\n          'original.name': file_name,\n          'copies.instances.name': file_name\n        }\n      });\n    }\n  }\n};\n\nuuflowManager.caculateKeywords = function(values, form, form_version) {\n  var form_v, keywords;\n  if (_.isEmpty(values)) {\n    return \"\";\n  }\n  keywords = [];\n  form_v = null;\n  if (form_version === form.current._id) {\n    form_v = form.current;\n  } else {\n    form_v = _.find(form.historys, function(form_h) {\n      return form_version === form_h._id;\n    });\n  }\n  _.each(form_v.fields, function(field) {\n    var multiValue;\n    if (field.is_searchable) {\n      if (field.type === 'input' || field.type === 'email' || field.type === 'url' || field.type === 'number' || field.type === 'select' || field.type === 'radio') {\n        if (values[field.code]) {\n          return keywords.push(values[field.code]);\n        }\n      } else if (field.type === 'multiSelect') {\n        if (values[field.code]) {\n          return keywords.push(values[field.code]);\n        }\n      } else if (field.type === 'user' || field.type === 'group') {\n        if (field.is_multiselect === true) {\n          multiValue = values[field.code];\n          if (_.isArray(multiValue)) {\n            return _.each(multiValue, function(singleV) {\n              if (singleV && singleV['name']) {\n                return keywords.push(singleV['name']);\n              }\n            });\n          }\n        } else {\n          if (values[field.code] && values[field.code]['name']) {\n            return keywords.push(values[field.code]['name']);\n          }\n        }\n      }\n    } else if (field.type === 'table') {\n      if (values[field.code]) {\n        return _.each(values[field.code], function(s_value) {\n          return _.each(field.fields, function(s_field) {\n            if (s_field.is_searchable) {\n              if (s_field.type === 'input' || s_field.type === 'email' || s_field.type === 'url' || s_field.type === 'number' || s_field.type === 'select' || s_field.type === 'radio') {\n                if (s_value[s_field.code]) {\n                  return keywords.push(s_value[s_field.code]);\n                }\n              } else if (s_field.type === 'multiSelect') {\n                if (s_value[s_field.code]) {\n                  return keywords.push(s_value[s_field.code]);\n                }\n              } else if (s_field.type === 'user' || s_field.type === 'group') {\n                if (s_field.is_multiselect === true) {\n                  multiValue = s_value[s_field.code];\n                  if (_.isArray(multiValue)) {\n                    return _.each(multiValue, function(singleV) {\n                      if (singleV && singleV['name']) {\n                        return keywords.push(singleV['name']);\n                      }\n                    });\n                  }\n                } else {\n                  if (s_value[s_field.code] && s_value[s_field.code]['name']) {\n                    return keywords.push(s_value[s_field.code]['name']);\n                  }\n                }\n              }\n            }\n          });\n        });\n      }\n    } else if (field.type === 'section') {\n      return _.each(field.fields, function(s_field) {\n        if (s_field.is_searchable) {\n          if (s_field.type === 'input' || s_field.type === 'email' || s_field.type === 'url' || s_field.type === 'number' || s_field.type === 'select' || s_field.type === 'radio') {\n            if (values[s_field.code]) {\n              return keywords.push(values[s_field.code]);\n            }\n          } else if (s_field.type === 'multiSelect') {\n            if (values[s_field.code]) {\n              return keywords.push(values[s_field.code]);\n            }\n          } else if (s_field.type === 'user' || s_field.type === 'group') {\n            if (s_field.is_multiselect === true) {\n              multiValue = values[s_field.code];\n              if (_.isArray(multiValue)) {\n                return _.each(multiValue, function(singleV) {\n                  if (singleV && singleV['name']) {\n                    return keywords.push(singleV['name']);\n                  }\n                });\n              }\n            } else {\n              if (values[s_field.code] && values[s_field.code]['name']) {\n                return keywords.push(values[s_field.code]['name']);\n              }\n            }\n          }\n        }\n      });\n    }\n  });\n  return keywords.join(\" \");\n};\n\nuuflowManager.checkValueFieldsRequire = function(values, form, form_version) {\n  var form_v, require_but_empty_fields;\n  values = values || {};\n  require_but_empty_fields = [];\n  form_v = null;\n  if (form_version === form.current._id) {\n    form_v = form.current;\n  } else {\n    form_v = _.find(form.historys, function(form_h) {\n      return form_version === form_h._id;\n    });\n  }\n  _.each(form_v.fields, function(field) {\n    if (field.type !== 'table') {\n      if (field.is_required && _.isEmpty(values[field.code])) {\n        return require_but_empty_fields.push(field.name || field.code);\n      }\n    } else if (field.type === 'table') {\n      if (_.isEmpty(values[field.code])) {\n        return _.each(field.fields, function(s_field) {\n          if (s_field.is_required) {\n            return require_but_empty_fields.push(s_field.name || s_field.code);\n          }\n        });\n      } else {\n        return _.each(values[field.code], function(s_value) {\n          return _.each(field.fields, function(s_field) {\n            if (s_field.is_required && _.isEmpty(s_value[s_field.code])) {\n              return require_but_empty_fields.push(s_field.name || s_field.code);\n            }\n          });\n        });\n      }\n    }\n  });\n  return require_but_empty_fields;\n};\n\nuuflowManager.triggerRecordInstanceQueue = function(ins_id, record_ids, step_name, flow_id, ins_state) {\n  var newObj, owDoc, syncType;\n  owDoc = Creator.getCollection('object_workflows').findOne({\n    flow_id: flow_id\n  });\n  if (owDoc) {\n    syncType = owDoc.sync_type;\n    if ((!syncType || syncType === 'every_step') || (syncType === 'final_step' && ins_state === 'completed')) {\n      newObj = {\n        info: {\n          instance_id: ins_id,\n          records: record_ids,\n          step_name: step_name,\n          instance_finish_date: new Date()\n        },\n        sent: false,\n        sending: 0,\n        createdAt: new Date(),\n        createdBy: '<SERVER>'\n      };\n      db.instance_record_queue.insert(newObj);\n    }\n  }\n};\n\nuuflowManager.distributedInstancesRemind = function(instance) {\n  var current_trace, e, flow, lang, next_approves, next_step, next_step_id, notification, original_flow, original_instacne, original_instacne_id, original_user, payload, ref, ref1, ref2;\n  if ((instance != null ? (ref = instance.distribute_from_instances) != null ? ref.length : void 0 : void 0) > 0) {\n    flow = db.flows.findOne({\n      _id: instance != null ? instance.flow : void 0\n    });\n    current_trace = instance[\"traces\"].pop();\n    if ((instance != null ? instance.state : void 0) === \"draft\") {\n      next_approves = current_trace != null ? current_trace.approves : void 0;\n      if ((next_approves != null ? next_approves.length : void 0) === 1) {\n        next_step = (ref1 = next_approves[0]) != null ? ref1.next_steps[0] : void 0;\n        next_step_id = next_step != null ? next_step.step : void 0;\n      }\n    } else {\n      next_step_id = current_trace != null ? current_trace.step : void 0;\n    }\n    if (next_step_id) {\n      next_step = uuflowManager.getStep(instance, flow, next_step_id);\n      if ((next_step != null ? next_step.step_type : void 0) === \"end\") {\n        original_instacne_id = instance != null ? (ref2 = instance.distribute_from_instances) != null ? ref2.pop() : void 0 : void 0;\n        original_instacne = db.instances.findOne({\n          _id: original_instacne_id\n        }, {\n          fields: {\n            flow: 1,\n            name: 1,\n            space: 1,\n            created_by: 1\n          }\n        });\n        original_flow = db.flows.findOne({\n          _id: original_instacne != null ? original_instacne.flow : void 0\n        }, {\n          fields: {\n            distribute_end_notification: 1\n          }\n        });\n        if ((original_flow != null ? original_flow.distribute_end_notification : void 0) === true) {\n          try {\n            original_user = db.users.findOne({\n              _id: instance != null ? instance.created_by : void 0\n            });\n            lang = 'en';\n            if ((original_user != null ? original_user.locale : void 0) === 'zh-cn') {\n              lang = 'zh-CN';\n            }\n            notification = new Object;\n            notification[\"createdAt\"] = new Date;\n            notification[\"createdBy\"] = '<SERVER>';\n            notification[\"from\"] = 'workflow';\n            notification['title'] = original_user.name;\n            notification['text'] = TAPi18n.__('instance.push.body.distribute_remind', {\n              instance_name: instance != null ? instance.name : void 0\n            }, lang);\n            payload = new Object;\n            payload[\"space\"] = original_instacne != null ? original_instacne.space : void 0;\n            payload[\"instance\"] = original_instacne != null ? original_instacne._id : void 0;\n            payload[\"host\"] = Meteor.absoluteUrl().substr(0, Meteor.absoluteUrl().length - 1);\n            payload[\"requireInteraction\"] = true;\n            notification[\"payload\"] = payload;\n            notification['query'] = {\n              userId: original_user._id,\n              appName: 'workflow'\n            };\n            Push.send(notification);\n          } catch (error) {\n            e = error;\n            console.error(e.stack);\n          }\n        }\n      }\n    }\n  }\n};\n\nuuflowManager.getAgent = function(spaceId, fromId) {\n  var now, r;\n  now = new Date();\n  r = db.process_delegation_rules.findOne({\n    space: spaceId,\n    from: fromId,\n    enabled: true,\n    start_time: {\n      $lte: now\n    },\n    end_time: {\n      $gte: now\n    }\n  });\n  return r != null ? r.to : void 0;\n};\n\nuuflowManager.cancelProcessDelegation = function(spaceId, toId) {\n  var ccQuery, query;\n  query = {\n    space: spaceId,\n    inbox_users: toId\n  };\n  query.traces = {\n    $elemMatch: {\n      is_finished: false,\n      approves: {\n        $elemMatch: {\n          is_finished: false,\n          agent: toId\n        }\n      }\n    }\n  };\n  db.instances.find(query, {\n    fields: {\n      inbox_users: 1,\n      traces: 1,\n      state: 1\n    }\n  }).forEach(function(ins) {\n    var trace;\n    trace = _.find(ins.traces, function(t) {\n      return t.is_finished === false;\n    });\n    return _.each(trace.approves, function(a, idx) {\n      var idxStr, next_step_space_user, next_step_user_org_info, setObj;\n      if (a.is_finished === false) {\n        if (a.agent === toId) {\n          next_step_space_user = uuflowManager.getSpaceUser(spaceId, a.user);\n          next_step_user_org_info = uuflowManager.getSpaceUserOrgInfo(next_step_space_user);\n          idxStr = \"traces.$.approves.\" + idx + \".\";\n          setObj = {};\n          setObj[idxStr + 'handler'] = a.user;\n          setObj[idxStr + 'handler_name'] = a.user_name;\n          setObj[idxStr + 'handler_organization'] = next_step_user_org_info[\"organization\"];\n          setObj[idxStr + 'handler_organization_name'] = next_step_user_org_info[\"organization_name\"];\n          setObj[idxStr + 'handler_organization_fullname'] = next_step_user_org_info[\"organization_fullname\"];\n          setObj[idxStr + 'agent'] = null;\n          ins.inbox_users.splice(ins.inbox_users.indexOf(toId), 1, a.user);\n          setObj.inbox_users = ins.inbox_users;\n          if (ins.state === 'draft') {\n            setObj.submitter = a.user;\n            setObj.submitter_name = a.user_name;\n          }\n          db.instances.update({\n            _id: ins._id,\n            inbox_users: toId,\n            'traces._id': a.trace\n          }, {\n            $set: setObj\n          });\n          pushManager.send_message_to_specifyUser('current_user', a.user);\n          return pushManager.send_message_to_specifyUser('current_user', toId);\n        } else if (a.user === toId) {\n          return db.instances.update({\n            _id: ins._id\n          }, {\n            $addToSet: {\n              inbox_users: toId\n            }\n          });\n        }\n      }\n    });\n  });\n  ccQuery = {\n    space: spaceId,\n    cc_users: toId\n  };\n  ccQuery['traces.approves'] = {\n    $elemMatch: {\n      is_finished: false,\n      agent: toId,\n      type: 'cc'\n    }\n  };\n  return db.instances.find(ccQuery, {\n    fields: {\n      cc_users: 1,\n      traces: 1\n    }\n  }).forEach(function(ins) {\n    return _.each(ins.traces, function(t) {\n      return _.each(t.approves, function(a, idx) {\n        var idxStr, next_step_space_user, next_step_user_org_info, setObj;\n        if (a.is_finished === false && a.type === 'cc') {\n          if (a.agent === toId) {\n            next_step_space_user = uuflowManager.getSpaceUser(spaceId, a.user);\n            next_step_user_org_info = uuflowManager.getSpaceUserOrgInfo(next_step_space_user);\n            idxStr = \"traces.$.approves.\" + idx + \".\";\n            setObj = {};\n            setObj[idxStr + 'handler'] = a.user;\n            setObj[idxStr + 'handler_name'] = a.user_name;\n            setObj[idxStr + 'handler_organization'] = next_step_user_org_info[\"organization\"];\n            setObj[idxStr + 'handler_organization_name'] = next_step_user_org_info[\"organization_name\"];\n            setObj[idxStr + 'handler_organization_fullname'] = next_step_user_org_info[\"organization_fullname\"];\n            setObj[idxStr + 'agent'] = null;\n            ins.cc_users.splice(ins.cc_users.indexOf(toId), 1, a.user);\n            setObj.cc_users = ins.cc_users;\n            db.instances.update({\n              _id: ins._id,\n              cc_users: toId,\n              'traces._id': a.trace\n            }, {\n              $set: setObj\n            });\n            pushManager.send_message_to_specifyUser('current_user', a.user);\n            return pushManager.send_message_to_specifyUser('current_user', toId);\n          } else if (a.user === toId) {\n            return db.instances.update({\n              _id: ins._id\n            }, {\n              $addToSet: {\n                cc_users: toId\n              }\n            });\n          }\n        }\n      });\n    });\n  });\n};\n\nuuflowManager.timeoutAutoSubmit = function(ins_id) {\n  var query;\n  query = {};\n  if (ins_id) {\n    check(ins_id, String);\n    query._id = ins_id;\n  }\n  query.state = 'pending';\n  query.current_step_auto_submit = true;\n  query.traces = {\n    $elemMatch: {\n      is_finished: false,\n      due_date: {\n        $lte: new Date\n      }\n    }\n  };\n  db.instances.find(query).forEach(function(ins) {\n    var approve_from_client, e, flow, flow_id, instance_id, judge, nextStep, nextStepId, nextSteps, nextUserIds, step, step_type, toLine, trace;\n    try {\n      flow_id = ins.flow;\n      instance_id = ins._id;\n      trace = _.last(ins.traces);\n      flow = uuflowManager.getFlow(flow_id);\n      step = uuflowManager.getStep(ins, flow, trace.step);\n      step_type = step.step_type;\n      toLine = _.find(step.lines, function(l) {\n        return l.timeout_line === true;\n      });\n      nextStepId = toLine.to_step;\n      nextStep = uuflowManager.getStep(ins, flow, nextStepId);\n      if (nextStep.step_type === 'condition') {\n        nextSteps = uuflowManager.getNextSteps(ins, flow, nextStep, \"\");\n        console.error(nextSteps);\n        nextStepId = nextSteps[0];\n      }\n      nextUserIds = getHandlersManager.getHandlers(instance_id, nextStepId);\n      judge = \"submitted\";\n      if (step_type === \"sign\") {\n        judge = \"approved\";\n      }\n      approve_from_client = {\n        'instance': instance_id,\n        'trace': trace._id,\n        'judge': judge,\n        'next_steps': [\n          {\n            'step': nextStepId,\n            'users': nextUserIds\n          }\n        ]\n      };\n      return _.each(trace.approves, function(a) {\n        var current_user_info, updatedInstance;\n        approve_from_client._id = a._id;\n        current_user_info = db.users.findOne(a.handler, {\n          services: 0\n        });\n        updatedInstance = uuflowManager.workflow_engine(approve_from_client, current_user_info, current_user_info._id, true);\n        return pushManager.send_instance_notification(\"auto_submit_pending_inbox\", updatedInstance, \"\", current_user_info);\n      });\n    } catch (error) {\n      e = error;\n      console.error('AUTO TIMEOUT_AUTO_SUBMIT ERROR: ');\n      return console.error(e.stack);\n    }\n  });\n  return true;\n};\n\n\n/* 申请单重定位\ninstance_from_client: {\n\t_id: 申请单_id,\n\trelocate_inbox_users: 新处理人,\n\trelocate_comment: 备注,\n\trelocate_next_step: 新步骤\n}\ncurrent_user_info: User记录\n */\n\nuuflowManager.relocate = function(instance_from_client, current_user_info) {\n  var _users, ah, approve_users, current_setp, current_setp_type, current_space_user, current_user, current_user_organization, flow, h, i, inbox_users, ins, instance, instance_id, l, last_trace, newTrace, new_inbox_users, next_step, next_step_name, next_step_type, not_in_inbox_users, now, permissions, r, relocate_appr, relocate_comment, relocate_inbox_users, relocate_next_step, sameTraces, setObj, signShowApproveId, space, space_id, ta, ti, traces;\n  current_user = current_user_info._id;\n  instance = uuflowManager.getInstance(instance_from_client[\"_id\"]);\n  last_trace = _.last(instance.traces);\n  permissions = permissionManager.getFlowPermissions(instance.flow, current_user);\n  space = db.spaces.findOne(instance.space, {\n    fields: {\n      admins: 1\n    }\n  });\n  if ((!permissions.includes(\"admin\")) && (!space.admins.includes(current_user))) {\n    throw new Meteor.Error('error!', \"用户没有对当前流程的管理权限\");\n  }\n  space_id = instance.space;\n  instance_id = last_trace.instance;\n  inbox_users = instance.inbox_users;\n  relocate_inbox_users = instance_from_client[\"relocate_inbox_users\"];\n  relocate_comment = instance_from_client[\"relocate_comment\"];\n  relocate_next_step = instance_from_client[\"relocate_next_step\"];\n  not_in_inbox_users = _.difference(inbox_users, relocate_inbox_users);\n  new_inbox_users = _.difference(relocate_inbox_users, inbox_users);\n  approve_users = [];\n  flow = uuflowManager.getFlow(instance.flow);\n  next_step = uuflowManager.getStep(instance, flow, relocate_next_step);\n  next_step_type = next_step.step_type;\n  next_step_name = next_step.name;\n  current_setp = uuflowManager.getStep(instance, flow, last_trace.step);\n  current_setp_type = current_setp.step_type;\n  traces = instance.traces;\n  setObj = new Object;\n  setObj.values = uuflowManager.getUpdatedValues(instance);\n  now = new Date;\n  i = 0;\n  while (i < traces.length) {\n    if (traces[i]._id === last_trace._id) {\n      if (!traces[i].approves) {\n        traces[i].approves = new Array;\n      }\n      h = 0;\n      while (h < traces[i].approves.length) {\n        if (traces[i].approves[h].is_finished === false && traces[i].approves[h].type !== \"cc\" && traces[i].approves[h].type !== \"distribute\") {\n          traces[i].approves[h].start_date = now;\n          traces[i].approves[h].finish_date = now;\n          traces[i].approves[h].read_date = now;\n          traces[i].approves[h].is_error = false;\n          traces[i].approves[h].is_read = true;\n          traces[i].approves[h].is_finished = true;\n          traces[i].approves[h].judge = \"terminated\";\n          traces[i].approves[h].cost_time = traces[i].approves[h].finish_date - traces[i].approves[h].start_date;\n          approve_users.push(traces[i].approves[h].user);\n          if (traces[i].approves[h].sign_show === true) {\n            ta = traces[i].approves[h];\n            sameTraces = _.filter(traces, function(t) {\n              return t.step === traces[i].step;\n            });\n            l = sameTraces.length - 1;\n            signShowApproveId = null;\n            while (l > -1) {\n              _.each(sameTraces[l].approves, function(a) {\n                if (a.user === ta.user && a.judge !== \"terminated\" && a.description && !signShowApproveId) {\n                  return signShowApproveId = a._id;\n                }\n              });\n              l--;\n            }\n            if (signShowApproveId) {\n              ti = 0;\n              while (ti < traces.length) {\n                ah = 0;\n                while (ah < traces[ti].approves.length) {\n                  if (traces[ti].approves[ah]._id === signShowApproveId) {\n                    traces[ti].approves[ah].sign_show = true;\n                    traces[i].approves[h].sign_show = false;\n                  }\n                  ah++;\n                }\n                ti++;\n              }\n            }\n          }\n        }\n        h++;\n      }\n      current_space_user = uuflowManager.getSpaceUser(space_id, current_user);\n      current_user_organization = db.organizations.findOne(current_space_user.organization, {\n        fields: {\n          name: 1,\n          fullname: 1\n        }\n      });\n      relocate_appr = new Object;\n      relocate_appr._id = new Mongo.ObjectID()._str;\n      relocate_appr.instance = instance_id;\n      relocate_appr.trace = traces[i]._id;\n      relocate_appr.is_finished = true;\n      relocate_appr.user = current_user;\n      relocate_appr.user_name = current_user_info.name;\n      relocate_appr.handler = current_user;\n      relocate_appr.handler_name = current_user_info.name;\n      relocate_appr.handler_organization = current_space_user.organization;\n      relocate_appr.handler_organization_name = current_user_organization.name;\n      relocate_appr.handler_organization_fullname = current_user_organization.fullname;\n      relocate_appr.start_date = now;\n      relocate_appr.finish_date = now;\n      relocate_appr.due_date = traces[i].due_date;\n      relocate_appr.read_date = now;\n      relocate_appr.judge = \"relocated\";\n      relocate_appr.is_read = true;\n      relocate_appr.description = relocate_comment;\n      relocate_appr.is_error = false;\n      relocate_appr.values = new Object;\n      relocate_appr.cost_time = relocate_appr.finish_date - relocate_appr.start_date;\n      traces[i].approves.push(relocate_appr);\n      traces[i].is_finished = true;\n      traces[i].finish_date = now;\n      traces[i].judge = \"relocated\";\n    }\n    i++;\n  }\n  if (next_step_type === \"end\") {\n    newTrace = new Object;\n    newTrace._id = new Mongo.ObjectID()._str;\n    newTrace.instance = instance_id;\n    newTrace.previous_trace_ids = [last_trace._id];\n    newTrace.is_finished = true;\n    newTrace.step = relocate_next_step;\n    newTrace.name = next_step_name;\n    newTrace.start_date = now;\n    newTrace.finish_date = now;\n    newTrace.approves = [];\n    setObj.state = \"completed\";\n    setObj.inbox_users = [];\n    setObj.final_decision = \"terminated\";\n    setObj.finish_date = new Date;\n    setObj.current_step_name = next_step_name;\n    setObj.current_step_auto_submit = false;\n  } else {\n    newTrace = new Object;\n    newTrace._id = new Mongo.ObjectID()._str;\n    newTrace.instance = instance_id;\n    newTrace.previous_trace_ids = [last_trace._id];\n    newTrace.is_finished = false;\n    newTrace.step = relocate_next_step;\n    newTrace.name = next_step_name;\n    newTrace.start_date = now;\n    newTrace.due_date = uuflowManager.getDueDate(next_step.timeout_hours, space_id);\n    newTrace.approves = [];\n    _.each(relocate_inbox_users, function(next_step_user_id, idx) {\n      var agent, handler_id, handler_info, newApprove, next_step_space_user, next_step_user_org_info, user_info;\n      newApprove = new Object;\n      newApprove._id = new Mongo.ObjectID()._str;\n      newApprove.instance = instance_id;\n      newApprove.trace = newTrace._id;\n      newApprove.is_finished = false;\n      newApprove.user = next_step_user_id;\n      user_info = db.users.findOne(next_step_user_id, {\n        fields: {\n          name: 1\n        }\n      });\n      newApprove.user_name = user_info.name;\n      handler_id = next_step_user_id;\n      handler_info = user_info;\n      agent = uuflowManager.getAgent(space_id, next_step_user_id);\n      if (agent) {\n        relocate_inbox_users[idx] = agent;\n        handler_id = agent;\n        handler_info = db.users.findOne({\n          _id: agent\n        }, {\n          fields: {\n            name: 1\n          }\n        });\n        newApprove.agent = agent;\n      }\n      newApprove.handler = handler_id;\n      newApprove.handler_name = handler_info.name;\n      next_step_space_user = uuflowManager.getSpaceUser(space_id, handler_id);\n      next_step_user_org_info = uuflowManager.getSpaceUserOrgInfo(next_step_space_user);\n      newApprove.handler_organization = next_step_user_org_info[\"organization\"];\n      newApprove.handler_organization_name = next_step_user_org_info[\"organization_name\"];\n      newApprove.handler_organization_fullname = next_step_user_org_info[\"organization_fullname\"];\n      newApprove.start_date = now;\n      newApprove.due_date = newTrace.due_date;\n      newApprove.is_read = false;\n      newApprove.is_error = false;\n      newApprove.values = new Object;\n      uuflowManager.setRemindInfo(instance.values, newApprove);\n      return newTrace.approves.push(newApprove);\n    });\n    setObj.inbox_users = relocate_inbox_users;\n    setObj.state = \"pending\";\n    setObj.current_step_name = next_step_name;\n    setObj.current_step_auto_submit = uuflowManager.getCurrentStepAutoSubmit(flow.timeout_auto_submit, next_step.lines);\n  }\n  instance.outbox_users.push(current_user);\n  instance.outbox_users = instance.outbox_users.concat(inbox_users).concat(approve_users);\n  setObj.outbox_users = _.uniq(instance.outbox_users);\n  setObj.modified = now;\n  setObj.modified_by = current_user;\n  setObj.is_archived = false;\n  traces.push(newTrace);\n  setObj.traces = traces;\n  if (setObj.state === 'completed') {\n    r = db.instances.update({\n      _id: instance_id\n    }, {\n      $set: setObj\n    });\n  } else {\n    r = db.instances.update({\n      _id: instance_id\n    }, {\n      $set: setObj,\n      $unset: {\n        finish_date: 1\n      }\n    });\n  }\n  if (r) {\n    ins = uuflowManager.getInstance(instance_id);\n    pushManager.send_message_current_user(current_user_info);\n    _.each(not_in_inbox_users, function(user_id) {\n      if (user_id !== current_user) {\n        return pushManager.send_message_to_specifyUser(\"current_user\", user_id);\n      }\n    });\n    _users = new Array;\n    _users.push(ins.applicant);\n    _users.push(ins.submitter);\n    _users = _.uniq(_users.concat(ins.outbox_users));\n    _.each(_users, function(user_id) {\n      return pushManager.send_message_to_specifyUser(\"current_user\", user_id);\n    });\n    pushManager.send_instance_notification(\"reassign_new_inbox_users\", ins, relocate_comment, current_user_info);\n    return pushManager.triggerWebhook(ins.flow, ins, {}, 'relocate', current_user, ins.inbox_users);\n  }\n};\n\nuuflowManager.draft_save_instance = function(ins, userId) {\n  var applicant, applicant_id, approve_id, current_trace, current_user, description, flow, flow_id, form, form_id, index, ins_id, instance, key_str, lang, name_forumla, next_steps, org_id, organization, result, setObj, space_id, start_step, trace_id, traces, user, values;\n  result = true;\n  setObj = {};\n  index = 0;\n  ins_id = ins._id;\n  trace_id = ins.traces[0]._id;\n  approve_id = ins.traces[0].approves[0]._id;\n  description = ins.traces[0].approves[0].description;\n  next_steps = ins.traces[0].approves[0].next_steps;\n  values = ins.traces[0].approves[0].values || {};\n  applicant_id = ins.applicant;\n  instance = db.instances.findOne(ins_id, {\n    fields: {\n      applicant: 1,\n      state: 1,\n      submitter: 1,\n      traces: 1,\n      form: 1,\n      flow_version: 1,\n      space: 1,\n      flow: 1\n    }\n  });\n  space_id = instance.space;\n  flow_id = instance.flow;\n  form_id = instance.form;\n  traces = instance.traces;\n  current_trace = _.find(traces, function(t) {\n    return t._id === trace_id;\n  });\n  current_trace.approves.forEach(function(a, idx) {\n    if (a._id === approve_id) {\n      index = idx;\n    }\n  });\n  key_str = 'traces.$.approves.' + index + '.';\n  current_user = db.users.findOne({\n    _id: userId\n  }, {\n    fields: {\n      locale: 1\n    }\n  });\n  lang = current_user.locale === 'zh-cn' ? 'zh-CN' : 'en';\n  uuflowManager.isInstanceDraft(instance, lang);\n  uuflowManager.isInstanceSubmitter(instance, userId);\n  flow = db.flows.findOne(flow_id, {\n    fields: {\n      'current._id': 1,\n      'current.form_version': 1,\n      'name': 1,\n      'current.steps': 1\n    }\n  });\n  setObj.modified = new Date;\n  setObj.modified_by = userId;\n  if (flow.current._id !== instance.flow_version) {\n    result = 'upgraded';\n    start_step = _.find(flow.current.steps, function(s) {\n      return s.step_type === 'start';\n    });\n    setObj.flow_version = flow.current._id;\n    setObj.form_version = flow.current.form_version;\n    setObj['traces.$.step'] = start_step._id;\n    setObj['traces.$.name'] = start_step.name;\n  }\n  if (instance.applicant !== applicant_id) {\n    user = db.users.findOne(applicant_id, {\n      fields: {\n        name: 1\n      }\n    });\n    applicant = db.space_users.find({\n      space: space_id,\n      user: applicant_id\n    }, {\n      fields: {\n        organization: 1\n      }\n    });\n    org_id = applicant.fetch()[0].organization;\n    organization = db.organizations.findOne(org_id, {\n      fields: {\n        name: 1,\n        fullname: 1\n      }\n    });\n    setObj.applicant = applicant_id;\n    setObj.applicant_name = user.name;\n    setObj.applicant_organization = org_id;\n    setObj.applicant_organization_name = organization.name;\n    setObj.applicant_organization_fullname = organization.fullname;\n    setObj[key_str + 'user'] = applicant_id;\n    setObj[key_str + 'user_name'] = user.name;\n  }\n  setObj[key_str + 'values'] = values;\n  setObj[key_str + 'description'] = description;\n  setObj[key_str + 'judge'] = 'submitted';\n  setObj[key_str + 'read_date'] = new Date;\n  if (result !== 'upgraded' && next_steps) {\n    setObj[key_str + 'next_steps'] = next_steps;\n  }\n  form = db.forms.findOne({\n    _id: form_id\n  }, {\n    fields: {\n      'current.name_forumla': 1\n    }\n  });\n  name_forumla = form.current.name_forumla;\n  if (name_forumla) {\n    setObj.name = uuflowManager.getInstanceName(ins, values);\n  }\n  db.instances.update({\n    _id: ins_id,\n    'traces._id': trace_id\n  }, {\n    $set: setObj\n  });\n  return result;\n};\n","pushManager = {\n\tbqq_app_id: \"200626779\",\n\timo_app_cid: Meteor.settings.imo?.appcid,\n\timo_app_uid: Meteor.settings.imo?.appuid,\n\timo_sync_app_key: Meteor.settings.imo?.sync_app_key,\n\timo_push_app_key: Meteor.settings.imo?.push_app_key\n}\n\npushManager.get_to_users = (send_from, instance, cc_user_ids, current_user_info) ->\n\tto_users = new Array\n\tif ['first_submit_applicant'].includes(send_from)\n\t\t# 申请人\n\t\tif instance.applicant isnt instance.submitter\n\t\t\tapplicant = db.users.findOne(instance.applicant)\n\t\t\tto_users.push(applicant)\n\n\telse if ['submit_terminate_approve', 'submit_completed_approve', 'submit_pending_rejected_approve','approved_completed_approve', 'rejected_completed_approve'].includes(send_from)\n\t\t# 已审批人\n\t\t# 获得已审批的人(去掉重复及申请人、提交人)\n\t\tremove_users = new Array\n\t\tremove_users.push(instance.applicant)\n\t\tremove_users.push(instance.submitter)\n\n\t\tapprove_user_ids = _.difference(instance.outbox_users, remove_users)\n\t\tto_users = db.users.find({ _id: { $in: approve_user_ids } }).fetch()\n\telse if ['reassign_new_inbox_users', 'submit_pending_rejected_inbox', 'submit_pending_inbox', 'first_submit_inbox', 'return_pending_inbox'].includes(send_from)\n\t\t# 待审批人\n\t\tto_users = db.users.find({ _id: { $in: instance.inbox_users } }).fetch()\n\telse if ['submit_completed_applicant', 'approved_completed_applicant', 'rejected_completed_applicant', 'monitor_delete_applicant', 'submit_terminate_applicant', 'submit_pending_rejected_applicant', 'submit_pending_rejected_applicant_inbox'].includes(send_from)\n\t\tapplicant = db.users.findOne(instance.applicant)\n\t\tto_users.push(applicant)\n\telse if ['trace_approve_cc'].includes(send_from) && cc_user_ids\n\t\tto_users = db.users.find({ _id: { $in: cc_user_ids } }).fetch()\n\telse if ['trace_approve_cc_submit'].includes(send_from) && cc_user_ids\n\t\tto_users = db.users.find({ _id: { $in: cc_user_ids } }).fetch()\n\telse if ['auto_submit_pending_inbox'].includes(send_from)\n\t\tto_users = [current_user_info]\n\n\treturn to_users\n\npushManager.get_body = (parameters, lang = \"zh-CN\") ->\n\tsend_from = parameters[\"send_from\"]\n\tapplicant_name = parameters[\"applicant_name\"]\n\tinstance_name = parameters[\"instance_name\"]\n\tto_username = parameters[\"to_username\"]\n\thref = parameters[\"href\"]\n\tfinal_decision = parameters[\"final_decision\"]\n\tdescription = parameters[\"description\"]\n\tstate = parameters[\"state\"]\n\tfrom_username = parameters[\"from_username\"]\n\tcurrent_step_name = parameters[\"current_step_name\"]\n\tnextApprove_usersname = parameters[\"nextApprove_usersname\"]\n\tnextStep_type = parameters[\"nextStep_type\"]\n\tapproves_description = parameters[\"approves_description\"]\n\tlastApprove_judge = parameters[\"lastApprove_judge\"]\n\tlastApprove_usersname = parameters[\"lastApprove_usersname\"]\n\tcurrent_user_name = parameters[\"current_user_name\"]\n\tcurrentStep_type = parameters[\"currentStep_type\"]\n\n\tpush_final_decision = \"\"\n\temail_final_decision = \"\"\n\temail_description = \"\"\n\n\tif not final_decision\n\t\tpush_final_decision = TAPi18n.__ 'instance.push.final_decision_nil', {}, lang\n\t\temail_final_decision = TAPi18n.__ 'instance.email.final_decision_nil', {}, lang\n\telse\n\t\tif \"approved\" is final_decision\n\t\t\tpush_final_decision = TAPi18n.__ 'instance.push.final_decision_approved', {}, lang\n\t\t\temail_final_decision = TAPi18n.__ 'instance.email.final_decision_approved', {}, lang\n\t\telse if \"rejected\" is final_decision\n\t\t\tpush_final_decision = TAPi18n.__ 'instance.push.final_decision_rejected', {}, lang\n\t\t\temail_final_decision = TAPi18n.__ 'instance.email.final_decision_rejected', {}, lang\n\t\t\temail_description = TAPi18n.__ 'instance.email.body.email_description', {description: description}, lang\n\t\telse\n\t\t\tpush_final_decision = TAPi18n.__ 'instance.push.final_decision_nil', {}, lang\n\t\t\temail_final_decision = TAPi18n.__ 'instance.email.final_decision_nil', {}, lang\n\n\temail_approve_type = null\n\turl_approve_type = null\n\tpush_approve_type = null\n\n\tif ['submit', 'start'].includes(nextStep_type)\n\t\temail_approve_type = TAPi18n.__ 'instance.email.body.input', {}, lang\n\t\turl_approve_type = TAPi18n.__ 'instance.email.body.url_input', {}, lang\n\t\tpush_approve_type = TAPi18n.__ 'instance.push.body.input', {}, lang\n\telse if ['sign', 'counterSign'].includes(nextStep_type)\n\t\temail_approve_type = TAPi18n.__ 'instance.email.body.approval', {}, lang\n\t\turl_approve_type = TAPi18n.__ 'instance.email.body.url_approval', {}, lang\n\t\tpush_approve_type = TAPi18n.__ 'instance.push.body.approval', {}, lang\n\n\tlast_approve_judge = null\n\tif \"submitted\" is lastApprove_judge\n\t\tlast_approve_judge = TAPi18n.__ 'instance.email.body.judge_submitted', {}, lang\n\telse if \"approved\" is lastApprove_judge\n\t\tlast_approve_judge = TAPi18n.__ 'instance.email.body.judge_approved', {}, lang\n\n\tbody = new Object\n\tif \"first_submit_applicant\" is send_from\n\t\tbody[\"push\"] = TAPi18n.__ 'instance.push.body.first_submit_applicant', {instance_name: instance_name,from_username: from_username,applicant_name: applicant_name,final_decision: push_final_decision}, lang\n\n\t\tif not approves_description\n\t\t\tbody[\"email\"] = TAPi18n.__ 'instance.email.body.first_submit_applicant', {instance_name: instance_name,to_username: to_username,href: href,applicant_name: applicant_name,final_decision: email_final_decision,description: email_description}, lang\n\t\telse\n\t\t\tbody[\"email\"] = TAPi18n.__ 'instance.email.body.first_submit_applicant_beApproveDescription', {instance_name: instance_name,to_username: to_username,href: href,applicant_name: applicant_name,final_decision: email_final_decision,description: email_description,approves_description: approves_description}, lang\n\n\telse if \"first_submit_inbox\" is send_from\n\t\tbody[\"push\"] = TAPi18n.__ 'instance.push.body.first_submit_inbox', {instance_name: instance_name,from_username: from_username,applicant_name: applicant_name,final_decision: push_final_decision,approve_type: push_approve_type}, lang\n\n\t\tif not approves_description\n\t\t\tbody[\"email\"] = TAPi18n.__ 'instance.email.body.first_submit_inbox', {instance_name: instance_name,to_username: to_username,href: href,applicant_name: applicant_name,final_decision: email_final_decision,description: email_description,approve_type: email_approve_type,url_approve_type: url_approve_type}, lang\n\t\telse\n\t\t\tbody[\"email\"] = TAPi18n.__ 'instance.email.body.first_submit_inbox_beApproveDescription', {instance_name: instance_name,to_username: to_username,href: href,applicant_name: applicant_name,final_decision: email_final_decision,description: email_description,approve_type: email_approve_type,url_approve_type: url_approve_type,approves_description: approves_description}, lang\n\n\telse if \"submit_completed_applicant\" is send_from\n\t\tbody[\"push\"] = TAPi18n.__ 'instance.push.body.submit_completed_applicant', {instance_name: instance_name,from_username: from_username,applicant_name: applicant_name,final_decision: push_final_decision}, lang\n\t\tif not approves_description\n\t\t\tbody[\"email\"] = TAPi18n.__ 'instance.email.body.submit_completed_applicant', {instance_name: instance_name,to_username: to_username, current_username: current_user_name, href: href,applicant_name: applicant_name,final_decision: email_final_decision,description: email_description,lastApprove_usersname: lastApprove_usersname}, lang\n\t\telse\n\t\t\tif currentStep_type == \"counterSign\"\n\t\t\t\tbody[\"email\"] = TAPi18n.__('instance.email.body.submit_completed_applicant_beApproveDescription_counterSign', {instance_name: instance_name,to_username: to_username, current_username: current_user_name,applicant_name: applicant_name,final_decision: email_final_decision,description: email_description,lastApprove_usersname: lastApprove_usersname}, lang) + approves_description + TAPi18n.__('help.href', {href: href}, lang)\n\t\t\telse\n\t\t\t\tbody[\"email\"] = TAPi18n.__ 'instance.email.body.submit_completed_applicant_beApproveDescription', {instance_name: instance_name,to_username: to_username, current_username: current_user_name, href: href,applicant_name: applicant_name,final_decision: email_final_decision,description: email_description,lastApprove_usersname: lastApprove_usersname,approves_description: approves_description}, lang\n\n\telse if \"submit_completed_approve\" is send_from\n\t\tbody[\"push\"] = TAPi18n.__ 'instance.push.body.submit_completed_approve', {instance_name: instance_name,from_username: from_username,applicant_name: applicant_name,final_decision: push_final_decision}, lang\n\t\tbody[\"email\"] = TAPi18n.__ 'instance.email.body.submit_completed_approve', {instance_name: instance_name,to_username: to_username, current_username: current_user_name, href: href,applicant_name: applicant_name,final_decision: email_final_decision,description: email_description}, lang\n\telse if \"submit_pending_rejected_applicant_inbox\" is send_from\n\t\tbody[\"push\"] = TAPi18n.__ 'instance.push.body.submit_pending_rejected_applicant_inbox', {instance_name: instance_name,from_username: from_username,applicant_name: applicant_name,final_decision: push_final_decision,description: description}, lang\n\t\tbody[\"email\"] = TAPi18n.__ 'instance.email.body.submit_pending_rejected_applicant_inbox', {instance_name: instance_name,to_username: to_username, current_username: current_user_name, href: href,applicant_name: applicant_name,final_decision: email_final_decision,description: email_description,lastApprove_usersname: lastApprove_usersname}, lang\n\telse if \"submit_pending_rejected_applicant\" is send_from\n\t\tbody[\"push\"] = TAPi18n.__ 'instance.push.body.submit_pending_rejected_applicant', {instance_name: instance_name,from_username: from_username,applicant_name: applicant_name,final_decision: push_final_decision,description: description,nextApprove_usersname: nextApprove_usersname}, lang\n\t\tbody[\"email\"] = TAPi18n.__ 'instance.email.body.submit_pending_rejected_applicant', {instance_name: instance_name,to_username: to_username, current_username: current_user_name, href: href,applicant_name: applicant_name,final_decision: email_final_decision,description: email_description,lastApprove_usersname: lastApprove_usersname,nextApprove_usersname: nextApprove_usersname}, lang\n\telse if \"submit_pending_rejected_approve\" is send_from\n\t\tbody[\"push\"] = TAPi18n.__ 'instance.push.body.submit_pending_rejected_approve', {instance_name: instance_name,from_username: from_username,applicant_name: applicant_name,final_decision: push_final_decision,description: description,current_user: current_user_name,nextApprove_usersname: nextApprove_usersname,current_step_name: current_step_name}, lang\n\t\tbody[\"email\"] = TAPi18n.__ 'instance.email.body.submit_pending_rejected_approve', {instance_name: instance_name,to_username: to_username, current_username: current_user_name, href: href,applicant_name: applicant_name,final_decision: email_final_decision,description: email_description}, lang\n\telse if \"submit_pending_rejected_inbox\" is send_from\n\t\tbody[\"push\"] = TAPi18n.__ 'instance.push.body.submit_pending_rejected_inbox', {instance_name: instance_name,from_username: from_username,applicant_name: applicant_name,final_decision: push_final_decision,approve_type: push_approve_type}, lang\n\t\tbody[\"email\"] = TAPi18n.__ 'instance.email.body.submit_pending_rejected_inbox', {instance_name: instance_name,to_username: to_username,href: href,applicant_name: applicant_name,final_decision: email_final_decision,description: email_description,approve_type: email_approve_type,url_approve_type: url_approve_type,lastApprove_usersname: lastApprove_usersname}, lang\n\telse if \"submit_pending_inbox\" is send_from\n\t\tbody[\"push\"] = TAPi18n.__ 'instance.push.body.submit_pending_inbox', {instance_name: instance_name,from_username: from_username,applicant_name: applicant_name,final_decision: push_final_decision,approve_type: push_approve_type}, lang\n\n\t\tif not approves_description\n\t\t\tbody[\"email\"] = TAPi18n.__ 'instance.email.body.submit_pending_inbox', {instance_name: instance_name,to_username: to_username,href: href,applicant_name: applicant_name,final_decision: email_final_decision,description: email_description,approve_type: email_approve_type,url_approve_type: url_approve_type,lastApprove_usersname: lastApprove_usersname, last_approve_judge: last_approve_judge}, lang\n\t\telse\n\t\t\tif currentStep_type == \"counterSign\"\n\t\t\t\tbody[\"email\"] = TAPi18n.__('instance.email.body.submit_pending_inbox_beApproveDescription_counterSign', {instance_name: instance_name,to_username: to_username,applicant_name: applicant_name,final_decision: email_final_decision,description: email_description,approve_type: email_approve_type,url_approve_type: url_approve_type,lastApprove_usersname: lastApprove_usersname, last_approve_judge: last_approve_judge}, lang) + approves_description + TAPi18n.__('help.href', {href: href}, lang)\n\t\t\telse\n\t\t\t\tbody[\"email\"] = TAPi18n.__ 'instance.email.body.submit_pending_inbox_beApproveDescription', {instance_name: instance_name,to_username: to_username,href: href,applicant_name: applicant_name,final_decision: email_final_decision,description: email_description,approve_type: email_approve_type,url_approve_type: url_approve_type,lastApprove_usersname: lastApprove_usersname, last_approve_judge: last_approve_judge,approves_description: approves_description}, lang\n\n\telse if \"submit_terminate_applicant\" is send_from\n\t\tbody[\"push\"] = TAPi18n.__ 'instance.push.body.submit_terminate_applicant', {instance_name: instance_name,from_username: from_username,applicant_name: applicant_name,final_decision: push_final_decision}, lang\n\t\tbody[\"email\"] = TAPi18n.__ 'instance.email.body.submit_terminate_applicant', {instance_name: instance_name,to_username: to_username, current_username: current_user_name, href: href,applicant_name: applicant_name,final_decision: email_final_decision,description: description}, lang\n\telse if \"submit_terminate_approve\" is send_from\n\t\tbody[\"push\"] = TAPi18n.__ 'instance.push.body.submit_terminate_approve', {instance_name: instance_name,from_username: from_username,applicant_name: applicant_name,final_decision: push_final_decision}, lang\n\t\tbody[\"email\"] = TAPi18n.__ 'instance.email.body.submit_terminate_approve', {instance_name: instance_name,to_username: to_username, current_username: current_user_name, href: href,applicant_name: applicant_name,final_decision: email_final_decision,description: description}, lang\n\telse if \"monitor_delete_applicant\" is send_from\n\t\tbody[\"push\"] = TAPi18n.__ 'instance.push.body.monitor_delete_applicant', {instance_name: instance_name,from_username: from_username,applicant_name: applicant_name,final_decision: push_final_decision}, lang\n\t\tbody[\"email\"] = TAPi18n.__ 'instance.email.body.monitor_delete_applicant', {instance_name: instance_name,to_username: to_username, current_username: current_user_name, href: href,applicant_name: applicant_name,final_decision: email_final_decision,description: email_description}, lang\n\telse if \"approved_completed_applicant\" is send_from\n\t\tbody[\"push\"] = TAPi18n.__ 'instance.push.body.approved_completed_applicant', {instance_name: instance_name,from_username: from_username,applicant_name: applicant_name,final_decision: push_final_decision}, lang\n\n\t\tif not approves_description\n\t\t\tbody[\"email\"] = TAPi18n.__ 'instance.email.body.approved_completed_applicant', {instance_name: instance_name,to_username: to_username, current_username: current_user_name, href: href,applicant_name: applicant_name,final_decision: email_final_decision,description: email_description,lastApprove_usersname: lastApprove_usersname}, lang\n\t\telse\n\t\t\tbody[\"email\"] = TAPi18n.__ 'instance.email.body.approved_completed_applicant_beApproveDescription', {instance_name: instance_name,to_username: to_username, current_username: current_user_name, href: href,applicant_name: applicant_name,final_decision: email_final_decision,description: email_description,lastApprove_usersname: lastApprove_usersname,approves_description: approves_description}, lang\n\n\telse if \"approved_completed_approve\" is send_from\n\t\tbody[\"push\"] = TAPi18n.__ 'instance.push.body.approved_completed_approve', {instance_name: instance_name,from_username: from_username,applicant_name: applicant_name,final_decision: push_final_decision}, lang\n\t\tbody[\"email\"] = TAPi18n.__ 'instance.email.body.approved_completed_approve', {instance_name: instance_name,to_username: to_username, current_username: current_user_name, href: href,applicant_name: applicant_name,final_decision: email_final_decision,description: email_description}, lang\n\telse if \"rejected_completed_applicant\" is send_from\n\t\tbody[\"push\"] = TAPi18n.__ 'instance.push.body.rejected_completed_applicant', {instance_name: instance_name,from_username: from_username,applicant_name: applicant_name,final_decision: push_final_decision,description: description}, lang\n\t\tbody[\"email\"] = TAPi18n.__ 'instance.email.body.rejected_completed_applicant', {instance_name: instance_name,to_username: to_username, current_username: current_user_name, href: href,applicant_name: applicant_name,final_decision: email_final_decision,description: email_description,lastApprove_usersname: lastApprove_usersname}, lang\n\telse if \"rejected_completed_approve\" is send_from\n\t\tbody[\"push\"] = TAPi18n.__ 'instance.push.body.rejected_completed_approve', {instance_name: instance_name,from_username: from_username,applicant_name: applicant_name,final_decision: push_final_decision,description: description}, lang\n\t\tbody[\"email\"] = TAPi18n.__ 'instance.email.body.rejected_completed_approve', {instance_name: instance_name,to_username: to_username, current_username: current_user_name, href: href,applicant_name: applicant_name,final_decision: email_final_decision,description: email_description}, lang\n\telse if \"reassign_new_inbox_users\" is send_from\n\t\tbody[\"push\"] = TAPi18n.__ 'instance.push.body.reassign_new_inbox_users', {instance_name: instance_name,from_username: from_username,applicant_name: applicant_name,final_decision: push_final_decision,description: description,current_user_name: current_user_name,url_approve_type: url_approve_type,approve_type: push_approve_type}, lang\n\t\tbody[\"email\"] = TAPi18n.__ 'instance.email.body.reassign_new_inbox_users', {instance_name: instance_name,to_username: to_username, current_username: current_user_name, href: href,applicant_name: applicant_name,final_decision: email_final_decision,description: description,current_user_name: current_user_name,url_approve_type: url_approve_type,approve_type: email_approve_type}, lang\n\telse if \"trace_approve_cc\" is send_from\n\t\tbody[\"push\"] = TAPi18n.__ 'instance.push.body.trace_approve_cc', {instance_name: instance_name,from_username: from_username,applicant_name: applicant_name,final_decision: push_final_decision,approve_type: push_approve_type}, lang\n\t\tbody[\"email\"] = TAPi18n.__ 'instance.email.body.trace_approve_cc', {instance_name: instance_name,to_username: to_username,href: href,applicant_name: applicant_name,final_decision: email_final_decision,description: email_description,approve_type: email_approve_type,url_approve_type: url_approve_type}, lang\n\telse if \"trace_approve_cc_submit\" is send_from\n\t\tbody[\"push\"] = TAPi18n.__ 'instance.push.body.trace_approve_cc_submit', {instance_name: instance_name,from_username: from_username,applicant_name: applicant_name,final_decision: push_final_decision,approve_type: push_approve_type, current_user_name: current_user_name}, lang\n\telse if \"auto_submit_pending_inbox\" is send_from\n\t\tbody[\"push\"] = TAPi18n.__ 'instance.push.body.auto_submit_pending_inbox', {instance_name: instance_name, current_step_name: current_step_name}, lang\n\t\tbody[\"email\"] = TAPi18n.__ 'instance.email.body.auto_submit_pending_inbox', {instance_name: instance_name, current_step_name: current_step_name, to_username: to_username}, lang\n\telse if \"return_pending_inbox\" is send_from\n\t\tbody[\"push\"] = TAPi18n.__ 'instance.push.body.return_pending_inbox', {instance_name: instance_name, current_step_name: current_step_name}, lang\n\t\tbody[\"email\"] = TAPi18n.__ 'instance.email.body.return_pending_inbox', {instance_name: instance_name, current_step_name: current_step_name, to_username: to_username}, lang\n\treturn body\n\npushManager.get_title = (parameters, lang=\"zh-CN\")->\n\tsend_from = parameters[\"send_from\"]\n\tinstance_name = parameters[\"instance_name\"]\n\tfrom_username = parameters[\"from_username\"]\n\tapplicant_name = parameters[\"applicant_name\"]\n\tcurrent_step_name = parameters[\"current_step_name\"]\n\tnextApprove_usersname = parameters[\"nextApprove_usersname\"]\n\tnextStep_type = parameters[\"nextStep_type\"]\n\n\tapprove_type = null\n\n\tif ['submit', 'start'].includes(nextStep_type)\n\t\tapprove_type = TAPi18n.__('instance.email.title.input', {}, lang)\n\telse if ['sign', 'counterSign'].includes(nextStep_type)\n\t\tapprove_type = TAPi18n.__('instance.email.title.approval', {}, lang)\n\n\ttitle = new Object\n\tif \"first_submit_applicant\" is send_from\n\t\ttitle[\"push\"] = TAPi18n.__ 'instance.push.title.first_submit_applicant', {from_username: from_username,instance_name: instance_name,applicant_name: applicant_name}, lang\n\t\ttitle[\"email\"] = TAPi18n.__ 'instance.email.title.first_submit_applicant', {from_username: from_username,instance_name: instance_name,applicant_name: applicant_name}, lang\n\telse if \"first_submit_inbox\" is send_from\n\t\ttitle[\"push\"] = TAPi18n.__ 'instance.push.title.first_submit_inbox', {from_username: from_username,instance_name: instance_name,applicant_name: applicant_name}, lang\n\t\ttitle[\"email\"] = TAPi18n.__ 'instance.email.title.first_submit_inbox', {from_username: from_username,instance_name: instance_name,applicant_name: applicant_name,approve_type: approve_type}, lang\n\telse if \"submit_completed_applicant\" is send_from\n\t\ttitle[\"push\"] = TAPi18n.__ 'instance.push.title.submit_completed_applicant', {from_username: from_username,instance_name: instance_name,applicant_name: applicant_name}, lang\n\t\ttitle[\"email\"] = TAPi18n.__ 'instance.email.title.submit_completed_applicant', {from_username: from_username,instance_name: instance_name,applicant_name: applicant_name}, lang\n\telse if \"submit_completed_approve\" is send_from\n\t\ttitle[\"push\"] = TAPi18n.__ 'instance.push.title.submit_completed_approve', {from_username: from_username,instance_name: instance_name,applicant_name: applicant_name}, lang\n\t\ttitle[\"email\"] = TAPi18n.__ 'instance.email.title.submit_completed_approve', {from_username: from_username,instance_name: instance_name,applicant_name: applicant_name}, lang\n\telse if \"submit_pending_rejected_applicant_inbox\" is send_from\n\t\ttitle[\"push\"] = TAPi18n.__ 'instance.push.title.submit_pending_rejected_applicant_inbox', {from_username: from_username,instance_name: instance_name,applicant_name: applicant_name}, lang\n\t\ttitle[\"email\"] = TAPi18n.__ 'instance.email.title.submit_pending_rejected_applicant_inbox', {from_username: from_username,instance_name: instance_name,applicant_name: applicant_name}, lang\n\telse if \"submit_pending_rejected_applicant\" is send_from\n\t\ttitle[\"push\"] = TAPi18n.__ 'instance.push.title.submit_pending_rejected_applicant', {from_username: from_username,instance_name: instance_name,applicant_name: applicant_name,nextApprove_usersname: nextApprove_usersname}, lang\n\t\ttitle[\"email\"] = TAPi18n.__ 'instance.email.title.submit_pending_rejected_applicant', {from_username: from_username,instance_name: instance_name,applicant_name: applicant_name,nextApprove_usersname: nextApprove_usersname}, lang\n\telse if \"submit_pending_rejected_approve\" is send_from\n\t\ttitle[\"push\"] = TAPi18n.__ 'instance.push.title.submit_pending_rejected_approve', {from_username: from_username,instance_name: instance_name,applicant_name: applicant_name}, lang\n\t\ttitle[\"email\"] = TAPi18n.__ 'instance.email.title.submit_pending_rejected_approve', {from_username: from_username,instance_name: instance_name,applicant_name: applicant_name,current_user: current_user_name,nextApprove_usersname: nextApprove_usersname,current_step_name: current_step_name}, lang\n\telse if \"submit_pending_rejected_inbox\" is send_from\n\t\ttitle[\"push\"] = TAPi18n.__ 'instance.push.title.submit_pending_rejected_inbox', {from_username: from_username,instance_name: instance_name,applicant_name: applicant_name}, lang\n\t\ttitle[\"email\"] = TAPi18n.__ 'instance.email.title.submit_pending_rejected_inbox', {from_username: from_username,instance_name: instance_name,applicant_name: applicant_name,approve_type: approve_type}, lang\n\telse if \"submit_pending_inbox\" is send_from\n\t\ttitle[\"push\"] = TAPi18n.__ 'instance.push.title.submit_pending_inbox', {from_username: from_username,instance_name: instance_name,applicant_name: applicant_name}, lang\n\t\ttitle[\"email\"] = TAPi18n.__ 'instance.email.title.submit_pending_inbox', {from_username: from_username,instance_name: instance_name,applicant_name: applicant_name,approve_type: approve_type}, lang\n\telse if \"submit_terminate_applicant\" is send_from\n\t\ttitle[\"push\"] = TAPi18n.__ 'instance.push.title.submit_terminate_applicant', {from_username: from_username,instance_name: instance_name,applicant_name: applicant_name}, lang\n\t\ttitle[\"email\"] = TAPi18n.__ 'instance.email.title.submit_terminate_applicant', {from_username: from_username,instance_name: instance_name,applicant_name: applicant_name}, lang\n\telse if \"submit_terminate_approve\" is send_from\n\t\ttitle[\"push\"] = TAPi18n.__ 'instance.push.title.submit_terminate_approve', {from_username: from_username,instance_name: instance_name,applicant_name: applicant_name}, lang\n\t\ttitle[\"email\"] = TAPi18n.__ 'instance.email.title.submit_terminate_approve', {from_username: from_username,instance_name: instance_name,applicant_name: applicant_name}, lang\n\telse if \"monitor_delete_applicant\" is send_from\n\t\ttitle[\"push\"] = TAPi18n.__ 'instance.push.title.monitor_delete_applicant', {from_username: from_username,instance_name: instance_name,applicant_name: applicant_name}, lang\n\t\ttitle[\"email\"] = TAPi18n.__ 'instance.email.title.monitor_delete_applicant', {from_username: from_username,instance_name: instance_name,applicant_name: applicant_name}, lang\n\telse if \"approved_completed_applicant\" is send_from\n\t\ttitle[\"push\"] = TAPi18n.__ 'instance.push.title.approved_completed_applicant', {from_username: from_username,instance_name: instance_name,applicant_name: applicant_name}, lang\n\t\ttitle[\"email\"] = TAPi18n.__ 'instance.email.title.approved_completed_applicant', {from_username: from_username,instance_name: instance_name,applicant_name: applicant_name}, lang\n\telse if \"approved_completed_approve\" is send_from\n\t\ttitle[\"push\"] = TAPi18n.__ 'instance.push.title.approved_completed_approve', {from_username: from_username,instance_name: instance_name,applicant_name: applicant_name}, lang\n\t\ttitle[\"email\"] = TAPi18n.__ 'instance.email.title.approved_completed_approve', {from_username: from_username,instance_name: instance_name,applicant_name: applicant_name}, lang\n\telse if \"rejected_completed_applicant\" is send_from\n\t\ttitle[\"push\"] = TAPi18n.__ 'instance.push.title.rejected_completed_applicant', {from_username: from_username,instance_name: instance_name,applicant_name: applicant_name}, lang\n\t\ttitle[\"email\"] = TAPi18n.__ 'instance.email.title.rejected_completed_applicant', {from_username: from_username,instance_name: instance_name,applicant_name: applicant_name}, lang\n\telse if \"rejected_completed_approve\" is send_from\n\t\ttitle[\"push\"] = TAPi18n.__ 'instance.push.title.rejected_completed_approve', {from_username: from_username,instance_name: instance_name,applicant_name: applicant_name}, lang\n\t\ttitle[\"email\"] = TAPi18n.__ 'instance.email.title.rejected_completed_approve', {from_username: from_username,instance_name: instance_name,applicant_name: applicant_name}, lang\n\telse if \"reassign_new_inbox_users\" is send_from\n\t\ttitle[\"push\"] = TAPi18n.__ 'instance.push.title.reassign_new_inbox_users', {from_username: from_username,instance_name: instance_name,applicant_name: applicant_name,approve_type: approve_type}, lang\n\t\ttitle[\"email\"] = TAPi18n.__ 'instance.email.title.reassign_new_inbox_users', {from_username: from_username,instance_name: instance_name,applicant_name: applicant_name,approve_type: approve_type}, lang\n\telse if \"trace_approve_cc\" is send_from\n\t\ttitle[\"push\"] = TAPi18n.__ 'instance.push.title.trace_approve_cc', {from_username: from_username,instance_name: instance_name,applicant_name: applicant_name}, lang\n\t\ttitle[\"email\"] = TAPi18n.__ 'instance.email.title.trace_approve_cc', {from_username: from_username,instance_name: instance_name,applicant_name: applicant_name,approve_type: approve_type}, lang\n\telse if \"trace_approve_cc_submit\" is send_from\n\t\ttitle[\"push\"] = TAPi18n.__ 'instance.push.title.trace_approve_cc_submit', {from_username: from_username,instance_name: instance_name,applicant_name: applicant_name}, lang\n\telse if \"auto_submit_pending_inbox\" is send_from\n\t\ttitle[\"push\"] = TAPi18n.__ 'instance.push.title.auto_submit_pending_inbox', {from_username: from_username,instance_name: instance_name,applicant_name: applicant_name}, lang\n\t\ttitle[\"email\"] = TAPi18n.__ 'instance.email.title.auto_submit_pending_inbox', {from_username: from_username,instance_name: instance_name,applicant_name: applicant_name,approve_type: approve_type}, lang\n\telse if \"return_pending_inbox\" is send_from\n\t\ttitle[\"push\"] = TAPi18n.__ 'instance.push.title.return_pending_inbox', {from_username: from_username,instance_name: instance_name,applicant_name: applicant_name}, lang\n\t\ttitle[\"email\"] = TAPi18n.__ 'instance.email.title.return_pending_inbox', {from_username: from_username,instance_name: instance_name,applicant_name: applicant_name,approve_type: approve_type}, lang\n\treturn title\n\npushManager.getSmsBody  = (parameters, lang=\"zh-CN\")->\n\treturn TAPi18n.__ 'instance.sms.submit_pending_inbox', parameters, lang\n\npushManager.get_badge = (send_from, user_id)->\n\tif not ['first_submit_inbox', 'submit_pending_rejected_inbox', 'submit_pending_inbox', 'current_user', 'terminate_approval', 'reassign_new_inbox_users', 'trace_approve_cc', 'trace_approve_cc_submit', 'auto_submit_pending_inbox', 'return_pending_inbox'].includes(send_from)\n\t\treturn null\n\tif !user_id\n\t\tconsole.log('pushManager.get_badge: send_from is ', send_from)\n\t\treturn null\n\tbadge = 0\n\tuser_spaces = db.space_users.find(\n\t\tuser: user_id\n\t\tuser_accepted: true, {fields: {space: 1}})\n\n\tuser_spaces.forEach (user_space) ->\n\t\tspaceId = user_space.space\n\n\t\tcategories = db.categories.find({space: spaceId, app: {$ne: null}}).fetch();\n\n\t\tif categories.length > 0\n\n\t\t\tappCategories = _.groupBy(categories, 'app');\n\n\t\t\t# 按应用计算待办数量\n\t\t\t_.each appCategories, (categorys, appName)->\n\t\t\t\tcategorysIds = _.pluck(categorys, '_id')\n\t\t\t\tif appName\n\t\t\t\t\tcategoryFormsIds = [];\n\t\t\t\t\tcategoryForms = db.forms.find({ category: {$in: categorysIds} }, { fields: { _id: 1 } }).fetch()\n\t\t\t\t\tif categoryForms.length > 0\n\t\t\t\t\t\tcategoryFormsIds = categoryForms.getProperty('_id')\n\t\t\t\t\tif categoryFormsIds.length > 0\n\t\t\t\t\t\tcategoryBadge = db.instances.find({ space: user_space.space, form: { $in: categoryFormsIds }, $or: [{ inbox_users: user_id },{ cc_users: user_id }] }, { fields: {_id: 1 } }).count()\n\t\t\t\t\t\tappKeyValue = db.steedos_keyvalues.findOne(\n\t\t\t\t\t\t\tuser: user_id\n\t\t\t\t\t\t\tspace: user_space.space\n\t\t\t\t\t\t\tkey: 'badge', {fields: {_id: 1, value: 1}})\n\t\t\t\t\t\tif appKeyValue\n\t\t\t\t\t\t\tif appKeyValue.value?[appName] != categoryBadge\n\t\t\t\t\t\t\t\t_set = {};\n\t\t\t\t\t\t\t\t_set['value.' + appName] = categoryBadge;\n\t\t\t\t\t\t\t\tdb.steedos_keyvalues.update { _id: appKeyValue._id }, $set: _set\n\t\t\t\t\t\telse\n\t\t\t\t\t\t\tappKeyValueNew = {}\n\t\t\t\t\t\t\tappKeyValueNew.user = user_id\n\t\t\t\t\t\t\tappKeyValueNew.space = user_space.space\n\t\t\t\t\t\t\tappKeyValueNew.key = 'badge'\n\t\t\t\t\t\t\tappKeyValueNew.value = {}\n\t\t\t\t\t\t\tappKeyValueNew.value[appName] = categoryBadge\n\t\t\t\t\t\t\tdb.steedos_keyvalues.insert appKeyValueNew\n\t\t\n\t\t\n\t\t# workflow 记录所有待办数量\n\t\tc = db.instances.find(\n\t\t\tspace: user_space.space\n\t\t\t$or: [\n\t\t\t\t{ inbox_users: user_id }\n\t\t\t\t{ cc_users: user_id }\n\t\t\t], {fields: {_id: 1}}).count()\n\t\tbadge += c\n\t\tsk = db.steedos_keyvalues.findOne(\n\t\t\tuser: user_id\n\t\t\tspace: user_space.space\n\t\t\tkey: 'badge', {fields: {_id: 1, value: 1}})\n\t\tif sk\n\t\t\tif sk.value?.workflow != c\n\t\t\t\tdb.steedos_keyvalues.update { _id: sk._id }, $set: 'value.workflow': c\n\t\telse\n\t\t\tsk_new = {}\n\t\t\tsk_new.user = user_id\n\t\t\tsk_new.space = user_space.space\n\t\t\tsk_new.key = 'badge'\n\t\t\tsk_new.value = 'workflow': c\n\t\t\tdb.steedos_keyvalues.insert sk_new\n\tsk_all = db.steedos_keyvalues.findOne(\n\t\tuser: user_id\n\t\tspace: null\n\t\tkey: 'badge', {fields: {_id: 1}})\n\tif sk_all\n\t\tdb.steedos_keyvalues.update { _id: sk_all._id }, $set: 'value.workflow': badge\n\telse\n\t\tsk_all_new = {}\n\t\tsk_all_new.user = user_id\n\t\tsk_all_new.space = null\n\t\tsk_all_new.key = 'badge'\n\t\tsk_all_new.value = 'workflow': badge\n\t\tdb.steedos_keyvalues.insert sk_all_new\n\treturn badge\n\n\n# 发送消息到qq\npushManager.send_to_qq = (to_user, from_user, space_id, instance_id, instance_state, body, i18n_obj)->\n\ttry\n\t\tif (not to_user.services) or (not to_user.services['bqq']) or (not to_user.services['bqq']['id'])\n\t\t\treturn\n\n\t\tspace = db.spaces.findOne({ _id: space_id, \"services.bqq.company_id\": { $ne: null } }, { fields: { services: 1 } })\n\t\tif not space\n\t\t\treturn\n\n\t\tapp_id = this.bqq_app_id\n\t\topen_id = from_user.services['bqq']['id']\n\t\temployee_access_token = from_user.services['bqq']['accessToken']\n\t\trecv_open_ids = to_user.services['bqq']['id']\n\t\toauth = space['services']['bqq']\n\n\t\tbox = \"inbox\"\n\t\tif instance_state is \"completed\"\n\t\t\tbox = \"completed\"\n\n\t\ttips_url = '/workflow/space/'+space_id+'/'+box+'/'+instance_id\n\n\t\tbqq_uri = encodeURI('https://openapi.b.qq.com/api/combomsg/send?company_id='+oauth['company_id']+'&company_token='+oauth['company_token']+'&app_id='+app_id+'&client_ip=0.0.0.0'+'&oauth_version=2'+'&employee_access_token='+employee_access_token+'&brief='+body['alert']+'&url='+tips_url+'&type=picture'+'&title='+body['alert']+'&summary='+body['alertTitle']+'&recv_open_ids='+recv_open_ids+'&open_id='+open_id)\n\n\t\tresponse = HTTP.post(bqq_uri)\n\n\t\tif response.data.ret > 0\n\t\t\tconsole.error response.data.msg\n\n\t\treturn\n\tcatch e\n\t\tconsole.error e.stack\n\npushManager.send_email_to_SMTP = (subject, content, to_user, reply_user)->\n\tif to_user.email && to_user.email_verified && to_user.email_notification\n\t\ttry\n\t\t\tMailQueue.send\n\t\t\t\tto: to_user.email\n\t\t\t\tfrom: pushManager.checkMailFromNameLength(reply_user.name) + ' on ' + Meteor.settings.email.from\n\t\t\t\tsubject: subject\n\t\t\t\thtml: content\n\t\tcatch e\n\t\t\tconsole.error e.stack\n\npushManager.checkMailFromNameLength = (name)->\n\treturn if name.length <= 18 then name else name.substr(0, 18) + '...'\n\npushManager.send_message_by_raix_push = (data)->\n\tif not data[\"data\"]\n\t\treturn\n\ttry\n\t\tnotification = new Object\n\t\tnotification[\"createdAt\"] = new Date\n\t\tnotification[\"createdBy\"] = '<SERVER>'\n\t\tnotification[\"from\"] = data[\"pushTopic\"]\n\t\tnotification['title'] = if data[\"data\"][\"alertTitle\"] then data[\"data\"][\"alertTitle\"] else \"\"\n\t\tnotification['text'] = if data[\"data\"][\"alert\"] then data[\"data\"][\"alert\"] else \"\"\n\n\t\tif data[\"data\"][\"space_id\"] and data[\"data\"][\"instance_id\"]\n\t\t\tpayload = new Object\n\t\t\tpayload[\"space\"] = data[\"data\"][\"space_id\"]\n\t\t\tpayload[\"instance\"] = data[\"data\"][\"instance_id\"]\n\t\t\tpayload[\"host\"] = Meteor.absoluteUrl().substr(0, Meteor.absoluteUrl().length-1)\n\n\t\t\tnotification[\"payload\"] = payload\n\n\t\tif data[\"data\"][\"badge\"] > -1\n\t\t\tnotification['badge'] = data[\"data\"][\"badge\"]\n\n\t\t_.each data[\"toUsers\"], (u) ->\n\t\t\tuser = db.users.findOne({ steedos_id: u }, { fields: { _id: 1 } })\n\t\t\tif user\n\t\t\t\tnotification['query'] = {userId: user._id, appName: data[\"pushTopic\"]}\n\t\t\t\tPush.send(notification)\n\tcatch e\n\t\tconsole.error e.stack\n\n#steedos_ids 必须为数组 ； body 如果有，则必须为Hash\npushManager.send_message = (steedos_ids, body, current_user_info)->\n\tif not steedos_ids or not (steedos_ids instanceof Array)\n\t\treturn\n\tdata = new Object\n\tdata[\"toUsers\"]  = steedos_ids\n\tdata[\"pushTopic\"] = 'workflow'\n\tdata[\"data\"] = body  if body\n\n\tpushManager.send_message_by_raix_push(data)\n\n\n\npushManager.send_to_sms = (to_user, message, current_user_info, spaceId)->\n\tif Meteor.settings?.workflow?.sms_notification && to_user?.mobile && to_user?.mobile_verified\n\t\tspaceUser = db.space_users.findOne({user: to_user._id, space: spaceId}, {fields: {sms_notification: 1}})\n\t\tif spaceUser?.sms_notification\n\t\t\tSMSQueue.send({\n\t\t\t\tRecNum: to_user.mobile,\n\t\t\t\tmsg: message\n\t\t\t\tcreatedBy: current_user_info._id\n\t\t\t}, spaceId)\n\n#通知服务\npushManager.send_instance_notification = (send_from, instance, description, current_user_info, cc_user_ids)->\n\t\t# Meteor.defer ()->\n\t\t\ttry\n\t\t\t\tspace_id = instance.space\n\t\t\t\tinstance_id = instance._id\n\t\t\t\tflow_version = instance.flow_version\n\t\t\t\tflow = uuflowManager.getFlow(instance.flow)\n\t\t\t\tto_users = pushManager.get_to_users(send_from, instance, cc_user_ids, current_user_info)\n\n\t\t\t\thref = Meteor.absoluteUrl() + \"workflow/space/#{space_id}/inbox/#{instance_id}\"\n\t\t\t\tbody_style_start = \"<div style='border:1px solid #bbb;padding:10px;'>\"\n\t\t\t\tbody_style_end = \"</div>\"\n\n\t\t\t\tcurrent_step_name = instance.current_step_name\n\t\t\t\tnextApprove_usersname = null\n\n\t\t\t\tif ['submit_pending_rejected_approve', 'submit_pending_rejected_applicant'].includes(send_from)\n\t\t\t\t\ttrace = _.find(instance.traces, (t) ->\n\t\t\t\t\t\treturn t.is_finished is false\n\t\t\t\t\t)\n\t\t\t\t\tapprove = _.find(trace.approves, (a) ->\n\t\t\t\t\t\treturn a.is_finished is false\n\t\t\t\t\t)\n\t\t\t\t\tnextApprove_usersname = approve.user_name\n\n\n\t\t\t\t#得到下一步步骤类型\n\t\t\t\tnextStep_type = uuflowManager.getStep(instance, flow, instance.traces[instance.traces.length-1].step).step_type\n\t\t\t\t#得到上一步处理结果\n\t\t\t\tlastApprove_judge = instance.traces[instance.traces.length-2].approves[0].judge\n\t\t\t\t_approves_username = new Array\n\t\t\t\t_.each(instance.traces[instance.traces.length-2].approves, (appr)->\n\t\t\t\t\t_approves_username.push(appr.handler_name)\n\t\t\t\t)\n\t\t\t\tlastApprove_usersname = _approves_username.join(\",\")\n\t\t\t\t# 得到当前步骤\n\t\t\t\tcurrent_step = uuflowManager.getStep(instance, flow, instance.traces[instance.traces.length-2].step)\n\n\t\t\t\t#代申请时，发送给申请人的邮件中，需要添加开始步骤的description\n\t\t\t\tapproves_description = null\n\t\t\t\t_approves_des = null\n\t\t\t\tif ['reassign_new_inbox_users', 'submit_completed_applicant', 'approved_completed_applicant', 'first_submit_applicant', 'first_submit_inbox', 'submit_pending_inbox'].includes(send_from)\n\t\t\t\t\tapproves_description = instance.traces[instance.traces.length-2].approves[0].description\n\t\t\t\t\tif current_step.step_type is \"counterSign\" and (\"submit_completed_applicant\" is send_from or \"submit_pending_inbox\" is send_from)\n\t\t\t\t\t\tto_user_change = 'en'\n\t\t\t\t\t\tif to_users[0].locale is 'zh-cn'\n\t\t\t\t\t\t\tto_user_change = 'zh-CN'\n\n\t\t\t\t\t\t_.each(instance.traces[instance.traces.length-2].approves, (appr)->\n\t\t\t\t\t\t\t_appr_description = appr.description\n\t\t\t\t\t\t\t_appr_userName = appr.user_name\n\t\t\t\t\t\t\tbr = '<br/>'\n\t\t\t\t\t\t\tif appr.judge is \"approved\"\n\t\t\t\t\t\t\t\t_approves_des = _appr_userName + \" : \" + TAPi18n.__('instance.judge.approved', {}, to_user_change) + \",\" + _appr_description + br\n\t\t\t\t\t\t\telse if appr.judge is \"rejected\"\n\t\t\t\t\t\t\t\t_approves_des = _appr_userName + \" : \" + TAPi18n.__('instance.judge.rejected', {}, to_user_change) + \",\" + _appr_description + br\n\n\n\t\t\t\t\t\t)\n\t\t\t\t\t\tapproves_description = _approves_des\n\n\t\t\t\t# from_user 默认为当前登录用户\n\t\t\t\tfrom_user = current_user_info\n\n\t\t\t\t# 发给下一步处理人或发送已处理过的人时，设置from_user对象为申请人\n\t\t\t\tif ['reassign_new_inbox_users', 'first_submit_inbox', 'submit_pending_rejected_inbox', 'submit_pending_inbox', 'submit_completed_approve', 'submit_pending_rejected_approve', 'submit_terminate_approve', 'approved_completed_approve', 'rejected_completed_approve'].includes(send_from)\n\t\t\t\t\tfrom_user = db.users.findOne(instance.applicant)\n\n\t\t\t\t#创建调用get_body、get_title函数时， 需要的参数\n\t\t\t\tparameters = new Object\n\t\t\t\tparameters[\"send_from\"] = send_from\n\t\t\t\tparameters[\"applicant_name\"] = instance.applicant_name\n\t\t\t\tparameters[\"instance_name\"] = instance.name\n\t\t\t\tparameters[\"href\"] = href\n\t\t\t\tparameters[\"final_decision\"] = instance.final_decision\n\t\t\t\tparameters[\"description\"] = description\n\t\t\t\tparameters[\"state\"] = instance.state\n\t\t\t\tparameters[\"from_username\"] = from_user.name\n\t\t\t\tparameters[\"current_step_name\"] = current_step_name\n\t\t\t\tparameters[\"nextApprove_usersname\"] = nextApprove_usersname\n\t\t\t\tparameters[\"nextStep_type\"] = nextStep_type\n\t\t\t\tparameters[\"approves_description\"] = approves_description\n\t\t\t\tparameters[\"lastApprove_judge\"] = lastApprove_judge\n\t\t\t\tparameters[\"lastApprove_usersname\"] = lastApprove_usersname\n\t\t\t\tparameters[\"current_user_name\"] = current_user_info.name\n\t\t\t\tparameters[\"currentStep_type\"] = current_step.step_type\n\t\t\t\t_.each to_users, (to_user)->\n\t\t\t\t\t#设置当前语言环境\n\t\t\t\t\tlang = 'en'\n\t\t\t\t\tif to_user.locale is 'zh-cn'\n\t\t\t\t\t\tlang = 'zh-CN'\n\n\t\t\t\t\tinscribed = TAPi18n.__('instance.email.inscribed', {}, lang)\n\t\t\t\t\tfootnote = \"<p style='text-align:left;color:#bbb;'>\" + TAPi18n.__('instance.email.footnote', {}, lang) + \"</p>\"\n\n\t\t\t\t\tif db.space_users.find({ space: space_id, user: to_user._id }).count() is 0\n\t\t\t\t\t\treturn\n\t\t\t\t\tif db.users.find(to_user._id).count() is 0\n\t\t\t\t\t\treturn\n\n\t\t\t\t\tparameters[\"to_username\"] = to_user.name\n\n\t\t\t\t\tins_html = ''\n\n\t\t\t\t\tif ['first_submit_inbox', 'submit_pending_inbox', 'submit_pending_rejected_inbox', 'submit_pending_rejected_applicant_inbox', 'reassign_new_inbox_users', 'trace_approve_cc', 'auto_submit_pending_inbox'].includes(send_from)\n\t\t\t\t\t\tif current_user_info.email && current_user_info.email_notification\n\t\t\t\t\t\t\ttry\n\t\t\t\t\t\t\t\t# console.time(\"push-2-1-ins_html\")\n\t\t\t\t\t\t\t\tins_html = uuflowManager.ins_html(current_user_info, instance)\n\t\t\t\t\t\t\t\t# console.timeEnd(\"push-2-1-ins_html\")\n\t\t\t\t\t\t\tcatch e\n\t\t\t\t\t\t\t\tconsole.error e\n\n\t\t\t\t\tbody = pushManager.get_body(parameters, lang)\n\t\t\t\t\ttitle = pushManager.get_title(parameters, lang)\n\t\t\t\t\tbadge = pushManager.get_badge(send_from, to_user._id)\n\n\t\t\t\t\t# push\n\t\t\t\t\tpush_body = new Object\n\n\t\t\t\t\tpush_body[\"alertTitle\"] = title[\"push\"]\n\t\t\t\t\tpush_body[\"alert\"] = body[\"push\"]\n\t\t\t\t\t#push_body[\"href\"] = href\n\t\t\t\t\tpush_body[\"space_id\"] = space_id\n\t\t\t\t\tpush_body[\"instance_id\"] = instance_id\n\t\t\t\t\tpush_body[\"badge\"] = badge if badge\n\t\t\t\t\tpush_body[\"sound\"] = \"default\"\n\n\t\t\t\t\tcontent = body_style_start + body[\"email\"] +  inscribed + ins_html + body_style_end + footnote\n\t\t\t\t\t# Email\n\t\t\t\t\t# 发送消息到 SMTP 服务\n\t\t\t\t\tpushManager.send_email_to_SMTP(title[\"email\"], content, to_user, from_user)\n\t\t\t\t\t# 发送消息到push service 服务\n\t\t\t\t\tpushManager.send_message([to_user.steedos_id], push_body, current_user_info)\n\t\t\t\t\t# 给下一步处理人发送短信\n\t\t\t\t\tif ['reassign_new_inbox_users', 'submit_pending_rejected_applicant_inbox', 'submit_pending_rejected_inbox', 'submit_pending_inbox', 'first_submit_inbox', 'return_pending_inbox'].includes(send_from)\n\t\t\t\t\t\tpushManager.send_to_sms(to_user, pushManager.getSmsBody(parameters, lang), current_user_info, space_id);\n\n\t\t\t\t\t# qq企业用户则发送客户端tips\n\t\t\t\t\tpushManager.send_to_qq(to_user, from_user, space_id, instance_id, instance.state, push_body, lang)\n\t\t\tcatch e\n\t\t\t\tconsole.error e.stack\n\n# 发送给当前用户\npushManager.send_message_current_user = (user_info)->\n\ttry\n\t\tbadge = this.get_badge(\"current_user\", user_info._id)\n\t\tpush_body = new Object\n\t\tpush_body[\"badge\"] = badge\n\t\tthis.send_message([user_info.steedos_id], push_body, user_info)\n\tcatch e\n\t\tconsole.error e.stack\n\n# 发送push 并且内容只有待审核数量\npushManager.send_message_to_specifyUser = (send_from, to_user)->\n\ttry\n\t\tbadge = this.get_badge(send_from, to_user)\n\t\tpush_body = new Object\n\t\tpush_body[\"badge\"] = badge\n\t\tuser_info = db.users.findOne({_id: to_user})\n\t\tthis.send_message([user_info.steedos_id], push_body, user_info) if user_info\n\tcatch e\n\t\tconsole.error e.stack\n\npushManager.triggerWebhook = (flow_id, instance, current_approve, action, from_user_id, to_user_ids)->\n\n\tinstance.attachments = cfs.instances.find({'metadata.instance': instance._id}).fetch()\n\n\t# 增加from_user和to_users的username、email、mobile\n\tfrom_user = db.users.findOne({\"_id\": from_user_id},{fields: {_id:1, username:1}})\n\tfrom_space_user = db.space_users.findOne({\"user\": from_user_id},{fields: {mobile:1, email:1}})\n\tfrom_user?.mobile = from_space_user?.mobile || \"\"\n\tfrom_user?.email = from_space_user?.email || \"\"\n\n\tif(to_user_ids.length>0)\n\t\tto_users = db.users.find({\"_id\": {$in: to_user_ids}},{fields: {_id:1, username:1}}).fetch()\n\t\tto_users.forEach (to_user)->\n\t\t\tto_space_user = db.space_users.findOne({\"user\": to_user._id},{fields: {mobile:1, email:1}})\n\t\t\tto_user?.mobile = to_space_user?.mobile || \"\"\n\t\t\tto_user?.email = to_space_user?.email || \"\"\n\n\tdb.webhooks.find({ flow: { $in: [flow_id, null] }, active: true }).forEach (w)->\n\t\tWebhookQueue.send({\n\t\t\t\tinstance: instance,\n\t\t\t\tcurrent_approve: current_approve,\n\t\t\t\tpayload_url: w.payload_url,\n\t\t\t\tcontent_type: w.content_type,\n\t\t\t\taction: action,\n\t\t\t\tfrom_user: from_user,\n\t\t\t\tto_users: to_users || []\n\t\t\t})\n","var ref, ref1, ref2, ref3;             \n\npushManager = {\n  bqq_app_id: \"200626779\",\n  imo_app_cid: (ref = Meteor.settings.imo) != null ? ref.appcid : void 0,\n  imo_app_uid: (ref1 = Meteor.settings.imo) != null ? ref1.appuid : void 0,\n  imo_sync_app_key: (ref2 = Meteor.settings.imo) != null ? ref2.sync_app_key : void 0,\n  imo_push_app_key: (ref3 = Meteor.settings.imo) != null ? ref3.push_app_key : void 0\n};\n\npushManager.get_to_users = function(send_from, instance, cc_user_ids, current_user_info) {\n  var applicant, approve_user_ids, remove_users, to_users;\n  to_users = new Array;\n  if (['first_submit_applicant'].includes(send_from)) {\n    if (instance.applicant !== instance.submitter) {\n      applicant = db.users.findOne(instance.applicant);\n      to_users.push(applicant);\n    }\n  } else if (['submit_terminate_approve', 'submit_completed_approve', 'submit_pending_rejected_approve', 'approved_completed_approve', 'rejected_completed_approve'].includes(send_from)) {\n    remove_users = new Array;\n    remove_users.push(instance.applicant);\n    remove_users.push(instance.submitter);\n    approve_user_ids = _.difference(instance.outbox_users, remove_users);\n    to_users = db.users.find({\n      _id: {\n        $in: approve_user_ids\n      }\n    }).fetch();\n  } else if (['reassign_new_inbox_users', 'submit_pending_rejected_inbox', 'submit_pending_inbox', 'first_submit_inbox', 'return_pending_inbox'].includes(send_from)) {\n    to_users = db.users.find({\n      _id: {\n        $in: instance.inbox_users\n      }\n    }).fetch();\n  } else if (['submit_completed_applicant', 'approved_completed_applicant', 'rejected_completed_applicant', 'monitor_delete_applicant', 'submit_terminate_applicant', 'submit_pending_rejected_applicant', 'submit_pending_rejected_applicant_inbox'].includes(send_from)) {\n    applicant = db.users.findOne(instance.applicant);\n    to_users.push(applicant);\n  } else if (['trace_approve_cc'].includes(send_from) && cc_user_ids) {\n    to_users = db.users.find({\n      _id: {\n        $in: cc_user_ids\n      }\n    }).fetch();\n  } else if (['trace_approve_cc_submit'].includes(send_from) && cc_user_ids) {\n    to_users = db.users.find({\n      _id: {\n        $in: cc_user_ids\n      }\n    }).fetch();\n  } else if (['auto_submit_pending_inbox'].includes(send_from)) {\n    to_users = [current_user_info];\n  }\n  return to_users;\n};\n\npushManager.get_body = function(parameters, lang) {\n  var applicant_name, approves_description, body, currentStep_type, current_step_name, current_user_name, description, email_approve_type, email_description, email_final_decision, final_decision, from_username, href, instance_name, lastApprove_judge, lastApprove_usersname, last_approve_judge, nextApprove_usersname, nextStep_type, push_approve_type, push_final_decision, send_from, state, to_username, url_approve_type;\n  if (lang == null) {\n    lang = \"zh-CN\";\n  }\n  send_from = parameters[\"send_from\"];\n  applicant_name = parameters[\"applicant_name\"];\n  instance_name = parameters[\"instance_name\"];\n  to_username = parameters[\"to_username\"];\n  href = parameters[\"href\"];\n  final_decision = parameters[\"final_decision\"];\n  description = parameters[\"description\"];\n  state = parameters[\"state\"];\n  from_username = parameters[\"from_username\"];\n  current_step_name = parameters[\"current_step_name\"];\n  nextApprove_usersname = parameters[\"nextApprove_usersname\"];\n  nextStep_type = parameters[\"nextStep_type\"];\n  approves_description = parameters[\"approves_description\"];\n  lastApprove_judge = parameters[\"lastApprove_judge\"];\n  lastApprove_usersname = parameters[\"lastApprove_usersname\"];\n  current_user_name = parameters[\"current_user_name\"];\n  currentStep_type = parameters[\"currentStep_type\"];\n  push_final_decision = \"\";\n  email_final_decision = \"\";\n  email_description = \"\";\n  if (!final_decision) {\n    push_final_decision = TAPi18n.__('instance.push.final_decision_nil', {}, lang);\n    email_final_decision = TAPi18n.__('instance.email.final_decision_nil', {}, lang);\n  } else {\n    if (\"approved\" === final_decision) {\n      push_final_decision = TAPi18n.__('instance.push.final_decision_approved', {}, lang);\n      email_final_decision = TAPi18n.__('instance.email.final_decision_approved', {}, lang);\n    } else if (\"rejected\" === final_decision) {\n      push_final_decision = TAPi18n.__('instance.push.final_decision_rejected', {}, lang);\n      email_final_decision = TAPi18n.__('instance.email.final_decision_rejected', {}, lang);\n      email_description = TAPi18n.__('instance.email.body.email_description', {\n        description: description\n      }, lang);\n    } else {\n      push_final_decision = TAPi18n.__('instance.push.final_decision_nil', {}, lang);\n      email_final_decision = TAPi18n.__('instance.email.final_decision_nil', {}, lang);\n    }\n  }\n  email_approve_type = null;\n  url_approve_type = null;\n  push_approve_type = null;\n  if (['submit', 'start'].includes(nextStep_type)) {\n    email_approve_type = TAPi18n.__('instance.email.body.input', {}, lang);\n    url_approve_type = TAPi18n.__('instance.email.body.url_input', {}, lang);\n    push_approve_type = TAPi18n.__('instance.push.body.input', {}, lang);\n  } else if (['sign', 'counterSign'].includes(nextStep_type)) {\n    email_approve_type = TAPi18n.__('instance.email.body.approval', {}, lang);\n    url_approve_type = TAPi18n.__('instance.email.body.url_approval', {}, lang);\n    push_approve_type = TAPi18n.__('instance.push.body.approval', {}, lang);\n  }\n  last_approve_judge = null;\n  if (\"submitted\" === lastApprove_judge) {\n    last_approve_judge = TAPi18n.__('instance.email.body.judge_submitted', {}, lang);\n  } else if (\"approved\" === lastApprove_judge) {\n    last_approve_judge = TAPi18n.__('instance.email.body.judge_approved', {}, lang);\n  }\n  body = new Object;\n  if (\"first_submit_applicant\" === send_from) {\n    body[\"push\"] = TAPi18n.__('instance.push.body.first_submit_applicant', {\n      instance_name: instance_name,\n      from_username: from_username,\n      applicant_name: applicant_name,\n      final_decision: push_final_decision\n    }, lang);\n    if (!approves_description) {\n      body[\"email\"] = TAPi18n.__('instance.email.body.first_submit_applicant', {\n        instance_name: instance_name,\n        to_username: to_username,\n        href: href,\n        applicant_name: applicant_name,\n        final_decision: email_final_decision,\n        description: email_description\n      }, lang);\n    } else {\n      body[\"email\"] = TAPi18n.__('instance.email.body.first_submit_applicant_beApproveDescription', {\n        instance_name: instance_name,\n        to_username: to_username,\n        href: href,\n        applicant_name: applicant_name,\n        final_decision: email_final_decision,\n        description: email_description,\n        approves_description: approves_description\n      }, lang);\n    }\n  } else if (\"first_submit_inbox\" === send_from) {\n    body[\"push\"] = TAPi18n.__('instance.push.body.first_submit_inbox', {\n      instance_name: instance_name,\n      from_username: from_username,\n      applicant_name: applicant_name,\n      final_decision: push_final_decision,\n      approve_type: push_approve_type\n    }, lang);\n    if (!approves_description) {\n      body[\"email\"] = TAPi18n.__('instance.email.body.first_submit_inbox', {\n        instance_name: instance_name,\n        to_username: to_username,\n        href: href,\n        applicant_name: applicant_name,\n        final_decision: email_final_decision,\n        description: email_description,\n        approve_type: email_approve_type,\n        url_approve_type: url_approve_type\n      }, lang);\n    } else {\n      body[\"email\"] = TAPi18n.__('instance.email.body.first_submit_inbox_beApproveDescription', {\n        instance_name: instance_name,\n        to_username: to_username,\n        href: href,\n        applicant_name: applicant_name,\n        final_decision: email_final_decision,\n        description: email_description,\n        approve_type: email_approve_type,\n        url_approve_type: url_approve_type,\n        approves_description: approves_description\n      }, lang);\n    }\n  } else if (\"submit_completed_applicant\" === send_from) {\n    body[\"push\"] = TAPi18n.__('instance.push.body.submit_completed_applicant', {\n      instance_name: instance_name,\n      from_username: from_username,\n      applicant_name: applicant_name,\n      final_decision: push_final_decision\n    }, lang);\n    if (!approves_description) {\n      body[\"email\"] = TAPi18n.__('instance.email.body.submit_completed_applicant', {\n        instance_name: instance_name,\n        to_username: to_username,\n        current_username: current_user_name,\n        href: href,\n        applicant_name: applicant_name,\n        final_decision: email_final_decision,\n        description: email_description,\n        lastApprove_usersname: lastApprove_usersname\n      }, lang);\n    } else {\n      if (currentStep_type === \"counterSign\") {\n        body[\"email\"] = TAPi18n.__('instance.email.body.submit_completed_applicant_beApproveDescription_counterSign', {\n          instance_name: instance_name,\n          to_username: to_username,\n          current_username: current_user_name,\n          applicant_name: applicant_name,\n          final_decision: email_final_decision,\n          description: email_description,\n          lastApprove_usersname: lastApprove_usersname\n        }, lang) + approves_description + TAPi18n.__('help.href', {\n          href: href\n        }, lang);\n      } else {\n        body[\"email\"] = TAPi18n.__('instance.email.body.submit_completed_applicant_beApproveDescription', {\n          instance_name: instance_name,\n          to_username: to_username,\n          current_username: current_user_name,\n          href: href,\n          applicant_name: applicant_name,\n          final_decision: email_final_decision,\n          description: email_description,\n          lastApprove_usersname: lastApprove_usersname,\n          approves_description: approves_description\n        }, lang);\n      }\n    }\n  } else if (\"submit_completed_approve\" === send_from) {\n    body[\"push\"] = TAPi18n.__('instance.push.body.submit_completed_approve', {\n      instance_name: instance_name,\n      from_username: from_username,\n      applicant_name: applicant_name,\n      final_decision: push_final_decision\n    }, lang);\n    body[\"email\"] = TAPi18n.__('instance.email.body.submit_completed_approve', {\n      instance_name: instance_name,\n      to_username: to_username,\n      current_username: current_user_name,\n      href: href,\n      applicant_name: applicant_name,\n      final_decision: email_final_decision,\n      description: email_description\n    }, lang);\n  } else if (\"submit_pending_rejected_applicant_inbox\" === send_from) {\n    body[\"push\"] = TAPi18n.__('instance.push.body.submit_pending_rejected_applicant_inbox', {\n      instance_name: instance_name,\n      from_username: from_username,\n      applicant_name: applicant_name,\n      final_decision: push_final_decision,\n      description: description\n    }, lang);\n    body[\"email\"] = TAPi18n.__('instance.email.body.submit_pending_rejected_applicant_inbox', {\n      instance_name: instance_name,\n      to_username: to_username,\n      current_username: current_user_name,\n      href: href,\n      applicant_name: applicant_name,\n      final_decision: email_final_decision,\n      description: email_description,\n      lastApprove_usersname: lastApprove_usersname\n    }, lang);\n  } else if (\"submit_pending_rejected_applicant\" === send_from) {\n    body[\"push\"] = TAPi18n.__('instance.push.body.submit_pending_rejected_applicant', {\n      instance_name: instance_name,\n      from_username: from_username,\n      applicant_name: applicant_name,\n      final_decision: push_final_decision,\n      description: description,\n      nextApprove_usersname: nextApprove_usersname\n    }, lang);\n    body[\"email\"] = TAPi18n.__('instance.email.body.submit_pending_rejected_applicant', {\n      instance_name: instance_name,\n      to_username: to_username,\n      current_username: current_user_name,\n      href: href,\n      applicant_name: applicant_name,\n      final_decision: email_final_decision,\n      description: email_description,\n      lastApprove_usersname: lastApprove_usersname,\n      nextApprove_usersname: nextApprove_usersname\n    }, lang);\n  } else if (\"submit_pending_rejected_approve\" === send_from) {\n    body[\"push\"] = TAPi18n.__('instance.push.body.submit_pending_rejected_approve', {\n      instance_name: instance_name,\n      from_username: from_username,\n      applicant_name: applicant_name,\n      final_decision: push_final_decision,\n      description: description,\n      current_user: current_user_name,\n      nextApprove_usersname: nextApprove_usersname,\n      current_step_name: current_step_name\n    }, lang);\n    body[\"email\"] = TAPi18n.__('instance.email.body.submit_pending_rejected_approve', {\n      instance_name: instance_name,\n      to_username: to_username,\n      current_username: current_user_name,\n      href: href,\n      applicant_name: applicant_name,\n      final_decision: email_final_decision,\n      description: email_description\n    }, lang);\n  } else if (\"submit_pending_rejected_inbox\" === send_from) {\n    body[\"push\"] = TAPi18n.__('instance.push.body.submit_pending_rejected_inbox', {\n      instance_name: instance_name,\n      from_username: from_username,\n      applicant_name: applicant_name,\n      final_decision: push_final_decision,\n      approve_type: push_approve_type\n    }, lang);\n    body[\"email\"] = TAPi18n.__('instance.email.body.submit_pending_rejected_inbox', {\n      instance_name: instance_name,\n      to_username: to_username,\n      href: href,\n      applicant_name: applicant_name,\n      final_decision: email_final_decision,\n      description: email_description,\n      approve_type: email_approve_type,\n      url_approve_type: url_approve_type,\n      lastApprove_usersname: lastApprove_usersname\n    }, lang);\n  } else if (\"submit_pending_inbox\" === send_from) {\n    body[\"push\"] = TAPi18n.__('instance.push.body.submit_pending_inbox', {\n      instance_name: instance_name,\n      from_username: from_username,\n      applicant_name: applicant_name,\n      final_decision: push_final_decision,\n      approve_type: push_approve_type\n    }, lang);\n    if (!approves_description) {\n      body[\"email\"] = TAPi18n.__('instance.email.body.submit_pending_inbox', {\n        instance_name: instance_name,\n        to_username: to_username,\n        href: href,\n        applicant_name: applicant_name,\n        final_decision: email_final_decision,\n        description: email_description,\n        approve_type: email_approve_type,\n        url_approve_type: url_approve_type,\n        lastApprove_usersname: lastApprove_usersname,\n        last_approve_judge: last_approve_judge\n      }, lang);\n    } else {\n      if (currentStep_type === \"counterSign\") {\n        body[\"email\"] = TAPi18n.__('instance.email.body.submit_pending_inbox_beApproveDescription_counterSign', {\n          instance_name: instance_name,\n          to_username: to_username,\n          applicant_name: applicant_name,\n          final_decision: email_final_decision,\n          description: email_description,\n          approve_type: email_approve_type,\n          url_approve_type: url_approve_type,\n          lastApprove_usersname: lastApprove_usersname,\n          last_approve_judge: last_approve_judge\n        }, lang) + approves_description + TAPi18n.__('help.href', {\n          href: href\n        }, lang);\n      } else {\n        body[\"email\"] = TAPi18n.__('instance.email.body.submit_pending_inbox_beApproveDescription', {\n          instance_name: instance_name,\n          to_username: to_username,\n          href: href,\n          applicant_name: applicant_name,\n          final_decision: email_final_decision,\n          description: email_description,\n          approve_type: email_approve_type,\n          url_approve_type: url_approve_type,\n          lastApprove_usersname: lastApprove_usersname,\n          last_approve_judge: last_approve_judge,\n          approves_description: approves_description\n        }, lang);\n      }\n    }\n  } else if (\"submit_terminate_applicant\" === send_from) {\n    body[\"push\"] = TAPi18n.__('instance.push.body.submit_terminate_applicant', {\n      instance_name: instance_name,\n      from_username: from_username,\n      applicant_name: applicant_name,\n      final_decision: push_final_decision\n    }, lang);\n    body[\"email\"] = TAPi18n.__('instance.email.body.submit_terminate_applicant', {\n      instance_name: instance_name,\n      to_username: to_username,\n      current_username: current_user_name,\n      href: href,\n      applicant_name: applicant_name,\n      final_decision: email_final_decision,\n      description: description\n    }, lang);\n  } else if (\"submit_terminate_approve\" === send_from) {\n    body[\"push\"] = TAPi18n.__('instance.push.body.submit_terminate_approve', {\n      instance_name: instance_name,\n      from_username: from_username,\n      applicant_name: applicant_name,\n      final_decision: push_final_decision\n    }, lang);\n    body[\"email\"] = TAPi18n.__('instance.email.body.submit_terminate_approve', {\n      instance_name: instance_name,\n      to_username: to_username,\n      current_username: current_user_name,\n      href: href,\n      applicant_name: applicant_name,\n      final_decision: email_final_decision,\n      description: description\n    }, lang);\n  } else if (\"monitor_delete_applicant\" === send_from) {\n    body[\"push\"] = TAPi18n.__('instance.push.body.monitor_delete_applicant', {\n      instance_name: instance_name,\n      from_username: from_username,\n      applicant_name: applicant_name,\n      final_decision: push_final_decision\n    }, lang);\n    body[\"email\"] = TAPi18n.__('instance.email.body.monitor_delete_applicant', {\n      instance_name: instance_name,\n      to_username: to_username,\n      current_username: current_user_name,\n      href: href,\n      applicant_name: applicant_name,\n      final_decision: email_final_decision,\n      description: email_description\n    }, lang);\n  } else if (\"approved_completed_applicant\" === send_from) {\n    body[\"push\"] = TAPi18n.__('instance.push.body.approved_completed_applicant', {\n      instance_name: instance_name,\n      from_username: from_username,\n      applicant_name: applicant_name,\n      final_decision: push_final_decision\n    }, lang);\n    if (!approves_description) {\n      body[\"email\"] = TAPi18n.__('instance.email.body.approved_completed_applicant', {\n        instance_name: instance_name,\n        to_username: to_username,\n        current_username: current_user_name,\n        href: href,\n        applicant_name: applicant_name,\n        final_decision: email_final_decision,\n        description: email_description,\n        lastApprove_usersname: lastApprove_usersname\n      }, lang);\n    } else {\n      body[\"email\"] = TAPi18n.__('instance.email.body.approved_completed_applicant_beApproveDescription', {\n        instance_name: instance_name,\n        to_username: to_username,\n        current_username: current_user_name,\n        href: href,\n        applicant_name: applicant_name,\n        final_decision: email_final_decision,\n        description: email_description,\n        lastApprove_usersname: lastApprove_usersname,\n        approves_description: approves_description\n      }, lang);\n    }\n  } else if (\"approved_completed_approve\" === send_from) {\n    body[\"push\"] = TAPi18n.__('instance.push.body.approved_completed_approve', {\n      instance_name: instance_name,\n      from_username: from_username,\n      applicant_name: applicant_name,\n      final_decision: push_final_decision\n    }, lang);\n    body[\"email\"] = TAPi18n.__('instance.email.body.approved_completed_approve', {\n      instance_name: instance_name,\n      to_username: to_username,\n      current_username: current_user_name,\n      href: href,\n      applicant_name: applicant_name,\n      final_decision: email_final_decision,\n      description: email_description\n    }, lang);\n  } else if (\"rejected_completed_applicant\" === send_from) {\n    body[\"push\"] = TAPi18n.__('instance.push.body.rejected_completed_applicant', {\n      instance_name: instance_name,\n      from_username: from_username,\n      applicant_name: applicant_name,\n      final_decision: push_final_decision,\n      description: description\n    }, lang);\n    body[\"email\"] = TAPi18n.__('instance.email.body.rejected_completed_applicant', {\n      instance_name: instance_name,\n      to_username: to_username,\n      current_username: current_user_name,\n      href: href,\n      applicant_name: applicant_name,\n      final_decision: email_final_decision,\n      description: email_description,\n      lastApprove_usersname: lastApprove_usersname\n    }, lang);\n  } else if (\"rejected_completed_approve\" === send_from) {\n    body[\"push\"] = TAPi18n.__('instance.push.body.rejected_completed_approve', {\n      instance_name: instance_name,\n      from_username: from_username,\n      applicant_name: applicant_name,\n      final_decision: push_final_decision,\n      description: description\n    }, lang);\n    body[\"email\"] = TAPi18n.__('instance.email.body.rejected_completed_approve', {\n      instance_name: instance_name,\n      to_username: to_username,\n      current_username: current_user_name,\n      href: href,\n      applicant_name: applicant_name,\n      final_decision: email_final_decision,\n      description: email_description\n    }, lang);\n  } else if (\"reassign_new_inbox_users\" === send_from) {\n    body[\"push\"] = TAPi18n.__('instance.push.body.reassign_new_inbox_users', {\n      instance_name: instance_name,\n      from_username: from_username,\n      applicant_name: applicant_name,\n      final_decision: push_final_decision,\n      description: description,\n      current_user_name: current_user_name,\n      url_approve_type: url_approve_type,\n      approve_type: push_approve_type\n    }, lang);\n    body[\"email\"] = TAPi18n.__('instance.email.body.reassign_new_inbox_users', {\n      instance_name: instance_name,\n      to_username: to_username,\n      current_username: current_user_name,\n      href: href,\n      applicant_name: applicant_name,\n      final_decision: email_final_decision,\n      description: description,\n      current_user_name: current_user_name,\n      url_approve_type: url_approve_type,\n      approve_type: email_approve_type\n    }, lang);\n  } else if (\"trace_approve_cc\" === send_from) {\n    body[\"push\"] = TAPi18n.__('instance.push.body.trace_approve_cc', {\n      instance_name: instance_name,\n      from_username: from_username,\n      applicant_name: applicant_name,\n      final_decision: push_final_decision,\n      approve_type: push_approve_type\n    }, lang);\n    body[\"email\"] = TAPi18n.__('instance.email.body.trace_approve_cc', {\n      instance_name: instance_name,\n      to_username: to_username,\n      href: href,\n      applicant_name: applicant_name,\n      final_decision: email_final_decision,\n      description: email_description,\n      approve_type: email_approve_type,\n      url_approve_type: url_approve_type\n    }, lang);\n  } else if (\"trace_approve_cc_submit\" === send_from) {\n    body[\"push\"] = TAPi18n.__('instance.push.body.trace_approve_cc_submit', {\n      instance_name: instance_name,\n      from_username: from_username,\n      applicant_name: applicant_name,\n      final_decision: push_final_decision,\n      approve_type: push_approve_type,\n      current_user_name: current_user_name\n    }, lang);\n  } else if (\"auto_submit_pending_inbox\" === send_from) {\n    body[\"push\"] = TAPi18n.__('instance.push.body.auto_submit_pending_inbox', {\n      instance_name: instance_name,\n      current_step_name: current_step_name\n    }, lang);\n    body[\"email\"] = TAPi18n.__('instance.email.body.auto_submit_pending_inbox', {\n      instance_name: instance_name,\n      current_step_name: current_step_name,\n      to_username: to_username\n    }, lang);\n  } else if (\"return_pending_inbox\" === send_from) {\n    body[\"push\"] = TAPi18n.__('instance.push.body.return_pending_inbox', {\n      instance_name: instance_name,\n      current_step_name: current_step_name\n    }, lang);\n    body[\"email\"] = TAPi18n.__('instance.email.body.return_pending_inbox', {\n      instance_name: instance_name,\n      current_step_name: current_step_name,\n      to_username: to_username\n    }, lang);\n  }\n  return body;\n};\n\npushManager.get_title = function(parameters, lang) {\n  var applicant_name, approve_type, current_step_name, from_username, instance_name, nextApprove_usersname, nextStep_type, send_from, title;\n  if (lang == null) {\n    lang = \"zh-CN\";\n  }\n  send_from = parameters[\"send_from\"];\n  instance_name = parameters[\"instance_name\"];\n  from_username = parameters[\"from_username\"];\n  applicant_name = parameters[\"applicant_name\"];\n  current_step_name = parameters[\"current_step_name\"];\n  nextApprove_usersname = parameters[\"nextApprove_usersname\"];\n  nextStep_type = parameters[\"nextStep_type\"];\n  approve_type = null;\n  if (['submit', 'start'].includes(nextStep_type)) {\n    approve_type = TAPi18n.__('instance.email.title.input', {}, lang);\n  } else if (['sign', 'counterSign'].includes(nextStep_type)) {\n    approve_type = TAPi18n.__('instance.email.title.approval', {}, lang);\n  }\n  title = new Object;\n  if (\"first_submit_applicant\" === send_from) {\n    title[\"push\"] = TAPi18n.__('instance.push.title.first_submit_applicant', {\n      from_username: from_username,\n      instance_name: instance_name,\n      applicant_name: applicant_name\n    }, lang);\n    title[\"email\"] = TAPi18n.__('instance.email.title.first_submit_applicant', {\n      from_username: from_username,\n      instance_name: instance_name,\n      applicant_name: applicant_name\n    }, lang);\n  } else if (\"first_submit_inbox\" === send_from) {\n    title[\"push\"] = TAPi18n.__('instance.push.title.first_submit_inbox', {\n      from_username: from_username,\n      instance_name: instance_name,\n      applicant_name: applicant_name\n    }, lang);\n    title[\"email\"] = TAPi18n.__('instance.email.title.first_submit_inbox', {\n      from_username: from_username,\n      instance_name: instance_name,\n      applicant_name: applicant_name,\n      approve_type: approve_type\n    }, lang);\n  } else if (\"submit_completed_applicant\" === send_from) {\n    title[\"push\"] = TAPi18n.__('instance.push.title.submit_completed_applicant', {\n      from_username: from_username,\n      instance_name: instance_name,\n      applicant_name: applicant_name\n    }, lang);\n    title[\"email\"] = TAPi18n.__('instance.email.title.submit_completed_applicant', {\n      from_username: from_username,\n      instance_name: instance_name,\n      applicant_name: applicant_name\n    }, lang);\n  } else if (\"submit_completed_approve\" === send_from) {\n    title[\"push\"] = TAPi18n.__('instance.push.title.submit_completed_approve', {\n      from_username: from_username,\n      instance_name: instance_name,\n      applicant_name: applicant_name\n    }, lang);\n    title[\"email\"] = TAPi18n.__('instance.email.title.submit_completed_approve', {\n      from_username: from_username,\n      instance_name: instance_name,\n      applicant_name: applicant_name\n    }, lang);\n  } else if (\"submit_pending_rejected_applicant_inbox\" === send_from) {\n    title[\"push\"] = TAPi18n.__('instance.push.title.submit_pending_rejected_applicant_inbox', {\n      from_username: from_username,\n      instance_name: instance_name,\n      applicant_name: applicant_name\n    }, lang);\n    title[\"email\"] = TAPi18n.__('instance.email.title.submit_pending_rejected_applicant_inbox', {\n      from_username: from_username,\n      instance_name: instance_name,\n      applicant_name: applicant_name\n    }, lang);\n  } else if (\"submit_pending_rejected_applicant\" === send_from) {\n    title[\"push\"] = TAPi18n.__('instance.push.title.submit_pending_rejected_applicant', {\n      from_username: from_username,\n      instance_name: instance_name,\n      applicant_name: applicant_name,\n      nextApprove_usersname: nextApprove_usersname\n    }, lang);\n    title[\"email\"] = TAPi18n.__('instance.email.title.submit_pending_rejected_applicant', {\n      from_username: from_username,\n      instance_name: instance_name,\n      applicant_name: applicant_name,\n      nextApprove_usersname: nextApprove_usersname\n    }, lang);\n  } else if (\"submit_pending_rejected_approve\" === send_from) {\n    title[\"push\"] = TAPi18n.__('instance.push.title.submit_pending_rejected_approve', {\n      from_username: from_username,\n      instance_name: instance_name,\n      applicant_name: applicant_name\n    }, lang);\n    title[\"email\"] = TAPi18n.__('instance.email.title.submit_pending_rejected_approve', {\n      from_username: from_username,\n      instance_name: instance_name,\n      applicant_name: applicant_name,\n      current_user: current_user_name,\n      nextApprove_usersname: nextApprove_usersname,\n      current_step_name: current_step_name\n    }, lang);\n  } else if (\"submit_pending_rejected_inbox\" === send_from) {\n    title[\"push\"] = TAPi18n.__('instance.push.title.submit_pending_rejected_inbox', {\n      from_username: from_username,\n      instance_name: instance_name,\n      applicant_name: applicant_name\n    }, lang);\n    title[\"email\"] = TAPi18n.__('instance.email.title.submit_pending_rejected_inbox', {\n      from_username: from_username,\n      instance_name: instance_name,\n      applicant_name: applicant_name,\n      approve_type: approve_type\n    }, lang);\n  } else if (\"submit_pending_inbox\" === send_from) {\n    title[\"push\"] = TAPi18n.__('instance.push.title.submit_pending_inbox', {\n      from_username: from_username,\n      instance_name: instance_name,\n      applicant_name: applicant_name\n    }, lang);\n    title[\"email\"] = TAPi18n.__('instance.email.title.submit_pending_inbox', {\n      from_username: from_username,\n      instance_name: instance_name,\n      applicant_name: applicant_name,\n      approve_type: approve_type\n    }, lang);\n  } else if (\"submit_terminate_applicant\" === send_from) {\n    title[\"push\"] = TAPi18n.__('instance.push.title.submit_terminate_applicant', {\n      from_username: from_username,\n      instance_name: instance_name,\n      applicant_name: applicant_name\n    }, lang);\n    title[\"email\"] = TAPi18n.__('instance.email.title.submit_terminate_applicant', {\n      from_username: from_username,\n      instance_name: instance_name,\n      applicant_name: applicant_name\n    }, lang);\n  } else if (\"submit_terminate_approve\" === send_from) {\n    title[\"push\"] = TAPi18n.__('instance.push.title.submit_terminate_approve', {\n      from_username: from_username,\n      instance_name: instance_name,\n      applicant_name: applicant_name\n    }, lang);\n    title[\"email\"] = TAPi18n.__('instance.email.title.submit_terminate_approve', {\n      from_username: from_username,\n      instance_name: instance_name,\n      applicant_name: applicant_name\n    }, lang);\n  } else if (\"monitor_delete_applicant\" === send_from) {\n    title[\"push\"] = TAPi18n.__('instance.push.title.monitor_delete_applicant', {\n      from_username: from_username,\n      instance_name: instance_name,\n      applicant_name: applicant_name\n    }, lang);\n    title[\"email\"] = TAPi18n.__('instance.email.title.monitor_delete_applicant', {\n      from_username: from_username,\n      instance_name: instance_name,\n      applicant_name: applicant_name\n    }, lang);\n  } else if (\"approved_completed_applicant\" === send_from) {\n    title[\"push\"] = TAPi18n.__('instance.push.title.approved_completed_applicant', {\n      from_username: from_username,\n      instance_name: instance_name,\n      applicant_name: applicant_name\n    }, lang);\n    title[\"email\"] = TAPi18n.__('instance.email.title.approved_completed_applicant', {\n      from_username: from_username,\n      instance_name: instance_name,\n      applicant_name: applicant_name\n    }, lang);\n  } else if (\"approved_completed_approve\" === send_from) {\n    title[\"push\"] = TAPi18n.__('instance.push.title.approved_completed_approve', {\n      from_username: from_username,\n      instance_name: instance_name,\n      applicant_name: applicant_name\n    }, lang);\n    title[\"email\"] = TAPi18n.__('instance.email.title.approved_completed_approve', {\n      from_username: from_username,\n      instance_name: instance_name,\n      applicant_name: applicant_name\n    }, lang);\n  } else if (\"rejected_completed_applicant\" === send_from) {\n    title[\"push\"] = TAPi18n.__('instance.push.title.rejected_completed_applicant', {\n      from_username: from_username,\n      instance_name: instance_name,\n      applicant_name: applicant_name\n    }, lang);\n    title[\"email\"] = TAPi18n.__('instance.email.title.rejected_completed_applicant', {\n      from_username: from_username,\n      instance_name: instance_name,\n      applicant_name: applicant_name\n    }, lang);\n  } else if (\"rejected_completed_approve\" === send_from) {\n    title[\"push\"] = TAPi18n.__('instance.push.title.rejected_completed_approve', {\n      from_username: from_username,\n      instance_name: instance_name,\n      applicant_name: applicant_name\n    }, lang);\n    title[\"email\"] = TAPi18n.__('instance.email.title.rejected_completed_approve', {\n      from_username: from_username,\n      instance_name: instance_name,\n      applicant_name: applicant_name\n    }, lang);\n  } else if (\"reassign_new_inbox_users\" === send_from) {\n    title[\"push\"] = TAPi18n.__('instance.push.title.reassign_new_inbox_users', {\n      from_username: from_username,\n      instance_name: instance_name,\n      applicant_name: applicant_name,\n      approve_type: approve_type\n    }, lang);\n    title[\"email\"] = TAPi18n.__('instance.email.title.reassign_new_inbox_users', {\n      from_username: from_username,\n      instance_name: instance_name,\n      applicant_name: applicant_name,\n      approve_type: approve_type\n    }, lang);\n  } else if (\"trace_approve_cc\" === send_from) {\n    title[\"push\"] = TAPi18n.__('instance.push.title.trace_approve_cc', {\n      from_username: from_username,\n      instance_name: instance_name,\n      applicant_name: applicant_name\n    }, lang);\n    title[\"email\"] = TAPi18n.__('instance.email.title.trace_approve_cc', {\n      from_username: from_username,\n      instance_name: instance_name,\n      applicant_name: applicant_name,\n      approve_type: approve_type\n    }, lang);\n  } else if (\"trace_approve_cc_submit\" === send_from) {\n    title[\"push\"] = TAPi18n.__('instance.push.title.trace_approve_cc_submit', {\n      from_username: from_username,\n      instance_name: instance_name,\n      applicant_name: applicant_name\n    }, lang);\n  } else if (\"auto_submit_pending_inbox\" === send_from) {\n    title[\"push\"] = TAPi18n.__('instance.push.title.auto_submit_pending_inbox', {\n      from_username: from_username,\n      instance_name: instance_name,\n      applicant_name: applicant_name\n    }, lang);\n    title[\"email\"] = TAPi18n.__('instance.email.title.auto_submit_pending_inbox', {\n      from_username: from_username,\n      instance_name: instance_name,\n      applicant_name: applicant_name,\n      approve_type: approve_type\n    }, lang);\n  } else if (\"return_pending_inbox\" === send_from) {\n    title[\"push\"] = TAPi18n.__('instance.push.title.return_pending_inbox', {\n      from_username: from_username,\n      instance_name: instance_name,\n      applicant_name: applicant_name\n    }, lang);\n    title[\"email\"] = TAPi18n.__('instance.email.title.return_pending_inbox', {\n      from_username: from_username,\n      instance_name: instance_name,\n      applicant_name: applicant_name,\n      approve_type: approve_type\n    }, lang);\n  }\n  return title;\n};\n\npushManager.getSmsBody = function(parameters, lang) {\n  if (lang == null) {\n    lang = \"zh-CN\";\n  }\n  return TAPi18n.__('instance.sms.submit_pending_inbox', parameters, lang);\n};\n\npushManager.get_badge = function(send_from, user_id) {\n  var badge, sk_all, sk_all_new, user_spaces;\n  if (!['first_submit_inbox', 'submit_pending_rejected_inbox', 'submit_pending_inbox', 'current_user', 'terminate_approval', 'reassign_new_inbox_users', 'trace_approve_cc', 'trace_approve_cc_submit', 'auto_submit_pending_inbox', 'return_pending_inbox'].includes(send_from)) {\n    return null;\n  }\n  if (!user_id) {\n    console.log('pushManager.get_badge: send_from is ', send_from);\n    return null;\n  }\n  badge = 0;\n  user_spaces = db.space_users.find({\n    user: user_id,\n    user_accepted: true\n  }, {\n    fields: {\n      space: 1\n    }\n  });\n  user_spaces.forEach(function(user_space) {\n    var appCategories, c, categories, ref4, sk, sk_new, spaceId;\n    spaceId = user_space.space;\n    categories = db.categories.find({\n      space: spaceId,\n      app: {\n        $ne: null\n      }\n    }).fetch();\n    if (categories.length > 0) {\n      appCategories = _.groupBy(categories, 'app');\n      _.each(appCategories, function(categorys, appName) {\n        var _set, appKeyValue, appKeyValueNew, categoryBadge, categoryForms, categoryFormsIds, categorysIds, ref4;\n        categorysIds = _.pluck(categorys, '_id');\n        if (appName) {\n          categoryFormsIds = [];\n          categoryForms = db.forms.find({\n            category: {\n              $in: categorysIds\n            }\n          }, {\n            fields: {\n              _id: 1\n            }\n          }).fetch();\n          if (categoryForms.length > 0) {\n            categoryFormsIds = categoryForms.getProperty('_id');\n          }\n          if (categoryFormsIds.length > 0) {\n            categoryBadge = db.instances.find({\n              space: user_space.space,\n              form: {\n                $in: categoryFormsIds\n              },\n              $or: [\n                {\n                  inbox_users: user_id\n                }, {\n                  cc_users: user_id\n                }\n              ]\n            }, {\n              fields: {\n                _id: 1\n              }\n            }).count();\n            appKeyValue = db.steedos_keyvalues.findOne({\n              user: user_id,\n              space: user_space.space,\n              key: 'badge'\n            }, {\n              fields: {\n                _id: 1,\n                value: 1\n              }\n            });\n            if (appKeyValue) {\n              if (((ref4 = appKeyValue.value) != null ? ref4[appName] : void 0) !== categoryBadge) {\n                _set = {};\n                _set['value.' + appName] = categoryBadge;\n                return db.steedos_keyvalues.update({\n                  _id: appKeyValue._id\n                }, {\n                  $set: _set\n                });\n              }\n            } else {\n              appKeyValueNew = {};\n              appKeyValueNew.user = user_id;\n              appKeyValueNew.space = user_space.space;\n              appKeyValueNew.key = 'badge';\n              appKeyValueNew.value = {};\n              appKeyValueNew.value[appName] = categoryBadge;\n              return db.steedos_keyvalues.insert(appKeyValueNew);\n            }\n          }\n        }\n      });\n    }\n    c = db.instances.find({\n      space: user_space.space,\n      $or: [\n        {\n          inbox_users: user_id\n        }, {\n          cc_users: user_id\n        }\n      ]\n    }, {\n      fields: {\n        _id: 1\n      }\n    }).count();\n    badge += c;\n    sk = db.steedos_keyvalues.findOne({\n      user: user_id,\n      space: user_space.space,\n      key: 'badge'\n    }, {\n      fields: {\n        _id: 1,\n        value: 1\n      }\n    });\n    if (sk) {\n      if (((ref4 = sk.value) != null ? ref4.workflow : void 0) !== c) {\n        return db.steedos_keyvalues.update({\n          _id: sk._id\n        }, {\n          $set: {\n            'value.workflow': c\n          }\n        });\n      }\n    } else {\n      sk_new = {};\n      sk_new.user = user_id;\n      sk_new.space = user_space.space;\n      sk_new.key = 'badge';\n      sk_new.value = {\n        'workflow': c\n      };\n      return db.steedos_keyvalues.insert(sk_new);\n    }\n  });\n  sk_all = db.steedos_keyvalues.findOne({\n    user: user_id,\n    space: null,\n    key: 'badge'\n  }, {\n    fields: {\n      _id: 1\n    }\n  });\n  if (sk_all) {\n    db.steedos_keyvalues.update({\n      _id: sk_all._id\n    }, {\n      $set: {\n        'value.workflow': badge\n      }\n    });\n  } else {\n    sk_all_new = {};\n    sk_all_new.user = user_id;\n    sk_all_new.space = null;\n    sk_all_new.key = 'badge';\n    sk_all_new.value = {\n      'workflow': badge\n    };\n    db.steedos_keyvalues.insert(sk_all_new);\n  }\n  return badge;\n};\n\npushManager.send_to_qq = function(to_user, from_user, space_id, instance_id, instance_state, body, i18n_obj) {\n  var app_id, box, bqq_uri, e, employee_access_token, oauth, open_id, recv_open_ids, response, space, tips_url;\n  try {\n    if ((!to_user.services) || (!to_user.services['bqq']) || (!to_user.services['bqq']['id'])) {\n      return;\n    }\n    space = db.spaces.findOne({\n      _id: space_id,\n      \"services.bqq.company_id\": {\n        $ne: null\n      }\n    }, {\n      fields: {\n        services: 1\n      }\n    });\n    if (!space) {\n      return;\n    }\n    app_id = this.bqq_app_id;\n    open_id = from_user.services['bqq']['id'];\n    employee_access_token = from_user.services['bqq']['accessToken'];\n    recv_open_ids = to_user.services['bqq']['id'];\n    oauth = space['services']['bqq'];\n    box = \"inbox\";\n    if (instance_state === \"completed\") {\n      box = \"completed\";\n    }\n    tips_url = '/workflow/space/' + space_id + '/' + box + '/' + instance_id;\n    bqq_uri = encodeURI('https://openapi.b.qq.com/api/combomsg/send?company_id=' + oauth['company_id'] + '&company_token=' + oauth['company_token'] + '&app_id=' + app_id + '&client_ip=0.0.0.0' + '&oauth_version=2' + '&employee_access_token=' + employee_access_token + '&brief=' + body['alert'] + '&url=' + tips_url + '&type=picture' + '&title=' + body['alert'] + '&summary=' + body['alertTitle'] + '&recv_open_ids=' + recv_open_ids + '&open_id=' + open_id);\n    response = HTTP.post(bqq_uri);\n    if (response.data.ret > 0) {\n      console.error(response.data.msg);\n    }\n  } catch (error) {\n    e = error;\n    return console.error(e.stack);\n  }\n};\n\npushManager.send_email_to_SMTP = function(subject, content, to_user, reply_user) {\n  var e;\n  if (to_user.email && to_user.email_verified && to_user.email_notification) {\n    try {\n      return MailQueue.send({\n        to: to_user.email,\n        from: pushManager.checkMailFromNameLength(reply_user.name) + ' on ' + Meteor.settings.email.from,\n        subject: subject,\n        html: content\n      });\n    } catch (error) {\n      e = error;\n      return console.error(e.stack);\n    }\n  }\n};\n\npushManager.checkMailFromNameLength = function(name) {\n  if (name.length <= 18) {\n    return name;\n  } else {\n    return name.substr(0, 18) + '...';\n  }\n};\n\npushManager.send_message_by_raix_push = function(data) {\n  var e, notification, payload;\n  if (!data[\"data\"]) {\n    return;\n  }\n  try {\n    notification = new Object;\n    notification[\"createdAt\"] = new Date;\n    notification[\"createdBy\"] = '<SERVER>';\n    notification[\"from\"] = data[\"pushTopic\"];\n    notification['title'] = data[\"data\"][\"alertTitle\"] ? data[\"data\"][\"alertTitle\"] : \"\";\n    notification['text'] = data[\"data\"][\"alert\"] ? data[\"data\"][\"alert\"] : \"\";\n    if (data[\"data\"][\"space_id\"] && data[\"data\"][\"instance_id\"]) {\n      payload = new Object;\n      payload[\"space\"] = data[\"data\"][\"space_id\"];\n      payload[\"instance\"] = data[\"data\"][\"instance_id\"];\n      payload[\"host\"] = Meteor.absoluteUrl().substr(0, Meteor.absoluteUrl().length - 1);\n      notification[\"payload\"] = payload;\n    }\n    if (data[\"data\"][\"badge\"] > -1) {\n      notification['badge'] = data[\"data\"][\"badge\"];\n    }\n    return _.each(data[\"toUsers\"], function(u) {\n      var user;\n      user = db.users.findOne({\n        steedos_id: u\n      }, {\n        fields: {\n          _id: 1\n        }\n      });\n      if (user) {\n        notification['query'] = {\n          userId: user._id,\n          appName: data[\"pushTopic\"]\n        };\n        return Push.send(notification);\n      }\n    });\n  } catch (error) {\n    e = error;\n    return console.error(e.stack);\n  }\n};\n\npushManager.send_message = function(steedos_ids, body, current_user_info) {\n  var data;\n  if (!steedos_ids || !(steedos_ids instanceof Array)) {\n    return;\n  }\n  data = new Object;\n  data[\"toUsers\"] = steedos_ids;\n  data[\"pushTopic\"] = 'workflow';\n  if (body) {\n    data[\"data\"] = body;\n  }\n  return pushManager.send_message_by_raix_push(data);\n};\n\npushManager.send_to_sms = function(to_user, message, current_user_info, spaceId) {\n  var ref4, ref5, spaceUser;\n  if (((ref4 = Meteor.settings) != null ? (ref5 = ref4.workflow) != null ? ref5.sms_notification : void 0 : void 0) && (to_user != null ? to_user.mobile : void 0) && (to_user != null ? to_user.mobile_verified : void 0)) {\n    spaceUser = db.space_users.findOne({\n      user: to_user._id,\n      space: spaceId\n    }, {\n      fields: {\n        sms_notification: 1\n      }\n    });\n    if (spaceUser != null ? spaceUser.sms_notification : void 0) {\n      return SMSQueue.send({\n        RecNum: to_user.mobile,\n        msg: message,\n        createdBy: current_user_info._id\n      }, spaceId);\n    }\n  }\n};\n\npushManager.send_instance_notification = function(send_from, instance, description, current_user_info, cc_user_ids) {\n  var _approves_des, _approves_username, approve, approves_description, body_style_end, body_style_start, current_step, current_step_name, e, flow, flow_version, from_user, href, instance_id, lastApprove_judge, lastApprove_usersname, nextApprove_usersname, nextStep_type, parameters, space_id, to_user_change, to_users, trace;\n  try {\n    space_id = instance.space;\n    instance_id = instance._id;\n    flow_version = instance.flow_version;\n    flow = uuflowManager.getFlow(instance.flow);\n    to_users = pushManager.get_to_users(send_from, instance, cc_user_ids, current_user_info);\n    href = Meteor.absoluteUrl() + (\"workflow/space/\" + space_id + \"/inbox/\" + instance_id);\n    body_style_start = \"<div style='border:1px solid #bbb;padding:10px;'>\";\n    body_style_end = \"</div>\";\n    current_step_name = instance.current_step_name;\n    nextApprove_usersname = null;\n    if (['submit_pending_rejected_approve', 'submit_pending_rejected_applicant'].includes(send_from)) {\n      trace = _.find(instance.traces, function(t) {\n        return t.is_finished === false;\n      });\n      approve = _.find(trace.approves, function(a) {\n        return a.is_finished === false;\n      });\n      nextApprove_usersname = approve.user_name;\n    }\n    nextStep_type = uuflowManager.getStep(instance, flow, instance.traces[instance.traces.length - 1].step).step_type;\n    lastApprove_judge = instance.traces[instance.traces.length - 2].approves[0].judge;\n    _approves_username = new Array;\n    _.each(instance.traces[instance.traces.length - 2].approves, function(appr) {\n      return _approves_username.push(appr.handler_name);\n    });\n    lastApprove_usersname = _approves_username.join(\",\");\n    current_step = uuflowManager.getStep(instance, flow, instance.traces[instance.traces.length - 2].step);\n    approves_description = null;\n    _approves_des = null;\n    if (['reassign_new_inbox_users', 'submit_completed_applicant', 'approved_completed_applicant', 'first_submit_applicant', 'first_submit_inbox', 'submit_pending_inbox'].includes(send_from)) {\n      approves_description = instance.traces[instance.traces.length - 2].approves[0].description;\n      if (current_step.step_type === \"counterSign\" && (\"submit_completed_applicant\" === send_from || \"submit_pending_inbox\" === send_from)) {\n        to_user_change = 'en';\n        if (to_users[0].locale === 'zh-cn') {\n          to_user_change = 'zh-CN';\n        }\n        _.each(instance.traces[instance.traces.length - 2].approves, function(appr) {\n          var _appr_description, _appr_userName, br;\n          _appr_description = appr.description;\n          _appr_userName = appr.user_name;\n          br = '<br/>';\n          if (appr.judge === \"approved\") {\n            return _approves_des = _appr_userName + \" : \" + TAPi18n.__('instance.judge.approved', {}, to_user_change) + \",\" + _appr_description + br;\n          } else if (appr.judge === \"rejected\") {\n            return _approves_des = _appr_userName + \" : \" + TAPi18n.__('instance.judge.rejected', {}, to_user_change) + \",\" + _appr_description + br;\n          }\n        });\n        approves_description = _approves_des;\n      }\n    }\n    from_user = current_user_info;\n    if (['reassign_new_inbox_users', 'first_submit_inbox', 'submit_pending_rejected_inbox', 'submit_pending_inbox', 'submit_completed_approve', 'submit_pending_rejected_approve', 'submit_terminate_approve', 'approved_completed_approve', 'rejected_completed_approve'].includes(send_from)) {\n      from_user = db.users.findOne(instance.applicant);\n    }\n    parameters = new Object;\n    parameters[\"send_from\"] = send_from;\n    parameters[\"applicant_name\"] = instance.applicant_name;\n    parameters[\"instance_name\"] = instance.name;\n    parameters[\"href\"] = href;\n    parameters[\"final_decision\"] = instance.final_decision;\n    parameters[\"description\"] = description;\n    parameters[\"state\"] = instance.state;\n    parameters[\"from_username\"] = from_user.name;\n    parameters[\"current_step_name\"] = current_step_name;\n    parameters[\"nextApprove_usersname\"] = nextApprove_usersname;\n    parameters[\"nextStep_type\"] = nextStep_type;\n    parameters[\"approves_description\"] = approves_description;\n    parameters[\"lastApprove_judge\"] = lastApprove_judge;\n    parameters[\"lastApprove_usersname\"] = lastApprove_usersname;\n    parameters[\"current_user_name\"] = current_user_info.name;\n    parameters[\"currentStep_type\"] = current_step.step_type;\n    return _.each(to_users, function(to_user) {\n      var badge, body, content, e, footnote, ins_html, inscribed, lang, push_body, title;\n      lang = 'en';\n      if (to_user.locale === 'zh-cn') {\n        lang = 'zh-CN';\n      }\n      inscribed = TAPi18n.__('instance.email.inscribed', {}, lang);\n      footnote = \"<p style='text-align:left;color:#bbb;'>\" + TAPi18n.__('instance.email.footnote', {}, lang) + \"</p>\";\n      if (db.space_users.find({\n        space: space_id,\n        user: to_user._id\n      }).count() === 0) {\n        return;\n      }\n      if (db.users.find(to_user._id).count() === 0) {\n        return;\n      }\n      parameters[\"to_username\"] = to_user.name;\n      ins_html = '';\n      if (['first_submit_inbox', 'submit_pending_inbox', 'submit_pending_rejected_inbox', 'submit_pending_rejected_applicant_inbox', 'reassign_new_inbox_users', 'trace_approve_cc', 'auto_submit_pending_inbox'].includes(send_from)) {\n        if (current_user_info.email && current_user_info.email_notification) {\n          try {\n            ins_html = uuflowManager.ins_html(current_user_info, instance);\n          } catch (error) {\n            e = error;\n            console.error(e);\n          }\n        }\n      }\n      body = pushManager.get_body(parameters, lang);\n      title = pushManager.get_title(parameters, lang);\n      badge = pushManager.get_badge(send_from, to_user._id);\n      push_body = new Object;\n      push_body[\"alertTitle\"] = title[\"push\"];\n      push_body[\"alert\"] = body[\"push\"];\n      push_body[\"space_id\"] = space_id;\n      push_body[\"instance_id\"] = instance_id;\n      if (badge) {\n        push_body[\"badge\"] = badge;\n      }\n      push_body[\"sound\"] = \"default\";\n      content = body_style_start + body[\"email\"] + inscribed + ins_html + body_style_end + footnote;\n      pushManager.send_email_to_SMTP(title[\"email\"], content, to_user, from_user);\n      pushManager.send_message([to_user.steedos_id], push_body, current_user_info);\n      if (['reassign_new_inbox_users', 'submit_pending_rejected_applicant_inbox', 'submit_pending_rejected_inbox', 'submit_pending_inbox', 'first_submit_inbox', 'return_pending_inbox'].includes(send_from)) {\n        pushManager.send_to_sms(to_user, pushManager.getSmsBody(parameters, lang), current_user_info, space_id);\n      }\n      return pushManager.send_to_qq(to_user, from_user, space_id, instance_id, instance.state, push_body, lang);\n    });\n  } catch (error) {\n    e = error;\n    return console.error(e.stack);\n  }\n};\n\npushManager.send_message_current_user = function(user_info) {\n  var badge, e, push_body;\n  try {\n    badge = this.get_badge(\"current_user\", user_info._id);\n    push_body = new Object;\n    push_body[\"badge\"] = badge;\n    return this.send_message([user_info.steedos_id], push_body, user_info);\n  } catch (error) {\n    e = error;\n    return console.error(e.stack);\n  }\n};\n\npushManager.send_message_to_specifyUser = function(send_from, to_user) {\n  var badge, e, push_body, user_info;\n  try {\n    badge = this.get_badge(send_from, to_user);\n    push_body = new Object;\n    push_body[\"badge\"] = badge;\n    user_info = db.users.findOne({\n      _id: to_user\n    });\n    if (user_info) {\n      return this.send_message([user_info.steedos_id], push_body, user_info);\n    }\n  } catch (error) {\n    e = error;\n    return console.error(e.stack);\n  }\n};\n\npushManager.triggerWebhook = function(flow_id, instance, current_approve, action, from_user_id, to_user_ids) {\n  var from_space_user, from_user, to_users;\n  instance.attachments = cfs.instances.find({\n    'metadata.instance': instance._id\n  }).fetch();\n  from_user = db.users.findOne({\n    \"_id\": from_user_id\n  }, {\n    fields: {\n      _id: 1,\n      username: 1\n    }\n  });\n  from_space_user = db.space_users.findOne({\n    \"user\": from_user_id\n  }, {\n    fields: {\n      mobile: 1,\n      email: 1\n    }\n  });\n  if (from_user != null) {\n    from_user.mobile = (from_space_user != null ? from_space_user.mobile : void 0) || \"\";\n  }\n  if (from_user != null) {\n    from_user.email = (from_space_user != null ? from_space_user.email : void 0) || \"\";\n  }\n  if (to_user_ids.length > 0) {\n    to_users = db.users.find({\n      \"_id\": {\n        $in: to_user_ids\n      }\n    }, {\n      fields: {\n        _id: 1,\n        username: 1\n      }\n    }).fetch();\n    to_users.forEach(function(to_user) {\n      var to_space_user;\n      to_space_user = db.space_users.findOne({\n        \"user\": to_user._id\n      }, {\n        fields: {\n          mobile: 1,\n          email: 1\n        }\n      });\n      if (to_user != null) {\n        to_user.mobile = (to_space_user != null ? to_space_user.mobile : void 0) || \"\";\n      }\n      return to_user != null ? to_user.email = (to_space_user != null ? to_space_user.email : void 0) || \"\" : void 0;\n    });\n  }\n  return db.webhooks.find({\n    flow: {\n      $in: [flow_id, null]\n    },\n    active: true\n  }).forEach(function(w) {\n    return WebhookQueue.send({\n      instance: instance,\n      current_approve: current_approve,\n      payload_url: w.payload_url,\n      content_type: w.content_type,\n      action: action,\n      from_user: from_user,\n      to_users: to_users || []\n    });\n  });\n};\n","steedosExport = {}\n\n_getFlowByForm = (form, flowId, is_copy, company_id)->\n\n\tquery = {form: form}\n\n\tif flowId\n\t\tquery._id = flowId\n\n\tfields = {history: 0}\n\n\tflows = db.flows.find(query, fields).fetch();\n\n\tflows.forEach (flow) ->\n\t\tflow.historys = []\n\t\tflow.object_workflows = Creator.getCollection(\"object_workflows\").find({flow_id: flow._id}, {fields: {name: 1, object_name: 1, flow_id: 1, field_map: 1, field_map_back: 1, field_map_script: 1, field_map_back_script: 1, sync_attachment: 1}}).fetch();\n\t\tif !is_copy || (!company_id && flow.company_id) || (company_id && !flow.company_id) || (company_id != flow.company_id)\n\t\t\tflow.current.steps?.forEach (step) ->\n\t\t\t\troles_name = []\n\t\t\t\troles_api_name = []\n\t\t\t\tif !_.isEmpty(step.approver_roles)\n\t\t\t\t\troles = db.flow_roles.find({_id: {$in: step.approver_roles}}, {fields: {name: 1, api_name: 1 }}).fetch();\n\t\t\t\t\troles_name = _.pluck(roles, 'name');\n\t\t\t\t\troles_api_name = _.pluck(roles, 'api_name');\n\n\t\t\t\tstep.approver_roles_name = roles_name\n\t\t\t\tstep.approver_roles_api_name = roles_api_name\n\n\t\t\t\thr_roles_name = []\n\t\t\t\thr_roles_api_name = []\n\t\t\t\tif !_.isEmpty(step.approver_hr_roles)\n\t\t\t\t\thrRoles = db.roles.find({_id: {$in: step.approver_hr_roles}}, {fields: {name: 1, api_name: 1}}).fetch();\n\t\t\t\t\thr_roles_name = _.pluck(hrRoles, 'name');\n\t\t\t\t\thr_roles_api_name = _.pluck(hrRoles, 'api_name');\n\t\t\t\tstep.approver_hr_roles_name = hr_roles_name\n\t\t\t\tstep.approver_hr_roles_api_name = hr_roles_api_name\n\n#\t\t\t\tstep.approver_users = []\n#\n#\t\t\t\tstep.approver_orgs = []\n\n#\t\tif !is_copy || (!company_id && flow.company_id) || (company_id && !flow.company_id) || (company_id != flow.company_id)\n#\t\t\tdelete flow.perms\n\n\treturn flows;\n\n###\n    获取form对象\n\n    category: form的分组名次\n\n    form：不包含历史版本\n\n    instance_number_rules: 表单字段所引用的编号规则\n\n    flows: 引用此表单的所有流程，不包含历史版本\n###\nsteedosExport.form = (formId, flowId, is_copy, company_id) ->\n\tform = db.forms.findOne({_id: formId}, {fields: {historys: 0}});\n\n\tif !form\n\t\treturn {}\n\n\tform.historys = []\n\n\tif form?.category\n\t\tcategory = db.categories.findOne({_id: form.category}, {fields: {name: 1}});\n\n\t\tif category?.name\n\t\t\tform.category_name = category.name\n\n\t_getNumberRuleName = (str)->\n\t\tif _.isString(str) && str?.indexOf(\"auto_number(\") > -1\n\t\t\tstr = str.replace(\"auto_number(\", \"\").replace(\")\", \"\").replace(\"\\\"\", \"\").replace(\"\\\"\", \"\").replace(\"\\'\", \"\").replace(\"\\'\", \"\")\n\t\t\treturn str\n\t\treturn ;\n\n\tinstance_number_rules = new Array()\n\n\tif form.current\n\n\t\tfields = new Array()\n\n\t\tc_fields = form.current.fields\n\n\t\tc_fields?.forEach (f)->\n\t\t\tif f.type == 'table'\n\t\t\t\tconsole.log 'ignore table field'\n\t\t\telse if f.type == 'section'\n\t\t\t\tf?.fields?.forEach (f1)->\n\t\t\t\t\tfields.push f1\n\t\t\telse\n\t\t\t\tfields.push f\n\n\t\t_getFieldNumberRule = (spaceId, instance_number_rules, str)->\n\t\t\tnumber_rule_name = _getNumberRuleName(str)\n\n\t\t\tif number_rule_name\n\t\t\t\tnumber_rule = db.instance_number_rules.findOne({space: spaceId, name: number_rule_name}, {fields: {_id: 1, name: 1, year: 1, first_number: 1, rules: 1}})\n\t\t\t\tif !number_rule\n\t\t\t\t\tthrow new Error('not find instance number rule, name is ' + number_rule_name);\n\t\t\t\tnumber_rule.number = 0\n\n\t\t\t\tif !instance_number_rules.findPropertyByPK(\"_id\", number_rule._id)\n\n\t\t\t\t\tdelete number_rule._id\n\n\t\t\t\t\tinstance_number_rules.push(number_rule)\n\n\t\t\treturn instance_number_rules\n\n\n\t\tfields.forEach (f)->\n\t\t\t_getFieldNumberRule(form.space, instance_number_rules, f.default_value)\n\n\t\t\t_getFieldNumberRule(form.space, instance_number_rules, f.formula)\n\n\tform.instance_number_rules = instance_number_rules\n\n\tform.flows = _getFlowByForm(formId, flowId, is_copy, company_id)\n\n\treturn form","var _getFlowByForm;               \n\nsteedosExport = {};\n\n_getFlowByForm = function(form, flowId, is_copy, company_id) {\n  var fields, flows, query;\n  query = {\n    form: form\n  };\n  if (flowId) {\n    query._id = flowId;\n  }\n  fields = {\n    history: 0\n  };\n  flows = db.flows.find(query, fields).fetch();\n  flows.forEach(function(flow) {\n    var ref;\n    flow.historys = [];\n    flow.object_workflows = Creator.getCollection(\"object_workflows\").find({\n      flow_id: flow._id\n    }, {\n      fields: {\n        name: 1,\n        object_name: 1,\n        flow_id: 1,\n        field_map: 1,\n        field_map_back: 1,\n        field_map_script: 1,\n        field_map_back_script: 1,\n        sync_attachment: 1\n      }\n    }).fetch();\n    if (!is_copy || (!company_id && flow.company_id) || (company_id && !flow.company_id) || (company_id !== flow.company_id)) {\n      return (ref = flow.current.steps) != null ? ref.forEach(function(step) {\n        var hrRoles, hr_roles_api_name, hr_roles_name, roles, roles_api_name, roles_name;\n        roles_name = [];\n        roles_api_name = [];\n        if (!_.isEmpty(step.approver_roles)) {\n          roles = db.flow_roles.find({\n            _id: {\n              $in: step.approver_roles\n            }\n          }, {\n            fields: {\n              name: 1,\n              api_name: 1\n            }\n          }).fetch();\n          roles_name = _.pluck(roles, 'name');\n          roles_api_name = _.pluck(roles, 'api_name');\n        }\n        step.approver_roles_name = roles_name;\n        step.approver_roles_api_name = roles_api_name;\n        hr_roles_name = [];\n        hr_roles_api_name = [];\n        if (!_.isEmpty(step.approver_hr_roles)) {\n          hrRoles = db.roles.find({\n            _id: {\n              $in: step.approver_hr_roles\n            }\n          }, {\n            fields: {\n              name: 1,\n              api_name: 1\n            }\n          }).fetch();\n          hr_roles_name = _.pluck(hrRoles, 'name');\n          hr_roles_api_name = _.pluck(hrRoles, 'api_name');\n        }\n        step.approver_hr_roles_name = hr_roles_name;\n        return step.approver_hr_roles_api_name = hr_roles_api_name;\n      }) : void 0;\n    }\n  });\n  return flows;\n};\n\n\n/*\n    获取form对象\n\n    category: form的分组名次\n\n    form：不包含历史版本\n\n    instance_number_rules: 表单字段所引用的编号规则\n\n    flows: 引用此表单的所有流程，不包含历史版本\n */\n\nsteedosExport.form = function(formId, flowId, is_copy, company_id) {\n  var _getFieldNumberRule, _getNumberRuleName, c_fields, category, fields, form, instance_number_rules;\n  form = db.forms.findOne({\n    _id: formId\n  }, {\n    fields: {\n      historys: 0\n    }\n  });\n  if (!form) {\n    return {};\n  }\n  form.historys = [];\n  if (form != null ? form.category : void 0) {\n    category = db.categories.findOne({\n      _id: form.category\n    }, {\n      fields: {\n        name: 1\n      }\n    });\n    if (category != null ? category.name : void 0) {\n      form.category_name = category.name;\n    }\n  }\n  _getNumberRuleName = function(str) {\n    if (_.isString(str) && (str != null ? str.indexOf(\"auto_number(\") : void 0) > -1) {\n      str = str.replace(\"auto_number(\", \"\").replace(\")\", \"\").replace(\"\\\"\", \"\").replace(\"\\\"\", \"\").replace(\"\\'\", \"\").replace(\"\\'\", \"\");\n      return str;\n    }\n  };\n  instance_number_rules = new Array();\n  if (form.current) {\n    fields = new Array();\n    c_fields = form.current.fields;\n    if (c_fields != null) {\n      c_fields.forEach(function(f) {\n        var ref;\n        if (f.type === 'table') {\n          return console.log('ignore table field');\n        } else if (f.type === 'section') {\n          return f != null ? (ref = f.fields) != null ? ref.forEach(function(f1) {\n            return fields.push(f1);\n          }) : void 0 : void 0;\n        } else {\n          return fields.push(f);\n        }\n      });\n    }\n    _getFieldNumberRule = function(spaceId, instance_number_rules, str) {\n      var number_rule, number_rule_name;\n      number_rule_name = _getNumberRuleName(str);\n      if (number_rule_name) {\n        number_rule = db.instance_number_rules.findOne({\n          space: spaceId,\n          name: number_rule_name\n        }, {\n          fields: {\n            _id: 1,\n            name: 1,\n            year: 1,\n            first_number: 1,\n            rules: 1\n          }\n        });\n        if (!number_rule) {\n          throw new Error('not find instance number rule, name is ' + number_rule_name);\n        }\n        number_rule.number = 0;\n        if (!instance_number_rules.findPropertyByPK(\"_id\", number_rule._id)) {\n          delete number_rule._id;\n          instance_number_rules.push(number_rule);\n        }\n      }\n      return instance_number_rules;\n    };\n    fields.forEach(function(f) {\n      _getFieldNumberRule(form.space, instance_number_rules, f.default_value);\n      return _getFieldNumberRule(form.space, instance_number_rules, f.formula);\n    });\n  }\n  form.instance_number_rules = instance_number_rules;\n  form.flows = _getFlowByForm(formId, flowId, is_copy, company_id);\n  return form;\n};\n","objectql = require(\"@steedos/objectql\");\n\nsteedosImport = {}\n\n_formatFieldsID = (fields)->\n\t_.each(fields,  (f)->\n\t\tif (!f._id && f.id)\n\t\t\tf._id = f.id;\n\t\t\tdelete f.id;\n\t\t\tif (f.type == 'section' || f.type == 'table')\n\t\t\t\t_formatFieldsID(f.fields);\n\t);\n\treturn fields;\n\nupgradeFlowByForm = (flow, formVersionId, options)->\n\tflowCollection = Creator.getCollection('flows');\n\tup = false;\n\tnow = options.now\n\tcurrentUserId = options.currentUserId\n\tspaceId = options.spaceId\n\tif (Creator.getCollection('instances').find({\n\t\tspace: spaceId,\n\t\tflow: flow._id,\n\t\tflow_version: flow.current._id\n\t}).count())\n\t\tup = true;\n\n\tflowUpdateObj = {\n\t\t$set: {}\n\t};\n\n\tif up == true && flow.current.start_date\n\t\tflowUpdateObj.$push = {\n\t\t\t'historys': flow.current\n\t\t};\n\n\t\tflowCurrent = {\n\t\t\t'_id': flowCollection._makeNewID(),\n\t\t\t'created': now,\n\t\t\t'created_by': currentUserId,\n\t\t\t'steps': flow.current.steps,\n\t\t\t'_rev': flow.current._rev + 1,\n\t\t\t'flow': flow._id,\n\t\t\t'form_version': formVersionId,\n\t\t\t'modified': now,\n\t\t\t'modified_by': currentUserId\n\t\t};\n\n\t\tif flow.state == \"enabled\"\n\t\t\tflowCurrent.start_date = now;\n\t\tflowUpdateObj.$set['current'] = flowCurrent;\n\telse\n\t\tflowUpdateObj.$set = {\n\t\t\t'current.form_version': formVersionId,\n\t\t\t'current.modified': now,\n\t\t\t'current.modified_by': currentUserId\n\t\t}\n\n\tflowUpdateObj.$set['modified'] = now;\n\tflowUpdateObj.$set['modified_by'] = currentUserId;\n\tflowCollection.update(flow._id, flowUpdateObj);\n\nupgradeForm = (formId, form, currentUserId, spaceId)->\n\tformCollection = Creator.getCollection('forms');\n\tflowCollection = Creator.getCollection('flows');\n\tff = formCollection.findOne({_id: formId, space: spaceId});\n\n\tif !ff\n\t\tthrow new Meteor.Error('error', \"无效的formId\")\n\n\tspaceId = ff.space;\n\tnow = new Date();\n\tcurrent = {};\n\tformUpdateObj = {};\n\n\tpass = false;\n\n\t# 根据APP 判断表单当前版本是否走过申请单 或者 records\n\tif ff.app == 'workflow'\n\t\tinsCount = Creator.getCollection('instances').find({\n\t\t\tspace: spaceId,\n\t\t\tform: formId,\n\t\t\t'form_version': form['current']['id']\n\t\t}).count();\n\n\t\tif insCount > 0\n\t\t\tpass = true\n\telse if ff.app == 'creator'\n\t\trecordsCount = Creator.getCollection('records').find({\n\t\t\tspace: spaceId,\n\t\t\tform: formId,\n\t\t\t'form_version': form['current']['id']\n\t\t}).count();\n\t\tif recordsCount > 0\n\t\t\tpass = true;\n\n\tif pass == true && ff[\"current\"][\"start_date\"]\n\t\tformUpdateObj.$push = {\n\t\t\t'historys': ff[\"current\"]\n\t\t};\n\t\tcurrent._id = formCollection._makeNewID();\n\t\tcurrent._rev = ff[\"current\"][\"_rev\"] + 1;\n\t\tcurrent.created = now;\n\t\tcurrent.created_by = currentUserId;\n\n\t\tif ff.state == 'enabled'\n\t\t\tcurrent.start_date = now;\n\t\tflowCollection.find({form: formId}).forEach (flow)->\n\t\t\tupgradeFlowByForm(flow, current._id, {now: now, currentUserId: currentUserId, spaceId: spaceId})\n\n\telse\n\t\tcurrent = ff.current;\n\n\tcurrent.modified = now;\n\tcurrent.modified_by = currentUserId;\n\tcurrent.form = formId;\n\tcurrent.fields = _formatFieldsID(form[\"current\"][\"fields\"]);\n\tcurrent.form_script = form[\"current\"][\"form_script\"];\n\tcurrent.name_forumla = form[\"current\"][\"name_forumla\"];\n\n\tformUpdateObj.$set = {\n\t\t'current': current,\n\t\t'name': form[\"name\"],\n\t\t'modified': now,\n\t\t'modified_by': currentUserId,\n\t\t'is_valid': form[\"is_valid\"],\n\t\t'description': form[\"description\"],\n\t\t'help_text': form[\"help_text\"],\n\t\t'error_message': form[\"error_message\"],\n\t\t'category': form[\"category\"],\n\t\t'instance_style': form[\"instance_style\"]\n\t}\n\n\tformCollection.update(formId, formUpdateObj);\n\nupgradeFlow = (flowCome, userId, flowId)->\n\n\tnow = new Date();\n\tflowCollection = Creator.getCollection('flows');\n\tformCollection = Creator.getCollection('forms');\n\tflow = flowCollection.findOne(flowId);\n\tspaceId = flow.space\n\n\t# 某步骤被删除后，删除同流程的“指定历史步骤”属性中被引用的步骤id（仅限于流程的最新版)\n\tclientStepIds = []\n\n\t_.each(flowCome['current']['steps'], (step) ->\n\t\tclientStepIds.push(step['id']);\n\t)\n\n\t_.each(flowCome['current']['steps'],  (step) ->\n\t\tif (step['approver_step'])\n\t\t\tif (!clientStepIds.includes(step['approver_step']))\n\t\t\t\tstep['approver_step'] = '';\n\t)\n\n\t# 流程升级\n\t# 由于前台后台posx posy timeout_hours字段类型不一致会导致流程升级 所以在这里统一转为后台Float类型 便于比较\n\t_.each(flowCome['current']['steps'],  (st) ->\n\t\tst['posx'] = parseFloat(st['posx']);\n\t\tst['posy'] = parseFloat(st['posy']);\n\t\tif (st['timeout_hours'])\n\t\t\tst['timeout_hours'] = parseFloat(st['timeout_hours']);\n\n\t)\n\n\t# 由于前台传的是id而非_id，故比较时将id转为_id\n\t_.each(flowCome['current']['steps'],  (step) ->\n\t\tif step['id']\n\t\t\tstep['_id'] = step['id'];\n\t\t\tdelete step['id'];\n\t\tif (step['lines'])\n\t\t\t_.each(step['lines'],  (line) ->\n\t\t\t\tif line['id']\n\t\t\t\t\tline['_id'] = line['id'];\n\t\t\t\t\tdelete line['id'];\n\t\t\t)\n\t)\n\n\tstepsStr = JSON.stringify(flow['current']['steps']);\n\tflowComeStepsStr = JSON.stringify(flowCome['current']['steps']);\n\tpass = false;\n\tupdateObj = {\n\t\t$set: {}\n\t};\n\n\n\tinsCount = Creator.getCollection('instances').find({\n\t\tspace: spaceId,\n\t\tflow: flowId,\n\t\tflow_version: flow.current._id\n\t}).count();\n\n\tif (insCount > 0)\n\t\tpass = true;\n\n\tif pass == true && flow.current.start_date && stepsStr == flowComeStepsStr\n\t\tupdateObj.$push = {\n\t\t\t'historys': flow.current\n\t\t};\n\t\tcurrent = {\n\t\t\t'_id': flowCollection._makeNewID(),\n\t\t\t'modified': now,\n\t\t\t'modified_by': userId,\n\t\t\t'created': now,\n\t\t\t'created_by': userId,\n\t\t\t'steps': flowCome['current']['steps'],\n\t\t\t'form_version': flow.current.form_version,\n\t\t\t'_rev': flow.current._rev,\n\t\t\t'flow': flowId,\n\t\t};\n\n\t\tif (flow.state == 'enabled')\n\t\t\tcurrent['start_date'] = now;\n\n\t\tupdateObj.$set.current = current;\n\telse\n\t\tupdateObj.$set = {\n\t\t\t'current.modified': now,\n\t\t\t'current.modified_by': userId,\n\t\t\t'current.steps': flowCome[\"current\"][\"steps\"]\n\t\t}\n\n\tupdateObj.$set.name = flowCome['name'];\n\tupdateObj.$set.name_formula = '';\n\tupdateObj.$set.code_formula = '';\n\tupdateObj.$set.is_valid = flowCome['is_valid'];\n\tupdateObj.$set.flowtype = flowCome['flowtype'];\n\tupdateObj.$set.help_text = flowCome['help_text'];\n\tupdateObj.$set.decription = flowCome['descriptions'];\n\tupdateObj.$set.error_message = flowCome['error_message'];\n\tupdateObj.$set.modified = now;\n\tupdateObj.$set.modified_by = userId;\n\n\t#流程权限保持不变\n#\tif (flowCome['perms'])\n#\t\tflowCome['perms']['_id'] = flowCome['perms']['id'];\n#\t\tdelete flowCome['perms']['id'];\n#\t\tupdateObj.$set.perms = flowCome['perms'];\n\n\t# flow对象上添加categoryId\n\tform = formCollection.findOne(flow.form, {\n\t\tfields: {\n\t\t\tcategory: 1\n\t\t}\n\t});\n\tupdateObj.$set.category = form['category'];\n\n\tflowCollection.update(flowId, updateObj);\n\n# TODO check 对象、字段是否存在\ncheckObjectWorkflow = (spaceId, objectName, doc)->\n\ttry\n\t\t_obj = objectql.getObject(objectName);\n\tcatch\n\t\tif !_obj\n\t\t\tthrow new Meteor.Error(500, \"import_flows_error_not_find_object\", objectName);\n\t_objconfig = _obj.toConfig();\n\tif !_objconfig.enable_workflow\n\t\tthrow new Meteor.Error(500, \"import_flows_error_not_allow_enable_workflow\", _objconfig.name);\n\tfileds = _objconfig.fields\n\tallowValues = _.pluck(Creator.getObjectLookupFieldOptions(objectName, true, false, true), 'value');\n\tobjectField = _.pluck(doc.field_map, \"object_field\");\n\tdiff = _.difference(objectField, allowValues);\n\tif diff.length > 0\n\t\tthrow new Meteor.Error(500, \"import_flows_error_not_find_fields\", diff.join(\",\"));\n\tobjectFieldBack = _.pluck(doc.field_map_back, \"object_field\");\n\tdiff1 = _.difference(objectFieldBack, allowValues);\n\tif diff1.length > 0\n\t\tthrow new Meteor.Error(500, \"import_flows_error_not_find_fields\", diff1.join(\",\"));\n\nsteedosImport.objectWorkflow = (spaceId, flowId, objectName, doc)->\n\tdelete doc._id\n\toldDoc = Creator.getCollection(\"object_workflows\").findOne({space: spaceId, flow_id: flowId, object_name: objectName})\n\tif oldDoc\n\t\tCreator.getCollection(\"object_workflows\").update(oldDoc._id, {$set: Object.assign({}, doc, {space: spaceId, flow_id: flowId, object_name: objectName})})\n\telse\n\t\tCreator.getCollection(\"object_workflows\").insert(Object.assign({}, doc, {space: spaceId, flow_id: flowId, object_name: objectName}))\n\nsteedosImport.workflow = (uid, spaceId, form, enabled, company_id, options)->\n\n\tupgrade = options?.upgrade || false\n\tupgradeFormId = options?.formId\n\tupgradeFlowId = options?.flowId\n\n\tif _.isEmpty(form)\n\t\tthrow new Meteor.Error('error', \"无效的json data\")\n\n\tif company_id\n\t\tif Creator.getCollection(\"company\").find({ _id: company_id, space: spaceId }).count() == 0\n\t\t\tthrow new Meteor.Error('error', \"无效的字段: company_id\")\n\n#\tif form?.flows\n#\t\t_.each form.flows, (flow)->\n#\t\t\tif flow.object_workflows\n#\t\t\t\t_.each flow.object_workflows, (_ow)->\n#\t\t\t\t\tcheckObjectWorkflow(spaceId, _ow.object_name, _ow)\n\n\tnew_form_ids = new Array()\n\n\tnew_flow_ids = new Array()\n\ttry\n\t\tif form?.category_name\n\t\t\tcategory = db.categories.findOne({space: spaceId, name: form.category_name}, {fields: {_id: 1}})\n\n\t\t\tif _.isEmpty(category)\n\t\t\t\tcategory_id = new Mongo.ObjectID()._str;\n\t\t\t\tnew_category = {\n\t\t\t\t\t_id: category_id,\n\t\t\t\t\tname: form.category_name,\n\t\t\t\t\tspace: spaceId,\n\t\t\t\t\tcreated: new Date,\n\t\t\t\t\tcreated_by: uid,\n\t\t\t\t\tmodified: new Date,\n\t\t\t\t\tmodified_by: uid,\n\t\t\t\t\towner: uid\n\t\t\t\t}\n\t\t\t\tif company_id\n\t\t\t\t\tnew_category.company_id = company_id\n\t\t\t\t\tnew_category.company_ids = [company_id]\n\t\t\t\tdb.categories.direct.insert(new_category);\n\t\t\t\tform.category = category_id\n\t\t\telse\n\t\t\t\tform.category = category._id\n\n\t\t\tdelete form.category_name\n\n\t\tif form?.instance_number_rules\n\t\t\tform.instance_number_rules.forEach (nr)->\n\t\t\t\ttry\n\t\t\t\t\trules = db.instance_number_rules.findOne({space: spaceId, \"name\": nr.name})\n\n\t\t\t\t\tif !rules\n\t\t\t\t\t\tnr.space = spaceId\n\t\t\t\t\t\tnr._id = new Mongo.ObjectID()._str\n\t\t\t\t\t\tnr.created = new Date\n\t\t\t\t\t\tnr.created_by = uid\n\t\t\t\t\t\tnr.modified = new Date\n\t\t\t\t\t\tnr.modified_by = uid\n\t\t\t\t\t\tdelete nr.company_id\n\t\t\t\t\t\tdelete nr.company_ids\n\t\t\t\t\t\tif company_id\n\t\t\t\t\t\t\tnr.company_id = company_id\n\t\t\t\t\t\t\tnr.company_ids = [company_id]\n\t\t\t\t\t\tdb.instance_number_rules.direct.insert(nr)\n\t\t\t\tcatch e\n\t\t\t\t\tconsole.log \"steedosImport.workflow\", e\n\n\t\t\tdelete form.instance_number_rules\n\n\t\tform_id = new Mongo.ObjectID()._str\n\n\t\tflows = form.flows\n\n\t\tdelete form.flows\n\n\t\tform._id = form_id\n\n\t\tform.space = spaceId\n\t\tif enabled\n\t\t\tform.state = 'enabled'\n\t\t\tform.is_valid = true #直接启用的表单设置is valid值为true\n\t\telse\n\t\t\tform.state = 'disabled' #设置状态为 未启用\n\t\t\tform.is_valid = true #设置已验证为 true , 简化用户操作\n\n\t\tform.created = new Date()\n\n\t\tform.created_by = uid\n\n\t\tform.modified = form.created\n\n\t\tform.modified_by = uid\n\n\t\tform.historys = []\n\n\t\tform.current._id = new Mongo.ObjectID()._str\n\n\t\tform.current._rev = 1 #重置版本号\n\n\t\tform.current.form = form_id\n\n\t\tform.current.created = new Date()\n\n\t\tform.current.created_by = uid\n\n\t\tform.current.modified = new Date()\n\n\t\tform.current.modified_by = uid\n\n\t\tdelete form.company_id\n\t\tdelete form.company_ids\n\t\tif company_id\n\t\t\tform.company_id = company_id\n\t\t\tform.company_ids = [company_id]\n\n\t\tform.import = true\n\n\t\tform.owner = uid\n\n\t\tif upgrade\n\t\t\tupgradeForm(upgradeFormId, form, uid, spaceId)\n\t\telse\n\t\t\tdb.forms.direct.insert(form)\n\t\t\tnew_form_ids.push(form_id)\n\n\t\tflows.forEach (flow)->\n\t\t\tflowObjectWorkflows = flow.object_workflows\n\t\t\tdelete flow.object_workflows\n\t\t\tflow_id = new Mongo.ObjectID()._str\n\n\t\t\tflow._id = flow_id\n\n\t\t\tflow.form = form_id\n\n\t\t\tflow.category = form.category\n\n\t\t\tif enabled\n\t\t\t\tflow.state = 'enabled'\n\t\t\t\tflow.is_valid = true #直接启用的流程设置is valid值为true\n\t\t\telse\n\t\t\t\tflow.state = 'disabled' #设置状态为 未启用\n\t\t\t\tflow.is_valid = true\n\n\t\t\tflow.current_no = 0 #重置编号起始为0\n\n\t\t\tflow.created = new Date()\n\n\t\t\tflow.created_by = uid\n\n\t\t\tflow.modified = flow.created\n\n\t\t\tflow.modified_by = uid\n\n\t\t\tdelete flow.company_id\n\t\t\tdelete flow.company_ids\n\t\t\tif company_id\n\t\t\t\tflow.company_id = company_id\n\t\t\t\tflow.company_ids = [company_id]\n\t\t\t#跨工作区导入时，重置流程权限perms\n\t\t\tif flow.perms && flow.space == spaceId\n\t\t\t\tperms = {\n\t\t\t\t\t_id: new Mongo.ObjectID()._str\n\t\t\t\t\tusers_can_add: []\n\t\t\t\t\torgs_can_add: orgs_can_add\n\t\t\t\t\tusers_can_monitor: []\n\t\t\t\t\torgs_can_monitor: []\n\t\t\t\t\tusers_can_admin: []\n\t\t\t\t\torgs_can_admin: []\n\t\t\t\t}\n\n\t\t\t\tusers_can_add = perms.users_can_add\n\t\t\t\torgs_can_add = perms.orgs_can_add\n\n\t\t\t\tusers_can_monitor = perms.users_can_monitor\n\t\t\t\torgs_can_monitor = perms.orgs_can_monitor\n\n\t\t\t\tusers_can_admin = perms.users_can_admin\n\t\t\t\torgs_can_admin = perms.orgs_can_admin\n\n\t\t\t\tif !_.isEmpty(users_can_add)\n\t\t\t\t\tperms.users_can_add = _.pluck(db.space_users.find({user: {$in: users_can_add}}, {fields: {user: 1}}).fetch(), 'user');\n\n\t\t\t\tif !_.isEmpty(orgs_can_add)\n\t\t\t\t\tperms.orgs_can_add = _.pluck(db.organizations.find({_id: {$in: orgs_can_add}}, {fields: {_id: 1}}).fetch(), '_id');\n\t\t\t\t\tif _.isEmpty(perms.orgs_can_add)\n\t\t\t\t\t\tif company_id\n\t\t\t\t\t\t\tperms.orgs_can_add  = [company_id]\n\t\t\t\t\t\telse\n\t\t\t\t\t\t\tperms.orgs_can_add  = db.organizations.find({\n\t\t\t\t\t\t\t\tspace: spaceId,\n\t\t\t\t\t\t\t\tparent: null\n\t\t\t\t\t\t\t}, {fields: {_id: 1}}).fetch().getProperty(\"_id\")\n\n\t\t\t\tif !_.isEmpty(users_can_monitor)\n\t\t\t\t\tperms.users_can_monitor = _.pluck(db.space_users.find({user: {$in: users_can_monitor}}, {fields: {user: 1}}).fetch(), 'user');\n\t\t\t\tif !_.isEmpty(orgs_can_monitor)\n\t\t\t\t\tperms.orgs_can_monitor = _.pluck(db.organizations.find({_id: {$in: orgs_can_monitor}}, {fields: {_id: 1}}).fetch(), '_id');\n\n\t\t\t\tif !_.isEmpty(users_can_admin)\n\t\t\t\t\tperms.users_can_monitor = _.pluck(db.space_users.find({user: {$in: users_can_admin}}, {fields: {user: 1}}).fetch(), 'user');\n\t\t\t\tif !_.isEmpty(orgs_can_admin)\n\t\t\t\t\tperms.orgs_can_monitor = _.pluck(db.organizations.find({_id: {$in: orgs_can_admin}}, {fields: {_id: 1}}).fetch(), '_id');\n\n\n\t\t\telse if !flow.perms || flow.space !=  spaceId\n\t\t\t\torgs_can_add = []\n\t\t\t\tif company_id\n\t\t\t\t\torgs_can_add = [company_id]\n\t\t\t\telse\n\t\t\t\t\torgs_can_add = db.organizations.find({\n\t\t\t\t\t\tspace: spaceId,\n\t\t\t\t\t\tparent: null\n\t\t\t\t\t}, {fields: {_id: 1}}).fetch().getProperty(\"_id\")\n\t\t\t\t#设置提交部门为：全公司\n\t\t\t\tperms = {\n\t\t\t\t\t_id: new Mongo.ObjectID()._str\n\t\t\t\t\tusers_can_add: []\n\t\t\t\t\torgs_can_add: orgs_can_add\n\t\t\t\t\tusers_can_monitor: []\n\t\t\t\t\torgs_can_monitor: []\n\t\t\t\t\tusers_can_admin: []\n\t\t\t\t\torgs_can_admin: []\n\t\t\t\t}\n\n\t\t\t\tflow.perms = perms\n\n\t\t\tflow.space = spaceId\n\n\t\t\tflow.current._id = new Mongo.ObjectID()._str\n\n\t\t\tflow.current.flow = flow_id\n\n\t\t\tflow.current._rev = 1 #重置版本\n\n\t\t\tflow.current.form_version = form.current._id\n\n\t\t\tflow.current.created = new Date()\n\n\t\t\tflow.current.created_by = uid\n\n\t\t\tflow.current.modified = new Date()\n\n\t\t\tflow.current.modified_by = uid\n\n\t\t\tflow.current?.steps.forEach (step)->\n\t\t\t\tif _.isArray(step.approver_users)\n\t\t\t\t\t_accepted_approve_users = [];\n\t\t\t\t\t_.each step.approver_users, (uid)->\n\t\t\t\t\t\tif db.space_users.findOne({user: uid, user_accepted: true, space: spaceId})\n\t\t\t\t\t\t\t_accepted_approve_users.push(uid);\n\t\t\t\t\tstep.approver_users = _accepted_approve_users;\n\n\t\t\t\tif _.isArray(step.approver_orgs)\n\t\t\t\t\t_accepted_approver_orgs = [];\n\t\t\t\t\t_.each step.approver_orgs, (oid)->\n\t\t\t\t\t\tif db.organizations.findOne({_id: oid, space: spaceId})\n\t\t\t\t\t\t\t_accepted_approver_orgs.push(oid);\n\t\t\t\t\tstep.approver_orgs = _accepted_approver_orgs;\n\n\t\t\t\tif _.isEmpty(step.approver_roles_name)\n\t\t\t\t\tdelete step.approver_roles_name\n\t\t\t\t\tif _.isEmpty(step.approver_roles)\n\t\t\t\t\t\tstep.approver_roles = []\n\t\t\t\t\tif !_.isEmpty(step.approver_hr_roles_name)\n\t\t\t\t\t\tapprover_hr_roles = new Array()\n\t\t\t\t\t\tstep.approver_hr_roles_name.forEach (role_name, _hr_index) ->\n\t\t\t\t\t\t\trole_query = {space: spaceId, name: role_name}\n\t\t\t\t\t\t\trole = db.roles.findOne(role_query, {fields: {_id: 1}})\n\t\t\t\t\t\t\tif _.isEmpty(role)\n\t\t\t\t\t\t\t\tapiName = \"\";\n\t\t\t\t\t\t\t\ttry \n\t\t\t\t\t\t\t\t\tapiName = step.approver_hr_roles_api_name?[_hr_index] || \"\"\n\t\t\t\t\t\t\t\tcatch error\n\t\t\t\t\t\t\t\t\tconsole.log();\t\t\n\t\t\t\t\t\t\t\trole_id = db.roles._makeNewID()\n\t\t\t\t\t\t\t\trole = {\n\t\t\t\t\t\t\t\t\t_id: role_id\n\t\t\t\t\t\t\t\t\tname: role_name,\n\t\t\t\t\t\t\t\t\tapi_name: apiName,\n\t\t\t\t\t\t\t\t\tspace: spaceId\n\t\t\t\t\t\t\t\t\tcreated: new Date\n\t\t\t\t\t\t\t\t\tcreated_by: uid,\n\t\t\t\t\t\t\t\t\tmodified: new Date(),\n\t\t\t\t\t\t\t\t\tmodified_by: uid,\n\t\t\t\t\t\t\t\t\towner: uid\n\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\tdb.roles.direct.insert(role)\n\n\t\t\t\t\t\t\t\tapprover_hr_roles.push(role_id)\n\t\t\t\t\t\t\telse\n\t\t\t\t\t\t\t\tapprover_hr_roles.push(role._id)\n\n\t\t\t\t\t\tstep.approver_hr_roles = approver_hr_roles\n\n\t\t\t\t\t\tdelete step.approver_roles_name\n\t\t\t\telse\n\t\t\t\t\tapprove_roles = new Array();\n\t\t\t\t\tapproveRolesByIds = [];\n\t\t\t\t\tif _.isArray(step.approver_roles) && !_.isEmpty(step.approver_roles)\n\t\t\t\t\t\tapproveRolesByIds = db.flow_roles.find({_id: {$in: step.approver_roles}, space: spaceId}, {fields: {_id: 1, name: 1, company_id: 1}}).fetch()\n\t\t\t\t\tstep.approver_roles_name.forEach (role_name, _index) ->\n\t\t\t\t\t\troleApiName = step.approver_roles_api_name?[_index] || \"\"\n\t\t\t\t\t\tapproveRoleById = _.find approveRolesByIds, (_role)->\n\t\t\t\t\t\t\treturn _role._id == step.approver_roles[_index]\n\t\t\t\t\t\tflow_role_query = {space: spaceId, name: role_name}\n\t\t\t\t\t\tif (!approveRoleById && company_id) || (approveRoleById?.company_id && company_id)\n\t\t\t\t\t\t\tflow_role_query.company_id = company_id\n\t\t\t\t\t\telse\n\t\t\t\t\t\t\tflow_role_query.$or = [{ company_id: { $exists: false } }, { company_id: null }, { company_id: '' }]\n\t\t\t\t\t\trole = db.flow_roles.findOne(flow_role_query, {fields: {_id: 1}})\n\t\t\t\t\t\tif _.isEmpty(role)\n\t\t\t\t\t\t\trole_id = db.flow_roles._makeNewID()\n\t\t\t\t\t\t\trole = {\n\t\t\t\t\t\t\t\t_id: role_id\n\t\t\t\t\t\t\t\tname: role_name\n\t\t\t\t\t\t\t\tapi_name: roleApiName\n\t\t\t\t\t\t\t\tspace: spaceId\n\t\t\t\t\t\t\t\tcreated: new Date\n\t\t\t\t\t\t\t\tcreated_by: uid\n\t\t\t\t\t\t\t\tmodified: new Date(),\n\t\t\t\t\t\t\t\tmodified_by: uid,\n\t\t\t\t\t\t\t\towner: uid\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\tif company_id\n\t\t\t\t\t\t\t\trole.company_id = company_id\n\t\t\t\t\t\t\t\trole.company_ids = [company_id]\n\t\t\t\t\t\t\tdb.flow_roles.direct.insert(role)\n\n\t\t\t\t\t\t\tapprove_roles.push(role_id)\n\t\t\t\t\t\telse\n\t\t\t\t\t\t\tapprove_roles.push(role._id)\n\n\t\t\t\t\tstep.approver_roles = approve_roles\n\n\t\t\t\t\tdelete step.approver_roles_name\n\n\t\t\tflow.import = true\n\n\t\t\tflow.owner = uid\n\n\t\t\tif upgrade\n\t\t\t\tupgradeFlow(flow, uid, upgradeFlowId)\n\t\t\t\t_.each flowObjectWorkflows, (_objectWorkflow)->\n\t\t\t\t\tsteedosImport.objectWorkflow(spaceId, upgradeFlowId, _objectWorkflow.object_name, _objectWorkflow)\n\t\t\telse\n\t\t\t\t# db.flows._check(spaceId);\n\t\t\t\tdb.flows.direct.insert(flow)\n\t\t\t\tnew_flow_ids.push(flow_id)\n\t\t\t\t_.each flowObjectWorkflows, (_objectWorkflow)->\n\t\t\t\t\tsteedosImport.objectWorkflow(spaceId, flow_id, _objectWorkflow.object_name, _objectWorkflow)\n\n\t\treturn new_flow_ids;\n\tcatch e\n\t\tnew_form_ids.forEach (id)->\n\t\t\tdb.forms.direct.remove(id)\n\n\t\tnew_flow_ids.forEach (id)->\n\t\t\tdb.flows.direct.remove(id)\n\t\tthrow  e\n\n\n\n\n\n","var _formatFieldsID, checkObjectWorkflow, objectql, upgradeFlow, upgradeFlowByForm, upgradeForm;               \n\nobjectql = require(\"@steedos/objectql\");\n\nsteedosImport = {};\n\n_formatFieldsID = function(fields) {\n  _.each(fields, function(f) {\n    if (!f._id && f.id) {\n      f._id = f.id;\n      delete f.id;\n      if (f.type === 'section' || f.type === 'table') {\n        return _formatFieldsID(f.fields);\n      }\n    }\n  });\n  return fields;\n};\n\nupgradeFlowByForm = function(flow, formVersionId, options) {\n  var currentUserId, flowCollection, flowCurrent, flowUpdateObj, now, spaceId, up;\n  flowCollection = Creator.getCollection('flows');\n  up = false;\n  now = options.now;\n  currentUserId = options.currentUserId;\n  spaceId = options.spaceId;\n  if (Creator.getCollection('instances').find({\n    space: spaceId,\n    flow: flow._id,\n    flow_version: flow.current._id\n  }).count()) {\n    up = true;\n  }\n  flowUpdateObj = {\n    $set: {}\n  };\n  if (up === true && flow.current.start_date) {\n    flowUpdateObj.$push = {\n      'historys': flow.current\n    };\n    flowCurrent = {\n      '_id': flowCollection._makeNewID(),\n      'created': now,\n      'created_by': currentUserId,\n      'steps': flow.current.steps,\n      '_rev': flow.current._rev + 1,\n      'flow': flow._id,\n      'form_version': formVersionId,\n      'modified': now,\n      'modified_by': currentUserId\n    };\n    if (flow.state === \"enabled\") {\n      flowCurrent.start_date = now;\n    }\n    flowUpdateObj.$set['current'] = flowCurrent;\n  } else {\n    flowUpdateObj.$set = {\n      'current.form_version': formVersionId,\n      'current.modified': now,\n      'current.modified_by': currentUserId\n    };\n  }\n  flowUpdateObj.$set['modified'] = now;\n  flowUpdateObj.$set['modified_by'] = currentUserId;\n  return flowCollection.update(flow._id, flowUpdateObj);\n};\n\nupgradeForm = function(formId, form, currentUserId, spaceId) {\n  var current, ff, flowCollection, formCollection, formUpdateObj, insCount, now, pass, recordsCount;\n  formCollection = Creator.getCollection('forms');\n  flowCollection = Creator.getCollection('flows');\n  ff = formCollection.findOne({\n    _id: formId,\n    space: spaceId\n  });\n  if (!ff) {\n    throw new Meteor.Error('error', \"无效的formId\");\n  }\n  spaceId = ff.space;\n  now = new Date();\n  current = {};\n  formUpdateObj = {};\n  pass = false;\n  if (ff.app === 'workflow') {\n    insCount = Creator.getCollection('instances').find({\n      space: spaceId,\n      form: formId,\n      'form_version': form['current']['id']\n    }).count();\n    if (insCount > 0) {\n      pass = true;\n    }\n  } else if (ff.app === 'creator') {\n    recordsCount = Creator.getCollection('records').find({\n      space: spaceId,\n      form: formId,\n      'form_version': form['current']['id']\n    }).count();\n    if (recordsCount > 0) {\n      pass = true;\n    }\n  }\n  if (pass === true && ff[\"current\"][\"start_date\"]) {\n    formUpdateObj.$push = {\n      'historys': ff[\"current\"]\n    };\n    current._id = formCollection._makeNewID();\n    current._rev = ff[\"current\"][\"_rev\"] + 1;\n    current.created = now;\n    current.created_by = currentUserId;\n    if (ff.state === 'enabled') {\n      current.start_date = now;\n    }\n    flowCollection.find({\n      form: formId\n    }).forEach(function(flow) {\n      return upgradeFlowByForm(flow, current._id, {\n        now: now,\n        currentUserId: currentUserId,\n        spaceId: spaceId\n      });\n    });\n  } else {\n    current = ff.current;\n  }\n  current.modified = now;\n  current.modified_by = currentUserId;\n  current.form = formId;\n  current.fields = _formatFieldsID(form[\"current\"][\"fields\"]);\n  current.form_script = form[\"current\"][\"form_script\"];\n  current.name_forumla = form[\"current\"][\"name_forumla\"];\n  formUpdateObj.$set = {\n    'current': current,\n    'name': form[\"name\"],\n    'modified': now,\n    'modified_by': currentUserId,\n    'is_valid': form[\"is_valid\"],\n    'description': form[\"description\"],\n    'help_text': form[\"help_text\"],\n    'error_message': form[\"error_message\"],\n    'category': form[\"category\"],\n    'instance_style': form[\"instance_style\"]\n  };\n  return formCollection.update(formId, formUpdateObj);\n};\n\nupgradeFlow = function(flowCome, userId, flowId) {\n  var clientStepIds, current, flow, flowCollection, flowComeStepsStr, form, formCollection, insCount, now, pass, spaceId, stepsStr, updateObj;\n  now = new Date();\n  flowCollection = Creator.getCollection('flows');\n  formCollection = Creator.getCollection('forms');\n  flow = flowCollection.findOne(flowId);\n  spaceId = flow.space;\n  clientStepIds = [];\n  _.each(flowCome['current']['steps'], function(step) {\n    return clientStepIds.push(step['id']);\n  });\n  _.each(flowCome['current']['steps'], function(step) {\n    if (step['approver_step']) {\n      if (!clientStepIds.includes(step['approver_step'])) {\n        return step['approver_step'] = '';\n      }\n    }\n  });\n  _.each(flowCome['current']['steps'], function(st) {\n    st['posx'] = parseFloat(st['posx']);\n    st['posy'] = parseFloat(st['posy']);\n    if (st['timeout_hours']) {\n      return st['timeout_hours'] = parseFloat(st['timeout_hours']);\n    }\n  });\n  _.each(flowCome['current']['steps'], function(step) {\n    if (step['id']) {\n      step['_id'] = step['id'];\n      delete step['id'];\n    }\n    if (step['lines']) {\n      return _.each(step['lines'], function(line) {\n        if (line['id']) {\n          line['_id'] = line['id'];\n          return delete line['id'];\n        }\n      });\n    }\n  });\n  stepsStr = JSON.stringify(flow['current']['steps']);\n  flowComeStepsStr = JSON.stringify(flowCome['current']['steps']);\n  pass = false;\n  updateObj = {\n    $set: {}\n  };\n  insCount = Creator.getCollection('instances').find({\n    space: spaceId,\n    flow: flowId,\n    flow_version: flow.current._id\n  }).count();\n  if (insCount > 0) {\n    pass = true;\n  }\n  if (pass === true && flow.current.start_date && stepsStr === flowComeStepsStr) {\n    updateObj.$push = {\n      'historys': flow.current\n    };\n    current = {\n      '_id': flowCollection._makeNewID(),\n      'modified': now,\n      'modified_by': userId,\n      'created': now,\n      'created_by': userId,\n      'steps': flowCome['current']['steps'],\n      'form_version': flow.current.form_version,\n      '_rev': flow.current._rev,\n      'flow': flowId\n    };\n    if (flow.state === 'enabled') {\n      current['start_date'] = now;\n    }\n    updateObj.$set.current = current;\n  } else {\n    updateObj.$set = {\n      'current.modified': now,\n      'current.modified_by': userId,\n      'current.steps': flowCome[\"current\"][\"steps\"]\n    };\n  }\n  updateObj.$set.name = flowCome['name'];\n  updateObj.$set.name_formula = '';\n  updateObj.$set.code_formula = '';\n  updateObj.$set.is_valid = flowCome['is_valid'];\n  updateObj.$set.flowtype = flowCome['flowtype'];\n  updateObj.$set.help_text = flowCome['help_text'];\n  updateObj.$set.decription = flowCome['descriptions'];\n  updateObj.$set.error_message = flowCome['error_message'];\n  updateObj.$set.modified = now;\n  updateObj.$set.modified_by = userId;\n  form = formCollection.findOne(flow.form, {\n    fields: {\n      category: 1\n    }\n  });\n  updateObj.$set.category = form['category'];\n  return flowCollection.update(flowId, updateObj);\n};\n\ncheckObjectWorkflow = function(spaceId, objectName, doc) {\n  var _obj, _objconfig, allowValues, diff, diff1, fileds, objectField, objectFieldBack;\n  try {\n    _obj = objectql.getObject(objectName);\n  } catch (error1) {\n    if (!_obj) {\n      throw new Meteor.Error(500, \"import_flows_error_not_find_object\", objectName);\n    }\n  }\n  _objconfig = _obj.toConfig();\n  if (!_objconfig.enable_workflow) {\n    throw new Meteor.Error(500, \"import_flows_error_not_allow_enable_workflow\", _objconfig.name);\n  }\n  fileds = _objconfig.fields;\n  allowValues = _.pluck(Creator.getObjectLookupFieldOptions(objectName, true, false, true), 'value');\n  objectField = _.pluck(doc.field_map, \"object_field\");\n  diff = _.difference(objectField, allowValues);\n  if (diff.length > 0) {\n    throw new Meteor.Error(500, \"import_flows_error_not_find_fields\", diff.join(\",\"));\n  }\n  objectFieldBack = _.pluck(doc.field_map_back, \"object_field\");\n  diff1 = _.difference(objectFieldBack, allowValues);\n  if (diff1.length > 0) {\n    throw new Meteor.Error(500, \"import_flows_error_not_find_fields\", diff1.join(\",\"));\n  }\n};\n\nsteedosImport.objectWorkflow = function(spaceId, flowId, objectName, doc) {\n  var oldDoc;\n  delete doc._id;\n  oldDoc = Creator.getCollection(\"object_workflows\").findOne({\n    space: spaceId,\n    flow_id: flowId,\n    object_name: objectName\n  });\n  if (oldDoc) {\n    return Creator.getCollection(\"object_workflows\").update(oldDoc._id, {\n      $set: Object.assign({}, doc, {\n        space: spaceId,\n        flow_id: flowId,\n        object_name: objectName\n      })\n    });\n  } else {\n    return Creator.getCollection(\"object_workflows\").insert(Object.assign({}, doc, {\n      space: spaceId,\n      flow_id: flowId,\n      object_name: objectName\n    }));\n  }\n};\n\nsteedosImport.workflow = function(uid, spaceId, form, enabled, company_id, options) {\n  var category, category_id, e, flows, form_id, new_category, new_flow_ids, new_form_ids, upgrade, upgradeFlowId, upgradeFormId;\n  upgrade = (options != null ? options.upgrade : void 0) || false;\n  upgradeFormId = options != null ? options.formId : void 0;\n  upgradeFlowId = options != null ? options.flowId : void 0;\n  if (_.isEmpty(form)) {\n    throw new Meteor.Error('error', \"无效的json data\");\n  }\n  if (company_id) {\n    if (Creator.getCollection(\"company\").find({\n      _id: company_id,\n      space: spaceId\n    }).count() === 0) {\n      throw new Meteor.Error('error', \"无效的字段: company_id\");\n    }\n  }\n  new_form_ids = new Array();\n  new_flow_ids = new Array();\n  try {\n    if (form != null ? form.category_name : void 0) {\n      category = db.categories.findOne({\n        space: spaceId,\n        name: form.category_name\n      }, {\n        fields: {\n          _id: 1\n        }\n      });\n      if (_.isEmpty(category)) {\n        category_id = new Mongo.ObjectID()._str;\n        new_category = {\n          _id: category_id,\n          name: form.category_name,\n          space: spaceId,\n          created: new Date,\n          created_by: uid,\n          modified: new Date,\n          modified_by: uid,\n          owner: uid\n        };\n        if (company_id) {\n          new_category.company_id = company_id;\n          new_category.company_ids = [company_id];\n        }\n        db.categories.direct.insert(new_category);\n        form.category = category_id;\n      } else {\n        form.category = category._id;\n      }\n      delete form.category_name;\n    }\n    if (form != null ? form.instance_number_rules : void 0) {\n      form.instance_number_rules.forEach(function(nr) {\n        var e, rules;\n        try {\n          rules = db.instance_number_rules.findOne({\n            space: spaceId,\n            \"name\": nr.name\n          });\n          if (!rules) {\n            nr.space = spaceId;\n            nr._id = new Mongo.ObjectID()._str;\n            nr.created = new Date;\n            nr.created_by = uid;\n            nr.modified = new Date;\n            nr.modified_by = uid;\n            delete nr.company_id;\n            delete nr.company_ids;\n            if (company_id) {\n              nr.company_id = company_id;\n              nr.company_ids = [company_id];\n            }\n            return db.instance_number_rules.direct.insert(nr);\n          }\n        } catch (error1) {\n          e = error1;\n          return console.log(\"steedosImport.workflow\", e);\n        }\n      });\n      delete form.instance_number_rules;\n    }\n    form_id = new Mongo.ObjectID()._str;\n    flows = form.flows;\n    delete form.flows;\n    form._id = form_id;\n    form.space = spaceId;\n    if (enabled) {\n      form.state = 'enabled';\n      form.is_valid = true;\n    } else {\n      form.state = 'disabled';\n      form.is_valid = true;\n    }\n    form.created = new Date();\n    form.created_by = uid;\n    form.modified = form.created;\n    form.modified_by = uid;\n    form.historys = [];\n    form.current._id = new Mongo.ObjectID()._str;\n    form.current._rev = 1;\n    form.current.form = form_id;\n    form.current.created = new Date();\n    form.current.created_by = uid;\n    form.current.modified = new Date();\n    form.current.modified_by = uid;\n    delete form.company_id;\n    delete form.company_ids;\n    if (company_id) {\n      form.company_id = company_id;\n      form.company_ids = [company_id];\n    }\n    form[\"import\"] = true;\n    form.owner = uid;\n    if (upgrade) {\n      upgradeForm(upgradeFormId, form, uid, spaceId);\n    } else {\n      db.forms.direct.insert(form);\n      new_form_ids.push(form_id);\n    }\n    flows.forEach(function(flow) {\n      var flowObjectWorkflows, flow_id, orgs_can_add, orgs_can_admin, orgs_can_monitor, perms, ref, users_can_add, users_can_admin, users_can_monitor;\n      flowObjectWorkflows = flow.object_workflows;\n      delete flow.object_workflows;\n      flow_id = new Mongo.ObjectID()._str;\n      flow._id = flow_id;\n      flow.form = form_id;\n      flow.category = form.category;\n      if (enabled) {\n        flow.state = 'enabled';\n        flow.is_valid = true;\n      } else {\n        flow.state = 'disabled';\n        flow.is_valid = true;\n      }\n      flow.current_no = 0;\n      flow.created = new Date();\n      flow.created_by = uid;\n      flow.modified = flow.created;\n      flow.modified_by = uid;\n      delete flow.company_id;\n      delete flow.company_ids;\n      if (company_id) {\n        flow.company_id = company_id;\n        flow.company_ids = [company_id];\n      }\n      if (flow.perms && flow.space === spaceId) {\n        perms = {\n          _id: new Mongo.ObjectID()._str,\n          users_can_add: [],\n          orgs_can_add: orgs_can_add,\n          users_can_monitor: [],\n          orgs_can_monitor: [],\n          users_can_admin: [],\n          orgs_can_admin: []\n        };\n        users_can_add = perms.users_can_add;\n        orgs_can_add = perms.orgs_can_add;\n        users_can_monitor = perms.users_can_monitor;\n        orgs_can_monitor = perms.orgs_can_monitor;\n        users_can_admin = perms.users_can_admin;\n        orgs_can_admin = perms.orgs_can_admin;\n        if (!_.isEmpty(users_can_add)) {\n          perms.users_can_add = _.pluck(db.space_users.find({\n            user: {\n              $in: users_can_add\n            }\n          }, {\n            fields: {\n              user: 1\n            }\n          }).fetch(), 'user');\n        }\n        if (!_.isEmpty(orgs_can_add)) {\n          perms.orgs_can_add = _.pluck(db.organizations.find({\n            _id: {\n              $in: orgs_can_add\n            }\n          }, {\n            fields: {\n              _id: 1\n            }\n          }).fetch(), '_id');\n          if (_.isEmpty(perms.orgs_can_add)) {\n            if (company_id) {\n              perms.orgs_can_add = [company_id];\n            } else {\n              perms.orgs_can_add = db.organizations.find({\n                space: spaceId,\n                parent: null\n              }, {\n                fields: {\n                  _id: 1\n                }\n              }).fetch().getProperty(\"_id\");\n            }\n          }\n        }\n        if (!_.isEmpty(users_can_monitor)) {\n          perms.users_can_monitor = _.pluck(db.space_users.find({\n            user: {\n              $in: users_can_monitor\n            }\n          }, {\n            fields: {\n              user: 1\n            }\n          }).fetch(), 'user');\n        }\n        if (!_.isEmpty(orgs_can_monitor)) {\n          perms.orgs_can_monitor = _.pluck(db.organizations.find({\n            _id: {\n              $in: orgs_can_monitor\n            }\n          }, {\n            fields: {\n              _id: 1\n            }\n          }).fetch(), '_id');\n        }\n        if (!_.isEmpty(users_can_admin)) {\n          perms.users_can_monitor = _.pluck(db.space_users.find({\n            user: {\n              $in: users_can_admin\n            }\n          }, {\n            fields: {\n              user: 1\n            }\n          }).fetch(), 'user');\n        }\n        if (!_.isEmpty(orgs_can_admin)) {\n          perms.orgs_can_monitor = _.pluck(db.organizations.find({\n            _id: {\n              $in: orgs_can_admin\n            }\n          }, {\n            fields: {\n              _id: 1\n            }\n          }).fetch(), '_id');\n        }\n      } else if (!flow.perms || flow.space !== spaceId) {\n        orgs_can_add = [];\n        if (company_id) {\n          orgs_can_add = [company_id];\n        } else {\n          orgs_can_add = db.organizations.find({\n            space: spaceId,\n            parent: null\n          }, {\n            fields: {\n              _id: 1\n            }\n          }).fetch().getProperty(\"_id\");\n        }\n        perms = {\n          _id: new Mongo.ObjectID()._str,\n          users_can_add: [],\n          orgs_can_add: orgs_can_add,\n          users_can_monitor: [],\n          orgs_can_monitor: [],\n          users_can_admin: [],\n          orgs_can_admin: []\n        };\n        flow.perms = perms;\n      }\n      flow.space = spaceId;\n      flow.current._id = new Mongo.ObjectID()._str;\n      flow.current.flow = flow_id;\n      flow.current._rev = 1;\n      flow.current.form_version = form.current._id;\n      flow.current.created = new Date();\n      flow.current.created_by = uid;\n      flow.current.modified = new Date();\n      flow.current.modified_by = uid;\n      if ((ref = flow.current) != null) {\n        ref.steps.forEach(function(step) {\n          var _accepted_approve_users, _accepted_approver_orgs, approveRolesByIds, approve_roles, approver_hr_roles;\n          if (_.isArray(step.approver_users)) {\n            _accepted_approve_users = [];\n            _.each(step.approver_users, function(uid) {\n              if (db.space_users.findOne({\n                user: uid,\n                user_accepted: true,\n                space: spaceId\n              })) {\n                return _accepted_approve_users.push(uid);\n              }\n            });\n            step.approver_users = _accepted_approve_users;\n          }\n          if (_.isArray(step.approver_orgs)) {\n            _accepted_approver_orgs = [];\n            _.each(step.approver_orgs, function(oid) {\n              if (db.organizations.findOne({\n                _id: oid,\n                space: spaceId\n              })) {\n                return _accepted_approver_orgs.push(oid);\n              }\n            });\n            step.approver_orgs = _accepted_approver_orgs;\n          }\n          if (_.isEmpty(step.approver_roles_name)) {\n            delete step.approver_roles_name;\n            if (_.isEmpty(step.approver_roles)) {\n              step.approver_roles = [];\n            }\n            if (!_.isEmpty(step.approver_hr_roles_name)) {\n              approver_hr_roles = new Array();\n              step.approver_hr_roles_name.forEach(function(role_name, _hr_index) {\n                var apiName, error, ref1, role, role_id, role_query;\n                role_query = {\n                  space: spaceId,\n                  name: role_name\n                };\n                role = db.roles.findOne(role_query, {\n                  fields: {\n                    _id: 1\n                  }\n                });\n                if (_.isEmpty(role)) {\n                  apiName = \"\";\n                  try {\n                    apiName = ((ref1 = step.approver_hr_roles_api_name) != null ? ref1[_hr_index] : void 0) || \"\";\n                  } catch (error1) {\n                    error = error1;\n                    console.log();\n                  }\n                  role_id = db.roles._makeNewID();\n                  role = {\n                    _id: role_id,\n                    name: role_name,\n                    api_name: apiName,\n                    space: spaceId,\n                    created: new Date,\n                    created_by: uid,\n                    modified: new Date(),\n                    modified_by: uid,\n                    owner: uid\n                  };\n                  db.roles.direct.insert(role);\n                  return approver_hr_roles.push(role_id);\n                } else {\n                  return approver_hr_roles.push(role._id);\n                }\n              });\n              step.approver_hr_roles = approver_hr_roles;\n              return delete step.approver_roles_name;\n            }\n          } else {\n            approve_roles = new Array();\n            approveRolesByIds = [];\n            if (_.isArray(step.approver_roles) && !_.isEmpty(step.approver_roles)) {\n              approveRolesByIds = db.flow_roles.find({\n                _id: {\n                  $in: step.approver_roles\n                },\n                space: spaceId\n              }, {\n                fields: {\n                  _id: 1,\n                  name: 1,\n                  company_id: 1\n                }\n              }).fetch();\n            }\n            step.approver_roles_name.forEach(function(role_name, _index) {\n              var approveRoleById, flow_role_query, ref1, role, roleApiName, role_id;\n              roleApiName = ((ref1 = step.approver_roles_api_name) != null ? ref1[_index] : void 0) || \"\";\n              approveRoleById = _.find(approveRolesByIds, function(_role) {\n                return _role._id === step.approver_roles[_index];\n              });\n              flow_role_query = {\n                space: spaceId,\n                name: role_name\n              };\n              if ((!approveRoleById && company_id) || ((approveRoleById != null ? approveRoleById.company_id : void 0) && company_id)) {\n                flow_role_query.company_id = company_id;\n              } else {\n                flow_role_query.$or = [\n                  {\n                    company_id: {\n                      $exists: false\n                    }\n                  }, {\n                    company_id: null\n                  }, {\n                    company_id: ''\n                  }\n                ];\n              }\n              role = db.flow_roles.findOne(flow_role_query, {\n                fields: {\n                  _id: 1\n                }\n              });\n              if (_.isEmpty(role)) {\n                role_id = db.flow_roles._makeNewID();\n                role = {\n                  _id: role_id,\n                  name: role_name,\n                  api_name: roleApiName,\n                  space: spaceId,\n                  created: new Date,\n                  created_by: uid,\n                  modified: new Date(),\n                  modified_by: uid,\n                  owner: uid\n                };\n                if (company_id) {\n                  role.company_id = company_id;\n                  role.company_ids = [company_id];\n                }\n                db.flow_roles.direct.insert(role);\n                return approve_roles.push(role_id);\n              } else {\n                return approve_roles.push(role._id);\n              }\n            });\n            step.approver_roles = approve_roles;\n            return delete step.approver_roles_name;\n          }\n        });\n      }\n      flow[\"import\"] = true;\n      flow.owner = uid;\n      if (upgrade) {\n        upgradeFlow(flow, uid, upgradeFlowId);\n        return _.each(flowObjectWorkflows, function(_objectWorkflow) {\n          return steedosImport.objectWorkflow(spaceId, upgradeFlowId, _objectWorkflow.object_name, _objectWorkflow);\n        });\n      } else {\n        db.flows.direct.insert(flow);\n        new_flow_ids.push(flow_id);\n        return _.each(flowObjectWorkflows, function(_objectWorkflow) {\n          return steedosImport.objectWorkflow(spaceId, flow_id, _objectWorkflow.object_name, _objectWorkflow);\n        });\n      }\n    });\n    return new_flow_ids;\n  } catch (error1) {\n    e = error1;\n    new_form_ids.forEach(function(id) {\n      return db.forms.direct.remove(id);\n    });\n    new_flow_ids.forEach(function(id) {\n      return db.flows.direct.remove(id);\n    });\n    throw e;\n  }\n};\n","fs_store\nstore_name = \"instances\"\nif Meteor.settings.public.cfs?.store == \"OSS\"\n    if Meteor.isClient\n        fs_store = new FS.Store.OSS(store_name)\n    else if Meteor.isServer\n        fs_store = new FS.Store.OSS store_name, Meteor.settings.cfs.aliyun\n\nelse if Meteor.settings.public.cfs?.store == \"S3\"\n    if Meteor.isClient\n        fs_store = new FS.Store.S3(store_name)\n    else if Meteor.isServer\n        fs_store = new FS.Store.S3 store_name, Meteor.settings.cfs.aws\n\nelse if Meteor.settings.public.cfs?.store == \"STEEDOSCLOUD\"\n    if Meteor.isClient\n        fs_store = new FS.Store.STEEDOSCLOUD(store_name)\n    else if Meteor.isServer\n        fs_store = new FS.Store.STEEDOSCLOUD store_name, Meteor.settings.cfs.steedosCloud\nelse\n    if Meteor.isClient\n        fs_store = new FS.Store.FileSystem(store_name)\n    else if Meteor.isServer\n        fs_store = new FS.Store.FileSystem(store_name, {\n                path: require('path').join(process.env.STEEDOS_STORAGE_DIR, \"files/#{store_name}\"),\n                fileKeyMaker: (fileObj)->\n                    # Lookup the copy\n                    store = fileObj and fileObj._getInfo(store_name)\n                    # If the store and key is found return the key\n                    if store and store.key\n                        return store.key\n\n                    # TO CUSTOMIZE, REPLACE CODE AFTER THIS POINT\n\n                    filename = fileObj.name();\n                    filenameInStore = fileObj.name({store: store_name})\n\n                    name = filenameInStore || filename\n\n                    name_split = name.split('.')\n                    extention = name_split.pop()\n\n                    final_filename = name_split.join('.').substring(0,50) + '.' + extention\n\n                    now = new Date\n                    year = now.getFullYear()\n                    month = now.getMonth() + 1\n                    ins_id = fileObj.metadata.instance\n\n                    path = require('path')\n                    mkdirp = require('mkdirp')\n                    pathname = path.join(process.env.STEEDOS_STORAGE_DIR, \"files/#{store_name}/\" + year + '/' + month + '/' + ins_id)\n                    # Set absolute path\n                    absolutePath = path.resolve(pathname)\n                    # Ensure the path exists\n                    mkdirp.sync(absolutePath)\n\n                    # If no store key found we resolve / generate a key\n                    return year + '/' + month + '/' + ins_id + '/' + fileObj.collectionName + '-' + fileObj._id + '-' + final_filename\n\n            })\n\ncfs[store_name] = new FS.Collection store_name,\n    stores: [fs_store]\n\ncfs[store_name].allow\n    download: ->\n        return true;\n\n","fs_store;\nvar fs_store, ref, ref1, ref2, store_name;\n\nstore_name = \"instances\";\n\nif (((ref = Meteor.settings[\"public\"].cfs) != null ? ref.store : void 0) === \"OSS\") {\n  if (Meteor.isClient) {\n    fs_store = new FS.Store.OSS(store_name);\n  } else if (Meteor.isServer) {\n    fs_store = new FS.Store.OSS(store_name, Meteor.settings.cfs.aliyun);\n  }\n} else if (((ref1 = Meteor.settings[\"public\"].cfs) != null ? ref1.store : void 0) === \"S3\") {\n  if (Meteor.isClient) {\n    fs_store = new FS.Store.S3(store_name);\n  } else if (Meteor.isServer) {\n    fs_store = new FS.Store.S3(store_name, Meteor.settings.cfs.aws);\n  }\n} else if (((ref2 = Meteor.settings[\"public\"].cfs) != null ? ref2.store : void 0) === \"STEEDOSCLOUD\") {\n  if (Meteor.isClient) {\n    fs_store = new FS.Store.STEEDOSCLOUD(store_name);\n  } else if (Meteor.isServer) {\n    fs_store = new FS.Store.STEEDOSCLOUD(store_name, Meteor.settings.cfs.steedosCloud);\n  }\n} else {\n  if (Meteor.isClient) {\n    fs_store = new FS.Store.FileSystem(store_name);\n  } else if (Meteor.isServer) {\n    fs_store = new FS.Store.FileSystem(store_name, {\n      path: require('path').join(process.env.STEEDOS_STORAGE_DIR, \"files/\" + store_name),\n      fileKeyMaker: function(fileObj) {\n        var absolutePath, extention, filename, filenameInStore, final_filename, ins_id, mkdirp, month, name, name_split, now, path, pathname, store, year;\n        store = fileObj && fileObj._getInfo(store_name);\n        if (store && store.key) {\n          return store.key;\n        }\n        filename = fileObj.name();\n        filenameInStore = fileObj.name({\n          store: store_name\n        });\n        name = filenameInStore || filename;\n        name_split = name.split('.');\n        extention = name_split.pop();\n        final_filename = name_split.join('.').substring(0, 50) + '.' + extention;\n        now = new Date;\n        year = now.getFullYear();\n        month = now.getMonth() + 1;\n        ins_id = fileObj.metadata.instance;\n        path = require('path');\n        mkdirp = require('mkdirp');\n        pathname = path.join(process.env.STEEDOS_STORAGE_DIR, (\"files/\" + store_name + \"/\") + year + '/' + month + '/' + ins_id);\n        absolutePath = path.resolve(pathname);\n        mkdirp.sync(absolutePath);\n        return year + '/' + month + '/' + ins_id + '/' + fileObj.collectionName + '-' + fileObj._id + '-' + final_filename;\n      }\n    });\n  }\n}\n\ncfs[store_name] = new FS.Collection(store_name, {\n  stores: [fs_store]\n});\n\ncfs[store_name].allow({\n  download: function() {\n    return true;\n  }\n});\n","Cookies = require(\"cookies\")\nJSZip = require(\"jszip\");\n\nexportByFlowIds = (flowIds, res)->\n\tflows = db.flows.find({_id: {$in: flowIds}}, {fields: {form: 1}}).fetch();\n\tzip = new JSZip();\n\tfileNames = {};\n\t_.each flows, (flow)->\n\t\tdata = steedosExport.form(flow.form);\n\t\tif _.isEmpty(data)\n\t\t\tfileName = 'null'\n\t\telse\n\t\t\tfileName = data.name\n\t\tif fileNames[fileName] > 0\n\t\t\tfileName = \"#{fileName} (#{fileNames[fileName]})\";\n\t\t\tfileNames[fileName] = fileNames[fileName] + 1;\n\t\telse\n\t\t\tfileNames[fileName] = 1;\n\n\t\tzip.file(\"#{fileName}.json\", new Buffer(JSON.stringify(data), 'utf-8'));\n\tres.setHeader('Content-type', 'application/octet-stream');\n\tres.setHeader('Content-Disposition', 'attachment;filename='+encodeURI('导出的流程文件')+'.zip');\n\tzip.generateNodeStream().pipe(res).on('finish', ()->\n\t\tconsole.log(\"text file written.\");\n\t);\n\nMeteor.startup ->\n\tWebApp.connectHandlers.use \"/api/workflow/export/form\", (req, res, next)->\n\t\tcookies = new Cookies( req, res );\n\t\t# first check request body\n\t\tif req.body\n\t\t\tuserId = req.body[\"X-User-Id\"]\n\t\t\tauthToken = req.body[\"X-Auth-Token\"]\n\n\t\t# then check cookie\n\t\tif !userId or !authToken\n\t\t\tuserId = cookies.get(\"X-User-Id\")\n\t\t\tauthToken = cookies.get(\"X-Auth-Token\")\n\n\t\tif !(userId and authToken)\n\t\t\tres.writeHead(401);\n\t\t\tres.end JSON.stringify({\n\t\t\t\t\"error\": \"Validate Request -- Missing X-Auth-Token\",\n\t\t\t\t\"success\": false\n\t\t\t})\n\t\t\treturn ;\n\n\n\t\tflowIds = req.query?.flows\n\t\tif flowIds\n\t\t\treturn exportByFlowIds(flowIds.split(','), res)\n\n\n\t\tformId = req.query?.form;\n\n\t\tform = db.forms.findOne({_id: formId}, {fields: {space: 1}})\n\n\t\tif _.isEmpty(form)\n\t\t\tres.writeHead(401);\n\t\t\tres.end JSON.stringify({\n\t\t\t\t\"error\": \"Validate Request -- Invalid formId\",\n\t\t\t\t\"success\": false\n\t\t\t})\n\t\t\treturn ;\n\t\telse\n#\t\t\tif !Steedos.isSpaceAdmin(form.space, userId)\n#\t\t\t\tres.writeHead(401);\n#\t\t\t\tres.end JSON.stringify({\n#\t\t\t\t\t\"error\": \"Validate Request -- No permission\",\n#\t\t\t\t\t\"success\": false\n#\t\t\t\t})\n#\t\t\t\treturn;\n\n\t\t\tspace = db.spaces.findOne(form.space, { fields: { _id: 1 } })\n\t\t\tif !space\n\t\t\t\tJsonRoutes.sendResult res,\n\t\t\t\t\tcode: 404,\n\t\t\t\t\tdata:\n\t\t\t\t\t\t\"error\": \"Validate Request -- No permission\",\n\t\t\t\t\t\t\"success\": false\n\t\t\t\treturn;\n\n\t\ttry\n\t\t\tdata = steedosExport.form(formId);\n\n\t\t\tif _.isEmpty(data)\n\t\t\t\tfileName = 'null'\n\t\t\telse\n\t\t\t\tfileName = data.name\n\n\t\t\tres.setHeader('Content-type', 'application/x-msdownload');\n\t\t\tres.setHeader('Content-Disposition', 'attachment;filename='+encodeURI(fileName)+'.json');\n\t\t\tres.end(JSON.stringify(data))\n\t\tcatch e\n\t\t\tJsonRoutes.sendResult res,\n\t\t\t\tcode: 500,\n\t\t\t\tdata:\n\t\t\t\t\t\"error\": e.message,\n\t\t\t\t\t\"success\": false\n\t\t\treturn;","var Cookies, JSZip, exportByFlowIds;\n\nCookies = require(\"cookies\");\n\nJSZip = require(\"jszip\");\n\nexportByFlowIds = function(flowIds, res) {\n  var fileNames, flows, zip;\n  flows = db.flows.find({\n    _id: {\n      $in: flowIds\n    }\n  }, {\n    fields: {\n      form: 1\n    }\n  }).fetch();\n  zip = new JSZip();\n  fileNames = {};\n  _.each(flows, function(flow) {\n    var data, fileName;\n    data = steedosExport.form(flow.form);\n    if (_.isEmpty(data)) {\n      fileName = 'null';\n    } else {\n      fileName = data.name;\n    }\n    if (fileNames[fileName] > 0) {\n      fileName = fileName + \" (\" + fileNames[fileName] + \")\";\n      fileNames[fileName] = fileNames[fileName] + 1;\n    } else {\n      fileNames[fileName] = 1;\n    }\n    return zip.file(fileName + \".json\", new Buffer(JSON.stringify(data), 'utf-8'));\n  });\n  res.setHeader('Content-type', 'application/octet-stream');\n  res.setHeader('Content-Disposition', 'attachment;filename=' + encodeURI('导出的流程文件') + '.zip');\n  return zip.generateNodeStream().pipe(res).on('finish', function() {\n    return console.log(\"text file written.\");\n  });\n};\n\nMeteor.startup(function() {\n  return WebApp.connectHandlers.use(\"/api/workflow/export/form\", function(req, res, next) {\n    var authToken, cookies, data, e, fileName, flowIds, form, formId, ref, ref1, space, userId;\n    cookies = new Cookies(req, res);\n    if (req.body) {\n      userId = req.body[\"X-User-Id\"];\n      authToken = req.body[\"X-Auth-Token\"];\n    }\n    if (!userId || !authToken) {\n      userId = cookies.get(\"X-User-Id\");\n      authToken = cookies.get(\"X-Auth-Token\");\n    }\n    if (!(userId && authToken)) {\n      res.writeHead(401);\n      res.end(JSON.stringify({\n        \"error\": \"Validate Request -- Missing X-Auth-Token\",\n        \"success\": false\n      }));\n      return;\n    }\n    flowIds = (ref = req.query) != null ? ref.flows : void 0;\n    if (flowIds) {\n      return exportByFlowIds(flowIds.split(','), res);\n    }\n    formId = (ref1 = req.query) != null ? ref1.form : void 0;\n    form = db.forms.findOne({\n      _id: formId\n    }, {\n      fields: {\n        space: 1\n      }\n    });\n    if (_.isEmpty(form)) {\n      res.writeHead(401);\n      res.end(JSON.stringify({\n        \"error\": \"Validate Request -- Invalid formId\",\n        \"success\": false\n      }));\n      return;\n    } else {\n      space = db.spaces.findOne(form.space, {\n        fields: {\n          _id: 1\n        }\n      });\n      if (!space) {\n        JsonRoutes.sendResult(res, {\n          code: 404,\n          data: {\n            \"error\": \"Validate Request -- No permission\",\n            \"success\": false\n          }\n        });\n        return;\n      }\n    }\n    try {\n      data = steedosExport.form(formId);\n      if (_.isEmpty(data)) {\n        fileName = 'null';\n      } else {\n        fileName = data.name;\n      }\n      res.setHeader('Content-type', 'application/x-msdownload');\n      res.setHeader('Content-Disposition', 'attachment;filename=' + encodeURI(fileName) + '.json');\n      return res.end(JSON.stringify(data));\n    } catch (error) {\n      e = error;\n      JsonRoutes.sendResult(res, {\n        code: 500,\n        data: {\n          \"error\": e.message,\n          \"success\": false\n        }\n      });\n    }\n  });\n});\n","Cookies = require(\"cookies\")\n\nimportWorkflow = (jsonStr, uid, spaceId, company_id, flowId)->\n\ttry\n\t\tform = JSON.parse(jsonStr)\n\tcatch e\n\t\tthrow new Meteor.Error('error', \"无效的JSON文件\");\n\n\toptions = {}\n\n\tif flowId\n\t\toptions.flowId = flowId\n\t\toptions.upgrade = true\n\t\tflow = db.flows.findOne({_id: flowId, space: spaceId}, {fields: {form: 1}})\n\t\tif !flow\n\t\t\tthrow new Meteor.Error(\"error\", \"无效的flowId\")\n\t\telse\n\t\t\toptions.formId = flow.form\n\n\tnew_flowIds = steedosImport.workflow(uid, spaceId, form, false, company_id, options);\n\treturn {new_flows: new_flowIds}\n\n\nJsonRoutes.add \"post\", \"/api/workflow/import/form\", (req, res, next) ->\n\tcookies = new Cookies( req, res );\n\n\tmsg = \"\"\n\t# first check request body\n\tif req.body\n\t\tuid = req.body[\"X-User-Id\"]\n\t\tauthToken = req.body[\"X-Auth-Token\"]\n\n\t# then check cookie\n\tif !uid or !authToken\n\t\tuid = cookies.get(\"X-User-Id\")\n\t\tauthToken = cookies.get(\"X-Auth-Token\")\n\n\tif !(uid and authToken)\n\t\tres.writeHead(401);\n\t\tres.end JSON.stringify({\n\t\t\t\"error\": \"Validate Request -- Missing X-Auth-Token\",\n\t\t\t\"success\": false\n\t\t})\n\t\treturn ;\n\n\tspaceId = req.query?.space;\n\n\tcompany_id = req.query?.company_id;\n\n\tflowId = req.query?.flowId;\n\n\tif flowId\n\t\tflow = db.flows.findOne({_id: flowId, space: spaceId}, {fields: {company_id: 1}})\n\t\tif flow\n\t\t\tcompany_id = flow.company_id\n\n\tspace = db.spaces.findOne(spaceId, { fields: { _id: 1 } })\n\n\tif !space\n\t\tJsonRoutes.sendResult res,\n\t\t\tcode: 404,\n\t\t\tdata:\n\t\t\t\t\"error\": \"Validate Request -- No permission\",\n\t\t\t\t\"success\": false\n\t\treturn;\n\n\tif !WorkflowCore.checkCreatePermissions(spaceId, uid, company_id)\n\t\tres.writeHead(401);\n\t\tres.end JSON.stringify({\n\t\t\t\"error\": \"Validate Request -- No permission\",\n\t\t\t\"success\": false\n\t\t})\n\t\treturn\n\n\ttry\n\t\tJsonRoutes.parseFiles req, res, ()->\n\t\t\ttry\n\t\t\t\tfiles = req.files\n\t\t\t\tfail = {}\n\t\t\t\tsuccess = {}\n\t\t\t\tmultiple = false\n\t\t\t\tif files.length > 1\n\t\t\t\t\tmultiple = true\n\n\t\t\t\tif flowId && files.length > 0\n\t\t\t\t\tfiles = [files[0]]\n\n\t\t\t\t_.each files, (file)->\n\t\t\t\t\tfilename = file.filename\n\t\t\t\t\ttry\n\t\t\t\t\t\tjsonData = file.data.toString(\"utf-8\");\n\t\t\t\t\t\tsuccess[filename] = importWorkflow(jsonData, uid, spaceId, company_id, flowId)\n\t\t\t\t\tcatch e\n\t\t\t\t\t\tif  e.reason && e.details\n\t\t\t\t\t\t\tfail[filename] = {reason: e.reason, details: e.details}\n\t\t\t\t\t\telse\n\t\t\t\t\t\t\tfail[filename] = e.reason || e.message\n\t\t\t\tif _.isEmpty(fail)\n\t\t\t\t\tres.statusCode = 200;\n\t\t\t\telse\n\t\t\t\t\tres.statusCode = 500;\n\t\t\t\tres.end(JSON.stringify({multiple: multiple, fail: fail, success: success}))\n\t\t\tcatch e1\n\t\t\t\tmsg = \"无效的JSON文件\"\n\t\t\t\tres.statusCode = 500;\n\t\t\t\tres.end(msg);\n\tcatch e\n\t\tconsole.error(e)\n\n","var Cookies, importWorkflow;\n\nCookies = require(\"cookies\");\n\nimportWorkflow = function(jsonStr, uid, spaceId, company_id, flowId) {\n  var e, flow, form, new_flowIds, options;\n  try {\n    form = JSON.parse(jsonStr);\n  } catch (error) {\n    e = error;\n    throw new Meteor.Error('error', \"无效的JSON文件\");\n  }\n  options = {};\n  if (flowId) {\n    options.flowId = flowId;\n    options.upgrade = true;\n    flow = db.flows.findOne({\n      _id: flowId,\n      space: spaceId\n    }, {\n      fields: {\n        form: 1\n      }\n    });\n    if (!flow) {\n      throw new Meteor.Error(\"error\", \"无效的flowId\");\n    } else {\n      options.formId = flow.form;\n    }\n  }\n  new_flowIds = steedosImport.workflow(uid, spaceId, form, false, company_id, options);\n  return {\n    new_flows: new_flowIds\n  };\n};\n\nJsonRoutes.add(\"post\", \"/api/workflow/import/form\", function(req, res, next) {\n  var authToken, company_id, cookies, e, flow, flowId, msg, ref, ref1, ref2, space, spaceId, uid;\n  cookies = new Cookies(req, res);\n  msg = \"\";\n  if (req.body) {\n    uid = req.body[\"X-User-Id\"];\n    authToken = req.body[\"X-Auth-Token\"];\n  }\n  if (!uid || !authToken) {\n    uid = cookies.get(\"X-User-Id\");\n    authToken = cookies.get(\"X-Auth-Token\");\n  }\n  if (!(uid && authToken)) {\n    res.writeHead(401);\n    res.end(JSON.stringify({\n      \"error\": \"Validate Request -- Missing X-Auth-Token\",\n      \"success\": false\n    }));\n    return;\n  }\n  spaceId = (ref = req.query) != null ? ref.space : void 0;\n  company_id = (ref1 = req.query) != null ? ref1.company_id : void 0;\n  flowId = (ref2 = req.query) != null ? ref2.flowId : void 0;\n  if (flowId) {\n    flow = db.flows.findOne({\n      _id: flowId,\n      space: spaceId\n    }, {\n      fields: {\n        company_id: 1\n      }\n    });\n    if (flow) {\n      company_id = flow.company_id;\n    }\n  }\n  space = db.spaces.findOne(spaceId, {\n    fields: {\n      _id: 1\n    }\n  });\n  if (!space) {\n    JsonRoutes.sendResult(res, {\n      code: 404,\n      data: {\n        \"error\": \"Validate Request -- No permission\",\n        \"success\": false\n      }\n    });\n    return;\n  }\n  if (!WorkflowCore.checkCreatePermissions(spaceId, uid, company_id)) {\n    res.writeHead(401);\n    res.end(JSON.stringify({\n      \"error\": \"Validate Request -- No permission\",\n      \"success\": false\n    }));\n    return;\n  }\n  try {\n    return JsonRoutes.parseFiles(req, res, function() {\n      var e1, fail, files, multiple, success;\n      try {\n        files = req.files;\n        fail = {};\n        success = {};\n        multiple = false;\n        if (files.length > 1) {\n          multiple = true;\n        }\n        if (flowId && files.length > 0) {\n          files = [files[0]];\n        }\n        _.each(files, function(file) {\n          var e, filename, jsonData;\n          filename = file.filename;\n          try {\n            jsonData = file.data.toString(\"utf-8\");\n            return success[filename] = importWorkflow(jsonData, uid, spaceId, company_id, flowId);\n          } catch (error) {\n            e = error;\n            if (e.reason && e.details) {\n              return fail[filename] = {\n                reason: e.reason,\n                details: e.details\n              };\n            } else {\n              return fail[filename] = e.reason || e.message;\n            }\n          }\n        });\n        if (_.isEmpty(fail)) {\n          res.statusCode = 200;\n        } else {\n          res.statusCode = 500;\n        }\n        return res.end(JSON.stringify({\n          multiple: multiple,\n          fail: fail,\n          success: success\n        }));\n      } catch (error) {\n        e1 = error;\n        msg = \"无效的JSON文件\";\n        res.statusCode = 500;\n        return res.end(msg);\n      }\n    });\n  } catch (error) {\n    e = error;\n    return console.error(e);\n  }\n});\n"]}